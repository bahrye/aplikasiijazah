<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="icon" type="image/png" sizes="32x32" href="https://uploadimage.io/images/2025/06/10/Icon-Legalisir-Ijazah.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-link { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; border-left: 4px solid transparent; }
        .nav-link.active { background-color: #3b82f6; color: white; border-left-color: #facc15; }
        .nav-link:hover { background-color: #2563eb; color: white; }
        .content-page, #login-container, #signup-container { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; }
        .score-input { width: 60px; text-align: center; }
        .total-cell { font-weight: bold; }
        .rekap-table th, .rekap-table td { padding: 8px 12px; border: 1px solid #e5e7eb; }
        .rekap-btn.active {
            background-color: #2563eb;
            color: white;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }
        .gradient-bg {
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, rgb(243, 244, 246) 0px, transparent 50%),
                radial-gradient(at 95% 20%, rgb(229, 231, 235) 0px, transparent 50%),
                radial-gradient(at 20% 90%, rgb(209, 213, 219) 0px, transparent 50%);
        }
        /* Animasi untuk titik-titik loading */
        .loading-animation::after {
            display: inline-block;
            animation: loading-dots 1.4s infinite;
            content: '.';
            width: 1em;
            text-align: left;
        }
        @keyframes loading-dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        .nama-siswa-cell {
            text-align: left;
        }
        /* CSS untuk Notifikasi Pop-up di Atas Tengah */
        #globalStatusMessage {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 90%;
            max-width: 500px;
            pointer-events: none; /* Agar tidak menghalangi klik */
        }

        .toast-notification {
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: white;
            font-weight: 500;
            text-align: center;
            animation: fadeInOut 4s ease-in-out forwards;
            opacity: 0;
            pointer-events: auto; /* Aktifkan kembali pointer */
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(-20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Container -->
    <div id="auth-wrapper" class="gradient-bg flex flex-col min-h-screen">
        <div class="flex-grow flex items-center justify-center py-8 px-4">
            <div class="w-full max-w-md">
                <!-- Container untuk Login -->
                <div id="login-container">
                    <div class="bg-white rounded-2xl shadow-xl p-8 md:p-10">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Login Aplikasi<br>Pengolahan Nilai Ijazah</h1>
                            <p class="text-gray-500 mt-2">Silakan masuk untuk melanjutkan</p>
                        </div>
                        <div id="login-info-message" class="mb-4 text-center text-sm"></div>
                        <form id="loginForm">
                            <div class="space-y-6">
                                <div>
                                    <label for="email" class="text-sm font-medium text-gray-700 block mb-2">Alamat Email</label>
                                    <input type="email" name="email" id="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="nama@email.com" required>
                                </div>
                                <div>
                                    <label for="password" class="text-sm font-medium text-gray-700 block mb-2">Kata Sandi</label>
                                    <div class="relative">
                                        <input type="password" name="password" id="password" class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="••••••••" required>
                                        <button type="button" data-toggle-password="password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                            <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                            <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <button type="submit" id="loginButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 shadow-lg">
                                        <span id="loginButtonText">Masuk</span>
                                        <span id="loginSpinner" class="hidden loading-animation">Memproses</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                        <div id="login-error-message" class="mt-4 text-center text-red-600 text-sm h-4"></div>
                        <div class="text-center text-sm mt-4">
                            <a href="#" id="forgot-password-link" class="text-gray-500 hover:text-blue-600">Lupa Password?</a>
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            Belum punya akun? 
                            <a href="#" id="show-signup" class="font-medium text-blue-600 hover:text-blue-500">Daftar sekarang</a>
                        </p>
                    </div>
                </div>

                <!-- Container untuk Signup (awalnya disembunyikan) -->
                <div id="signup-container" class="hidden">
                    <div class="bg-white rounded-2xl shadow-xl p-8 md:p-10">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Buat Akun Sekolah</h1>
                            <p class="text-gray-500 mt-2">Isi form di bawah untuk mendaftar.</p>
                        </div>
                        <form id="signupForm">
                             <div id="signup-message" class="mb-4 text-center text-sm h-auto"></div>
                            <div class="space-y-4">
                                <div id="initial-fields" class="space-y-4">
                                    <div>
                                        <label for="signup-namasekolah" class="text-sm font-medium text-gray-700 block mb-2">Nama Sekolah</label>
                                        <input type="text" id="signup-namasekolah" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Contoh: MI Al-Hidayah" required>
                                    </div>
                                    <div>
                                      <label for="signup-jenjang" class="text-sm font-medium text-gray-700 block mb-2">Jenjang Sekolah</label>
                                      <select id="signup-jenjang" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white" required>
                                        <option value="" disabled selected>-- Pilih Jenjang --</option>
                                        <option value="MI">MI (Madrasah Ibtidaiyah)</option>
                                        <option value="MTS">MTS (Madrasah Tsanawiyah)</option>
                                        <option value="MA">MA (Madrasah Aliyah)</option>
                                      </select>
                                    </div>
                                    <div>
                                        <label for="signup-email" class="text-sm font-medium text-gray-700 block mb-2">Alamat Email</label>
                                        <input type="email" id="signup-email" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="nama@email.com" required>
                                    </div>
                                    <div>
                                        <label for="signup-password" class="text-sm font-medium text-gray-700 block mb-2">Kata Sandi</label>
                                        <div class="relative">
                                            <input type="password" id="signup-password" class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg shadow-sm" placeholder="••••••••" required>
                                            <button type="button" data-toggle-password="signup-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="confirm-password" class="text-sm font-medium text-gray-700 block mb-2">Konfirmasi Kata Sandi</label>
                                        <div class="relative">
                                            <input type="password" id="confirm-password" class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg shadow-sm" placeholder="••••••••" required>
                                            <button type="button" data-toggle-password="confirm-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="pt-2">
                                        <button type="button" id="requestOtpButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 shadow-lg">
                                            <span id="requestOtpButtonText">Kirim Kode Verifikasi</span>
                                            <span id="requestOtpSpinner" class="hidden loading-animation">Mengirim</span>
                                        </button>
                                    </div>
                                </div>
                                <div id="otp-section" class="hidden">
                                    <label for="signup-otp" class="text-sm font-medium text-gray-700 block mb-2">Kode OTP</label>
                                    <input type="text" id="signup-otp" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Masukkan 6 digit kode dari email" required>
                                </div>
                                <div id="final-signup-button-container" class="hidden">
                                    <button type="submit" id="signupButton" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 shadow-lg">
                                        <span id="signupButtonText">Daftar</span>
                                        <span id="signupSpinner" class="hidden loading-animation">Memproses</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            Sudah punya akun? 
                            <a href="#" id="show-login" class="font-medium text-blue-600 hover:text-blue-500">Masuk di sini</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center py-4">
            <a href="https://wa.me/6281543276033" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-500 hover:text-blue-600 transition-colors">
              &copy; <span id="currentYearAuth"></span> Created by Syamsul Bahri
            </a>
        </footer>
    </div>

    <!-- Container untuk Aplikasi Utama (awalnya disembunyikan) -->
    <div id="app-container" class="hidden">
        <div class="flex h-screen">
            <aside class="w-64 bg-blue-800 text-white flex flex-col">
                <div class="h-16 flex items-center justify-center text-xl font-bold border-b border-blue-700 text-center px-2"><span id="school-name-sidebar">SYAMSUL BAHRI</span></div>
                <nav class="flex-1 px-4 py-4 space-y-2">
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md active" data-page="dashboard"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span>Dashboard</span></a>
                    <div class="border-t border-blue-700 my-2"></div>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="data-sekolah"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg><span>Data Sekolah</span></a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="data-siswa"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.975 5.975 0 0112 13a5.975 5.975 0 01-3 5.197z" /></svg><span>Data Siswa</span></a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="mapel"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v11.494m-9-5.747h18" /></svg><span>Mapel & Bobot</span></a>
                    <div class="border-t border-blue-700 my-2"></div>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="input-ujian"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 0v6m0-6L9 13" /></svg><span>Input Nilai Ujian</span></a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="input-rapor"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span>Input Nilai Rapor</span></a>
                    <div class="border-t border-blue-700 my-2"></div>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="rekapitulasi"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span>Rekapitulasi</span></a>
                </nav>
                <div class="mt-auto p-4 border-t border-blue-700">
                     <a href="#" id="logoutButton" class="nav-link flex items-center space-x-3 p-2 rounded-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg><span>Logout</span></a>
                </div>
            </aside>

            <main class="flex-1 p-6 md:p-10 overflow-y-auto flex flex-col">
                <div class="flex-grow">
                    <div id="page-dashboard" class="content-page">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Dashboard</h1>
                        <p class="text-gray-600 mb-8">Ringkasan data akademik sekolah Anda.</p>
                        
                        <!-- Kartu Statistik -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            <!-- Kartu Siswa (dapat diklik) -->
                            <div id="student-card" class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 cursor-pointer">
                                <div class="bg-blue-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.125-1.273-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.125-1.273.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Jumlah Siswa</p>
                                    <p id="studentCount" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <!-- Kartu Mapel (dapat diklik) -->
                            <div id="mapel-card" class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 cursor-pointer">
                                <div class="bg-green-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m-9-5.747h18" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Jumlah Mata Pelajaran</p>
                                    <p id="mapelCount" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>

                        <!-- Grafik -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Distribusi Jenis Ujian Mata Pelajaran</h2>
                            <div class="h-80">
                                <canvas id="mapelChart"></canvas>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-6 mt-8">
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Rata-rata Nilai Ujian per Mapel</h2>
                                <div class="h-96">
                                    <canvas id="ujianAverageChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Rata-rata Nilai Rapor per Mapel</h2>
                                <div class="h-96">
                                    <canvas id="raporAverageChart"></canvas>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Rata-rata Nilai Ijazah per Mapel</h2>
                                <div class="h-96">
                                    <canvas id="ijazahAverageChart"></canvas>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <div class="mb-4">
                                    <h2 class="text-xl font-bold text-gray-800">Distribusi Rata-rata Nilai Ujian Siswa</h2>
                                    <p class="text-sm text-gray-500">(Silahkan Perbarui Rekapitulasi Untuk Mendapatkan Grafik Terbaru)</p>
                                </div>
                                <div class="h-96">
                                    <canvas id="examScoreDistributionChart"></canvas>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <div class="mb-4">
                                    <h2 class="text-xl font-bold text-gray-800">Peringkat Siswa Berdasarkan Rata-rata Nilai Ijazah</h2>
                                    <p class="text-sm text-gray-500">(Silahkan Perbarui Rekapitulasi Untuk Mendapatkan Grafik Terbaru)</p>
                                </div> 
                                <div class="h-96">
                                    <canvas id="ijazahRankingChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="page-data-sekolah" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Data Sekolah</h1>
                        <p class="mt-2 text-gray-600 mb-8">Gunakan formulir ini untuk mengisi atau memperbarui informasi detail mengenai sekolah Anda.</p>
                        <div class="bg-white p-8 rounded-lg shadow-md max-w-4xl">
                            <form id="schoolDataForm">
                                <div class="mb-6 pb-6 border-b">
                                <label for="jenjang" class="block text-sm font-medium text-gray-700">Jenjang Sekolah</label>
                                <select id="jenjang" name="jenjang" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" disabled>
                                    <option value="">-- Pilih Jenjang --</option>
                                    <option value="MI">MI (Madrasah Ibtidaiyah)</option>
                                    <option value="MTS">MTS (Madrasah Tsanawiyah)</option>
                                    <option value="MA">MA (Madrasah Aliyah)</option>
                                </select>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                    <div>
                                        <label for="namaSekolah" class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                                        <input type="text" id="namaSekolah" name="namaSekolah" class="mt-1 w-full px-3 py-2 border border-gray-300 bg-gray-100 rounded-md shadow-sm" readonly>
                                        <label for="npsn" class="block text-sm font-medium text-gray-700 mt-4">NPSN</label>
                                        <input type="text" id="npsn" name="npsn" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="alamat" class="block text-sm font-medium text-gray-700 mt-4">Alamat Jalan</label>
                                        <textarea id="alamat" name="alamat" rows="3" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                                        <label for="kelurahan" class="block text-sm font-medium text-gray-700 mt-4">Kelurahan/Desa</label>
                                        <input type="text" id="kelurahan" name="kelurahan" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="kecamatan" class="block text-sm font-medium text-gray-700 mt-4">Kecamatan</label>
                                        <input type="text" id="kecamatan" name="kecamatan" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label for="kabupaten" class="block text-sm font-medium text-gray-700">Kabupaten/Kota</label>
                                        <input type="text" id="kabupaten" name="kabupaten" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="provinsi" class="block text-sm font-medium text-gray-700 mt-4">Provinsi</label>
                                        <input type="text" id="provinsi" name="provinsi" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="kodePos" class="block text-sm font-medium text-gray-700 mt-4">Kode Pos</label>
                                        <input type="text" id="kodePos" name="kodePos" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="telepon" class="block text-sm font-medium text-gray-700 mt-4">Nomor Telepon</label>
                                        <input type="tel" id="telepon" name="telepon" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="email-sekolah" class="block text-sm font-medium text-gray-700 mt-4">Email</label>
                                        <input type="email" id="email-sekolah" name="email" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="website" class="block text-sm font-medium text-gray-700 mt-4">Website</label>
                                        <input type="url" id="website" name="website" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                <div class="mt-8 border-t pt-6">
                                    <h2 class="text-lg font-medium text-gray-900">Data Kepala Sekolah</h2>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mt-4">
                                        <div>
                                            <label for="namaKepsek" class="block text-sm font-medium text-gray-700">Nama Kepala Sekolah</label>
                                            <input type="text" id="namaKepsek" name="namaKepsek" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="nipKepsek" class="block text-sm font-medium text-gray-700">NIP Kepala Sekolah (Jika ada)</label>
                                            <input type="text" id="nipKepsek" name="nipKepsek" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-8 pt-5 border-t">
                                    <button type="submit" id="schoolSubmitBtn" class="w-full md:w-auto flex justify-center py-2 px-8 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                                        <span id="schoolSubmitBtnText">Simpan Data Sekolah</span>
                                        <span id="schoolLoadingSpinner" class="hidden loading-animation">Menyimpan</span>
                                    </button>
                                </div>
                            </form>
                            <div id="schoolStatusMessage" class="mt-6 p-4 rounded-md text-center opacity-0 transition-opacity"></div>
                        </div>
                    </div>
                    
                    <div id="page-data-siswa" class="content-page hidden">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800">Manajemen Data Siswa</h1>
                                <p class="mt-2 text-gray-600">Tambah, lihat, edit, atau hapus data siswa di sekolah Anda.</p>
                            </div>
                            <div class="flex space-x-2">
                                <button id="addStudentBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">+ Tambah Siswa</button>
                                <button id="deleteAllStudentsBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">Hapus Semua Siswa</button>
                            </div>
                        </div>
                        <div class="mt-8 border-t pt-6">
                            <h2 class="text-xl font-bold text-gray-800">Import Data Siswa</h2>
                            <p class="mt-1 text-gray-600">Unggah data siswa secara massal menggunakan template Excel.</p>
                            <div class="mt-4 flex flex-wrap items-center gap-4">
                                <button id="downloadTemplateBtn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Download Template</button>
                                <input type="file" id="siswaFileInput" class="hidden" accept=".xlsx, .xls, .csv">
                                <label for="siswaFileInput" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg cursor-pointer hover:bg-green-700">Pilih File...</label>
                                <span id="fileName" class="text-gray-500">Tidak ada file dipilih</span>
                                <button id="importSiswaBtn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Import Data</button>
                            </div>
                            <div id="importStatus" class="mt-4"></div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md mt-8">
                            <div id="siswaTableContainer" class="overflow-x-auto"></div>
                        </div>
                    </div>
                    
                    <div id="page-mapel" class="content-page hidden">
                        <div class="mb-10">
                            <h2 class="text-2xl font-bold text-gray-800">Pengaturan Bobot Nilai</h2>
                            <p class="mt-1 text-gray-600">Atur persentase bobot antara nilai ujian dan nilai rapor. Total keduanya harus 100%.</p>
                            <div class="mt-4 bg-white p-6 rounded-lg shadow-md max-w-xl">
                                <form id="bobotForm">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                                        <div>
                                            <label for="bobotUjian" class="block text-sm font-medium text-gray-700">Bobot Nilai Ujian</label>
                                            <div class="mt-1 relative rounded-md shadow-sm">
                                                <input type="number" id="bobotUjian" name="bobotUjian" min="0" max="100" class="w-full p-2 pr-8 border rounded-md" required>
                                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><span class="text-gray-500 sm:text-sm">%</span></div>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="bobotRapor" class="block text-sm font-medium text-gray-700">Bobot Nilai Rapor</label>
                                            <div class="mt-1 relative rounded-md shadow-sm">
                                                <input type="number" id="bobotRapor" name="bobotRapor" min="0" max="100" class="w-full p-2 pr-8 border rounded-md" required>
                                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><span class="text-gray-500 sm:text-sm">%</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-6 pt-4 border-t">
                                        <button type="submit" id="saveBobotBtn" class="bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400">Simpan Bobot</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="mb-10 border-t pt-8">
                            <h2 class="text-xl font-bold text-gray-800">Opsi Impor & Manajemen Data</h2>
                            <p class="mt-1 text-gray-600">Gunakan opsi di bawah untuk mengelola data mata pelajaran secara massal.</p>
                            
                            <!-- Area Import -->
                            <div class="mt-6 p-6 bg-white rounded-lg shadow-md">
                                <h3 class="font-semibold text-lg text-gray-800 mb-4">Impor Data Mata Pelajaran</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Import by System -->
                                    <div class="border p-4 rounded-lg">
                                        <h4 class="font-medium text-gray-700">Otomatis dari Sistem</h4>
                                        <p class="text-sm text-gray-500 mb-3">Impor daftar mapel standar sesuai jenjang sekolah Anda.</p>
                                        <button id="importMapelSystemBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 w-full flex items-center justify-center disabled:bg-blue-400">
                                        <span id="importMapelSystemBtnText">Import Mapel by System</span>
                                        <span id="importMapelSystemSpinner" class="hidden loading-animation">Mengimpor</span>
                                        </button>
                                    </div>
                                    <!-- Import from File -->
                                    <div class="border p-4 rounded-lg">
                                        <h4 class="font-medium text-gray-700">Manual dari File</h4>
                                        <p class="text-sm text-gray-500 mb-3">Unggah data mapel dari template Excel. Kode mapel yang sama akan dilewati.</p>
                                        <div class="flex flex-col space-y-2">
                                            <div class="flex space-x-2">
                                                <button id="downloadMapelTemplateBtn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 text-sm flex-1">Download Template</button>
                                                <label for="mapelFileInput" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg cursor-pointer hover:bg-green-700 text-sm flex-1 text-center">Pilih File</label>
                                            </div>
                                            <input type="file" id="mapelFileInput" class="hidden" accept=".xlsx, .xls, .csv">
                                            <span id="mapelFileName" class="text-gray-500 text-sm text-center">Tidak ada file dipilih</span>
                                            <button id="importMapelBtn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed w-full">Import dari File</button>
                                        </div>
                                    </div>
                                </div>
                                <div id="importMapelStatus" class="mt-4"></div>
                            </div>

                            <!-- Area Manajemen -->
                            <div class="mt-6 flex justify-between items-center bg-white p-6 rounded-lg shadow-md">
                                <div>
                                    <h3 class="font-semibold text-lg text-gray-800">Manajemen Data</h3>
                                    <p class="text-sm text-gray-500">Tambah manual atau hapus semua data mapel.</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button id="addMapelBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">+ Tambah Mapel</button>
                                    <button id="deleteAllMapelBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">Hapus Semua Mapel</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabel Mapel -->
                        <div class="mt-8">
                            <h2 class="text-2xl font-bold text-gray-800">Daftar Mata Pelajaran Saat Ini</h2>
                            <div class="bg-white p-4 rounded-lg shadow-md mt-4">
                                <div id="mapelTableContainer" class="overflow-x-auto"></div>
                            </div>
                        </div>
                    </div>

                    
                    <div id="page-input-ujian" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Input Nilai Ujian</h1>
                        <p class="mt-2 text-gray-600 mb-8">Pilih jenis ujian yang akan diinput nilainya atau cek rata-rata.</p>
                        <div class="flex flex-wrap gap-4 mb-8">
                            <button id="btn-show-ujian-madrasah" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors">Input Nilai Ujian Madrasah</button>
                            <button id="btn-show-ujian-praktek" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition-colors">Input Nilai Ujian Praktek</button>
                            <button id="btn-cek-rata-ujian" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors">Cek Rata-Rata Nilai Ujian</button>
                        </div>
                        <div id="input-ujian-container"></div>
                    </div>
        
                    <div id="page-input-rapor" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Input Nilai Rapor</h1>
                        <div id="rapor-container" class="mt-4"></div>
                    </div>
                    <div id="page-rekapitulasi" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Rekapitulasi Nilai Akhir</h1>
                        <p class="mt-2 text-gray-600 mb-8">Lihat ringkasan nilai ujian, rapor, dan nilai akhir ijazah.</p>
                        
                        <div id="rekap-loader" class="text-center p-8">
                            <p class="font-bold loading-animation">Mengumpulkan dan memproses semua data nilai</p>
                            <p>Silakan tunggu, ini mungkin memakan waktu beberapa saat.</p>
                        </div>
                        
                        <div id="rekap-content" class="hidden">
                            <div class="flex space-x-4 mb-8 border-b pb-4">
                                <button data-rekap="ujian" class="rekap-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-blue-200 transition-colors">Rekap Nilai Ujian</button>
                                <button data-rekap="rapor" class="rekap-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-blue-200 transition-colors">Rekap Nilai Rapor</button>
                                <button data-rekap="ijazah" class="rekap-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-blue-200 transition-colors">Rekap Nilai Ijazah</button>
                                <button id="updateRekapBtn" class="ml-auto bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center disabled:bg-green-400">
                                    <span id="updateRekapBtnText">Perbarui & Muat Ulang Data</span>
                                    <span id="updateRekapSpinner" class="hidden loading-animation">Memperbarui</span>
                                </button>
                            </div>
                            <div id="rekap-display-area">
                            </div>
                        </div>
        
                        <div id="rekap-setup" class="hidden text-center p-8 bg-yellow-100 rounded-lg">
                            <p class="font-bold text-yellow-800">Sheet Rekapitulasi belum dibuat.</p>
                            <p class="text-yellow-700 mt-2">Silakan klik tombol di bawah untuk membuat sheet yang diperlukan untuk menampilkan data rekapitulasi.</p>
                            <button id="createRekapSheetsBtn" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Buat Sheet Rekapitulasi</button>
                        </div>
                    </div>
                </div>
                <footer class="text-center py-4 mt-8 border-t">
                    <a href="https://wa.me/6281543276033" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-500 hover:text-blue-600 transition-colors">
                      &copy; <span id="currentYearApp"></span> Created by Syamsul Bahri
                    </a>
                </footer>
            </main>
        </div>
    </div>
    
    <div id="siswa-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95">
             <div class="flex justify-between items-center border-b pb-3 mb-5">
                <h2 id="siswa-modal-title" class="text-2xl font-bold text-gray-800">Tambah Siswa Baru</h2>
                <button id="closeSiswaModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="siswaForm">
                <input type="hidden" id="studentRow" name="studentRow">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label for="nama" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                        <input type="text" id="nama" name="nama" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="nisn" class="block text-sm font-medium text-gray-700">NISN</label>
                        <input type="text" id="nisn" name="nisn" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="nis" class="block text-sm font-medium text-gray-700">NIS</label>
                        <input type="text" id="nis" name="nis" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                     <div>
                        <label for="tempatLahir" class="block text-sm font-medium text-gray-700">Tempat Lahir</label>
                        <input type="text" id="tempatLahir" name="tempatLahir" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="tanggalLahir" class="block text-sm font-medium text-gray-700">Tanggal Lahir</label>
                        <input type="date" id="tanggalLahir" name="tanggalLahir" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t flex justify-end">
                    <button type="button" id="cancelSiswaBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md mr-3 hover:bg-gray-300">Batal</button>
                    <button type="submit" id="saveSiswaBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="mapel-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95">
            <div class="flex justify-between items-center border-b pb-3 mb-5">
                <h2 id="mapel-modal-title" class="text-2xl font-bold text-gray-800">Tambah Mata Pelajaran</h2>
                <button id="closeMapelModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="mapelForm">
                <input type="hidden" id="mapelRow" name="mapelRow">
                <div class="space-y-4">
                    <div>
                        <label for="kode" class="block text-sm font-medium text-gray-700">Kode Mata Pelajaran</label>
                        <input type="text" id="kode" name="kode" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="namaMapel" class="block text-sm font-medium text-gray-700">Nama Mata Pelajaran</label>
                        <input type="text" id="namaMapel" name="nama" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="kelompok" class="block text-sm font-medium text-gray-700">Kelompok</label>
                        <select id="kelompok" name="kelompok" class="mt-1 w-full p-2 border rounded-md bg-white">
                            <option>Umum</option>
                            <option>Peminatan</option>
                            <option>Muatan Lokal</option>
                        </select>
                    </div>
                    <div class="pt-2">
                        <label class="block text-sm font-medium text-gray-700">Jenis Ujian</label>
                        <div class="mt-2 space-y-2">
                             <div class="flex items-center"><input type="radio" id="jenisUjianMadrasah" name="jenisUjian" value="Ujian Madrasah" class="h-4 w-4 text-blue-600 border-gray-300"><label for="jenisUjianMadrasah" class="ml-3 block text-sm text-gray-900">Ujian Madrasah Saja</label></div>
                             <div class="flex items-center"><input type="radio" id="jenisUjianPraktek" name="jenisUjian" value="Ujian Praktek" class="h-4 w-4 text-blue-600 border-gray-300"><label for="jenisUjianPraktek" class="ml-3 block text-sm text-gray-900">Ujian Praktek Saja</label></div>
                             <div class="flex items-center"><input type="radio" id="jenisKeduanya" name="jenisUjian" value="Keduanya" class="h-4 w-4 text-blue-600 border-gray-300"><label for="jenisKeduanya" class="ml-3 block text-sm text-gray-900">Keduanya (Madrasah & Praktek)</label></div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t flex justify-end">
                    <button type="button" id="cancelMapelBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md mr-3 hover:bg-gray-300">Batal</button>
                    <button type="submit" id="saveMapelBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="export-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 transform scale-95">
            <div class="flex justify-between items-center border-b pb-3 mb-5">
                <h2 class="text-2xl font-bold text-gray-800">Input Data untuk Ekspor</h2>
                <button id="closeExportModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="exportForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="exportNamaSekolah" class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                        <input type="text" id="exportNamaSekolah" class="mt-1 w-full p-2 border bg-gray-100 rounded-md" readonly>
                        
                        <label for="exportTahunAjaran" class="block text-sm font-medium text-gray-700 mt-4">Tahun Ajaran</label>
                        <select id="exportTahunAjaran" class="mt-1 w-full p-2 border rounded-md bg-white"></select>
                        
                        <label for="exportTempatTTD" class="block text-sm font-medium text-gray-700 mt-4">Tempat Tanda Tangan</label>
                        <input type="text" id="exportTempatTTD" placeholder="Contoh: Bulukumba" class="mt-1 w-full p-2 border rounded-md">

                        <label for="exportTanggalTTD" class="block text-sm font-medium text-gray-700 mt-4">Tanggal Tanda Tangan</label>
                        <input type="date" id="exportTanggalTTD" class="mt-1 w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label for="exportTipeKamad" class="block text-sm font-medium text-gray-700">Tipe Kepala Madrasah</label>
                        <select id="exportTipeKamad" class="mt-1 w-full p-2 border rounded-md bg-white">
                            <option>Kepala Madrasah</option>
                            <option>Plt. Kepala Madrasah</option>
                        </select>

                        <label for="exportNamaKamad" class="block text-sm font-medium text-gray-700 mt-4">Nama Kepala Madrasah</label>
                        <input type="text" id="exportNamaKamad" class="mt-1 w-full p-2 border bg-gray-100 rounded-md" readonly>

                        <label for="exportNip" class="block text-sm font-medium text-gray-700 mt-4">NIP</label>
                        <input type="text" id="exportNip" class="mt-1 w-full p-2 border bg-gray-100 rounded-md" readonly>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t flex justify-end space-x-3">
                    <button type="button" id="cancelExportBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="button" id="generateExcelBtn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span class="btn-text">Unduh Excel</span>
                        <span class="btn-spinner hidden loading-animation">Memproses</span>
                    </button>
                    <button type="button" id="generatePdfBtn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="btn-text">Unduh PDF</span>
                        <span class="btn-spinner hidden loading-animation">Memproses</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="forgot-password-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95">
            <div class="flex justify-between items-center border-b pb-3 mb-5">
                <h2 class="text-2xl font-bold text-gray-800">Reset Password</h2>
                <button id="closeForgotPasswordModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="forgotPasswordForm">
                <div id="fp-step-1" class="space-y-4">
                    <p class="text-sm text-gray-600">Masukkan alamat email Anda yang terdaftar untuk menerima kode verifikasi (OTP).</p>
                    <div>
                        <label for="fp-email" class="block text-sm font-medium text-gray-700">Alamat Email</label>
                        <input type="email" id="fp-email" name="fp-email" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <button type="button" id="fp-send-otp-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">
                        <span class="btn-text">Kirim Kode OTP</span>
                        <span class="btn-spinner hidden loading-animation">Mengirim</span>
                    </button>
                </div>

                <div id="fp-step-2" class="space-y-4 hidden">
                    <p class="text-sm text-gray-600">Kode OTP telah dikirim. Silakan cek email Anda dan masukkan kode serta password baru Anda.</p>
                    <div>
                        <label for="fp-otp" class="block text-sm font-medium text-gray-700">Kode OTP (6 digit)</label>
                        <input type="text" id="fp-otp" name="fp-otp" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="fp-new-password" class="block text-sm font-medium text-gray-700">Password Baru</label>
                        <div class="relative mt-1">
                            <input type="password" id="fp-new-password" name="fp-new-password" class="w-full p-2 pr-10 border rounded-md" required>
                            <button type="button" data-toggle-password="fp-new-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                            </button>
                        </div>
                    </div>
                    <button type="submit" id="fp-reset-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">
                        <span class="btn-text">Reset Password</span>
                        <span class="btn-spinner hidden loading-animation">Memproses</span>
                    </button>
                </div>
            </form>
            <div id="fp-status-message" class="mt-4 text-center text-sm"></div>
        </div>
    </div>

    <div id="globalStatusMessage"></div>

    <!-- Tambahkan library Chart.js di dalam <head> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Global variable to hold the user's spreadsheet ID and chart instance
        let userSpreadsheetId = null;
        let inactivityTimer;
        let mapelChartInstance = null; // Untuk menyimpan instance grafik
        // [BARU] Tambahkan variabel untuk grafik rata-rata
        let ujianChartInstance = null;
        let raporChartInstance = null;
        let ijazahChartInstance = null;
        let examScoreShareChartInstance = null; // Nama variabel diubah
        let ijazahRankingChartInstance = null; // [BARU]

        // Fungsi ini akan mengatur tahun saat ini pada elemen footer
        function setFooterYear() {
            const currentYear = new Date().getFullYear();
            const yearAuthSpan = document.getElementById('currentYearAuth');
            const yearAppSpan = document.getElementById('currentYearApp');
            if (yearAuthSpan) yearAuthSpan.textContent = currentYear;
            if (yearAppSpan) yearAppSpan.textContent = currentYear;
        }

        document.addEventListener('DOMContentLoaded', function() {
            setFooterYear();

            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const logoutButton = document.getElementById('logoutButton');
            const showSignupBtn = document.getElementById('show-signup');
            const showLoginBtn = document.getElementById('show-login');
            const requestOtpButton = document.getElementById('requestOtpButton'); // Tombol baru

            // Check for existing session on page load
            const storedId = sessionStorage.getItem('userSpreadsheetId');
            const lastPage = sessionStorage.getItem('lastActivePage') || 'dashboard';

            if (storedId) {
                userSpreadsheetId = storedId;
                document.getElementById('auth-wrapper').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                initializeApp(lastPage);
            } else {
                document.getElementById('auth-wrapper').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }

            // --- Event listener untuk Login, Signup, Logout ---
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            // Event listener submit sekarang akan memanggil fungsi handleSignup yang sudah dimodifikasi
            if (signupForm) signupForm.addEventListener('submit', handleSignup);
            // Event listener BARU untuk tombol permintaan OTP
            if (requestOtpButton) requestOtpButton.addEventListener('click', handleRequestOtp);

            if (logoutButton) logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                logoutUser();
            });

            // Event listener untuk beralih antara form login dan signup
            if (showSignupBtn) {
                showSignupBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('login-container').classList.add('hidden');
                    document.getElementById('signup-container').classList.remove('hidden');
                });
            }
            if (showLoginBtn) {
                showLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('signup-container').classList.add('hidden');
                    document.getElementById('login-container').classList.remove('hidden');
                });
            }
            
            setupPasswordToggles();


            // --- Event listener untuk modal ekspor ---
            const exportModal = document.getElementById('export-modal');
            const closeExportModalBtn = document.getElementById('closeExportModalBtn');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const generatePdfBtn = document.getElementById('generatePdfBtn');
            const generateExcelBtn = document.getElementById('generateExcelBtn');

            const closeExportModal = () => {
                if(exportModal) {
                  exportModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                  setTimeout(() => exportModal.classList.add('hidden'), 300);
                }
            };

            if (closeExportModalBtn) closeExportModalBtn.addEventListener('click', closeExportModal);
            if (cancelExportBtn) cancelExportBtn.addEventListener('click', closeExportModal);

            // Handler untuk memicu ekspor
            const handleExport = (event, format) => {
                const rekapType = document.getElementById('exportForm').dataset.rekapType;
                const exportButton = event.currentTarget;

                const exportOptions = {
                    tahunAjaran: document.getElementById('exportTahunAjaran').value,
                    tempatTTD: document.getElementById('exportTempatTTD').value,
                    tanggalTTD: document.getElementById('exportTanggalTTD').value,
                    tipeKamad: document.getElementById('exportTipeKamad').value,
                };

                // Simpan Opsi ke Local Storage
                localStorage.setItem('exportOptions', JSON.stringify(exportOptions));

                const btnText = exportButton.querySelector('.btn-text');
                const spinner = exportButton.querySelector('.btn-spinner');

                exportButton.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');

                google.script.run
                    .withSuccessHandler(result => {
                        if (result && result.base64Data) {
                            const link = document.createElement('a');
                            link.href = `data:${result.mimeType};base64,${result.base64Data}`;
                            link.download = result.fileName;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            showGlobalStatus(`File '${result.fileName}' berhasil diunduh.`, true);
                            closeExportModal();
                        } else {
                            const errorMessage = result ? result.error : 'Terjadi kesalahan tidak diketahui di server.';
                            showGlobalStatus(`Gagal mengekspor: ${errorMessage}`, false);
                        }
                        exportButton.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    })
                    .withFailureHandler(error => {
                        showGlobalStatus(`Error Kritis: ${error.message}. Coba refresh halaman.`, false);
                        exportButton.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    })
                    .exportRekapData(userSpreadsheetId, rekapType, format, exportOptions);
            };

            if (generatePdfBtn) generatePdfBtn.addEventListener('click', (e) => handleExport(e, 'pdf'));
            if (generateExcelBtn) generateExcelBtn.addEventListener('click', (e) => handleExport(e, 'excel'));

            // --- [BARU] Event listener dan fungsi untuk Lupa Password ---
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const forgotPasswordModal = document.getElementById('forgot-password-modal');
            const closeForgotPasswordModalBtn = document.getElementById('closeForgotPasswordModalBtn');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            const fpStep1 = document.getElementById('fp-step-1');
            const fpStep2 = document.getElementById('fp-step-2');
            const fpSendOtpBtn = document.getElementById('fp-send-otp-btn');
            const fpResetBtn = document.getElementById('fp-reset-btn');
            const fpStatusMessage = document.getElementById('fp-status-message');

            const openForgotPasswordModal = () => {
                forgotPasswordModal.classList.remove('hidden');
                setTimeout(() => {
                    forgotPasswordModal.querySelector('.modal-content').style.transform = 'scale(1)';
                }, 10);
            };

            const closeForgotPasswordModal = () => {
                forgotPasswordModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => {
                    forgotPasswordModal.classList.add('hidden');
                    // Reset form ke step 1 saat ditutup
                    fpStep1.classList.remove('hidden');
                    fpStep2.classList.add('hidden');
                    forgotPasswordForm.reset();
                    fpStatusMessage.innerHTML = '';
                }, 300);
            };

            if (forgotPasswordLink) forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                openForgotPasswordModal();
            });

            if (closeForgotPasswordModalBtn) closeForgotPasswordModalBtn.addEventListener('click', closeForgotPasswordModal);

            // Tombol untuk mengirim OTP
            if (fpSendOtpBtn) fpSendOtpBtn.addEventListener('click', function() {
                const email = document.getElementById('fp-email').value;
                if (!email) {
                    fpStatusMessage.textContent = 'Email tidak boleh kosong.';
                    fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    return;
                }
                
                const btn = this;
                const btnText = btn.querySelector('.btn-text');
                const spinner = btn.querySelector('.btn-spinner');

                btn.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');
                fpStatusMessage.innerHTML = '';

                google.script.run
                    .withSuccessHandler(response => {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');

                        if (response.status === 'success') {
                            fpStatusMessage.textContent = response.message;
                            fpStatusMessage.className = 'mt-4 text-center text-sm text-green-600';
                            fpStep1.classList.add('hidden');
                            fpStep2.classList.remove('hidden');
                        } else {
                            fpStatusMessage.textContent = response.message;
                            fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                        }
                    })
                    .withFailureHandler(error => {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                        fpStatusMessage.textContent = 'Error: ' + error.message;
                        fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    })
                    .sendPasswordResetOtp(email);
            });

            // Tombol untuk submit OTP dan password baru
            if (forgotPasswordForm) forgotPasswordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('fp-email').value;
                const otp = document.getElementById('fp-otp').value;
                const newPassword = document.getElementById('fp-new-password').value;

                if (!otp || !newPassword) {
                    fpStatusMessage.textContent = 'OTP dan Password Baru tidak boleh kosong.';
                    fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    return;
                }

                const btn = fpResetBtn;
                const btnText = btn.querySelector('.btn-text');
                const spinner = btn.querySelector('.btn-spinner');

                btn.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');

                google.script.run
                    .withSuccessHandler(response => {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');

                        if (response.status === 'success') {
                            fpStatusMessage.textContent = response.message + ' Anda akan dialihkan ke halaman login.';
                            fpStatusMessage.className = 'mt-4 text-center text-sm text-green-600';
                            setTimeout(() => {
                                closeForgotPasswordModal();
                                const loginInfoMessageDiv = document.getElementById('login-info-message');
                                loginInfoMessageDiv.textContent = "Password berhasil direset. Silakan login dengan password baru Anda.";
                                loginInfoMessageDiv.className = "mb-4 text-center text-sm p-3 bg-green-100 text-green-800 rounded-lg";
                            }, 3000);
                        } else {
                            fpStatusMessage.textContent = response.message;
                            fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                        }
                    })
                    .withFailureHandler(error => {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                        fpStatusMessage.textContent = 'Error: ' + error.message;
                        fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    })
                    .resetPasswordWithOtp(email, otp, newPassword);
            });
        });

        function setupPasswordToggles() {
            document.querySelectorAll('[data-toggle-password]').forEach(button => {
                button.addEventListener('click', () => {
                    const inputId = button.getAttribute('data-toggle-password');
                    const passwordInput = document.getElementById(inputId);
                    if (passwordInput) {
                        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                        passwordInput.setAttribute('type', type);
                        button.querySelector('.eye-icon').classList.toggle('hidden');
                        button.querySelector('.eye-slash-icon').classList.toggle('hidden');
                    }
                });
            });
        }

        function logoutUser() {
            // Hapus semua data sesi
            userSpreadsheetId = null;
            sessionStorage.clear();
            localStorage.removeItem('exportOptions');
            clearTimeout(inactivityTimer);

            // Alihkan tampilan secara manual, tanpa memuat ulang halaman
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('auth-wrapper').classList.remove('hidden');

            // Opsional: Bersihkan form login dan tampilkan pesan logout
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.reset();
            }
            const errorMessageDiv = document.getElementById('login-error-message');
            if (errorMessageDiv) {
                errorMessageDiv.textContent = '';
            }
            const loginInfoMessageDiv = document.getElementById('login-info-message');
            if (loginInfoMessageDiv) {
                loginInfoMessageDiv.textContent = "Anda telah berhasil logout.";
                loginInfoMessageDiv.className = "mb-4 text-center text-sm p-3 bg-blue-100 text-blue-800 rounded-lg";
            }
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(logoutUser, 30 * 60 * 1000); // 30 menit
        }

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            const loginSpinner = document.getElementById('loginSpinner');
            const errorMessageDiv = document.getElementById('login-error-message');

            errorMessageDiv.textContent = '';
            loginButton.disabled = true;
            loginButtonText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');

            google.script.run
                .withSuccessHandler(response => {
                    loginButton.disabled = false;
                    loginButtonText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');

                    if (response && response.status === 'success') {
                        userSpreadsheetId = response.spreadsheetId;
                        sessionStorage.setItem('userSpreadsheetId', userSpreadsheetId);
                        document.getElementById('auth-wrapper').classList.add('hidden');
                        document.getElementById('app-container').classList.remove('hidden');
                        initializeApp('dashboard');
                    } else {
                        errorMessageDiv.textContent = response ? response.message : 'Login gagal karena respons tidak valid.';
                    }
                })
                .withFailureHandler(error => {
                    errorMessageDiv.textContent = 'Terjadi kesalahan: ' + error.message;
                    loginButton.disabled = false;
                    loginButtonText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');
                })
                .checkLogin(email, password);
        }

        function validatePassword(password) {
            const errors = [];

            if (password.length < 8) {
                errors.push("Password minimal harus 8 karakter.");
            }
            if (!/[A-Z]/.test(password)) {
                errors.push("Harus memiliki setidaknya 1 huruf besar (A-Z).");
            }
            if (!/[a-z]/.test(password)) {
                errors.push("Harus memiliki setidaknya 1 huruf kecil (a-z).");
            }
            if (!/[0-9]/.test(password)) {
                errors.push("Harus memiliki setidaknya 1 angka (0-9).");
            }
            // Pengecekan untuk karakter spesial
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(password)) {
                errors.push("Harus memiliki setidaknya 1 karakter spesial (cth: !@#$).");
            }
            
            return errors;
        }
        
        function handleRequestOtp() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const namaSekolah = document.getElementById('signup-namasekolah').value;
            const jenjang = document.getElementById('signup-jenjang').value;

            const requestOtpButton = document.getElementById('requestOtpButton');
            const requestOtpBtnText = document.getElementById('requestOtpButtonText');
            const requestOtpSpinner = document.getElementById('requestOtpSpinner');
            const messageDiv = document.getElementById('signup-message');

            messageDiv.innerHTML = ''; // Bersihkan pesan sebelumnya
            messageDiv.classList.remove('text-red-600', 'text-green-600');

            // Validasi awal (apakah semua field terisi)
            if (!email || !password || !namaSekolah || !jenjang || !confirmPassword) {
                messageDiv.textContent = 'Semua field wajib diisi.';
                messageDiv.classList.add('text-red-600');
                return;
            }

            // Validasi kecocokan kata sandi
            if (password !== confirmPassword) {
                messageDiv.textContent = 'Kata sandi dan konfirmasi kata sandi tidak cocok.';
                messageDiv.classList.add('text-red-600');
                return;
            }

            // BARU: Validasi kekuatan kata sandi
            const passwordErrors = validatePassword(password);
            if (passwordErrors.length > 0) {
                let errorHtml = '<strong class="block text-center">Password belum memenuhi syarat:</strong><ul class="list-disc list-inside text-left mt-1 text-sm">';
                passwordErrors.forEach(error => {
                    errorHtml += `<li>${error}</li>`;
                });
                errorHtml += '</ul>';
                messageDiv.innerHTML = errorHtml;
                messageDiv.classList.add('text-red-600');
                return; // Hentikan proses jika password tidak valid
            }

            // Tampilkan loading
            requestOtpButton.disabled = true;
            requestOtpBtnText.classList.add('hidden');
            requestOtpSpinner.classList.remove('hidden');

            google.script.run
                .withSuccessHandler(response => {
                    requestOtpButton.disabled = false;
                    requestOtpBtnText.classList.remove('hidden');
                    requestOtpSpinner.classList.add('hidden');

                    if (response.status === 'success') {
                        messageDiv.textContent = response.message;
                        messageDiv.classList.add('text-green-600');

                        // Sembunyikan field awal dan tombol minta OTP
                        document.getElementById('initial-fields').querySelectorAll('input, select').forEach(el => el.disabled = true);
                        requestOtpButton.classList.add('hidden');

                        // Tampilkan field OTP dan tombol daftar final
                        document.getElementById('otp-section').classList.remove('hidden');
                        document.getElementById('final-signup-button-container').classList.remove('hidden');

                    } else {
                        messageDiv.textContent = response.message;
                        messageDiv.classList.add('text-red-600');
                    }
                })
                .withFailureHandler(error => {
                    messageDiv.textContent = 'Terjadi kesalahan: ' + error.message;
                    messageDiv.classList.add('text-red-600');
                    requestOtpButton.disabled = false;
                    requestOtpBtnText.classList.remove('hidden');
                    requestOtpSpinner.classList.add('hidden');
                })
                .sendVerificationEmail(email);
        }


        // --- [MODIFIKASI] Fungsi signup sekarang menangani submit final dengan OTP ---
        function handleSignup(event) {
            event.preventDefault(); 
            const namaSekolah = document.getElementById('signup-namasekolah').value;
            const jenjang = document.getElementById('signup-jenjang').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            // [PERBAIKAN] Ambil kode OTP dan hapus spasi di awal/akhir menggunakan .trim()
            const otp = document.getElementById('signup-otp').value.trim(); 

            const signupButton = document.getElementById('signupButton');
            const signupButtonText = document.getElementById('signupButtonText');
            const signupSpinner = document.getElementById('signupSpinner');
            const messageDiv = document.getElementById('signup-message');

            messageDiv.textContent = '';
            messageDiv.classList.remove('text-red-600', 'text-green-600');
            
            if (!otp) {
                messageDiv.textContent = 'Kode OTP wajib diisi.';
                messageDiv.classList.add('text-red-600');
                return;
            }

            signupButton.disabled = true;
            signupButtonText.classList.add('hidden');
            signupSpinner.classList.remove('hidden');

            const userData = {
                email: email,
                password: password,
                namaSekolah: namaSekolah,
                jenjang: jenjang
            };

            // Memanggil fungsi `registerUser` yang sudah dimodifikasi di backend dengan menyertakan OTP
            google.script.run
                .withSuccessHandler(response => {
                    signupButton.disabled = false;
                    signupButtonText.classList.remove('hidden');
                    signupSpinner.classList.add('hidden');
                    
                    if (response && response.status === 'success') {
                        // Reset dan alihkan ke halaman login
                        document.getElementById('signupForm').reset();
                        document.getElementById('initial-fields').querySelectorAll('input, select').forEach(el => el.disabled = false);
                        document.getElementById('requestOtpButton').classList.remove('hidden');
                        document.getElementById('otp-section').classList.add('hidden');
                        document.getElementById('final-signup-button-container').classList.add('hidden');

                        document.getElementById('signup-container').classList.add('hidden');
                        document.getElementById('login-container').classList.remove('hidden');
                        
                        const loginInfoMessageDiv = document.getElementById('login-info-message');
                        loginInfoMessageDiv.textContent = "Pendaftaran berhasil! Silakan masuk dengan akun yang baru Anda buat.";
                        loginInfoMessageDiv.className = "mb-4 text-center text-sm p-3 bg-green-100 text-green-800 rounded-lg";
                    } else {
                        messageDiv.textContent = response ? response.message : 'Gagal mendaftar karena respons tidak valid dari server.';
                        messageDiv.classList.add('text-red-600');
                    }
                })
                .withFailureHandler(error => {
                    messageDiv.textContent = 'Terjadi kesalahan: ' + error.message;
                    messageDiv.classList.add('text-red-600');
                    signupButton.disabled = false;
                    signupButtonText.classList.remove('hidden');
                    signupSpinner.classList.add('hidden');
                })
                .registerUser(userData, otp); // Parameter OTP ditambahkan di sini
        }

        function loadDashboardData() {
            document.getElementById('studentCount').textContent = '...';
            document.getElementById('mapelCount').textContent = '...';

            // Helper function untuk membuat grafik batang horizontal
            const createAverageChart = (canvasId, chartInstance, chartData, chartLabel) => {
                if (chartInstance) {
                    chartInstance.destroy();
                }
                if (!chartData || !chartData.labels || !chartData.data) return null;

                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, {
                    type: 'bar', // Menggunakan grafik batang
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: chartLabel,
                            data: chartData.data,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Membuat grafik menjadi horizontal
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) { if (value % 1 === 0) { return value; } } // Tampilkan hanya integer
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // Sembunyikan legenda karena sudah ada di judul
                            }
                        }
                    }
                });
            };

            google.script.run
                .withSuccessHandler(response => {
                    if (response && response.status === 'success') {
                        // --- Kode untuk kartu statistik (tidak berubah) ---
                        document.getElementById('studentCount').textContent = response.studentCount || 0;
                        document.getElementById('mapelCount').textContent = response.mapelCount || 0;

                        // --- Kode untuk grafik distribusi jenis ujian (tidak berubah) ---
                        let madrasahCount = 0, praktekCount = 0, keduanyaCount = 0;
                        if (response.mapelList && response.mapelList.length > 0) {
                            response.mapelList.forEach(mapel => {
                                if (mapel.jenisUjian === 'Ujian Madrasah') madrasahCount++;
                                else if (mapel.jenisUjian === 'Ujian Praktek') praktekCount++;
                                else if (mapel.jenisUjian === 'Keduanya') keduanyaCount++;
                            });
                        }
                        const ctx = document.getElementById('mapelChart').getContext('2d');
                        if (mapelChartInstance) {
                            mapelChartInstance.destroy();
                        }
                        mapelChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Ujian Madrasah', 'Ujian Praktek', 'Keduanya'],
                                datasets: [{
                                    label: 'Jumlah Mapel',
                                    data: [madrasahCount, praktekCount, keduanyaCount],
                                    backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(249, 115, 22, 0.7)'],
                                    borderColor: ['rgba(59, 130, 246, 1)', 'rgba(16, 185, 129, 1)', 'rgba(249, 115, 22, 1)'],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                                plugins: { legend: { display: false } }
                            }
                        });

                        // --- [BARU] Kode untuk membuat grafik rata-rata nilai ---
                        if (response.subjectAverages) {
                            ujianChartInstance = createAverageChart('ujianAverageChart', ujianChartInstance, response.subjectAverages.ujian, 'Rata-rata Nilai Ujian');
                            raporChartInstance = createAverageChart('raporAverageChart', raporChartInstance, response.subjectAverages.rapor, 'Rata-rata Nilai Rapor');
                            ijazahChartInstance = createAverageChart('ijazahAverageChart', ijazahChartInstance, response.subjectAverages.ijazah, 'Rata-rata Nilai Ijazah');
                        }

                        // --- [DIUBAH] Kode untuk grafik distribusi nilai ujian per siswa (Pie Chart) ---
                        if (response.examScoreShare) {
                            // [BARU] Urutkan data dari skor tertinggi ke terendah sebelum ditampilkan
                            response.examScoreShare.sort((a, b) => b.skor - a.skor);

                            // Ekstrak nama dan skor SETELAH diurutkan, lalu tambahkan nomor peringkat
                            const studentLabels = response.examScoreShare.map((s, index) => `${index + 1}. ${s.nama}`);
                            const studentScores = response.examScoreShare.map(s => s.skor);

                            const ctxPie = document.getElementById('examScoreDistributionChart').getContext('2d');
                            if (examScoreShareChartInstance) {
                                examScoreShareChartInstance.destroy();
                            }
                            examScoreShareChartInstance = new Chart(ctxPie, {
                                type: 'pie',
                                data: {
                                    labels: studentLabels, // Label sudah berisi nomor peringkat
                                    datasets: [{
                                        data: studentScores,
                                        backgroundColor: [
                                            'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)',
                                            'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)',
                                            'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
                                            'rgba(199, 199, 199, 0.7)', 'rgba(83, 109, 254, 0.7)',
                                            'rgba(0, 200, 83, 0.7)', 'rgba(244, 67, 54, 0.7)',
                                            'rgba(156, 39, 176, 0.7)', 'rgba(3, 169, 244, 0.7)'
                                        ],
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'right',
                                            labels: {
                                              boxWidth: 12,
                                              font: {
                                                  size: 10
                                              }
                                            }
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    let label = context.label || '';
                                                    if (label) {
                                                        label += ': ';
                                                    }
                                                    if (context.raw !== null) {
                                                        label += 'Rata-rata ' + context.raw.toFixed(2);
                                                    }
                                                    return label;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }

                        // --- [DIUBAH] Kode untuk grafik peringkat siswa berdasarkan nilai rata-rata ijazah (Bar Chart) ---
                        if (response.ijazahRanking) {
                            // [PERBAIKAN] Ubah dari pembulatan menjadi format 2 angka di belakang koma
                            const peringkatData = response.ijazahRanking.map(item => parseFloat(item.nilai.toFixed(2)));
                            const namaSiswa = response.ijazahRanking.map(item => item.nama);
                            
                            const ctxRanking = document.getElementById('ijazahRankingChart').getContext('2d');
                            if (ijazahRankingChartInstance) {
                                ijazahRankingChartInstance.destroy();
                            }
                            ijazahRankingChartInstance = new Chart(ctxRanking, {
                                type: 'bar',
                                data: {
                                    labels: namaSiswa,
                                    datasets: [{
                                        label: 'Rata-rata Nilai Ijazah',
                                        data: peringkatData, // Data sekarang dalam format 2 angka di belakang koma
                                        backgroundColor: 'rgba(255, 159, 64, 0.7)',
                                        borderColor: 'rgba(255, 159, 64, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    indexAxis: 'y',
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: {
                                            beginAtZero: true
                                            // [PERBAIKAN] Hapus callback ticks agar sumbu-X bisa menampilkan desimal jika perlu
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    }
                                }
                            });
                        }
                    } else {
                        showGlobalStatus(response ? response.message : 'Gagal memuat data dashboard.', false);
                    }
                })
                .withFailureHandler(error => {
                    showGlobalStatus(`Gagal memuat dashboard: ${error.message}`, false);
                })
                .getDashboardData(userSpreadsheetId);
        }

        function initializeApp(lastPage = 'dashboard') {
            if (!userSpreadsheetId) {
                alert("Error: Sesi tidak valid. Silakan login ulang.");
                logoutUser();
                return;
            }

            resetInactivityTimer();
            document.onmousemove = resetInactivityTimer;
            document.onmousedown = resetInactivityTimer;
            document.ontouchstart = resetInactivityTimer;
            document.onclick = resetInactivityTimer;
            document.onkeydown = resetInactivityTimer;
            document.addEventListener('scroll', resetInactivityTimer, true);

            let rekapitulasiData = null;
            const navLinks = document.querySelectorAll('.nav-link');
            const contentPages = document.querySelectorAll('.content-page');

            loadSchoolData();

            navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    if (e.currentTarget.id === 'logoutButton') return;

                    const targetPageId = e.currentTarget.dataset.page;
                    sessionStorage.setItem('lastActivePage', targetPageId);
                    contentPages.forEach(p => p.classList.add('hidden'));
                    document.getElementById('page-' + targetPageId)?.classList.remove('hidden');
                    navLinks.forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');

                    if (targetPageId === 'dashboard') loadDashboardData();
                    if (targetPageId === 'data-siswa') loadStudentsData();
                    if (targetPageId === 'mapel') { loadMapelData(); loadBobotData(); }
                    if (targetPageId === 'input-ujian') document.getElementById('input-ujian-container').innerHTML = '';
                    if (targetPageId === 'input-rapor') initRaporPage();
                    if (targetPageId === 'rekapitulasi') initRekapitulasiPage();
                });
            });
            
            document.getElementById('student-card')?.addEventListener('click', () => {
                document.querySelector('.nav-link[data-page="data-siswa"]').click();
            });
            document.getElementById('mapel-card')?.addEventListener('click', () => {
                document.querySelector('.nav-link[data-page="mapel"]').click();
            });

            const lastActiveLink = document.querySelector(`.nav-link[data-page="${lastPage}"]`);
            if (lastActiveLink) {
                lastActiveLink.click();
            } else {
                document.querySelector('.nav-link[data-page="dashboard"]').click();
            }

            function loadSchoolData() {
                google.script.run
                    .withSuccessHandler(data => {
                        if (data) {
                            const schoolNameSidebar = document.getElementById('school-name-sidebar');
                            if (data.namaSekolah) schoolNameSidebar.textContent = data.namaSekolah.toUpperCase();
                            for (const key in data) {
                                const element = document.getElementById(key === 'email' ? 'email-sekolah' : key);
                                if (element) element.value = data[key] || '';
                            }
                        }
                    })
                    .getSchoolData(userSpreadsheetId);
            }

            document.getElementById('schoolDataForm')?.addEventListener('submit', function(event) {
                event.preventDefault();
                const btn = this.querySelector('button[type="submit"]');
                const btnText = btn.querySelector('#schoolSubmitBtnText');
                const btnSpinner = btn.querySelector('#schoolLoadingSpinner');

                btn.disabled = true;
                btnText.classList.add('hidden');
                btnSpinner.classList.remove('hidden');

                const dataObj = Object.fromEntries(new FormData(this).entries());
                dataObj.jenjang = document.getElementById('jenjang').value;
                dataObj.namaSekolah = document.getElementById('namaSekolah').value;

                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        btnSpinner.classList.add('hidden');
                        if (response.status === 'success') loadSchoolData();
                    })
                    .withFailureHandler(error => {
                        showGlobalStatus('Error: ' + error.message, false);
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        btnSpinner.classList.add('hidden');
                    })
                    .saveSchoolData(userSpreadsheetId, dataObj);
            });

            // --- DATA SISWA FUNCTIONS ---
            const addStudentBtn = document.getElementById('addStudentBtn');
            const siswaModal = document.getElementById('siswa-modal');
            const closeSiswaModalBtn = document.getElementById('closeSiswaModalBtn');
            const cancelSiswaBtn = document.getElementById('cancelSiswaBtn');
            const siswaForm = document.getElementById('siswaForm');
            const siswaModalTitle = document.getElementById('siswa-modal-title');
            const studentRowInput = document.getElementById('studentRow');
            const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
            const importSiswaBtn = document.getElementById('importSiswaBtn');
            const siswaFileInput = document.getElementById('siswaFileInput');
            const fileNameSpan = document.getElementById('fileName');
            const importStatusDiv = document.getElementById('importStatus');
            const deleteAllStudentsBtn = document.getElementById('deleteAllStudentsBtn');

            const openSiswaModal = () => {
                siswaModal.classList.remove('hidden');
                setTimeout(() => {
                    siswaModal.querySelector('.modal-content').style.transform = 'scale(1)';
                }, 10);
            };
            const closeSiswaModal = () => {
                siswaModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => siswaModal.classList.add('hidden'), 300);
            };
            if (addStudentBtn) {
                addStudentBtn.addEventListener('click', () => {
                    siswaForm.reset();
                    studentRowInput.value = '';
                    siswaModalTitle.textContent = "Tambah Siswa Baru";
                    openSiswaModal();
                });
                closeSiswaModalBtn.addEventListener('click', closeSiswaModal);
                cancelSiswaBtn.addEventListener('click', closeSiswaModal);
            }
            if (deleteAllStudentsBtn) {
                deleteAllStudentsBtn.addEventListener('click', function() {
                    const btn = this;
                    if (btn.dataset.confirming) {
                        btn.disabled = true;
                        btn.textContent = 'Menghapus...';
                        google.script.run
                            .withSuccessHandler(response => {
                                showGlobalStatus(response.message, response.status === 'success');
                                if (response.status === 'success') {
                                    loadStudentsData();
                                }
                                btn.disabled = false;
                                btn.textContent = 'Hapus Semua Siswa';
                                delete btn.dataset.confirming;
                            })
                            .withFailureHandler(err => {
                                showGlobalStatus('Error: ' + err.message, false);
                                btn.disabled = false;
                                btn.textContent = 'Hapus Semua Siswa';
                                delete btn.dataset.confirming;
                            })
                            .deleteAllStudents(userSpreadsheetId);
                    } else {
                        btn.dataset.confirming = 'true';
                        btn.textContent = 'YAKIN? KLIK LAGI UNTUK HAPUS';
                        btn.classList.replace('bg-red-600', 'bg-yellow-500');
                        btn.classList.replace('hover:bg-red-700', 'hover:bg-yellow-600');

                        setTimeout(() => {
                            if (btn.dataset.confirming) {
                                btn.textContent = 'Hapus Semua Siswa';
                                delete btn.dataset.confirming;
                                btn.classList.replace('bg-yellow-500', 'bg-red-600');
                                btn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
                            }
                        }, 4000);
                    }
                });
            }
            if (downloadTemplateBtn) {
                downloadTemplateBtn.addEventListener('click', () => {
                    const btn = downloadTemplateBtn;
                    btn.disabled = true;
                    btn.textContent = 'Membuat Template...';
                    google.script.run
                        .withSuccessHandler(result => {
                            btn.disabled = false;
                            btn.textContent = 'Download Template';
                            if (result.base64Data) {
                                const link = document.createElement('a');
                                link.href = `data:${result.mimeType};base64,${result.base64Data}`;
                                link.download = result.fileName;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                showGlobalStatus('Template berhasil diunduh.', true);
                            } else {
                                showGlobalStatus('Gagal membuat template: ' + (result.error || 'Unknown error'), false);
                            }
                        })
                        .withFailureHandler(error => {
                            showGlobalStatus('Error: ' + error.message, false);
                            btn.disabled = false;
                            btn.textContent = 'Download Template';
                        })
                        .generateSiswaTemplate();
                });
            }
            if (siswaFileInput) {
                siswaFileInput.addEventListener('change', () => {
                    const file = siswaFileInput.files[0];
                    if (file) {
                        fileNameSpan.textContent = file.name;
                        importSiswaBtn.disabled = false;
                    } else {
                        fileNameSpan.textContent = 'Tidak ada file dipilih';
                        importSiswaBtn.disabled = true;
                    }
                });
            }
            if (importSiswaBtn) {
                importSiswaBtn.addEventListener('click', () => {
                    const file = siswaFileInput.files[0];
                    if (!file) {
                        showGlobalStatus('Silakan pilih file untuk diimpor.', false);
                        return;
                    }
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        const fileData = {
                            fileName: file.name,
                            mimeType: file.type,
                            content: reader.result.split(',')[1]
                        };
                        importStatusDiv.innerHTML = '<p class="text-blue-600 loading-animation">Mengimpor data</p>';
                        importSiswaBtn.disabled = true;
                        importSiswaBtn.textContent = 'Mengimpor...';
                        google.script.run
                            .withSuccessHandler(response => {
                                importSiswaBtn.disabled = false;
                                importSiswaBtn.textContent = 'Import Data';
                                fileNameSpan.textContent = 'Tidak ada file dipilih';
                                siswaFileInput.value = '';

                                // Tampilkan notifikasi pop-up
                                if (response.status === 'partial' || response.status === 'success') {
                                    let successMsg = `<strong>Proses impor siswa selesai.</strong>`;
                                    if(response.newCount > 0) {
                                        successMsg += `<br>${response.newCount} siswa baru berhasil ditambahkan.`
                                    }
                                    showGlobalStatus(successMsg, true);
                                }

                                // Tetap tampilkan laporan detail di bawah tombol
                                let reportHtml = `<div class="p-4 border rounded-md bg-gray-50"><strong>${response.message}</strong><ul>`;
                                if (response.newCount > 0) reportHtml += `<li class="text-green-600">${response.newCount} siswa baru berhasil ditambahkan.</li>`;
                                if (response.skippedCount > 0) reportHtml += `<li class="text-yellow-600">${response.skippedCount} data duplikat dilewati.</li>`;
                                if (response.conflictCount > 0) {
                                    reportHtml += `<li class="text-red-600">${response.conflictCount} data konflik (NISN sudah ada dengan nama berbeda):</li>`;
                                    reportHtml += `<ul class="list-disc ml-6 text-sm">`;
                                    response.conflicts.forEach(c => {
                                        reportHtml += `<li>NISN <span class="math-inline">\{c\.nisn\} \(</span>{c.nama} di file) - ${c.reason}</li>`;
                                    });
                                    reportHtml += `</ul>`;
                                }
                                reportHtml += `</ul></div>`;
                                importStatusDiv.innerHTML = reportHtml;

                                // BARU: Sembunyikan laporan detail setelah 10 detik
                                setTimeout(() => {
                                    importStatusDiv.innerHTML = '';
                                }, 10000);

                                if (response.newCount > 0) {
                                    loadStudentsData();
                                }
                            })
                            .withFailureHandler(error => {
                                showGlobalStatus('Error: ' + error.message, false);
                                importSiswaBtn.disabled = false;
                                importSiswaBtn.textContent = 'Import Data';
                                fileNameSpan.textContent = 'Tidak ada file dipilih';
                                siswaFileInput.value = '';
                                importStatusDiv.innerHTML = `<p class="text-red-600">${error.message}</p>`;
                            })
                            .importFromExcel(userSpreadsheetId, fileData, 'Data Siswa');
                    };
                    reader.onerror = (error) => {
                        showGlobalStatus('Gagal membaca file.', false);
                    };
                });
            }

            function loadStudentsData() {
                const container = document.getElementById('siswaTableContainer');
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Memuat data siswa...</p>`;
                google.script.run
                    .withSuccessHandler(students => {
                        if (students && students.length > 0) {
                            const table = document.createElement('table');
                            table.className = 'min-w-full divide-y divide-gray-200';
                            table.innerHTML = `<thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TEMPAT, TANGGAL LAHIR</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody class="bg-white divide-y divide-gray-200"></tbody>`;
                            const tbody = table.querySelector('tbody');
                            students.forEach(s => {
                                const tr = document.createElement('tr');
                                const formattedDate = formatIndonesianDate(s.tanggalLahir);
                                const ttl = s.tempatLahir && formattedDate ? `${s.tempatLahir}, ${formattedDate}` : (s.tempatLahir || formattedDate || '');
                                tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${s.nisn}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 nama-siswa-cell">${s.nama.toUpperCase()}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ttl}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="text-indigo-600 hover:text-indigo-900" data-action="edit">Edit</button><button class="text-red-600 hover:text-red-900 ml-4" data-action="delete">Hapus</button></td>`;
                                tr.querySelector('[data-action="edit"]').addEventListener('click', () => handleEditStudent(s));
                                tr.querySelector('[data-action="delete"]').addEventListener('click', (e) => handleDeleteStudent(s, e.target));
                                tbody.appendChild(tr);
                            });
                            container.innerHTML = '';
                            container.appendChild(table);
                        } else {
                            container.innerHTML = `<p class="text-center text-gray-500 py-4">Belum ada data siswa. Silakan tambahkan siswa baru.</p>`;
                        }
                    })
                    .withFailureHandler(err => {
                        container.innerHTML = `<p class="text-center text-red-500 py-4">Gagal memuat data: ${err.message}</p>`;
                    })
                    .getStudents(userSpreadsheetId);
            }

            if (siswaForm) {
                siswaForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const saveBtn = document.getElementById('saveSiswaBtn');
                    const originalBtnText = saveBtn.textContent;

                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Menyimpan';
                    saveBtn.classList.add('loading-animation');

                    const studentData = Object.fromEntries(new FormData(e.target).entries());
                    const handler = studentData.studentRow ? 'updateStudent' : 'addStudent';

                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.status === 'success') {
                                closeSiswaModal();
                                loadStudentsData();
                            }
                            saveBtn.disabled = false;
                            saveBtn.textContent = originalBtnText;
                            saveBtn.classList.remove('loading-animation');
                        })
                        .withFailureHandler(error => {
                            showGlobalStatus(error.message, false);
                            saveBtn.disabled = false;
                            saveBtn.textContent = originalBtnText;
                            saveBtn.classList.remove('loading-animation');
                        })[handler](userSpreadsheetId, studentData);
                });
            }

            function handleEditStudent(student) {
                siswaForm.reset();
                siswaModalTitle.textContent = "Edit Data Siswa";
                studentRowInput.value = student.row;
                document.getElementById('nama').value = student.nama;
                document.getElementById('nisn').value = student.nisn;
                document.getElementById('nis').value = student.nis;
                document.getElementById('tempatLahir').value = student.tempatLahir;
                document.getElementById('tanggalLahir').value = student.tanggalLahir; // Simplified
                openSiswaModal();
            }

            function handleDeleteStudent(student, targetButton) {
                if (targetButton.dataset.confirming) {
                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.status === 'success') loadStudentsData();
                        })
                        .withFailureHandler(err => showGlobalStatus(err.message, false))
                        .deleteStudent(userSpreadsheetId, student.row);
                } else {
                    targetButton.textContent = 'Yakin?';
                    targetButton.dataset.confirming = true;
                    targetButton.classList.add('text-yellow-500', 'hover:text-yellow-700');
                    targetButton.classList.remove('text-red-600', 'hover:text-red-900');
                    setTimeout(() => {
                        if (targetButton.dataset.confirming) {
                            targetButton.textContent = 'Hapus';
                            delete targetButton.dataset.confirming;
                            targetButton.classList.remove('text-yellow-500', 'hover:text-yellow-700');
                            targetButton.classList.add('text-red-600', 'hover:text-red-900');
                        }
                    }, 3000);
                }
            }

            // --- MAPEL & BOBOT FUNCTIONS ---
            const bobotUjianInput = document.getElementById('bobotUjian');
            const bobotRaporInput = document.getElementById('bobotRapor');
            const bobotForm = document.getElementById('bobotForm');

            function syncBobot(source, target) {
                source.addEventListener('input', () => {
                    const sourceVal = parseInt(source.value, 10);
                    if (!isNaN(sourceVal) && sourceVal >= 0 && sourceVal <= 100) target.value = 100 - sourceVal;
                    else if (source.value === '') target.value = '';
                    else if (sourceVal > 100) {
                        source.value = 100;
                        target.value = 0;
                    }
                });
            }
            if (bobotUjianInput && bobotRaporInput) {
                syncBobot(bobotUjianInput, bobotRaporInput);
                syncBobot(bobotRaporInput, bobotUjianInput);
            }
            if (bobotForm) {
                bobotForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const saveBtn = e.currentTarget.querySelector('button[type="submit"]');
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Menyimpan...';
                    const bobotData = {
                        bobotUjian: bobotUjianInput.value,
                        bobotRapor: bobotRaporInput.value
                    };
                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            saveBtn.disabled = false;
                            saveBtn.textContent = 'Simpan Bobot';
                        })
                        .withFailureHandler(err => {
                            showGlobalStatus('Gagal menyimpan bobot: ' + err.message, false);
                            saveBtn.disabled = false;
                            saveBtn.textContent = 'Simpan Bobot';
                        })
                        .saveBobot(userSpreadsheetId, bobotData);
                });
            }

            function loadBobotData() {
                google.script.run
                    .withSuccessHandler(data => {
                        if (data) {
                            bobotUjianInput.value = data.bobotUjian || '';
                            bobotRaporInput.value = data.bobotRapor || '';
                        }
                    })
                    .getBobot(userSpreadsheetId);
            }

            const addMapelBtn = document.getElementById('addMapelBtn');
            const mapelModal = document.getElementById('mapel-modal');
            const closeMapelModalBtn = document.getElementById('closeMapelModalBtn');
            const cancelMapelBtn = document.getElementById('cancelMapelBtn');
            const mapelForm = document.getElementById('mapelForm');
            const mapelModalTitle = document.getElementById('mapel-modal-title');
            const mapelRowInput = document.getElementById('mapelRow');
            const downloadMapelTemplateBtn = document.getElementById('downloadMapelTemplateBtn');
            const importMapelBtn = document.getElementById('importMapelBtn');
            const mapelFileInput = document.getElementById('mapelFileInput');
            const mapelFileNameSpan = document.getElementById('mapelFileName');
            const importMapelStatusDiv = document.getElementById('importMapelStatus');
            const importMapelSystemBtn = document.getElementById('importMapelSystemBtn');
            const deleteAllMapelBtn = document.getElementById('deleteAllMapelBtn');

            const openMapelModal = () => {
                mapelModal.classList.remove('hidden');
                setTimeout(() => mapelModal.style.opacity = '1', 10);
            };
            const closeMapelModal = () => {
                mapelModal.style.opacity = '0';
                setTimeout(() => mapelModal.classList.add('hidden'), 300);
            };
            if (addMapelBtn) {
                addMapelBtn.addEventListener('click', () => {
                    mapelForm.reset();
                    mapelRowInput.value = '';
                    mapelModalTitle.textContent = "Tambah Mata Pelajaran";
                    openMapelModal();
                });
                closeMapelModalBtn.addEventListener('click', closeMapelModal);
                cancelMapelBtn.addEventListener('click', closeMapelModal);
            }
            if (deleteAllMapelBtn) {
                deleteAllMapelBtn.addEventListener('click', function() {
                    const btn = this;
                    if (btn.dataset.confirming) {
                        btn.disabled = true;
                        btn.textContent = 'Menghapus...';
                        google.script.run
                            .withSuccessHandler(response => {
                                showGlobalStatus(response.message, response.status === 'success');
                                if (response.status === 'success') {
                                    loadMapelData();
                                }
                                btn.disabled = false;
                                btn.textContent = 'Hapus Semua Mapel';
                                delete btn.dataset.confirming;
                            })
                            .withFailureHandler(err => {
                                showGlobalStatus('Error: ' + err.message, false);
                                btn.disabled = false;
                                btn.textContent = 'Hapus Semua Mapel';
                                delete btn.dataset.confirming;
                            })
                            .deleteAllMapel(userSpreadsheetId);
                    } else {
                        btn.dataset.confirming = 'true';
                        btn.textContent = 'YAKIN? KLIK LAGI';
                        btn.classList.replace('bg-red-600', 'bg-yellow-500');
                        btn.classList.replace('hover:bg-red-700', 'hover:bg-yellow-600');

                        setTimeout(() => {
                            if (btn.dataset.confirming) {
                                btn.textContent = 'Hapus Semua Mapel';
                                delete btn.dataset.confirming;
                                btn.classList.replace('bg-yellow-500', 'bg-red-600');
                                btn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
                            }
                        }, 4000);
                    }
                });
            }
            if (importMapelSystemBtn) {
                importMapelSystemBtn.addEventListener('click', function() {
                    const btn = this;
                    const btnText = document.getElementById('importMapelSystemBtnText');
                    const spinner = document.getElementById('importMapelSystemSpinner');

                    btn.disabled = true;
                    btnText.classList.add('hidden');
                    spinner.classList.remove('hidden');

                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.newCount > 0 || response.status === 'success') {
                                loadMapelData();
                            }
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .withFailureHandler(err => {
                            showGlobalStatus('Error: ' + err.message, false);
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .importMapelBySystem(userSpreadsheetId);
                });
            }

            if (downloadMapelTemplateBtn) {
                downloadMapelTemplateBtn.addEventListener('click', () => {
                    const btn = downloadMapelTemplateBtn;
                    btn.disabled = true;
                    btn.textContent = 'Membuat...';
                    google.script.run
                        .withSuccessHandler(result => {
                            btn.disabled = false;
                            btn.textContent = 'Download Template';
                            if (result.base64Data) {
                                const link = document.createElement('a');
                                link.href = `data:${result.mimeType};base64,${result.base64Data}`;
                                link.download = result.fileName;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                showGlobalStatus('Template Mapel berhasil diunduh.', true);
                            } else {
                                showGlobalStatus('Gagal membuat template: ' + (result.error || 'Unknown error'), false);
                            }
                        })
                        .withFailureHandler(error => {
                            showGlobalStatus('Error: ' + error.message, false);
                            btn.disabled = false;
                            btn.textContent = 'Download Template';
                        })
                        .generateMapelTemplate();
                });
            }
            if (mapelFileInput) {
                mapelFileInput.addEventListener('change', () => {
                    const file = mapelFileInput.files[0];
                    if (file) {
                        mapelFileNameSpan.textContent = file.name;
                        importMapelBtn.disabled = false;
                    } else {
                        mapelFileNameSpan.textContent = 'Tidak ada file dipilih';
                        importMapelBtn.disabled = true;
                    }
                });
            }
            if (importMapelBtn) {
                importMapelBtn.addEventListener('click', () => {
                    const file = mapelFileInput.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        const fileData = {
                            fileName: file.name,
                            mimeType: file.type,
                            content: reader.result.split(',')[1]
                        };
                        importMapelStatusDiv.innerHTML = '<p class="text-blue-600 loading-animation">Mengimpor file</p>';
                        importMapelBtn.disabled = true;
                        importMapelBtn.textContent = 'Mengimpor...';
                        google.script.run
                            .withSuccessHandler(response => {
                                importMapelBtn.disabled = false;
                                importMapelBtn.textContent = 'Import dari File';
                                mapelFileNameSpan.textContent = 'Tidak ada file dipilih';
                                mapelFileInput.value = '';

                                // Tampilkan notifikasi pop-up
                                if (response.status === 'success') {
                                    let mainMessage = response.message.split('.')[0] + '.';
                                    let successMsg = `<strong>${mainMessage}</strong>`;
                                    if(response.newCount > 0) {
                                        successMsg += `<br>${response.newCount} mapel baru berhasil ditambahkan.`
                                    }
                                    showGlobalStatus(successMsg, true);
                                }

                                // Tetap tampilkan laporan detail di bawah tombol
                                let reportHtml = `<div class="p-3 border rounded-md bg-gray-50 text-sm"><strong>${response.message}</strong><ul>`;
                                if (response.newCount > 0) reportHtml += `<li class="text-green-600">${response.newCount} mapel baru berhasil ditambahkan.</li>`;
                                if (response.skippedCount > 0) reportHtml += `<li class="text-yellow-600">${response.skippedCount} mapel duplikat dilewati.</li>`;
                                reportHtml += `</ul></div>`;
                                importMapelStatusDiv.innerHTML = reportHtml;

                                // BARU: Sembunyikan laporan detail setelah 10 detik
                                setTimeout(() => {
                                    importMapelStatusDiv.innerHTML = '';
                                }, 10000);

                                if (response.newCount > 0) loadMapelData();
                            })
                            .withFailureHandler(error => {
                                importMapelStatusDiv.innerHTML = `<p class="text-red-600">${error.message}</p>`;
                                importMapelBtn.disabled = false;
                                importMapelBtn.textContent = 'Import dari File';
                            })
                            .importFromExcel(userSpreadsheetId, fileData, 'Data Mata Pelajaran');
                    };
                    reader.onerror = () => showGlobalStatus('Gagal membaca file.', false);
                });
            }

            function loadMapelData() {
                const container = document.getElementById('mapelTableContainer');
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Memuat data mapel...</p>`;
                google.script.run
                    .withSuccessHandler(mapelList => {
                        if (mapelList && mapelList.length > 0) {
                            const table = document.createElement('table');
                            table.className = 'min-w-full divide-y divide-gray-200';
                            table.innerHTML = `<thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Mata Pelajaran</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Ujian</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody class="bg-white divide-y divide-gray-200"></tbody>`;
                            const tbody = table.querySelector('tbody');
                            mapelList.forEach(m => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${m.kode}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 nama-siswa-cell">${m.nama}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${m.jenisUjian}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="text-indigo-600 hover:text-indigo-900" data-action="edit">Edit</button><button class="text-red-600 hover:text-red-900 ml-4" data-action="delete">Hapus</button></td>`;
                                tr.querySelector('[data-action="edit"]').addEventListener('click', () => handleEditMapel(m));
                                tr.querySelector('[data-action="delete"]').addEventListener('click', (e) => handleDeleteMapel(m, e.target));
                                tbody.appendChild(tr);
                            });
                            container.innerHTML = '';
                            container.appendChild(table);
                        } else {
                            container.innerHTML = `<p class="text-center text-gray-500 py-4">Belum ada data mata pelajaran.</p>`;
                        }
                    })
                    .withFailureHandler(err => {
                        container.innerHTML = `<p class="text-center text-red-500 py-4">Gagal memuat data: ${err.message}</p>`;
                    })
                    .getMapel(userSpreadsheetId);
            }

            if (mapelForm) {
                mapelForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const saveBtn = document.getElementById('saveMapelBtn');
                    const originalBtnText = saveBtn.textContent;

                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Menyimpan';
                    saveBtn.classList.add('loading-animation');

                    const mapelData = Object.fromEntries(new FormData(e.target).entries());
                    const handler = mapelData.mapelRow ? 'updateMapel' : 'addMapel';

                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.status === 'success') {
                                closeMapelModal();
                                loadMapelData();
                            }
                            saveBtn.disabled = false;
                            saveBtn.textContent = originalBtnText;
                            saveBtn.classList.remove('loading-animation');
                        })
                        .withFailureHandler(error => {
                            showGlobalStatus(error.message, false);
                            saveBtn.disabled = false;
                            saveBtn.textContent = originalBtnText;
                            saveBtn.classList.remove('loading-animation');
                        })[handler](userSpreadsheetId, mapelData);
                });
            }

            function handleEditMapel(mapel) {
                mapelForm.reset();
                mapelModalTitle.textContent = "Edit Mata Pelajaran";
                mapelRowInput.value = mapel.row;
                document.getElementById('kode').value = mapel.kode;
                document.getElementById('namaMapel').value = mapel.nama;
                document.getElementById('kelompok').value = mapel.kelompok;
                if (mapel.jenisUjian) {
                    const radioBtn = document.querySelector(`input[name="jenisUjian"][value="${mapel.jenisUjian}"]`);
                    if (radioBtn) radioBtn.checked = true;
                }
                openMapelModal();
            }

            function handleDeleteMapel(mapel, targetButton) {
                if (targetButton.dataset.confirming) {
                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.status === 'success') loadMapelData();
                        })
                        .withFailureHandler(err => showGlobalStatus(err.message, false))
                        .deleteMapel(userSpreadsheetId, mapel.row);
                } else {
                    targetButton.textContent = 'Yakin?';
                    targetButton.dataset.confirming = true;
                    targetButton.classList.add('text-yellow-500', 'hover:text-yellow-700');
                    targetButton.classList.remove('text-red-600', 'hover:text-red-900');
                    setTimeout(() => {
                        if (targetButton.dataset.confirming) {
                            targetButton.textContent = 'Hapus';
                            delete targetButton.dataset.confirming;
                            targetButton.classList.remove('text-yellow-500', 'hover:text-yellow-700');
                            targetButton.classList.add('text-red-600', 'hover:text-red-900');
                        }
                    }, 3000);
                }
            }

            // --- INPUT NILAI FUNCTIONS ---
            document.getElementById('btn-show-ujian-madrasah').addEventListener('click', () => buildScoreTable('madrasah', 'Tabel Input Nilai Ujian Madrasah'));
            document.getElementById('btn-show-ujian-praktek').addEventListener('click', () => buildScoreTable('praktek', 'Tabel Input Nilai Ujian Praktek'));
            document.getElementById('btn-cek-rata-ujian').addEventListener('click', calculateUjianAverage);

            function buildScoreTable(jenis, title) {
                const container = document.getElementById('input-ujian-container');
                container.innerHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-4">${title}</h2><div class="text-center p-8"><p class="font-bold loading-animation">Memuat data</p><p>Silakan tunggu sebentar.</p></div>`;
                const sheetName = jenis === 'madrasah' ? 'Nilai Ujian Madrasah' : 'Nilai Ujian Praktek';
                Promise.all([
                    new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getStudents(userSpreadsheetId)),
                    new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getMapelByJenis(userSpreadsheetId, jenis)),
                    new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, sheetName))
                ]).then(([students, mapelList, existingScores]) => {
                    const contentDiv = container.querySelector('div');
                    if (!students || students.length === 0) {
                        contentDiv.innerHTML = `<p class="text-center text-red-500 p-4">Data siswa tidak ditemukan. Harap isi data siswa terlebih dahulu.</p>`;
                        return;
                    }
                    if (!mapelList || mapelList.length === 0) {
                        contentDiv.innerHTML = `<p class="text-center text-red-500 p-4">Tidak ada mata pelajaran yang ditandai untuk Ujian ${jenis}. Silahkan edit dan ubah Jenis Ujian pada Mata Pelajaran.</p>`;
                        return;
                    }

                    const tableWrapper = document.createElement('div');
                    tableWrapper.className = 'bg-white p-4 rounded-lg shadow-md';
                    const tableHtml = `<form id="form-nilai-${jenis}"><div class="overflow-x-auto"><table id="score-table-${jenis}" class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>${mapelList.map(m => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-Rata</th></tr></thead><tbody class="bg-white divide-y divide-gray-200"></tbody></table></div><div class="mt-6 pt-4 border-t flex justify-end space-x-3"><button type="button" class="clear-scores-btn bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Bersihkan</button><button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Simpan Nilai ${jenis}</button></div></form>`;
                    tableWrapper.innerHTML = tableHtml;
                    const tbody = tableWrapper.querySelector('tbody');
                    students.forEach((s, index) => {
                        const studentScores = existingScores[s.nisn] || {};
                        let rowHtml = `<tr data-nisn="${s.nisn}" data-nama="${s.nama.toUpperCase()}"><td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${index + 1}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${s.nisn}</td><td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 nama-siswa-cell">${s.nama.toUpperCase()}</td>`;
                        mapelList.forEach(m => {
                            rowHtml += `<td class="px-2 py-1"><input type="number" min="0" max="100" class="score-input p-1 border rounded-md" data-mapel-kode="${m.kode}" value="${studentScores[m.kode] ?? ''}"></td>`;
                        });
                        rowHtml += `<td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell jumlah-nilai">0</td><td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell rata-rata-nilai">0.00</td></tr>`;
                        tbody.innerHTML += rowHtml;
                    });
                    contentDiv.innerHTML = '';
                    contentDiv.appendChild(tableWrapper);
                    const scoreTable = document.getElementById(`score-table-${jenis}`);
                    scoreTable.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
                    scoreTable.addEventListener('input', handleScoreInput);
                    scoreTable.addEventListener('paste', handleSmartPaste);
                    document.getElementById(`form-nilai-${jenis}`).addEventListener('submit', (e) => handleSaveNilai(e, jenis));
                    tableWrapper.querySelector('.clear-scores-btn').addEventListener('click', (e) => {
                        const form = e.target.closest('form');
                        form.querySelectorAll('.score-input').forEach(input => input.value = '');
                        form.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
                    });
                }).catch(err => {
                    container.innerHTML = `<p class="text-center text-red-500 p-4">Terjadi kesalahan saat memuat data: ${err.message}</p>`;
                });
            }

            function handleSaveNilai(event, jenisUjian) {
                event.preventDefault();
                const form = event.target;
                const saveBtn = form.querySelector('button[type="submit"]');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Menyimpan...';
                const allRows = form.querySelectorAll('tbody tr');
                const nilaiData = [];
                allRows.forEach(row => {
                    const studentScores = {
                        nisn: row.dataset.nisn,
                        nama: row.dataset.nama,
                        scores: {}
                    };
                    const inputs = row.querySelectorAll('.score-input');
                    inputs.forEach(input => {
                        studentScores.scores[input.dataset.mapelKode] = input.value;
                    });
                    nilaiData.push(studentScores);
                });
                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        saveBtn.disabled = false;
                        saveBtn.textContent = `Simpan Nilai ${jenisUjian}`;
                    })
                    .withFailureHandler(err => {
                        showGlobalStatus(`Gagal menyimpan: ${err.message}`, false);
                        saveBtn.disabled = false;
                        saveBtn.textContent = `Simpan Nilai ${jenisUjian}`;
                    })
                    .saveNilai(userSpreadsheetId, {
                        jenis: jenisUjian,
                        nilai: nilaiData
                    });
            }

            function initRaporPage() {
                const container = document.getElementById('rapor-container');
                container.innerHTML = '<p>Memeriksa data sekolah...</p>';
                google.script.run
                    .withSuccessHandler(schoolData => {
                        if (!schoolData || !schoolData.jenjang) {
                            container.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">Harap atur <b>Jenjang Sekolah</b> di halaman <a href="#" onclick="document.querySelector('[data-page=data-sekolah]').click()" class="font-bold underline">Data Sekolah</a> terlebih dahulu.</div>`;
                            return;
                        }
                        const jenjang = schoolData.jenjang;
                        const semesterList = semesters[jenjang];
                        let html = '';
                        for (const key in semesterList) {
                            html += `<div class="mb-6 bg-white p-4 rounded-lg shadow-sm"><h3 class="text-xl font-bold text-gray-700">${semesterList[key]}</h3><div class="flex flex-wrap gap-4 mt-3"><button onclick="buildRaporScoreTable('${key}', 'Pengetahuan')" class="bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600 text-sm">Input Nilai Pengetahuan</button><button onclick="buildRaporScoreTable('${key}', 'Keterampilan')" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 text-sm">Input Nilai Keterampilan</button><button onclick="calculateRaporAverage('${key}')" class="bg-amber-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-amber-600 text-sm">Cek Rata-Rata Nilai</button></div><div id="table-container-${key}" class="mt-4"></div></div>`;
                        }
                        container.innerHTML = html;
                    })
                    .getSchoolData(userSpreadsheetId);
            }

            function calculateUjianAverage() {
                const container = document.getElementById('input-ujian-container');
                container.innerHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-4">Tabel Rata-Rata Nilai Ujian</h2><div class="text-center p-8"><p class="font-bold loading-animation">Menghitung rata-rata</p><p>Silakan tunggu...</p></div>`;
                Promise.all([
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getStudents(userSpreadsheetId)),
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getMapel(userSpreadsheetId)),
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, 'Nilai Ujian Madrasah')),
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, 'Nilai Ujian Praktek'))
                ]).then(([students, allMapel, nilaiMadrasah, nilaiPraktek]) => {
                    if (!students || students.length === 0) {
                        container.innerHTML = `<p class="text-red-500">Data siswa tidak ditemukan.</p>`;
                        return;
                    }
                    if (!allMapel || allMapel.length === 0) {
                        container.innerHTML = `<p class="text-red-500">Data mata pelajaran tidak ditemukan.</p>`;
                        return;
                    }
                    const tableWrapper = document.createElement('div');
                    tableWrapper.className = 'bg-white p-4 rounded-lg shadow-md';
                    let tableHtml = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>${allMapel.map(m => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-Rata</th></tr></thead><tbody>`;
                    
                    students.forEach((student, index) => {
                        tableHtml += `<tr><td class="px-3 py-2 text-sm">${index + 1}</td><td class="px-4 py-2 text-sm">${student.nisn}</td><td class="px-4 py-2 text-sm font-medium nama-siswa-cell">${student.nama.toUpperCase()}</td>`;
                        
                        const studentScores = [];
                        allMapel.forEach(mapel => {
                            const nilaiM = parseFloat((nilaiMadrasah[student.nisn] || {})[mapel.kode]);
                            const nilaiP = parseFloat((nilaiPraktek[student.nisn] || {})[mapel.kode]);
                            
                            let avgScore = null; // Default ke null jika tidak ada nilai
                            const hasM = !isNaN(nilaiM);
                            const hasP = !isNaN(nilaiP);

                            if (hasM && hasP) {
                                avgScore = (nilaiM + nilaiP) / 2;
                            } else if (hasM) {
                                avgScore = nilaiM;
                            } else if (hasP) {
                                avgScore = nilaiP;
                            }

                            studentScores.push(avgScore);
                            tableHtml += `<td class="px-2 py-1 text-center average-score-cell">${avgScore !== null ? Math.round(avgScore) : '-'}</td>`;
                        });

                        const validScores = studentScores.filter(s => s !== null);
                        const total = validScores.reduce((sum, score) => sum + score, 0);
                        const count = validScores.length;
                        const average = count > 0 ? (total / count).toFixed(2) : "0.00";

                        tableHtml += `<td class="px-4 py-2 text-center font-bold">${Math.round(total)}</td><td class="px-4 py-2 text-center font-bold">${average}</td></tr>`;
                    });

                    tableHtml += `</tbody></table></div>`;
                    tableWrapper.innerHTML = tableHtml;
                    container.querySelector('div').innerHTML = '';
                    container.querySelector('div').appendChild(tableWrapper);

                }).catch(err => {
                    container.innerHTML = `<p class="text-red-500">Gagal memuat data rata-rata: ${err.message}</p>`;
                });
            }

            // --- REKAPITULASI FUNCTIONS ---
            function initRekapitulasiPage() {
                const loader = document.getElementById('rekap-loader');
                const content = document.getElementById('rekap-content');
                const setupDiv = document.getElementById('rekap-setup');
                const displayArea = document.getElementById('rekap-display-area');

                loader.classList.remove('hidden');
                content.classList.add('hidden');
                setupDiv.classList.add('hidden');
                displayArea.innerHTML = '';

                google.script.run
                    .withSuccessHandler(sheetsExist => {
                        if (sheetsExist) {
                            // Panggil fungsi baru yang sudah dioptimasi
                            google.script.run
                                .withSuccessHandler(response => {
                                    if (response.status === 'success') {
                                        rekapitulasiData = response.data; // Ambil data dari properti 'data'
                                        loader.classList.add('hidden');
                                        content.classList.remove('hidden');
                                        const activeBtn = document.querySelector('.rekap-btn.active') || document.querySelector('[data-rekap="ijazah"]');
                                        activeBtn.click();
                                    } else {
                                        loader.classList.add('hidden');
                                        showGlobalStatus('Error: ' + response.message, false);
                                    }
                                })
                                .getRekapitulasiData_Optimized(userSpreadsheetId); // Panggil fungsi baru
                        } else {
                            loader.classList.add('hidden');
                            setupDiv.classList.remove('hidden');
                        }
                    })
                    .checkRekapSheetsExist(userSpreadsheetId);
            }

            document.querySelectorAll('.rekap-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.rekap-btn').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    const type = e.currentTarget.dataset.rekap;
                    if (rekapitulasiData) displayRekap(type, rekapitulasiData);
                });
            });

            document.getElementById('updateRekapBtn')?.addEventListener('click', function() {
                const btn = this;
                const btnText = document.getElementById('updateRekapBtnText');
                const spinner = document.getElementById('updateRekapSpinner');

                btn.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');

                google.script.run
                    .withSuccessHandler(response => {
                        if (response.status === 'success') {
                            showGlobalStatus(response.message, true);
                            initRekapitulasiPage();
                        } else {
                            showGlobalStatus(response.message, false);
                        }
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    })
                    .withFailureHandler(err => {
                        showGlobalStatus('Gagal memperbarui: ' + err.message, false);
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    })
                    .updateRekapitulasi(userSpreadsheetId);
            });

            function displayRekap(type, rekapData) {
                const { students, mapel, bobot, rekapUjian, rekapRapor, rekapIjazah } = rekapData;
                const displayArea = document.getElementById('rekap-display-area');
                let dataToShow, title = 'Rekapitulasi Nilai', bobotInfo = '';

                switch (type) {
                    case 'ujian': dataToShow = rekapUjian; title = 'Rekapitulasi Nilai Ujian'; break;
                    case 'rapor': dataToShow = rekapRapor; title = 'Rekapitulasi Nilai Rapor'; break;
                    case 'ijazah':
                    default:
                        dataToShow = rekapIjazah;
                        title = 'Rekapitulasi Nilai Ijazah';
                        if (bobot) {
                            bobotInfo = `<p class="text-sm font-normal text-gray-600">Bobot Nilai Ujian: <strong>${bobot.bobotUjian}%</strong>, Bobot Nilai Rapor: <strong>${bobot.bobotRapor}%</strong></p>`;
                        }
                }

                let tableHtml = `<div class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex justify-between items-start flex-wrap gap-2">
                        <div><h3 class="text-xl font-bold">${title}</h3>${bobotInfo}</div>
                        <div class="flex space-x-2">
                            <button id="showExportModalButton" data-rekap-type="${type}" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2 w-48">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 btn-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                <span class="btn-text">Pengaturan & Ekspor</span>
                                <span class="btn-spinner hidden loading-animation">Memuat...</span>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto mt-4"><table class="min-w-full text-sm rekap-table">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="text-left">No</th><th class="text-left">NISN</th><th class="text-left">Nama Siswa</th>
                                ${mapel.map(m => `<th title="${m.nama}">${m.kode}</th>`).join('')}
                                <th>Jumlah</th><th>Rata-rata</th>
                            </tr>
                        </thead>
                        <tbody>`;

                if (students && students.length > 0) {
                    students.forEach((student, index) => {
                        const scores = dataToShow[student.nisn] || {};
                        let total = 0;
                        let rowHtml = `<tr><td>${index + 1}</td><td>${student.nisn}</td><td class="nama-siswa-cell">${student.nama.toUpperCase()}</td>`;

                        mapel.forEach(m => {
                            // [PERBAIKAN] Logika diubah di sini
                            const rawScore = parseFloat(scores[m.kode] || 0);
                            const roundedScore = Math.round(rawScore); // 1. Bulatkan nilai mapel
                            
                            total += roundedScore; // 2. Jumlahkan nilai yang SUDAH DIBULATKAN
                            
                            rowHtml += `<td class="text-center">${roundedScore}</td>`; // 3. Tampilkan nilai yang sudah dibulatkan
                        });

                        // Rata-rata sekarang dihitung dari total nilai yang sudah dibulatkan
                        const average = mapel.length > 0 ? (total / mapel.length).toFixed(2).replace('.', ',') : '0,00';
                        
                        // Total tidak perlu dibulatkan lagi karena sudah merupakan hasil penjumlahan bilangan bulat
                        rowHtml += `<td class="text-center font-bold">${total}</td><td class="text-center font-bold">${average}</td>`;
                        
                        rowHtml += `</tr>`;
                        tableHtml += rowHtml;
                    });
                }

                tableHtml += `</tbody></table></div></div>`;
                displayArea.innerHTML = tableHtml;

                document.getElementById('showExportModalButton')?.addEventListener('click', function() {
                    const btn = this;
                    const btnIcon = btn.querySelector('.btn-icon');
                    const btnText = btn.querySelector('.btn-text');
                    const spinner = btn.querySelector('.btn-spinner');

                    btn.disabled = true;
                    btnIcon.classList.add('hidden');
                    btnText.textContent = '';
                    spinner.classList.remove('hidden');

                    const rekapType = this.dataset.rekapType;
                    document.getElementById('exportForm').dataset.rekapType = rekapType;
                    const savedOptions = JSON.parse(localStorage.getItem('exportOptions'));

                    google.script.run
                        .withSuccessHandler(schoolData => {
                            btn.disabled = false;
                            btnIcon.classList.remove('hidden');
                            btnText.textContent = 'Pengaturan & Ekspor';
                            spinner.classList.add('hidden');

                            document.getElementById('exportNamaSekolah').value = schoolData.namaSekolah || '';
                            document.getElementById('exportNamaKamad').value = schoolData.namaKepsek || '';
                            document.getElementById('exportNip').value = schoolData.nipKepsek || '';

                            const tahunAjaranSelect = document.getElementById('exportTahunAjaran');
                            tahunAjaranSelect.innerHTML = '';
                            const currentYear = new Date().getFullYear();
                            const years = [`${currentYear - 2}/${currentYear - 1}`, `${currentYear - 1}/${currentYear}`, `${currentYear}/${currentYear + 1}`, `${currentYear + 1}/${currentYear + 2}`, `${currentYear + 2}/${currentYear + 3}`];
                            years.forEach(year => {
                                const option = document.createElement('option');
                                option.value = year;
                                option.textContent = year;
                                tahunAjaranSelect.appendChild(option);
                            });

                            if (savedOptions) {
                                tahunAjaranSelect.value = savedOptions.tahunAjaran || years[2];
                                document.getElementById('exportTempatTTD').value = savedOptions.tempatTTD || '';
                                document.getElementById('exportTanggalTTD').value = savedOptions.tanggalTTD || new Date().toISOString().split('T')[0];
                                document.getElementById('exportTipeKamad').value = savedOptions.tipeKamad || 'Kepala Madrasah';
                            } else {
                                tahunAjaranSelect.value = years[2];
                                document.getElementById('exportTanggalTTD').valueAsDate = new Date();
                            }

                            document.getElementById('export-modal').classList.remove('hidden');
                        })
                        .withFailureHandler(error => {
                            btn.disabled = false;
                            btnIcon.classList.remove('hidden');
                            btnText.textContent = 'Pengaturan & Ekspor';
                            spinner.classList.add('hidden');
                            showGlobalStatus('Gagal memuat pengaturan: ' + error.message, false);
                        })
                        .getSchoolData(userSpreadsheetId);
                });
            }
        }

        // --- GLOBAL HELPER FUNCTIONS ---
        function formatIndonesianDate(dateString) {
            if (!dateString || dateString.indexOf('-') === -1) return dateString;
            try {
                const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                const parts = dateString.split('-');
                const date = new Date(parts[0], parts[1] - 1, parts[2]);
                return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
            } catch (e) {
                return dateString;
            }
        }
        
        function handleSaveRapor(event, semesterKey, jenisNilai) {
            event.preventDefault();
            const form = event.target;
            const saveBtn = form.querySelector('button[type="submit"]');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';
            const allRows = form.querySelectorAll('tbody tr');
            const nilaiData = [];
            allRows.forEach(row => {
                const studentScores = { nisn: row.dataset.nisn, nama: row.dataset.nama, scores: {} };
                row.querySelectorAll('.score-input').forEach(input => {
                    studentScores.scores[input.dataset.mapelKode] = input.value;
                });
                nilaiData.push(studentScores);
            });
            google.script.run
                .withSuccessHandler(response => {
                    showGlobalStatus(response.message, response.status === 'success');
                    saveBtn.disabled = false;
                    saveBtn.textContent = `Simpan Nilai ${jenisNilai}`;
                })
                .withFailureHandler(err => {
                    showGlobalStatus(`Gagal menyimpan: ${err.message}`, false);
                    saveBtn.disabled = false;
                    saveBtn.textContent = `Simpan Nilai ${jenisNilai}`;
                })
                .saveNilaiRapor(userSpreadsheetId, { semesterKey, jenisNilai, nilai: nilaiData });
        }

        function buildRaporScoreTable(semesterKey, jenisNilai) {
            const container = document.getElementById(`table-container-${semesterKey}`);
            container.innerHTML = `<div class="text-center p-8"><p class="font-bold loading-animation">Memuat data</p></div>`;
            const sheetName = `Rapor_${jenisNilai}_${semesterKey}`;
            Promise.all([
                new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getStudents(userSpreadsheetId)),
                new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getMapel(userSpreadsheetId)),
                new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, sheetName))
            ]).then(([students, mapelList, existingScores]) => {
                if (!students || students.length === 0) {
                    container.innerHTML = `<p class="text-center text-red-500 p-4">Data siswa tidak ditemukan.</p>`; return;
                }
                if (!mapelList || mapelList.length === 0) {
                    container.innerHTML = `<p class="text-center text-red-500 p-4">Data mata pelajaran tidak ditemukan.</p>`; return;
                }
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'p-4 border rounded-lg';
                tableWrapper.innerHTML = `<h4 class="text-lg font-semibold mb-3">Tabel Nilai ${jenisNilai}</h4><form id="form-${sheetName}"><div class="overflow-x-auto"><table id="score-table-${sheetName}" class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>${mapelList.map(m => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-Rata</th></tr></thead><tbody class="bg-white divide-y divide-gray-200"></tbody></table></div><div class="mt-6 pt-4 border-t flex justify-end space-x-3"><button type="button" class="clear-scores-btn bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Bersihkan</button><button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Simpan Nilai ${jenisNilai}</button></div></form>`;
                const tbody = tableWrapper.querySelector('tbody');
                students.forEach((s, index) => {
                    const studentScores = existingScores[s.nisn] || {};
                    let rowHtml = `<tr data-nisn="${s.nisn}" data-nama="${s.nama.toUpperCase()}"><td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${index + 1}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${s.nisn}</td><td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 nama-siswa-cell">${s.nama.toUpperCase()}</td>`;
                    mapelList.forEach(m => {
                        rowHtml += `<td class="px-2 py-1"><input type="number" min="0" max="100" class="score-input p-1 border rounded-md" data-mapel-kode="${m.kode}" value="${studentScores[m.kode] ?? ''}"></td>`;
                    });
                    rowHtml += `<td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell jumlah-nilai">0</td><td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell rata-rata-nilai">0.00</td></tr>`;
                    tbody.innerHTML += rowHtml;
                });
                container.innerHTML = '';
                container.appendChild(tableWrapper);
                const scoreTable = document.getElementById(`score-table-${sheetName}`);
                scoreTable.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
                scoreTable.addEventListener('input', handleScoreInput);
                scoreTable.addEventListener('paste', handleSmartPaste);
                document.getElementById(`form-${sheetName}`).addEventListener('submit', (e) => handleSaveRapor(e, semesterKey, jenisNilai));
                tableWrapper.querySelector('.clear-scores-btn').addEventListener('click', (e) => {
                    const form = e.target.closest('form');
                    form.querySelectorAll('.score-input').forEach(input => input.value = '');
                    form.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
                });
            });
        }

        function calculateRaporAverage(semesterKey) {
            const container = document.getElementById(`table-container-${semesterKey}`);
            container.innerHTML = `<h4 class="text-lg font-semibold mb-3">Tabel Rata-Rata Nilai</h4><div class="text-center p-8"><p class="font-bold loading-animation">Menghitung rata-rata</p><p>Silakan tunggu...</p></div>`;
            const sheetNameP = `Rapor_Pengetahuan_${semesterKey}`;
            const sheetNameK = `Rapor_Keterampilan_${semesterKey}`;
            Promise.all([
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getStudents(userSpreadsheetId)),
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getMapel(userSpreadsheetId)),
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, sheetNameP)),
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, sheetNameK))
            ]).then(([students, mapelList, nilaiPengetahuan, nilaiKeterampilan]) => {
                if (!students || students.length === 0) { container.innerHTML = `<p class="text-red-500">Data siswa tidak ditemukan.</p>`; return; }
                if (!mapelList || mapelList.length === 0) { container.innerHTML = `<p class="text-red-500">Data mata pelajaran tidak ditemukan.</p>`; return; }
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'p-4 border rounded-lg';
                let tableHtml = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>${mapelList.map(m => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-Rata</th></tr></thead><tbody>`;
                
                students.forEach((student, index) => {
                    let rowHtml = `<tr data-nisn="${student.nisn}" data-nama="${student.nama.toUpperCase()}"><td class="px-3 py-2 text-sm">${index + 1}</td><td class="px-4 py-2 text-sm">${student.nisn}</td><td class="px-4 py-2 text-sm font-medium nama-siswa-cell">${student.nama.toUpperCase()}</td>`;
                        
                    mapelList.forEach(mapel => {
                        const nilaiP = parseFloat((nilaiPengetahuan[student.nisn] || {})[mapel.kode]);
                        const nilaiK = parseFloat((nilaiKeterampilan[student.nisn] || {})[mapel.kode]);
                            
                        let avgScore = null; // Default ke null jika tidak ada nilai
                        const hasP = !isNaN(nilaiP);
                        const hasK = !isNaN(nilaiK);

                        if (hasP && hasK) avgScore = (nilaiP + nilaiK) / 2;
                        else if (hasP) avgScore = nilaiP;
                        else if (hasK) avgScore = nilaiK;
                            
                        rowHtml += `<td class="px-2 py-1 text-center average-score-cell">${avgScore !== null ? Math.round(avgScore) : '-'}</td>`;
                    });
                    rowHtml += `<td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell jumlah-nilai">0</td><td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell rata-rata-nilai">0.00</td></tr>`;
                    tableHtml += rowHtml;
                });

                tableHtml += `</tbody></table></div>`;
                tableWrapper.innerHTML = tableHtml;
                container.innerHTML = `<h4 class="text-lg font-semibold mb-3">Tabel Rata-Rata Nilai</h4>`;
                container.appendChild(tableWrapper);
                tableWrapper.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
            }).catch(err => {
                container.innerHTML = `<p class="text-red-500">Gagal memuat data rata-rata: ${err.message}</p>`;
            });
        }

        const semesters = {
            MI: { k4_ganjil: 'Kelas 4 Ganjil', k4_genap: 'Kelas 4 Genap', k5_ganjil: 'Kelas 5 Ganjil', k5_genap: 'Kelas 5 Genap', k6_ganjil: 'Kelas 6 Ganjil' },
            MTS: { k7_ganjil: 'Kelas 7 Ganjil', k7_genap: 'Kelas 7 Genap', k8_ganjil: 'Kelas 8 Ganjil', k8_genap: 'Kelas 8 Genap', k9_ganjil: 'Kelas 9 Ganjil' },
            MA: { k10_ganjil: 'Kelas 10 Ganjil', k10_genap: 'Kelas 10 Genap', k11_ganjil: 'Kelas 11 Ganjil', k11_genap: 'Kelas 11 Genap', k12_ganjil: 'Kelas 12 Ganjil' }
        };

        function showGlobalStatus(message, isSuccess) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `toast-notification ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            statusDiv.innerHTML = message; // innerHTML agar bisa menampilkan format tebal
            document.getElementById('globalStatusMessage').appendChild(statusDiv);

            setTimeout(() => {
                statusDiv.remove();
            }, 4000); // Disesuaikan dengan durasi animasi CSS
        }

        function updateRowTotals(rowElement) {
            const inputs = rowElement.querySelectorAll('.score-input, .average-score-cell');
            let total = 0;
            let count = 0;
            inputs.forEach(input => {
                const value = parseFloat(input.value || input.textContent);
                if (!isNaN(value)) { total += value; count++; }
            });
            const average = count > 0 ? (total / count).toFixed(2) : '0.00';
            const totalCell = rowElement.querySelector('.jumlah-nilai');
            const avgCell = rowElement.querySelector('.rata-rata-nilai');
            if (totalCell) totalCell.textContent = Math.round(total);
            if (avgCell) avgCell.textContent = average;
        }

        function handleScoreInput(event) {
            if (event.target.classList.contains('score-input')) {
                updateRowTotals(event.target.closest('tr'));
            }
        }

        function handleSmartPaste(event) {
            if (!event.target.classList.contains('score-input')) return;
            event.preventDefault();
            const pastedText = (event.clipboardData || window.clipboardData).getData('text');
            const pastedRows = pastedText.split(/\r?\n/).filter(r => r).map(row => row.split('\t'));
            const tableBody = event.target.closest('tbody');
            if (!tableBody) return;
            const allTableRows = Array.from(tableBody.querySelectorAll('tr'));
            const startRowElement = event.target.closest('tr');
            const startRowIndex = allTableRows.indexOf(startRowElement);
            const allRowInputs = Array.from(startRowElement.querySelectorAll('.score-input'));
            const startColIndex = allRowInputs.indexOf(event.target);
            pastedRows.forEach((rowData, r_offset) => {
                const targetRow = allTableRows[startRowIndex + r_offset];
                if (targetRow) {
                    const targetRowInputs = Array.from(targetRow.querySelectorAll('.score-input'));
                    rowData.forEach((cellData, c_offset) => {
                        const targetInput = targetRowInputs[startColIndex + c_offset];
                        if (targetInput) targetInput.value = cellData.trim();
                    });
                    updateRowTotals(targetRow);
                }
            });
        }
    </script>
</body>
</html>
