<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-link { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; border-left: 4px solid transparent; }
        .nav-link.active { background-color: #3b82f6; color: white; border-left-color: #facc15; }
        .nav-link:hover { background-color: #2563eb; color: white; }
        .content-page, #login-container, #signup-container { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content { 
            transition: transform 0.3s ease-in-out;
            display: flex; /* Tambahkan ini */
            flex-direction: column; /* Tambahkan ini */
            max-height: 90vh; /* Tambahkan ini: Batasi tinggi modal maksimal 90% dari tinggi layar */
        }
        .score-input { width: 60px; text-align: center; }
        .total-cell { font-weight: bold; }
        .rekap-table th, .rekap-table td { padding: 8px 12px; border: 1px solid #e5e7eb; }
        .rekap-btn.active {
            background-color: #2563eb;
            color: white;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }
        .gradient-bg {
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, rgb(243, 244, 246) 0px, transparent 50%),
                radial-gradient(at 95% 20%, rgb(229, 231, 235) 0px, transparent 50%),
                radial-gradient(at 20% 90%, rgb(209, 213, 219) 0px, transparent 50%);
        }
        /* Animasi untuk titik-titik loading */
        .loading-animation::after {
            display: inline-block;
            animation: loading-dots 1.4s infinite;
            content: '.';
            width: 1em;
            text-align: left;
        }
        @keyframes loading-dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        .nama-siswa-cell {
            text-align: left;
        }
        /* CSS untuk Notifikasi Pop-up di Atas Tengah */
        #globalStatusMessage {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 90%;
            max-width: 500px;
            pointer-events: none; /* Agar tidak menghalangi klik */
        }

        .toast-notification {
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: white;
            font-weight: 500;
            text-align: center;
            animation: fadeInOut 4s ease-in-out forwards;
            opacity: 0;
            pointer-events: auto; /* Aktifkan kembali pointer */
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(-20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }

        /* ===== [TAMBAHAN] KODE CSS UNTUK SCROLLBAR KUSTOM ===== */

        /* Untuk browser berbasis WebKit (Chrome, Safari, Edge) */
        .custom-scrollbar::-webkit-scrollbar {
          width: 8px; /* Lebar scrollbar */
        }

        .custom-scrollbar::-webkit-scrollbar-track {
          background: #1e3a8a; /* Warna track, sedikit lebih gelap dari sidebar */
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
          background-color: #3b82f6; /* Warna utama scrollbar (biru) */
          border-radius: 10px; /* Membuat ujungnya bulat */
          border: 2px solid #1e3a8a; /* Memberi sedikit jarak dari track */
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background-color: #2563eb; /* Warna saat mouse di atasnya */
        }

        /* Untuk Firefox */
        .custom-scrollbar {
          scrollbar-width: thin;
          scrollbar-color: #3b82f6 #1e3a8a; /* Format: warna thumb, warna track */
        }

        /* Letakkan ini di dalam tag <style> */

        .shepherd-custom-theme {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            max-width: 350px;
        }

        .shepherd-custom-theme .shepherd-header {
            background: #1e3a8a !important; /* Biru Tua - INI PERUBAHANNYA */
            padding: 1rem 1.5rem;
        }

        .shepherd-custom-theme .shepherd-title {
            color: #ffffff;
            font-weight: 700;
            font-size: 1.125rem;
        }

        .shepherd-custom-theme .shepherd-cancel-icon {
            color: #ffffff;
            opacity: 0.75;
        }
        .shepherd-custom-theme .shepherd-cancel-icon:hover {
            opacity: 1;
        }

        .shepherd-custom-theme .shepherd-text {
            padding: 1.5rem;
            color: #374151; /* Abu-abu gelap */
            line-height: 1.6;
        }

        .shepherd-custom-theme .shepherd-footer {
            padding: 0 1.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shepherd-custom-theme .shepherd-button {
            background: #3b82f6; /* Biru */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .shepherd-custom-theme .shepherd-button:not(.shepherd-button-secondary):hover {
            background: #2563eb;
        }

        .shepherd-custom-theme .shepherd-button.shepherd-button-secondary {
            background: #e5e7eb; /* Abu-abu terang */
            color: #374151;
        }

        .shepherd-custom-theme .shepherd-button.shepherd-button-secondary:hover {
            background: #d1d5db;
        }

        /* Styling untuk checkbox "Jangan tampilkan lagi" */
        .shepherd-dont-show-again {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            color: #4b5563;
        }

        .shepherd-dont-show-again input {
            margin-right: 0.5rem;
            height: 1rem;
            width: 1rem;
        }

        /* [BARU] Tambahkan kode ini */
        .rekap-btn:not(.active):hover {
            background-color: #3b82f6; /* Warna biru yang sama dengan nav-link */
            color: white;
        }

        /* Tambahkan style ini di dalam tag <style> */
        .ujian-btn.active {
            background-color: #16a34a; /* Tailwind green-600 */
            color: white;
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.1);
            transform: scale(1.05);
        }

        .ujian-btn.active:hover {
            background-color: #15803d; /* Tailwind green-700 */
        }

        /* [BARU] Tambahkan ini untuk styling sel yang terblok */
        .cell-selected {
            background-color: #dbeafe !important; /* Biru sangat muda */
            border-color: #3b82f6 !important; /* Border biru */
        }

        /* [BARU] Tambahkan ini untuk mencegah seleksi teks saat drag */
        .no-select {
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none;     /* IE 10+ dan Edge */
            user-select: none;         /* Standar */
        }

        /* KODE BARU (Hover menjadi hijau) */
        .ujian-btn:not(.active):hover {
            background-color: #16a34a; /* Warna hijau, sama seperti state .active */
            color: white;             /* Ubah juga warna teks menjadi putih */
        }

        /* GAYA BARU UNTUK TOMBOL RAPOR */
        .rapor-semester-btn.active {
            background-color: #16a34a; /* Hijau */
            color: white;
            transform: scale(1.05);
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.1);
        }

        .rapor-semester-btn:not(.active):hover {
            background-color: #16a34a; /* Hijau saat hover */
            color: white;
        }

        /* Letakkan ini di dalam tag <style> */
        .clickable-ratio {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-color: #9ca3af; /* Warna garis bawah abu-abu */
            text-decoration-thickness: 1px;
            text-underline-offset: 2px;
        }
        .clickable-ratio:hover {
            text-decoration-color: #3b82f6; /* Warna garis bawah biru saat di-hover */
        }

        /* ================================================= */
        /* PERBAIKAN UNTUK TOMBOL MODAL YG TIDAK BISA DIKLIK */
        /* ================================================= */

        /* Atur agar latar belakang modal tidak menangkap klik */
        #mapel-import-modal {
          pointer-events: none; 
        }

        /* Tapi, aktifkan kembali klik HANYA untuk kotak konten modal dan semua isinya (termasuk tombol) */
        #mapel-import-modal .modal-content {
          pointer-events: auto;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Container -->
    <div id="auth-wrapper" class="gradient-bg flex flex-col min-h-screen">
        <div class="flex-grow flex items-center justify-center py-8 px-4">
            <div class="w-full max-w-md">
                <!-- Container untuk Login -->
                <div id="login-container">
                    <div class="bg-white rounded-2xl shadow-xl p-8 md:p-10">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Login Aplikasi<br>Pengolahan Nilai Ijazah</h1>
                            <p class="text-gray-500 mt-2">Silakan masuk untuk melanjutkan</p>
                        </div>
                        <div id="login-info-message" class="mb-4 text-center text-sm"></div>
                        <form id="loginForm">
                            <div class="space-y-6">
                                <div>
                                    <label for="email" class="text-sm font-medium text-gray-700 block mb-2">Alamat Email</label>
                                    <input type="email" name="email" id="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="nama@email.com" required>
                                </div>
                                <div>
                                    <label for="password" class="text-sm font-medium text-gray-700 block mb-2">Kata Sandi</label>
                                    <div class="relative">
                                        <input type="password" name="password" id="password" class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="••••••••" required>
                                        <button type="button" data-toggle-password="password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                            <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                            <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <button type="submit" id="loginButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 shadow-lg">
                                        <span id="loginButtonText">Masuk</span>
                                        <span id="loginSpinner" class="hidden loading-animation">Memproses</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                        <div id="login-error-message" class="mt-4 text-center text-red-600 text-sm h-4"></div>
                        <div class="text-center text-sm mt-4">
                            <a href="#" id="forgot-password-link" class="text-gray-500 hover:text-blue-600">Lupa Password?</a>
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            Belum punya akun? 
                            <a href="#" id="show-signup" class="font-medium text-blue-600 hover:text-blue-500">Daftar sekarang</a>
                        </p>
                    </div>
                </div>

                <!-- Container untuk Signup (awalnya disembunyikan) -->
                <div id="signup-container" class="hidden">
                    <div class="bg-white rounded-2xl shadow-xl p-8 md:p-10">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Buat Akun Sekolah</h1>
                            <p class="text-gray-500 mt-2">Isi form di bawah untuk mendaftar.</p>
                        </div>
                        <form id="signupForm">
                             <div id="signup-message" class="mb-4 text-center text-sm h-auto"></div>
                            <div class="space-y-4">
                                <div id="initial-fields" class="space-y-4">
                                    <div>
                                        <label for="signup-namasekolah" class="text-sm font-medium text-gray-700 block mb-2">Nama Sekolah</label>
                                        <input type="text" id="signup-namasekolah" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Contoh: MI Al-Hidayah" required>
                                    </div>
                                    <div>
                                      <label for="signup-jenjang" class="text-sm font-medium text-gray-700 block mb-2">Jenjang Sekolah</label>
                                      <select id="signup-jenjang" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white" required>
                                        <option value="" disabled selected>-- Pilih Jenjang --</option>
                                        <option value="MI">MI (Madrasah Ibtidaiyah)</option>
                                        <option value="MTS">MTS (Madrasah Tsanawiyah)</option>
                                        <option value="MA">MA (Madrasah Aliyah)</option>
                                      </select>
                                    </div>
                                    <div>
                                        <label for="signup-email" class="text-sm font-medium text-gray-700 block mb-2">Alamat Email</label>
                                        <input type="email" id="signup-email" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="nama@email.com" required>
                                    </div>
                                    <div>
                                        <label for="signup-password" class="text-sm font-medium text-gray-700 block mb-2">Kata Sandi</label>
                                        <div class="relative">
                                            <input type="password" id="signup-password" class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg shadow-sm" placeholder="••••••••" required>
                                            <button type="button" data-toggle-password="signup-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                            </button>
                                        </div>
                                        <div id="signup-password-req" class="text-xs space-y-1 mt-2"></div>
                                    </div>
                                    <div>
                                        <label for="confirm-password" class="text-sm font-medium text-gray-700 block mb-2">Konfirmasi Kata Sandi</label>
                                        <div class="relative">
                                            <input type="password" id="confirm-password" class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg shadow-sm" placeholder="••••••••" required>
                                            <button type="button" data-toggle-password="confirm-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                            </button>
                                        </div>
                                        <div id="signup-confirm-msg" class="text-red-600 text-xs mt-1 h-4 font-medium"></div>
                                    </div>
                                    <div class="pt-2">
                                        <button type="button" id="requestOtpButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 shadow-lg">
                                            <span id="requestOtpButtonText">Kirim Kode Verifikasi</span>
                                            <span id="requestOtpSpinner" class="hidden loading-animation">Mengirim</span>
                                        </button>
                                    </div>
                                </div>
                                <div id="otp-section" class="hidden">
                                    <label for="signup-otp" class="text-sm font-medium text-gray-700 block mb-2">Kode OTP</label>
                                    <input type="text" id="signup-otp" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Masukkan 6 digit kode dari email" required>
                                </div>
                                <div id="final-signup-button-container" class="hidden">
                                    <button type="submit" id="signupButton" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 shadow-lg">
                                        <span id="signupButtonText">Daftar</span>
                                        <span id="signupSpinner" class="hidden loading-animation">Memproses</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            Sudah punya akun? 
                            <a href="#" id="show-login" class="font-medium text-blue-600 hover:text-blue-500">Masuk di sini</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center py-4">
            <a href="https://wa.me/qr/FMVS3NLDIRUAA1" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-500 hover:text-blue-600 transition-colors">
              &copy; <span id="currentYearAuth"></span> Created by Syamsul Bahri
            </a>
        </footer>
    </div>

    <!-- Container untuk Aplikasi Utama (awalnya disembunyikan) -->
    <div id="app-container" class="hidden">
        <div id="impersonation-exit-banner" class="hidden fixed top-0 left-0 right-0 bg-yellow-400 text-yellow-900 font-bold text-center p-2 z-[100] shadow-lg cursor-pointer">
            Anda sedang masuk sebagai <span id="impersonated-school-name" class="underline"></span>. Klik di sini untuk kembali ke akun Superadmin Anda.
        </div>
        <div class="flex h-screen">
            <aside class="w-64 bg-blue-800 text-white flex flex-col">
                <div class="h-16 flex items-center justify-center text-xl font-bold border-b border-blue-700 text-center px-2 pt-4"><span id="school-name-sidebar">SYAMSUL BAHRI</span></div>

                <nav id="main-nav" class="flex-1 px-4 py-4 space-y-2 overflow-y-auto custom-scrollbar">
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md active" data-page="dashboard"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span>Dashboard</span></a>
                    
                    <div class="border-t border-blue-700 my-2"></div>
                    
                    <a href="#" id="nav-manajemen-akun" class="nav-link flex items-center space-x-3 p-2 rounded-md hidden" data-page="manajemen-akun"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A4 4 0 019 9.754a4 4 0 014.541-3.333a4 4 0 014.541 3.333M15 21a6 6 0 00-9-5.197" /></svg><span>Manajemen Akun</span></a>
                    <a href="#" id="nav-daftar-pengajuan" class="nav-link flex justify-between items-center space-x-3 p-2 rounded-md hidden" data-page="daftar-pengajuan"><span class="flex items-center space-x-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg><span>Daftar Pengajuan</span></span><span id="pengajuan-badge" class="hidden bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-0.5 rounded-full"></span></a>
                    <a href="#" id="admin-tools-link" class="nav-link flex items-center space-x-3 p-2 rounded-md hidden" data-page="admin-tools"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg><span>Alat Admin</span></a>
                    <a href="#" id="nav-kelola-update" class="nav-link flex items-center space-x-3 p-2 rounded-md hidden" data-page="kelola-update"><svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg><span>Kelola Update</span></a>

                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="data-sekolah"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg><span>Data Sekolah</span></a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="data-siswa"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><span>Data Siswa</span></a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="mapel"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg><span>Mapel & Bobot</span></a>
                    
                    <div class="border-t border-blue-700 my-2"></div>

                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="pengaturan"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg><span>Pengaturan Nilai KKM</span></a>
                    
                    <div class="border-t border-blue-700 my-2"></div>
                    
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="input-ujian"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg><span>Input Nilai Ujian</span></a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="input-rapor"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span>Input Nilai Rapor</span></a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="validasi-nilai"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Validasi Nilai</span></a>

                    <div class="border-t border-blue-700 my-2"></div>
                    
                    <a href="#" class="nav-link flex justify-between items-center space-x-3 p-2 rounded-md" data-page="rekapitulasi"><span class="flex items-center space-x-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span>Rekapitulasi</span></span><span id="rekap-indicator" class="relative hidden w-3 h-3 mr-1"><span class="animate-ping absolute h-full w-full rounded-full bg-yellow-300 opacity-75"></span><span class="absolute h-full w-full rounded-full bg-yellow-400"></span></span></a>
                    
                    <div class="border-t border-blue-700 my-2"></div>
                    
                    <a href="#" class="nav-link flex justify-between items-center" data-page="pengajuan"><span class="flex items-center space-x-3 p-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Pengajuan</span></span><span id="pengajuan-indicator-container" class="pr-3"></span></a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="backup-restore"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5" /></svg><span>Backup & Restore</span></a>
                    <a href="#" id="nav-update" class="nav-link flex justify-between items-center space-x-3 p-2 rounded-md" data-page="update-info"><span class="flex items-center space-x-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><span>Info & Update</span></span></a>
                    
                    <div class="border-t border-blue-700 my-2"></div>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="ubah-password">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 7a4 4 0 11-8 0 4 4 0 018 0zM9 15h6" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                        <span>Ubah Password</span>
                    </a>
                </nav>

                <div class="p-4 border-t border-blue-700">
                    <a href="#" id="logoutButton" class="w-full flex items-center space-x-3 p-2 rounded-md hover:bg-blue-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                        <span>Logout</span>
                    </a>
                </div>
            </aside>

            <main class="flex-1 p-6 md:p-10 overflow-y-auto flex flex-col">
                <div class="flex-grow">
                    <div id="page-dashboard" class="content-page">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Dashboard</h1>
                        <p class="text-gray-600 mb-8">Ringkasan data akademik sekolah Anda.</p>
                        
                        <!-- Kartu Statistik -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            <!-- Kartu Siswa (dapat diklik) -->
                            <div id="student-card" class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 cursor-pointer">
                                <div class="bg-blue-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Jumlah Siswa</p>
                                    <p id="studentCount" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <!-- Kartu Mapel (dapat diklik) -->
                            <div id="mapel-card" class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 cursor-pointer">
                                <div class="bg-green-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Jumlah Mata Pelajaran</p>
                                    <p id="mapelCount" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <a id="hubungi-admin-card" href="https://wa.me/qr/FMVS3NLDIRUAA1" target="_blank" rel="noopener noreferrer" class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 cursor-pointer">
                                <div class="bg-green-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.487 5.235 3.487 8.413 0 6.557-5.338 11.892-11.894 11.892-1.99 0-3.903-.52-5.586-1.456l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 4.315 1.731 6.086l.06.094-1.105 4.023 4.13-1.082.092.055z"/>
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-lg font-bold text-gray-800">Hubungi Admin!</p>
                                    <p class="text-sm text-gray-500 mt-1">Jika ada saran atau menemukan masalah, klik di sini.</p>
                                </div>
                            </a>
                        </div>

                        <!-- Grafik -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Distribusi Jenis Ujian Mata Pelajaran</h2>
                            <div class="h-80">
                                <canvas id="mapelChart"></canvas>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-6 mt-8">
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Rata-rata Nilai Ujian per Mapel</h2>
                                <div class="h-96">
                                    <canvas id="ujianAverageChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Rata-rata Nilai Rapor per Mapel</h2>
                                <div class="h-96">
                                    <canvas id="raporAverageChart"></canvas>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Rata-rata Nilai Ijazah per Mapel</h2>
                                <div class="h-96">
                                    <canvas id="ijazahAverageChart"></canvas>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <div class="mb-4">
                                    <h2 class="text-xl font-bold text-gray-800">Peringkat Siswa Berdasarkan Rata-rata Nilai Ujian Siswa</h2>
                                    <p class="text-sm text-gray-500">(Silahkan Perbarui Rekapitulasi Untuk Mendapatkan Grafik Terbaru)</p>
                                </div>
                                <div id="examScoreScrollContainer" class="h-96 w-full" style="overflow-x: auto; overflow-y: hidden;">
                                    <div id="examScoreChartWrapper" style="position: relative; height: 100%;">
                                        <canvas id="examScoreDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <div class="mb-4">
                                    <h2 class="text-xl font-bold text-gray-800">Peringkat Siswa Berdasarkan Rata-rata Nilai Ijazah</h2>
                                    <p class="text-sm text-gray-500">(Silahkan Perbarui Rekapitulasi Untuk Mendapatkan Grafik Terbaru)</p>
                                </div>
                                <div id="ijazahRankingScrollContainer" class="h-96 w-full" style="overflow-x: auto; overflow-y: hidden;">
                                    <div id="ijazahRankingChartWrapper" style="position: relative; height: 100%;">
                                        <canvas id="ijazahRankingChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="page-data-sekolah" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Data Sekolah</h1>
                        <p class="mt-2 text-gray-600 mb-8">Gunakan formulir ini untuk mengisi atau memperbarui informasi detail mengenai sekolah Anda.</p>
                        <div class="bg-white p-8 rounded-lg shadow-md max-w-4xl">
                            <form id="schoolDataForm">
                                <div class="mb-6 pb-6 border-b">
                                <label for="jenjang" class="block text-sm font-medium text-gray-700">Jenjang Sekolah</label>
                                <select id="jenjang" name="jenjang" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" disabled>
                                    <option value="">-- Pilih Jenjang --</option>
                                    <option value="MI">MI (Madrasah Ibtidaiyah)</option>
                                    <option value="MTS">MTS (Madrasah Tsanawiyah)</option>
                                    <option value="MA">MA (Madrasah Aliyah)</option>
                                </select>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                    <div>
                                        <label for="namaSekolah" class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                                        <input type="text" id="namaSekolah" name="namaSekolah" class="mt-1 w-full px-3 py-2 border border-gray-300 bg-gray-100 rounded-md shadow-sm" readonly>
                                        <label for="npsn" class="block text-sm font-medium text-gray-700 mt-4">NPSN</label>
                                        <input type="text" id="npsn" name="npsn" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="nsm" class="block text-sm font-medium text-gray-700 mt-4">NSM (Nomor Statistik Madrasah)</label>
                                        <input type="text" id="nsm" name="nsm" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="alamat" class="block text-sm font-medium text-gray-700 mt-4">Alamat Jalan</label>
                                        <textarea id="alamat" name="alamat" rows="3" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                                        <label for="kelurahan" class="block text-sm font-medium text-gray-700 mt-4">Kelurahan/Desa</label>
                                        <input type="text" id="kelurahan" name="kelurahan" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="kecamatan" class="block text-sm font-medium text-gray-700 mt-4">Kecamatan</label>
                                        <input type="text" id="kecamatan" name="kecamatan" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label for="kabupaten" class="block text-sm font-medium text-gray-700">Kabupaten/Kota</label>
                                        <input type="text" id="kabupaten" name="kabupaten" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="provinsi" class="block text-sm font-medium text-gray-700 mt-4">Provinsi</label>
                                        <input type="text" id="provinsi" name="provinsi" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="kodePos" class="block text-sm font-medium text-gray-700 mt-4">Kode Pos</label>
                                        <input type="text" id="kodePos" name="kodePos" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="telepon" class="block text-sm font-medium text-gray-700 mt-4">Nomor Telepon</label>
                                        <input type="tel" id="telepon" name="telepon" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="email-sekolah" class="block text-sm font-medium text-gray-700 mt-4">Email</label>
                                        <input type="email" id="email-sekolah" name="email" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="website" class="block text-sm font-medium text-gray-700 mt-4">Website</label>
                                        <input type="url" id="website" name="website" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                <div class="mt-8 border-t pt-6">
                                    <h2 class="text-lg font-medium text-gray-900">Data Kepala Sekolah</h2>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mt-4">
                                        <div>
                                            <label for="namaKepsek" class="block text-sm font-medium text-gray-700">Nama Kepala Sekolah</label>
                                            <input type="text" id="namaKepsek" name="namaKepsek" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="nipKepsek" class="block text-sm font-medium text-gray-700">NIP Kepala Sekolah (Jika ada)</label>
                                            <input type="text" id="nipKepsek" name="nipKepsek" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-8 pt-5 border-t">
                                    <button type="submit" id="schoolSubmitBtn" class="w-full md:w-auto flex justify-center py-2 px-8 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                                        <span id="schoolSubmitBtnText">Simpan Data Sekolah</span>
                                        <span id="schoolLoadingSpinner" class="hidden loading-animation">Menyimpan</span>
                                    </button>
                                </div>
                            </form>
                            <div id="schoolStatusMessage" class="mt-6 p-4 rounded-md text-center opacity-0 transition-opacity"></div>
                        </div>
                    </div>

                    <div id="page-pengaturan" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Pengaturan Aplikasi</h1>
                        <p class="mt-2 text-gray-600 mb-8">Sesuaikan beberapa parameter aplikasi untuk sekolah Anda.</p>
                        
                        <div class="bg-white p-8 rounded-lg shadow-md max-w-2xl">
                            <form id="pengaturanForm">
                                <h2 class="text-xl font-bold text-gray-700">Pengaturan Nilai</h2>
                                <div class="mt-6 border-t pt-6">
                                    <label for="kkmSekolah" class="block text-sm font-medium text-gray-700">Nilai KKM (Kriteria Ketuntasan Minimal)</label>
                                    <p class="text-xs text-gray-500 mt-1 mb-2">Nilai ini akan digunakan sebagai ambang batas, misalnya untuk menandai nilai yang belum tuntas.</p>
                                    <input type="number" id="kkmSekolah" name="kkmSekolah" min="0" max="100" class="mt-1 w-full max-w-xs px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: 75">
                                </div>

                                <div class="mt-8 pt-5 border-t">
                                    <button type="submit" id="pengaturanSubmitBtn" class="w-full md:w-auto flex justify-center py-2 px-8 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                                        <span id="pengaturanSubmitBtnText">Simpan Pengaturan</span>
                                        <span id="pengaturanLoadingSpinner" class="hidden loading-animation">Menyimpan</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div id="page-manajemen-akun" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Manajemen Akun Pengguna</h1>
                        <p class="mt-2 text-gray-600 mb-8">Kelola semua akun yang terdaftar di sistem.</p>
                        <div class="bg-white p-4 rounded-lg shadow-md mt-8">
                            <div id="userManagementTableContainer" class="overflow-x-auto">
                                </div>
                        </div>
                    </div>

                    <div id="page-daftar-pengajuan" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Daftar Pengajuan Perubahan Data</h1>
                        <p class="mt-2 text-gray-600 mb-8">Tinjau dan proses permintaan perubahan data dari pengguna.</p>
                        <div id="pengajuanContainer_Superadmin" class="bg-white p-4 rounded-lg shadow-md mt-4">
                            </div>
                    </div>

                    <!-- Letakkan ini di dalam <main> -->
                    <div id="page-superadmin-dashboard" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Dashboard Superadmin</h1>
                        <p class="text-gray-600 mb-8">Ringkasan data seluruh sistem.</p>

                        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between">
                            <div>
                                <p id="last-updated-text" class="text-sm text-gray-600">
                                    <span class="loading-animation">Memuat status data</span>
                                </p>
                            </div>
                            <button id="force-refresh-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center space-x-2 transition-opacity disabled:opacity-50">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M4 4l7 7M20 20v-5h-5M20 20l-7-7" />
                                </svg>
                                <span>Perbarui Data Sekarang</span>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <!-- Kartu Total Akun (dapat diklik) -->
                            <div id="sa-card-total-akun" class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 cursor-pointer">
                                <div class="bg-blue-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.653-.125-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.653.125-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Jumlah Seluruh Akun</p>
                                    <p id="sa-total-akun" class="text-3xl font-bold text-gray-800">...</p>
                                </div>
                            </div>

                            <!-- Kartu Total Siswa -->
                            <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                                <div class="bg-purple-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A4 4 0 019 9.754a4 4 0 014.541-3.333a4 4 0 014.541 3.333M15 21a6 6 0 00-9-5.197" /></svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Jumlah Seluruh Siswa</p>
                                    <p id="sa-total-siswa" class="text-3xl font-bold text-gray-800">...</p>
                                </div>
                            </div>

                            <!-- Kartu Akun Aktif -->
                            <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                                <div class="bg-green-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Akun Aktif</p>
                                    <p id="sa-akun-aktif" class="text-3xl font-bold text-gray-800">...</p>
                                </div>
                            </div>
                            
                            <!-- Kartu Akun Nonaktif -->
                            <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                                <div class="bg-red-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Akun Nonaktif</p>
                                    <p id="sa-akun-nonaktif" class="text-3xl font-bold text-gray-800">...</p>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                                <div class="bg-gray-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Jumlah Total Ajuan</p>
                                    <p id="sa-total-ajuan" class="text-3xl font-bold text-gray-800">...</p>
                                </div>
                            </div>

                            <div id="sa-card-ajuan-menunggu" class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 cursor-pointer">
                                <div class="bg-yellow-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Ajuan Menunggu</p>
                                    <p id="sa-ajuan-menunggu" class="text-3xl font-bold text-gray-800">...</p>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                                <div class="bg-green-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Ajuan Diterima</p>
                                    <p id="sa-ajuan-diterima" class="text-3xl font-bold text-gray-800">...</p>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4">
                                <div class="bg-red-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Ajuan Ditolak</p>
                                    <p id="sa-ajuan-ditolak" class="text-3xl font-bold text-gray-800">...</p>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg col-span-1 md:col-span-2">
                                <h3 class="text-lg font-bold text-gray-800">Pengaturan Batas Default Siswa</h3>
                                <p class="text-sm text-gray-500 mt-1">Atur batas jumlah siswa default untuk setiap akun baru yang mendaftar.</p>
                                <div class="mt-4 flex items-center space-x-4">
                                    <input type="number" id="default-limit-input" class="w-full max-w-xs p-2 border border-gray-300 rounded-md shadow-sm">
                                    <button id="save-default-limit-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Simpan</button>
                                </div>
                                <div id="default-limit-status" class="text-sm mt-2"></div>
                            </div>
                        </div>
                        <div class="mt-8">
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Riwayat Aktivitas Login (50 Terbaru)</h3>
                                <div id="login-history-container" class="overflow-x-auto">
                                    <p class="text-center p-4 loading-animation">Memuat riwayat login</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="page-data-siswa" class="content-page hidden">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800">Manajemen Data Siswa</h1>
                                <p class="mt-2 text-gray-600">Tambah, lihat, edit, atau hapus data siswa di sekolah Anda.</p>
                            </div>
                            <div class="flex space-x-2">
                                <button id="checkCompletenessBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors">Cek Kelengkapan Data</button>
                            </div>
                        </div>

                        <div class="mt-8 border-t pt-6">
                            <h2 class="text-xl font-bold text-gray-800">Import Data Siswa</h2>
                            <p class="mt-1 text-gray-600">Unggah data siswa secara massal menggunakan template Excel. <br>Wajib mengisi <b>NISN</b> dan <b>NAMA LENGKAP</b>, yang lain boleh dikosongkan.</p>
                            <div class="mt-4 flex flex-wrap items-center gap-4">
                                <button id="downloadTemplateBtn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Download Template</button>
                                <input type="file" id="siswaFileInput" class="hidden" accept=".xlsx, .xls, .csv">
                                <label for="siswaFileInput" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg cursor-pointer hover:bg-green-700">Pilih File...</label>
                                <span id="fileName" class="text-gray-500">Tidak ada file dipilih</span>
                                <button id="importSiswaBtn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Import Data</button>
                            </div>
                            <div id="importStatus" class="mt-4"></div>
                        </div>

                        <div id="student-quota-info" class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-800 flex flex-wrap items-center justify-center gap-x-6 gap-y-2">
                            </div>
                        
                        <div id="bulk-action-bar" class="hidden my-4 p-3 bg-blue-100 border border-blue-200 rounded-lg flex items-center justify-between flex-wrap gap-4">
                            <span id="selected-student-count" class="font-bold text-blue-800">0 siswa dipilih</span>
                            <div class="flex items-center gap-3">
                                <input type="number" id="bulk-tahun-lulus-input" placeholder="Tahun Lulus" class="p-2 border border-gray-300 rounded-md w-32">
                                <button id="bulk-update-tahun-lulus-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md text-sm">Update Tahun Lulus</button>
                                <button id="bulk-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-md text-sm">Hapus Terpilih</button>
                            </div>
                        </div>

                        <div class="flex justify-between items-center my-4 flex-wrap gap-4">
                            <div class="flex-grow max-w-lg">
                                <label for="searchSiswaInput" class="sr-only">Cari Siswa</label>
                                <div class="relative">
                                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                            <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <input type="text" id="searchSiswaInput" class="block w-full rounded-md border-gray-300 pl-10 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Cari Siswa (berdasarkan Nama atau NISN)...">
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button id="addStudentBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors">+ Tambah Siswa</button>
                                <button id="deleteAllStudentsBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors">Hapus Semua Siswa</button>
                            </div>
                        </div>

                        <div class="bg-white p-4 rounded-lg shadow-md mt-4">
                            <div id="siswaTableContainer" class="overflow-x-auto"></div>
                        </div>
                    </div>
                    
                    <div id="page-mapel" class="content-page hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
                            
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Pengaturan Bobot Nilai</h2>
                                <p class="mt-1 text-gray-600">Atur persentase bobot antara nilai ujian dan nilai rapor. Total keduanya harus 100%.</p>
                                <div class="mt-4 bg-white p-6 rounded-lg shadow-md">
                                    <form id="bobotForm">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                                            <div>
                                                <label for="bobotUjian" class="block text-sm font-medium text-gray-700">Bobot Nilai Ujian</label>
                                                <div class="mt-1 relative rounded-md shadow-sm">
                                                    <input type="number" id="bobotUjian" name="bobotUjian" min="0" max="100" class="w-full p-2 pr-8 border rounded-md" required>
                                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><span class="text-gray-500 sm:text-sm">%</span></div>
                                                </div>
                                            </div>
                                            <div>
                                                <label for="bobotRapor" class="block text-sm font-medium text-gray-700">Bobot Nilai Rapor</label>
                                                <div class="mt-1 relative rounded-md shadow-sm">
                                                    <input type="number" id="bobotRapor" name="bobotRapor" min="0" max="100" class="w-full p-2 pr-8 border rounded-md" required>
                                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><span class="text-gray-500 sm:text-sm">%</span></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-6 pt-4 border-t">
                                            <button type="submit" id="saveBobotBtn" class="bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400">Simpan Bobot</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Impor Mata Pelajaran</h2>
                                <p class="mt-1 text-gray-600">Impor mapel standar sesuai jenjang sekolah Anda.</p>
                                <div class="mt-4 p-6 bg-white rounded-lg shadow-md">
                                    <h3 class="font-semibold text-lg text-gray-800">Otomatis dari Sistem</h3>
                                    <p class="text-sm text-gray-500 mb-3">Impor daftar mata pelajaran standar sesuai dengan jenjang sekolah Anda (MI, MTS, atau MA). Kode mata pelajaran yang sudah ada akan dilewati secara otomatis.</p>
                                    <button id="importMapelSystemBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 w-full flex items-center justify-center disabled:bg-blue-400">
                                        <span id="importMapelSystemBtnText">Import Mapel by System</span>
                                        <span id="importMapelSystemSpinner" class="hidden loading-animation">Mengimpor</span>
                                    </button>
                                    <div id="importMapelStatus" class="mt-4"></div>
                                </div>
                            </div>

                        </div>

                        <div class="border-t pt-8">
                            
                            <div class="mb-8 flex justify-between items-center bg-white p-6 rounded-lg shadow-md">
                                <div>
                                    <h3 class="font-semibold text-lg text-gray-800">Manajemen Data</h3>
                                    <p class="text-sm text-gray-500">Tambah manual atau hapus semua data mapel.</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button id="addMapelBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">+ Tambah Mapel</button>
                                    <button id="deleteAllMapelBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">Hapus Semua Mapel</button>
                                </div>
                            </div>
                            
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">Daftar Mata Pelajaran Saat Ini</h2>
                                <div class="mb-6">
                                    <label for="searchMapelInput" class="block text-sm font-medium text-gray-700">Cari Mata Pelajaran</label>
                                    <div class="relative mt-1 rounded-md shadow-sm">
                                        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                                <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <input type="text" id="searchMapelInput" class="block w-full rounded-md border-gray-300 pl-10 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ketik kode atau nama mapel untuk mencari...">
                                    </div>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow-md mt-4">
                                    <div id="mapelTableContainer" class="overflow-x-auto"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="page-input-ujian" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Input Nilai Ujian</h1>
                        <p class="mt-2 text-gray-600 mb-8">Pilih jenis ujian yang akan diinput nilainya atau cek rata-rata.</p>
                        <div class="flex flex-wrap items-center gap-3 mb-8">
                            <button id="btn-show-ujian-madrasah" class="ujian-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors text-sm">Input Nilai Ujian Madrasah</button>
                            <button id="btn-show-ujian-praktek" class="ujian-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors text-sm">Input Nilai Ujian Praktek</button>
                            <button id="btn-cek-rata-ujian" class="ujian-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors text-sm">Cek Rata-Rata Nilai Ujian</button>
                            <button id="deleteAllUjianScoresBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors text-sm">Hapus Semua Nilai Ujian</button>
                        </div>
                        <div id="input-ujian-container"></div>
                    </div>
        
                    <div id="page-input-rapor" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Input Nilai Rapor</h1>
                        <div id="rapor-container" class="mt-4"></div>
                    </div>

                    <div id="page-validasi-nilai" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Validasi Kelengkapan Nilai</h1>
                        <p class="mt-2 text-gray-600 mb-8">Pilih mode validasi untuk memeriksa kelengkapan data nilai seluruh siswa.</p>
                        
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex flex-wrap items-center justify-center gap-4 border-b pb-6 mb-6">
                                <button id="validateBySheetBtn" class="validation-mode-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center space-x-2 text-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                    <span>Validasi per Jenis Ujian</span>
                                </button>
                                <button id="validateBySubjectBtn" class="validation-mode-btn bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center space-x-2 text-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
                                    <span>Validasi per Mata Pelajaran</span>
                                </button>
                            </div>
                            
                            <div id="validationResultContainer" class="mt-2">
                                <p class="text-center text-gray-500">Pilih salah satu mode validasi di atas untuk memulai.</p>
                            </div>
                        </div>
                    </div>

                    <div id="page-rekapitulasi" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Rekapitulasi Nilai Akhir</h1>
                        <p class="mt-2 text-gray-600 mb-8">Lihat ringkasan nilai ujian, rapor, dan nilai akhir ijazah.</p>
                        
                        <div id="rekap-loader" class="text-center p-8">
                            <p class="font-bold loading-animation">Mengumpulkan dan memproses semua data nilai</p>
                            <p>Silakan tunggu, ini mungkin memakan waktu beberapa saat.</p>
                        </div>
                        
                        <div id="rekap-content" class="hidden">
                            <div class="flex space-x-4 mb-8 border-b pb-4">
                                <button data-rekap="ujian" class="rekap-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Rekap Nilai Ujian</button>
                                <button data-rekap="rapor" class="rekap-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Rekap Nilai Rapor</button>
                                <button data-rekap="ijazah" class="rekap-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Rekap Nilai Ijazah</button>
                                <button id="updateRekapBtn" class="ml-auto bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center disabled:bg-green-400">
                                    <span id="updateRekapBtnText">Perbarui & Muat Ulang Data</span>
                                    <span id="updateRekapSpinner" class="hidden loading-animation">Memperbarui</span>
                                </button>
                            </div>
                            <div id="rekap-display-area">
                            </div>
                        </div>
        
                        <div id="rekap-setup" class="hidden text-center p-8 bg-yellow-100 rounded-lg">
                            <p class="font-bold text-yellow-800">Sheet Rekapitulasi belum dibuat.</p>
                            <p class="text-yellow-700 mt-2">Silakan klik tombol di bawah untuk membuat sheet yang diperlukan untuk menampilkan data rekapitulasi.</p>
                            <button id="createRekapSheetsBtn" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Buat Sheet Rekapitulasi</button>
                        </div>
                    </div>

                    <div id="page-update-info" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Informasi Pembaruan Aplikasi</h1>
                        <p class="mt-2 text-gray-600 mb-8">Berikut adalah riwayat perubahan dan fitur baru pada aplikasi.</p>

                        <div id="changelog-container" class="space-y-6">
                            </div>
                        <div class="mt-10 pt-6 border-t">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">Riwayat Perubahan (Changelog)</h2>
                                <div id="full-changelog-container" class="space-y-3">
                                    <p class="text-gray-500">Memuat riwayat versi...</p>
                                </div>
                        </div>
                    </div>

                    <div id="page-backup-restore" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Backup & Restore Data</h1>
                        <p class="mt-2 text-gray-600 mb-8">Amankan data Anda dengan membuat salinan, atau pulihkan data dari salinan yang ada.</p>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="space-y-8">
                                <div class="bg-white p-6 rounded-lg shadow-md border border-blue-200">
                                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        Buat Backup Baru
                                    </h2>
                                    <p class="mt-2 text-sm text-gray-600">Proses ini akan membuat salinan data Anda saat ini dan menghasilkan sebuah <b>**Kode Restore**</b> unik.</p>
                                    <div class="mt-4">
                                        <button id="createBackupBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center disabled:bg-gray-400">
                                            <span id="createBackupBtnText">Buat Backup Sekarang</span>
                                            <span id="createBackupSpinner" class="hidden loading-animation">Membuat Backup</span>
                                        </button>
                                    </div>
                                    <div id="newBackupCodeResult" class="mt-4"></div>
                                </div>

                                <div class="bg-white p-6 rounded-lg shadow-md border border-green-200">
                                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5" />
                                        </svg>
                                        Pulihkan dari Kode
                                    </h2>
                                    <p class="mt-2 text-sm text-gray-600">Masukkan Kode Restore untuk memulihkan data. <strong class="text-red-600">Perhatian:</strong> Ini akan menimpa semua data saat ini.</p>
                                    <div class="mt-4 flex items-center space-x-2">
                                        <input type="text" id="restore-code-input" placeholder="XXXX-YYYY" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm uppercase font-mono tracking-wider">
                                        <button id="restoreFromCodeBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Pulihkan</button>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Daftar Backup Tersimpan</h2>
                                <div id="backupListContainer" class="overflow-x-auto max-h-96 custom-scrollbar">
                                    <p class="text-center text-gray-500 py-4 loading-animation">Memuat daftar backup</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="page-ubah-password" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Ubah Password Akun</h1>
                        <p class="mt-2 text-gray-600 mb-8">Gunakan formulir ini untuk mengubah password Anda.</p>
                        <div class="bg-white p-8 rounded-lg shadow-md max-w-lg">
                            <form id="changePasswordForm">
                                <div class="space-y-6">
                                    <div>
                                        <label for="current-password" class="block text-sm font-medium text-gray-700">Password Saat Ini</label>
                                        <div class="relative mt-1">
                                            <input type="password" id="current-password" class="w-full p-2 pr-10 border rounded-md" required>
                                            <button type="button" data-toggle-password="current-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="new-password-change" class="block text-sm font-medium text-gray-700">Password Baru</label>
                                        <div class="relative mt-1">
                                            <input type="password" id="new-password-change" class="w-full p-2 pr-10 border rounded-md" required>
                                            <button type="button" data-toggle-password="new-password-change" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                            </button>
                                        </div>
                                        <div id="change-password-req" class="text-xs space-y-1 mt-2"></div>
                                    </div>
                                    <div>
                                        <label for="confirm-password-change" class="block text-sm font-medium text-gray-700">Konfirmasi Password Baru</label>
                                        <div class="relative mt-1">
                                            <input type="password" id="confirm-password-change" class="w-full p-2 pr-10 border rounded-md" required>
                                            <button type="button" data-toggle-password="confirm-password-change" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                            </button>
                                        </div>
                                        <div id="change-confirm-msg" class="text-red-600 text-xs mt-1 h-4 font-medium"></div>
                                    </div>
                                </div>
                                <div class="mt-8 pt-5 border-t">
                                    <button type="submit" id="changePasswordBtn" class="w-full flex justify-center py-2 px-8 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                                        <span id="changePasswordBtnText">Ubah Password</span>
                                        <span id="changePasswordSpinner" class="hidden loading-animation">Menyimpan</span>
                                    </button>
                                </div>
                            </form>
                            <div id="changePasswordStatusMessage" class="mt-6 text-center"></div>
                        </div>
                    </div>

                    <div id="page-pengajuan" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Pengajuan Perubahan Data</h1>
                        <p class="mt-2 text-gray-600 mb-8">Gunakan form ini jika Anda ingin mengubah Jenjang atau Nama Sekolah Anda. Pengajuan akan ditinjau oleh Superadmin.</p>
                        
                        <div class="bg-white p-8 rounded-lg shadow-md max-w-4xl mx-auto">

                            <div class="mb-6 pb-6 border-b">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">Data Saat Ini</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <label class="block font-medium text-gray-500">Jenjang Sekolah</label>
                                        <p id="currentJenjang" class="mt-1 text-gray-900 font-bold text-base">-</p>
                                    </div>
                                    <div>
                                        <label class="block font-medium text-gray-500">Nama Sekolah</label>
                                        <p id="currentNamaSekolah" class="mt-1 text-gray-900 font-bold text-base">-</p>
                                    </div>
                                </div>
                            </div>

                            <form id="pengajuanForm">
                                <h2 class="text-xl font-semibold text-gray-700 mb-4">Form Pengajuan Data Baru</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                    <div>
                                        <label for="newJenjang" class="block text-sm font-medium text-gray-700">Ubah Jenjang ke</label>
                                        <select id="newJenjang" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm">
                                            <option value="">-- Biarkan Jika Tidak Diubah --</option>
                                            <option value="MI">MI (Madrasah Ibtidaiyah)</option>
                                            <option value="MTS">MTS (Madrasah Tsanawiyah)</option>
                                            <option value="MA">MA (Madrasah Aliyah)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="newNamaSekolah" class="block text-sm font-medium text-gray-700">Ubah Nama Sekolah ke</label>
                                        <input type="text" id="newNamaSekolah" placeholder="Kosongkan jika tidak diubah" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                                    </div>
                                </div>
                                
                                <div class="mt-8 pt-5 border-t flex items-center justify-between flex-wrap gap-4">
                                    <button type="submit" id="submitPengajuanBtn" class="order-1 flex justify-center py-2 px-8 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                        <span id="pengajuanBtnText">Ajukan Perubahan</span>
                                        <span id="pengajuanSpinner" class="hidden loading-animation">Mengajukan</span>
                                    </button>
                                    <div id="currentAjuanStatusContainer" class="order-2 flex-grow text-right">
                                        </div>
                                </div>
                            </form>

                        </div>

                        <div id="ajuanHistoryContainer" class="max-w-4xl mx-auto mt-10">
                            </div>
                    </div>

                    <div id="page-admin-tools" class="content-page hidden p-4 sm:p-6 lg:p-8">
                        <div class="max-w-4xl mx-auto">
                            <div class="flex items-center mb-6">
                                <svg class="w-8 h-8 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                <h1 class="text-3xl font-bold text-gray-800">Alat Superadmin</h1>
                            </div>

                            <div class="space-y-8">
                                <div class="bg-white p-6 rounded-lg shadow-md border border-red-200">
                                    <h2 class="text-xl font-bold text-gray-800 mb-2">Pulihkan Data Pengguna dari Kode Unik</h2>
                                    <p class="text-sm text-gray-600 mb-4">
                                        Gunakan fitur ini untuk menimpa data pengguna dengan data dari file backup. 
                                        <strong class="text-red-600">Hati-hati, tindakan ini tidak bisa dibatalkan!</strong>
                                    </p>
                                    <div class="space-y-4">
                                        <div>
                                            <label for="admin-restore-code" class="block text-sm font-medium text-gray-700">Kode Restore Unik</label>
                                            <input type="text" id="admin-restore-code" placeholder="Contoh: ABCD-1234" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm uppercase font-mono">
                                        </div>
                                        <div>
                                            <label for="admin-restore-target-id-new" class="block text-sm font-medium text-gray-700">ID Spreadsheet Tujuan (Yang akan ditimpa)</label>
                                            <input type="text" id="admin-restore-target-id-new" placeholder="Masukkan ID Spreadsheet pengguna" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                        </div>
                                        <button id="adminRestoreFromCodeBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                            Lakukan Restore dari Kode
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="page-kelola-update" class="content-page hidden">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800">Kelola Info & Update</h1>
                                <p class="mt-2 text-gray-600">Tambah, edit, atau hapus daftar versi aplikasi.</p>
                            </div>
                            <button id="addVersionBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">+ Tambah Versi Baru</button>
                        </div>
                        <div id="versionsTableContainer" class="bg-white p-4 rounded-lg shadow-md mt-8 overflow-x-auto">
                            </div>
                    </div>

                    <div id="version-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
                        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl transform scale-95 flex flex-col max-h-[90vh]">
                            <div class="flex-shrink-0 flex justify-between items-center border-b p-6">
                                <h2 id="version-modal-title" class="text-2xl font-bold text-gray-800">Tambah Versi Baru</h2>
                                <button id="closeVersionModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                            </div>
                            <form id="versionForm" class="flex flex-col flex-grow min-h-0">
                                <div class="flex-grow overflow-y-auto p-6 space-y-4">
                                    <input type="hidden" id="versionRow" name="row">
                                    <div>
                                        <label for="versionNumber" class="block text-sm font-medium text-gray-700">Nomor Versi</label>
                                        <input type="text" id="versionNumber" name="version" class="mt-1 w-full p-2 border rounded-md" placeholder="Contoh: 4.1.0" required>
                                    </div>
                                    <div>
                                        <label for="releaseDate" class="block text-sm font-medium text-gray-700">Tanggal Rilis</label>
                                        <input type="date" id="releaseDate" name="releaseDate" class="mt-1 w-full p-2 border rounded-md" required>
                                    </div>
                                    <div>
                                        <label for="changelog" class="block text-sm font-medium text-gray-700">Catatan Perubahan (pisahkan tiap poin dengan baris baru)</label>
                                        <textarea id="changelog" name="changelog" rows="8" class="mt-1 w-full p-2 border rounded-md" placeholder="- Menambahkan fitur A&#10;- Memperbaiki bug B" required></textarea>
                                    </div>
                                </div>
                                <div class="flex-shrink-0 mt-auto p-6 border-t flex justify-end">
                                    <button type="button" id="cancelVersionBtn" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-md mr-3">Batal</button>
                                    <button type="submit" id="saveVersionBtn" class="bg-blue-600 text-white py-2 px-6 rounded-md flex items-center justify-center w-28 h-10 transition-all duration-200">
                                        <span class="btn-text">Simpan</span>
                                        <span class="btn-spinner hidden">
                                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        </span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <footer class="text-center py-4 mt-8 border-t">
                    <a href="https://wa.me/qr/FMVS3NLDIRUAA1" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-500 hover:text-blue-600 transition-colors">
                      &copy; <span id="currentYearApp"></span> Created by Syamsul Bahri
                    </a>
                </footer>
            </main>
        </div>
    </div>
    
    <div id="siswa-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95 flex flex-col max-h-[90vh]">
          
            <div class="flex-shrink-0 flex justify-between items-center border-b pb-3 mb-5 px-6 pt-6">
                <h2 id="siswa-modal-title" class="text-2xl font-bold text-gray-800">Tambah Siswa Baru</h2>
                <button id="closeSiswaModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>

            <form id="siswaForm" class="flex flex-col flex-grow min-h-0">

                <div class="flex-grow overflow-y-auto px-6">
                    <input type="hidden" id="studentRow" name="studentRow">

                    <div class="space-y-4">
                        <div>
                            <label for="nama" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                            <input type="text" id="nama" name="nama" class="mt-1 w-full p-2 border rounded-md" required>
                        </div>

                        <div>
                            <label for="nisn" class="block text-sm font-medium text-gray-700">NISN</label>
                            <input type="text" id="nisn" name="nisn" class="mt-1 w-full p-2 border rounded-md" required>
                            <div id="nisn-error-msg" class="text-red-600 text-sm mt-1 h-4"></div>
                        </div>
                        
                        <div>
                            <label for="nis" class="block text-sm font-medium text-gray-700">
                                NIS 
                                <span class="text-xs text-gray-500">(2 digit thn masuk, 4 digit no. urut)</span>
                            </label>
                            <input type="text" id="nis" name="nis" class="mt-1 w-full p-2 border rounded-md" placeholder="Contoh: 210001">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="jenisKelamin" class="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
                                <select id="jenisKelamin" name="jenisKelamin" class="mt-1 w-full p-2 border rounded-md bg-white" required>
                                    <option value="" disabled selected>-- Pilih --</option>
                                    <option value="L">Laki-laki</option>
                                    <option value="P">Perempuan</option>
                                </select>
                            </div>
                            <div>
                                <label for="tempatLahir" class="block text-sm font-medium text-gray-700">Tempat Lahir</label>
                                <input type="text" id="tempatLahir" name="tempatLahir" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                        </div>
                        
                        <div>
                            <label for="tanggalLahir" class="block text-sm font-medium text-gray-700">Tanggal Lahir</label>
                            <input type="date" id="tanggalLahir" name="tanggalLahir" class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        
                        <div>
                            <label for="alamatSiswa" class="block text-sm font-medium text-gray-700">Alamat Lengkap Siswa</label>
                            <textarea id="alamatSiswa" name="alamat" rows="3" class="mt-1 w-full p-2 border rounded-md"></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="teleponSiswa" class="block text-sm font-medium text-gray-700">Nomor Telepon</label>
                                <input type="tel" id="teleponSiswa" name="telepon" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="emailSiswa" class="block text-sm font-medium text-gray-700">Email Siswa</label>
                                <input type="email" id="emailSiswa" name="emailSiswa" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="tahunMasuk" class="block text-sm font-medium text-gray-700">Tahun Masuk</label>
                                <input type="number" id="tahunMasuk" name="tahunMasuk" placeholder="Contoh: 2021" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="tahunLulus" class="block text-sm font-medium text-gray-700">Tahun Lulus</label>
                                <input type="number" id="tahunLulus" name="tahunLulus" placeholder="Contoh: 2024" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 mt-auto pt-4 border-t flex justify-end px-6 pb-6">
                    <button type="button" id="cancelSiswaBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md mr-3 hover:bg-gray-300">Batal</button>
                    <button type="submit" id="saveSiswaBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="mapel-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl transform scale-95 flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0 flex justify-between items-center border-b p-6">
                <h2 id="mapel-modal-title" class="text-2xl font-bold text-gray-800">Tambah Mata Pelajaran Massal</h2>
                <button id="closeMapelModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-6">
                <p class="text-sm text-gray-600 mb-4">Masukkan data untuk satu atau beberapa mata pelajaran di bawah. Klik "+ Tambah Baris" untuk menambahkan lebih banyak.</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-100 text-sm">
                            <tr>
                                <th class="p-2 text-left w-1/5">Kode Mapel</th>
                                <th class="p-2 text-left w-2/5">Nama Mata Pelajaran</th>
                                <th class="p-2 text-left w-1/5">Kelompok</th>
                                <th class="p-2 text-left w-1/5">Jenis Ujian</th>
                                <th class="p-2 w-12">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="mapel-input-tbody">
                            </tbody>
                    </table>
                </div>
                <button type="button" id="addMapelRowBtn" class="mt-4 bg-gray-200 text-gray-700 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg text-sm">
                    + Tambah Baris
                </button>
            </div>

            <div class="flex-shrink-0 mt-auto p-6 border-t flex justify-end">
                <button type="button" id="cancelMapelBtn" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-md mr-3 hover:bg-gray-400">Batal</button>
                <button type="button" id="saveAllMapelBtn" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">
                    <span id="saveAllMapelBtnText">Simpan Semua</span>
                    <span id="saveAllMapelSpinner" class="hidden loading-animation">Menyimpan</span>
                </button>
            </div>

        </div>
    </div>

    <div id="export-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl transform scale-95 flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0 flex justify-between items-center border-b p-6">
                <h2 class="text-2xl font-bold text-gray-800">Input Data untuk Ekspor</h2>
                <button id="closeExportModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>

            <form id="exportForm" class="flex-grow contents">
                
                <div class="flex-grow overflow-y-auto p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div>
                            <label for="exportNamaSekolah" class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                            <input type="text" id="exportNamaSekolah" class="mt-1 w-full p-2 border bg-gray-100 rounded-md" readonly>
                            
                            <label for="exportTahunAjaran" class="block text-sm font-medium text-gray-700 mt-4">Tahun Ajaran</label>
                            <select id="exportTahunAjaran" class="mt-1 w-full p-2 border rounded-md bg-white"></select>
                            
                            <label for="exportTempatTTD" class="block text-sm font-medium text-gray-700 mt-4">Tempat Tanda Tangan</label>
                            <input type="text" id="exportTempatTTD" placeholder="Contoh: Bulukumba" class="mt-1 w-full p-2 border rounded-md">

                            <label for="exportTanggalTTD" class="block text-sm font-medium text-gray-700 mt-4">Tanggal Tanda Tangan</label>
                            <input type="date" id="exportTanggalTTD" class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="exportTipeKamad" class="block text-sm font-medium text-gray-700">Tipe Kepala Madrasah</label>
                            <select id="exportTipeKamad" class="mt-1 w-full p-2 border rounded-md bg-white">
                                <option>Kepala Madrasah</option>
                                <option>Plt. Kepala Madrasah</option>
                            </select>

                            <label for="exportNamaKamad" class="block text-sm font-medium text-gray-700 mt-4">Nama Kepala Madrasah</label>
                            <input type="text" id="exportNamaKamad" class="mt-1 w-full p-2 border bg-gray-100 rounded-md" readonly>

                            <label for="exportNip" class="block text-sm font-medium text-gray-700 mt-4">NIP</label>
                            <input type="text" id="exportNip" class="mt-1 w-full p-2 border bg-gray-100 rounded-md" readonly>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 mt-auto p-6 border-t flex flex-wrap justify-end gap-3">
                    <button type="button" id="cancelExportBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="button" id="generateExcelBtn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span class="btn-text">Unduh Excel</span>
                        <span class="btn-spinner hidden loading-animation">Memproses</span>
                    </button>
                    <button type="button" id="generatePdfBtn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="btn-text">Unduh PDF</span>
                        <span class="btn-spinner hidden loading-animation">Memproses</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="forgot-password-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95 flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0 flex justify-between items-center border-b px-6 pt-6 pb-3">
                <h2 class="text-2xl font-bold text-gray-800">Reset Password</h2>
                <button id="closeForgotPasswordModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>

            <form id="forgotPasswordForm" class="flex-grow overflow-y-auto p-6">
                
                <div id="fp-step-1" class="space-y-4">
                    <p class="text-sm text-gray-600">Masukkan alamat email Anda yang terdaftar untuk menerima kode verifikasi (OTP).</p>
                    <div>
                        <label for="fp-email" class="block text-sm font-medium text-gray-700">Alamat Email</label>
                        <input type="email" id="fp-email" name="fp-email" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <button type="button" id="fp-send-otp-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">
                        <span class="btn-text">Kirim Kode OTP</span>
                        <span class="btn-spinner hidden loading-animation">Mengirim</span>
                    </button>
                </div>

                <div id="fp-step-2" class="space-y-4 hidden">
                    <p class="text-sm text-gray-600">Kode OTP telah dikirim. Silakan cek email Anda dan masukkan kode serta password baru Anda.</p>
                    <div>
                        <label for="fp-otp" class="block text-sm font-medium text-gray-700">Kode OTP (6 digit)</label>
                        <input type="text" id="fp-otp" name="fp-otp" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="fp-new-password" class="block text-sm font-medium text-gray-700">Password Baru</label>
                        <div class="relative mt-1">
                            <input type="password" id="fp-new-password" name="fp-new-password" class="w-full p-2 pr-10 border rounded-md" required>
                            <button type="button" data-toggle-password="fp-new-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                            </button>
                        </div>
                        <div id="fp-password-req" class="text-xs space-y-1 mt-2"></div>
                    </div>
                    <div>
                        <label for="fp-confirm-password" class="block text-sm font-medium text-gray-700">Konfirmasi Password Baru</label>
                        <div class="relative mt-1">
                            <input type="password" id="fp-confirm-password" name="fp-confirm-password" class="w-full p-2 pr-10 border rounded-md" required>
                        </div>
                        <div id="fp-confirm-msg" class="text-red-600 text-xs mt-1 h-4 font-medium"></div>
                    </div>
                    <button type="submit" id="fp-reset-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">
                        <span class="btn-text">Reset Password</span>
                        <span class="btn-spinner hidden loading-animation">Memproses</span>
                    </button>
                </div>
            </form>

            <div id="fp-status-message" class="flex-shrink-0 px-6 pb-4 text-center text-sm"></div>
        </div>
    </div>

    <div id="update-confirm-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 transform scale-95">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-5">Konfirmasi Pembaruan Data Siswa</h2>
            <p class="mb-4 text-yellow-800 bg-yellow-100 p-3 rounded-md">NISN <strong id="conflictNisn"></strong> sudah ada dengan data yang berbeda. Apakah Anda ingin memperbaruinya?</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-bold text-lg text-gray-700 mb-2">Data Lama</h3>
                    <div id="old-data-display" class="space-y-2 text-sm p-4 bg-gray-50 rounded-md border"></div>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-green-700 mb-2">Data Baru</h3>
                    <div id="new-data-display" class="space-y-2 text-sm p-4 bg-green-50 rounded-md border border-green-200"></div>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t flex justify-end space-x-3">
                <button id="cancelUpdateBtn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400">Batal</button>
                <button id="confirmUpdateBtn" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ya, Update Data</button>
            </div>
        </div>
    </div>

    <div id="conflict-detail-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 transform scale-95">
            <div class="flex justify-between items-center border-b pb-3 mb-5">
                <h2 class="text-2xl font-bold text-gray-800">Detail Perubahan Data Siswa</h2>
                <button id="closeConflictDetailModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            
            <p class="mb-4">Berikut adalah perbandingan data lama yang tersimpan di sistem dengan data baru dari file yang Anda unggah. Perbedaan data ditandai dengan latar belakang kuning.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow overflow-y-auto pr-2 custom-scrollbar">
                <div>
                    <h3 class="font-bold text-lg text-gray-700 mb-2">Data Lama (di Sistem)</h3>
                    <div id="conflict-old-data" class="space-y-2 text-sm p-4 bg-gray-50 rounded-md border"></div>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-green-700 mb-2">Data Baru (dari File)</h3>
                    <div id="conflict-new-data" class="space-y-2 text-sm p-4 bg-green-50 rounded-md border border-green-200"></div>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t flex justify-end">
                <button id="closeConflictDetailModalBtn2" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Tutup</button>
            </div>
        </div>
    </div>

    <div id="completeness-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-5xl transform scale-95 flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0 flex justify-between items-center border-b p-4 sm:p-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Kelengkapan Data Siswa</h2>
                <button id="closeCompletenessModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>

            <div class="flex-grow p-4 sm:p-6 overflow-y-auto custom-scrollbar">
                <p class="text-sm text-gray-600 mb-4">Tabel ini menunjukkan field data mana yang sudah terisi (✅) dan mana yang masih kosong (❌). Klik ikon untuk melihat data asli.</p>
                
                <div class="bg-gray-50 p-4 rounded-lg mb-4 flex flex-wrap items-center justify-between gap-4">
                    <div id="completeness-summary" class="text-sm font-medium text-gray-700">
                        </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="completeness-filter-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="completeness-filter-checkbox" class="ml-2 block text-sm text-gray-900">
                                Hanya tampilkan yang tidak lengkap
                            </label>
                        </div>
                        <select id="completeness-sort-select" class="block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm bg-white">
                            <option value="name_asc">Urutkan berdasarkan Nama (A-Z)</option>
                            <option value="missing_desc">Urutkan berdasarkan Data Kosong (Terbanyak)</option>
                        </select>
                    </div>
                </div>

                <div id="completeness-table-container">
                    </div>
            </div>

            <div class="flex-shrink-0 mt-auto pt-4 border-t flex justify-end p-4 sm:p-6">
                <button type="button" id="closeCompletenessModalBtn2" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Tutup</button>
            </div>
        </div>
    </div>

    <div id="edit-mapel-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95 flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0 flex justify-between items-center border-b p-6">
                <h2 id="edit-mapel-modal-title" class="text-2xl font-bold text-gray-800">Edit Mata Pelajaran</h2>
                <button id="closeEditMapelModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            
            <form id="editMapelForm" class="flex flex-col flex-grow min-h-0">
                <div class="flex-grow overflow-y-auto p-6">
                    <input type="hidden" id="mapelRowEdit" name="mapelRow">
                    <div class="space-y-4">
                        <div>
                            <label for="kodeEdit" class="block text-sm font-medium text-gray-700">Kode Mata Pelajaran (Tidak bisa diubah)</label>
                            <input type="text" id="kodeEdit" name="kode" class="mt-1 w-full p-2 border rounded-md bg-gray-100" readonly>
                        </div>
                        <div>
                            <label for="namaMapelEdit" class="block text-sm font-medium text-gray-700">Nama Mata Pelajaran</label>
                            <input type="text" id="namaMapelEdit" name="nama" class="mt-1 w-full p-2 border rounded-md" required>
                        </div>
                        <div>
                            <label for="kelompokEdit" class="block text-sm font-medium text-gray-700">Kelompok</label>
                            <select id="kelompokEdit" name="kelompok" class="mt-1 w-full p-2 border rounded-md bg-white">
                                <option>Umum</option>
                                <option>Peminatan</option>
                                <option>Muatan Lokal</option>
                            </select>
                        </div>
                        <div class="pt-2">
                            <label class="block text-sm font-medium text-gray-700">Jenis Ujian</label>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center"><input type="radio" id="jenisUjianMadrasahEdit" name="jenisUjian" value="Ujian Madrasah" class="h-4 w-4 text-blue-600 border-gray-300"><label for="jenisUjianMadrasahEdit" class="ml-3 block text-sm text-gray-900">Ujian Madrasah Saja</label></div>
                                <div class="flex items-center"><input type="radio" id="jenisUjianPraktekEdit" name="jenisUjian" value="Ujian Praktek" class="h-4 w-4 text-blue-600 border-gray-300"><label for="jenisUjianPraktekEdit" class="ml-3 block text-sm text-gray-900">Ujian Praktek Saja</label></div>
                                <div class="flex items-center"><input type="radio" id="jenisKeduanyaEdit" name="jenisUjian" value="Keduanya" class="h-4 w-4 text-blue-600 border-gray-300"><label for="jenisKeduanyaEdit" class="ml-3 block text-sm text-gray-900">Keduanya (Madrasah & Praktek)</label></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 mt-auto p-6 border-t flex justify-end">
                    <button type="button" id="cancelEditMapelBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md mr-3 hover:bg-gray-300">Batal</button>
                    <button type="submit" id="saveEditMapelBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-user-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95">
            <div class="flex justify-between items-center border-b p-6">
                <h2 id="edit-user-modal-title" class="text-2xl font-bold text-gray-800">Edit Akun Pengguna</h2>
                <button id="closeEditUserModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <form id="editUserForm" class="p-6">
                <input type="hidden" id="edit-user-row">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email (Tidak bisa diubah)</label>
                        <input type="email" id="edit-user-email" class="mt-1 w-full p-2 border rounded-md bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="edit-user-namasekolah" class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                        <input type="text" id="edit-user-namasekolah" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="edit-user-jenjang" class="block text-sm font-medium text-gray-700">Jenjang</label>
                        <select id="edit-user-jenjang" class="mt-1 w-full p-2 border rounded-md bg-white" required>
                            <option value="MI">MI</option>
                            <option value="MTS">MTS</option>
                            <option value="MA">MA</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 pt-4 border-t flex justify-end">
                    <button type="button" id="cancelEditUserBtn" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-md mr-3">Batal</button>
                    <button type="submit" id="saveEditUserBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="type-to-confirm-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[51]">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95 p-6">
            <h2 id="confirm-modal-title" class="text-2xl font-bold text-red-700">Konfirmasi Penghapusan</h2>
            <div id="confirm-modal-body" class="mt-4 text-gray-600">
                </div>
            
            <p class="mt-4 text-sm">Untuk melanjutkan, ketik frasa <code class="bg-gray-200 text-red-700 font-bold p-1 rounded">HAPUS SEMUA</code> di kolom di bawah ini.</p>
            
            <input type="text" id="confirm-modal-input" class="mt-2 w-full p-2 border border-gray-400 rounded-md" autocomplete="off">
            
            <div class="mt-6 pt-4 border-t flex justify-end space-x-3">
                <button id="confirm-modal-cancel-btn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400">Batal</button>
                <button id="confirm-modal-action-btn" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700 disabled:bg-red-300 disabled:cursor-not-allowed">
                    Konfirmasi & Hapus
                </button>
            </div>
        </div>
    </div>

    <div id="status-info-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-[70]">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm transform scale-95 text-center p-6">
            <div id="status-info-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                </div>
            <h3 id="status-info-title" class="mt-5 text-xl font-bold text-gray-900">Judul Status</h3>
            <p id="status-info-message" class="mt-2 text-sm text-gray-600">Pesan status akan muncul di sini.</p>
            <div class="mt-6">
                <button type="button" id="status-info-close-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 sm:text-sm">
                    OK, Mengerti
                </button>
            </div>
        </div>
    </div>

    <div id="rejection-notes-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[52]">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95 p-6">
            <h2 class="text-2xl font-bold text-gray-800">Alasan Penolakan</h2>
            <p class="mt-2 text-sm text-gray-600">Harap berikan alasan mengapa pengajuan ini ditolak. Alasan ini akan dapat dilihat oleh pengguna.</p>
            
            <textarea id="rejection-notes-textarea" class="mt-4 w-full h-24 p-2 border border-gray-300 rounded-md" placeholder="Contoh: Nama sekolah tidak sesuai dengan data referensi."></textarea>
            
            <div class="mt-6 pt-4 border-t flex justify-end space-x-3">
                <button id="cancel-rejection-btn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400">Batal</button>
                <button id="confirm-rejection-btn" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700">
                    Tolak Pengajuan
                </button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[55]">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95 p-6 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                <svg class="h-6 w-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h2 id="confirm-custom-title" class="text-2xl font-bold text-gray-800">Judul Konfirmasi</h2>
            <p id="confirm-custom-body" class="mt-2 text-gray-600">Pesan konfirmasi akan muncul di sini.</p>
            
            <div class="mt-6 flex justify-center space-x-4">
                <button id="confirm-custom-cancel-btn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400 font-medium">
                    Batal
                </button>
                <button id="confirm-custom-action-btn" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700 font-medium">
                    Ya, Lanjutkan
                </button>
            </div>
        </div>
    </div>

    <div id="mapel-import-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl transform scale-95 flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0 flex justify-between items-center border-b p-6">
                <h2 class="text-2xl font-bold text-gray-800">Pilih Mata Pelajaran untuk Diimpor</h2>
                <button id="closeMapelImportModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            
            <div id="mapel-import-list" class="flex-grow overflow-y-auto p-6">
                <p class="text-center text-gray-500 loading-animation">Memuat daftar mata pelajaran</p>
            </div>

            <div class="flex-shrink-0 mt-auto p-6 border-t flex justify-between items-center">
                <div>
                    <input type="checkbox" id="selectAllMapelImport" class="h-4 w-4 rounded border-gray-300">
                    <label for="selectAllMapelImport" class="ml-2 text-sm font-medium text-gray-700">Pilih Semua</label>
                </div>
                <div>
                    <button type="button" id="cancelMapelImportBtn" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-md mr-3">Batal</button>
                    <button type="button" id="importSelectedMapelBtn" class="bg-blue-600 text-white py-2 px-6 rounded-md">
                        <span class="btn-text">Impor yang Dipilih</span>
                        <span class="btn-spinner hidden loading-animation">Mengimpor</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="missing-details-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[60]">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95 flex flex-col max-h-[90vh]">
            <div class="flex-shrink-0 flex justify-between items-center border-b p-4 sm:p-6">
                <h2 id="missing-details-title" class="text-xl sm:text-2xl font-bold text-gray-800">Detail Nilai Kosong</h2>
                <button id="closeMissingDetailsBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="missing-details-list" class="flex-grow p-4 sm:p-6 overflow-y-auto custom-scrollbar">
                </div>
            <div class="flex-shrink-0 mt-auto pt-4 border-t flex justify-end p-4 sm:p-6">
                <button type="button" id="closeMissingDetailsBtn2" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Tutup</button>
            </div>
        </div>
    </div>

    <div id="undo-redo-container" class="hidden fixed top-1/2 right-5 transform -translate-y-1/2 z-50 flex flex-col space-y-2">
        <button id="edit-scores-floating-btn" title="Ubah Mode Edit" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:bg-gray-100 hover:text-blue-600 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
            </svg>
        </button>
        <button id="undo-btn" title="Undo (Ctrl+Z)" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:bg-gray-100 hover:text-blue-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 016 6v3" />
            </svg>
        </button>
        <button id="redo-btn" title="Redo (Ctrl+Y)" class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center text-gray-600 hover:bg-gray-100 hover:text-blue-600 transition disabled:opacity-50 disabled:cursor-not-allowed">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 15l6-6m0 0l-6-6m6 6H9a6 6 0 00-6 6v3" />
            </svg>
        </button>
    </div>

    <div id="restore-confirm-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[51]">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95 p-6">
            <h2 class="text-2xl font-bold text-red-700">Konfirmasi Pemulihan Data</h2>
            <div id="restore-confirm-body" class="mt-4 text-gray-600">
                <p>Tindakan ini akan <strong class="text-red-600">MENGHAPUS SEMUA DATA ANDA SAAT INI</strong> dan menggantinya dengan data dari backup:</p>
                <p id="restore-backup-name" class="font-bold my-2 text-center bg-gray-100 p-2 rounded"></p>
                <p>Tindakan ini tidak dapat dibatalkan.</p>
            </div>
            
            <p class="mt-4 text-sm">Untuk melanjutkan, ketik nama sekolah Anda "<strong id="restore-confirm-school-name" class="text-blue-600"></strong>" di kolom di bawah ini.</p>
            
            <input type="text" id="restore-confirm-input" class="mt-2 w-full p-2 border border-gray-400 rounded-md" autocomplete="off">
            
            <div class="mt-6 pt-4 border-t flex justify-end space-x-3">
                <button id="restore-confirm-cancel-btn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400">Batal</button>
                <button id="restore-confirm-action-btn" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700 disabled:bg-red-300 disabled:cursor-not-allowed">
                    Pulihkan Data
                </button>
            </div>
        </div>
    </div>

    <div id="changelog-popup-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[70]">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-xl leading-6 font-bold text-gray-900" id="changelog-popup-title">Pembaruan Aplikasi!</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-600">
                                Aplikasi telah diperbarui ke <strong id="changelog-popup-version"></strong> pada tanggal <strong id="changelog-popup-date"></strong>. Berikut adalah ringkasan perubahannya:
                            </p>
                            <ul id="changelog-popup-list" class="mt-3 list-disc list-inside text-sm text-gray-700 space-y-1">
                                </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button type="button" id="changelog-popup-close-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    OK, Saya Mengerti
                </button>
            </div>
        </div>
    </div>

    <div id="transcript-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl transform scale-95 flex flex-col max-h-[95vh]">
            <div class="flex-shrink-0 flex justify-between items-center border-b p-4">
                <h2 class="text-xl font-bold text-gray-800">Transkrip Nilai Siswa</h2>
                <div>
                    <button id="printTranscriptBtn" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-md hover:bg-blue-700 transition-colors text-sm">Cetak / Simpan PDF</button>
                    <button id="closeTranscriptModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl ml-4">&times;</button>
                </div>
            </div>
            
            <div id="transcript-content-container" class="flex-grow overflow-y-auto">
                <div id="transcript-loader" class="text-center p-10">
                    <p class="loading-animation text-lg">Memuat data siswa...</p>
                </div>
                <div id="transcript-printable-area" class="hidden">
                    </div>
            </div>
        </div>
    </div>

    <div id="data-viewer-tooltip" class="hidden absolute z-50 px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm"></div>
    <div id="globalStatusMessage"></div>

    <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center text-center z-[9999] p-4">
      <h2 id="overlay-title" class="text-2xl font-bold text-gray-800">Memproses Permintaan Anda</h2>
      <p id="overlay-subtitle" class="mt-2 text-gray-600">Mohon tunggu dan jangan menutup jendela ini...</p>
      
      <div id="overlay-button-container" class="mt-6"></div>
    </div>

    <!-- Tambahkan library Chart.js di dalam <head> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>

    <script>
        let isChangelogLoaded = false; 
        // Global variable to hold the user's spreadsheet ID and chart instance
        let userSpreadsheetId = null;
        let allStudentsData = [];
        let inactivityTimer;
        let mapelChartInstance = null; // Untuk menyimpan instance grafik
        // [BARU] Tambahkan variabel untuk grafik rata-rata
        let ujianChartInstance = null;
        let raporChartInstance = null;
        let ijazahChartInstance = null;
        let examScoreShareChartInstance = null; // Nama variabel diubah
        let ijazahRankingChartInstance = null; // [BARU]
        let currentImportConflicts = [];
        // Variabel global untuk menyimpan data siswa yang sudah diproses
        let processedStudents = [];
        let allMapelData = [];
        let saveOrderTimer;
        // Letakkan ini di dekat variabel global lainnya
        let undoHistory = [];
        let redoHistory = [];
        let isUndoingOrRedoing = false; // Flag penting untuk mencegah feedback loop
        let currentFocusedInput = null; // Menyimpan nilai input saat difokus
        // Letakkan ini di dekat variabel global lainnya
        let isSelecting = false;
        let startCell = null;
        const selectedCells = new Set();
        let activeTableKey = null; 
        let selectedStudentRows = new Set();

        // Fungsi ini akan mengatur tahun saat ini pada elemen footer
        function setFooterYear() {
            const currentYear = new Date().getFullYear();
            const yearAuthSpan = document.getElementById('currentYearAuth');
            const yearAppSpan = document.getElementById('currentYearApp');
            if (yearAuthSpan) yearAuthSpan.textContent = currentYear;
            if (yearAppSpan) yearAppSpan.textContent = currentYear;
        }

        document.addEventListener('DOMContentLoaded', function() {
            setFooterYear();

            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const logoutButton = document.getElementById('logoutButton');
            const showSignupBtn = document.getElementById('show-signup');
            const showLoginBtn = document.getElementById('show-login');
            const requestOtpButton = document.getElementById('requestOtpButton'); // Tombol baru

            // Logika pengecekan sesi saat halaman dimuat
            const storedSpreadsheetId = sessionStorage.getItem('userSpreadsheetId');
            const storedRole = sessionStorage.getItem('userRole');

            if (storedRole === 'Superadmin') {
                // Jika peran yang tersimpan adalah Superadmin, langsung inisialisasi UI Superadmin
                document.getElementById('auth-wrapper').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                initializeSuperadminApp();
            } else if (storedSpreadsheetId) {
                // Jika ada spreadsheetId, berarti ini pengguna biasa, inisialisasi UI normal
                userSpreadsheetId = storedSpreadsheetId;
                const lastPage = sessionStorage.getItem('lastActivePage') || 'dashboard';
                document.getElementById('auth-wrapper').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                initializeApp(lastPage);
            } else {
                // Jika tidak ada keduanya, tampilkan halaman login
                document.getElementById('auth-wrapper').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }

            // ==========================================================
            // ===== TAMBAHKAN BLOK KODE BARU DI BAWAH INI =====
            // ==========================================================
            // Listener untuk tombol-tombol pada modal transkrip
            document.getElementById('closeTranscriptModalBtn').addEventListener('click', () => {
                const modal = document.getElementById('transcript-modal');
                // Tambahkan animasi saat menutup
                modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => modal.classList.add('hidden'), 300);
            });

            /*
            document.getElementById('printTranscriptBtn').addEventListener('click', () => {
                const printableArea = document.getElementById('transcript-printable-area');
                if (!printableArea) {
                    alert('Area untuk dicetak tidak ditemukan!');
                    return;
                }
                const contentToPrint = printableArea.innerHTML;
                const deployUrl = sessionStorage.getItem('webAppUrl') || '';
                const appTitle = "Aplikasi Pengolahan Nilai Ijazah by Syamsul Bahri";

                const printWindow = window.open('', '', 'height=800,width=800');
                printWindow.document.write(`<html><head><title>${appTitle}</title>`);
                
                Array.from(document.styleSheets).forEach(styleSheet => {
                    try {
                        const cssRules = Array.from(styleSheet.cssRules).map(rule => rule.cssText).join('');
                        printWindow.document.write(`<style>${cssRules}</style>`);
                    } catch (e) {
                        if (styleSheet.href) {
                            printWindow.document.write(`<link rel="stylesheet" href="${styleSheet.href}">`);
                        }
                    }
                });

                printWindow.document.write(`
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { margin: 0; font-family: 'Inter', sans-serif; font-size: 13px; padding-bottom: 25px; }
                        .print-footer { position: fixed; width: 95%; left: 2.5%; bottom: 5mm; display: flex; align-items: center; font-size: 9px; color: #888; }
                        .qr-code-img { width: 70px; height: 70px; margin-right: 10px; }
                        .p-2 { padding: 0.25rem 0.5rem !important; }
                        .mb-4 { margin-bottom: 0.75rem !important; }
                        .mt-8 { margin-top: 1.25rem !important; }
                        .h-20 { height: 3.5rem !important; }
                    </style>
                `);
                
                printWindow.document.write('</head><body style="position: relative;">');
                printWindow.document.write(contentToPrint);
                
                if (deployUrl) {
                    const encodedUrl = encodeURIComponent(deployUrl);
                    const qrCodeApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=70x70&data=${encodedUrl}`;
                    // Beri ID pada gambar QR Code agar bisa kita pantau
                    printWindow.document.write(`
                        <div class="print-footer">
                            <img id="print-qr-code" src="${qrCodeApiUrl}" alt="QR Code Link Aplikasi" class="qr-code-img" />
                            <span>Scan untuk validasi online</span>
                        </div>
                    `);
                }
                
                printWindow.document.write('</body></html>');
                printWindow.document.close();

                // --- [PERUBAHAN UTAMA] Logika baru untuk menunggu gambar selesai dimuat ---
                const qrImage = printWindow.document.getElementById('print-qr-code');

                if (qrImage) {
                    // Jika gambar ada, tunggu sampai 'onload' terpanggil
                    qrImage.onload = function() {
                        printWindow.focus();
                        printWindow.print();
                        printWindow.close();
                    };
                    // Fallback jika gambar gagal dimuat, tetap cetak setelah 2 detik
                    setTimeout(function() {
                        printWindow.focus();
                        printWindow.print();
                        printWindow.close();
                    }, 2000);
                } else {
                    // Jika tidak ada QR code, langsung cetak setelah jeda singkat
                    setTimeout(function() {
                        printWindow.focus();
                        printWindow.print();
                        printWindow.close();
                    }, 500);
                }
            });
            */
            // ==========================================================
            // ===== AKHIR DARI BLOK TAMBAHAN =====
            // ==========================================================

            // --- Event listener untuk Login, Signup, Logout ---
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            // Event listener submit sekarang akan memanggil fungsi handleSignup yang sudah dimodifikasi
            if (signupForm) signupForm.addEventListener('submit', handleSignup);
            // Event listener BARU untuk tombol permintaan OTP
            if (requestOtpButton) requestOtpButton.addEventListener('click', handleRequestOtp);

            if (logoutButton) logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                logoutUser();
            });

            // Event listener untuk beralih antara form login dan signup
            if (showSignupBtn) {
                showSignupBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('login-container').classList.add('hidden');
                    document.getElementById('signup-container').classList.remove('hidden');
                });
            }
            if (showLoginBtn) {
                showLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('signup-container').classList.add('hidden');
                    document.getElementById('login-container').classList.remove('hidden');
                });
            }
            
            setupPasswordToggles();

            // Di dalam DOMContentLoaded
            const pengaturanForm = document.getElementById('pengaturanForm');
            if (pengaturanForm) {
                pengaturanForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    const btn = document.getElementById('pengaturanSubmitBtn');
                    const btnText = document.getElementById('pengaturanSubmitBtnText');
                    const spinner = document.getElementById('pengaturanLoadingSpinner');

                    const kkmValue = document.getElementById('kkmSekolah').value;

                    if (kkmValue === '' || isNaN(kkmValue) || kkmValue < 0 || kkmValue > 100) {
                        showGlobalStatus("Nilai KKM harus berupa angka antara 0 dan 100.", false);
                        return;
                    }

                    btn.disabled = true;
                    btnText.classList.add('hidden');
                    spinner.classList.remove('hidden');

                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .withFailureHandler(err => {
                            showGlobalStatus("Error: " + err.message, false);
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .saveKkm(userSpreadsheetId, Number(kkmValue));
                });
            }

            // ===== GANTI BLOK LISTENER INI DENGAN VERSI BARU =====
            // "Penjaga" untuk overlay. Dia akan menangani semua klik di dalam overlay.
            document.getElementById('loading-overlay').addEventListener('click', function(event) {
                // Cek apakah elemen yang diklik adalah tombol refresh manual kita
                if (event.target.id === 'force-refresh-btn') {
                    
                    // --- PERBAIKAN FINAL (METODE MUAT ULANG HALAMAN) ---
                    
                    // 1. Simpan informasi bahwa kita ingin kembali ke halaman data siswa.
                    sessionStorage.setItem('lastActivePage', 'data-siswa');
                    
                    // 2. Ambil URL aplikasi dari sesi yang disimpan saat login.
                    const webAppUrl = sessionStorage.getItem('webAppUrl');
                    
                    // 3. Perintahkan browser untuk me-refresh seluruh halaman.
                    if (webAppUrl) {
                        window.top.location.href = webAppUrl;
                    } else {
                        // Fallback jika URL tidak ditemukan, jarang terjadi.
                        window.top.location.reload();
                    }
                }
            });

            // --- [BARU] LISTENER GLOBAL UNTUK KEYBOARD & MOUSE ---

            // Listener untuk melepas tombol mouse, berlaku di seluruh jendela
            window.addEventListener('mouseup', () => {
                if (isSelecting) {
                    isSelecting = false;
                    document.body.classList.remove('no-select');
                }
            });

            // Listener untuk menghapus seleksi saat klik di luar area tabel
            document.addEventListener('click', (e) => {
                // .closest() akan mencari elemen parent terdekat yang cocok
                if (!e.target.closest('.score-table')) {
                    clearSelection();
                }
            });

            // ===== GANTI SELURUH BLOK EVENT LISTENER INI DENGAN VERSI BARU =====
            document.addEventListener('keydown', (e) => {
                // Logika untuk Ctrl + Z (Undo)
                if (e.ctrlKey && e.key.toLowerCase() === 'z') {
                    e.preventDefault();
                    performUndo();
                }
                // Logika untuk Ctrl + Y (Redo)
                if (e.ctrlKey && e.key.toLowerCase() === 'y') {
                    e.preventDefault();
                    performRedo();
                }
                // Logika untuk Ctrl + A (Select All)
                if (e.ctrlKey && e.key.toLowerCase() === 'a') {
                    const activeElement = document.activeElement;
                    const activeTable = activeElement ? activeElement.closest('.score-table') : null;
                    if (activeTable && activeElement.classList.contains('score-input')) {
                        e.preventDefault();
                        
                        // --- PERUBAHAN DI SINI: Cek apakah form terkunci ---
                        const editBtn = document.getElementById(`edit-scores-btn-${activeTableKey}`);
                        if (editBtn && !editBtn.classList.contains('hidden')) return; // Jika terkunci, jangan lakukan apa-apa
                        // --- AKHIR PERUBAHAN ---

                        clearSelection();
                        const allInputs = activeTable.querySelectorAll('.score-input');
                        allInputs.forEach(input => {
                            input.classList.add('cell-selected');
                            selectedCells.add(input);
                        });
                    }
                }
                // Logika untuk tombol Delete
                if (e.key === 'Delete' && selectedCells.size > 0) {
                    e.preventDefault();

                    // --- PERUBAHAN DI SINI: Cek apakah form terkunci ---
                    if (!activeTableKey) return; // Jika tidak ada tabel aktif, hentikan.
                    const editBtn = document.getElementById(`edit-scores-btn-${activeTableKey}`);
                    // Jika tombol edit ada dan terlihat (tidak ada class hidden), berarti form terkunci.
                    if (editBtn && !editBtn.classList.contains('hidden')) {
                        return; // Hentikan fungsi hapus.
                    }
                    // --- AKHIR PERUBAHAN ---

                    handleSelectionDeletion();
                }
            });

            // Letakkan di dalam DOMContentLoaded
            document.getElementById('undo-btn').addEventListener('click', performUndo);
            document.getElementById('redo-btn').addEventListener('click', performRedo);

            // Tambahkan shortcut keyboard
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    performUndo();
                }
                if (e.ctrlKey && e.key === 'y') {
                    e.preventDefault();
                    performRedo();
                }
            });

            // Pendaftaran
            setupRealtimePasswordValidation(document.getElementById('signup-password'), document.getElementById('signup-password-req'));
            setupPasswordConfirmation(
                document.getElementById('signup-password'),
                document.getElementById('confirm-password'),
                document.getElementById('signup-confirm-msg')
            );

            // Ubah Password
            setupRealtimePasswordValidation(document.getElementById('new-password-change'), document.getElementById('change-password-req'));
            setupPasswordConfirmation(
                document.getElementById('new-password-change'),
                document.getElementById('confirm-password-change'),
                document.getElementById('change-confirm-msg')
            );

            // Lupa Password
            setupRealtimePasswordValidation(document.getElementById('fp-new-password'), document.getElementById('fp-password-req'));
            setupPasswordConfirmation(
                document.getElementById('fp-new-password'),
                document.getElementById('fp-confirm-password'),
                document.getElementById('fp-confirm-msg')
            );


            // --- Event listener untuk modal ekspor ---
            const exportModal = document.getElementById('export-modal');
            const closeExportModalBtn = document.getElementById('closeExportModalBtn');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const generatePdfBtn = document.getElementById('generatePdfBtn');
            const generateExcelBtn = document.getElementById('generateExcelBtn');

            const closeExportModal = () => {
                if(exportModal) {
                  exportModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                  setTimeout(() => exportModal.classList.add('hidden'), 300);
                }
            };

            if (closeExportModalBtn) closeExportModalBtn.addEventListener('click', closeExportModal);
            if (cancelExportBtn) cancelExportBtn.addEventListener('click', closeExportModal);

            // Handler untuk memicu ekspor
            const handleExport = (event, format) => {
                const rekapType = document.getElementById('exportForm').dataset.rekapType;
                const exportButton = event.currentTarget;

                const exportOptions = {
                    tahunAjaran: document.getElementById('exportTahunAjaran').value,
                    tempatTTD: document.getElementById('exportTempatTTD').value,
                    tanggalTTD: document.getElementById('exportTanggalTTD').value,
                    tipeKamad: document.getElementById('exportTipeKamad').value,
                };

                // Simpan Opsi ke Local Storage
                localStorage.setItem('exportOptions', JSON.stringify(exportOptions));

                const btnText = exportButton.querySelector('.btn-text');
                const spinner = exportButton.querySelector('.btn-spinner');

                exportButton.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');

                google.script.run
                    .withSuccessHandler(result => {
                        if (result && result.base64Data) {
                            const link = document.createElement('a');
                            link.href = `data:${result.mimeType};base64,${result.base64Data}`;
                            link.download = result.fileName;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            showGlobalStatus(`File '${result.fileName}' berhasil diunduh.`, true);
                            closeExportModal();
                        } else {
                            const errorMessage = result ? result.error : 'Terjadi kesalahan tidak diketahui di server.';
                            showGlobalStatus(`Gagal mengekspor: ${errorMessage}`, false);
                        }
                        exportButton.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    })
                    .withFailureHandler(error => {
                        showGlobalStatus(`Error Kritis: ${error.message}. Coba refresh halaman.`, false);
                        exportButton.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    })
                    .exportRekapData(userSpreadsheetId, rekapType, format, exportOptions);
            };

            if (generatePdfBtn) generatePdfBtn.addEventListener('click', (e) => handleExport(e, 'pdf'));
            if (generateExcelBtn) generateExcelBtn.addEventListener('click', (e) => handleExport(e, 'excel'));

            // --- [BARU] Event listener dan fungsi untuk Lupa Password ---
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const forgotPasswordModal = document.getElementById('forgot-password-modal');
            const closeForgotPasswordModalBtn = document.getElementById('closeForgotPasswordModalBtn');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            const fpStep1 = document.getElementById('fp-step-1');
            const fpStep2 = document.getElementById('fp-step-2');
            const fpSendOtpBtn = document.getElementById('fp-send-otp-btn');
            const fpResetBtn = document.getElementById('fp-reset-btn');
            const fpStatusMessage = document.getElementById('fp-status-message');

            const openForgotPasswordModal = () => {
                forgotPasswordModal.classList.remove('hidden');
                setTimeout(() => {
                    forgotPasswordModal.querySelector('.modal-content').style.transform = 'scale(1)';
                }, 10);
            };

            const closeForgotPasswordModal = () => {
                forgotPasswordModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => {
                    forgotPasswordModal.classList.add('hidden');
                    // Reset form ke step 1 saat ditutup
                    fpStep1.classList.remove('hidden');
                    fpStep2.classList.add('hidden');
                    forgotPasswordForm.reset();
                    fpStatusMessage.innerHTML = '';
                }, 300);
            };

            if (forgotPasswordLink) forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                openForgotPasswordModal();
            });

            if (closeForgotPasswordModalBtn) closeForgotPasswordModalBtn.addEventListener('click', closeForgotPasswordModal);

            // Tombol untuk mengirim OTP
            if (fpSendOtpBtn) fpSendOtpBtn.addEventListener('click', function() {
                const email = document.getElementById('fp-email').value;
                if (!email) {
                    fpStatusMessage.textContent = 'Email tidak boleh kosong.';
                    fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    return;
                }
                
                const btn = this;
                const btnText = btn.querySelector('.btn-text');
                const spinner = btn.querySelector('.btn-spinner');

                btn.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');
                fpStatusMessage.innerHTML = '';

                google.script.run
                    .withSuccessHandler(response => {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');

                        if (response.status === 'success') {
                            fpStatusMessage.textContent = response.message;
                            fpStatusMessage.className = 'mt-4 text-center text-sm text-green-600';
                            fpStep1.classList.add('hidden');
                            fpStep2.classList.remove('hidden');
                        } else {
                            fpStatusMessage.textContent = response.message;
                            fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                        }
                    })
                    .withFailureHandler(error => {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                        fpStatusMessage.textContent = 'Error: ' + error.message;
                        fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    })
                    .sendPasswordResetOtp(email);
            });

            // Tombol untuk submit OTP dan password baru
            if (forgotPasswordForm) forgotPasswordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('fp-email').value;
                const otp = document.getElementById('fp-otp').value;
                const newPassword = document.getElementById('fp-new-password').value;
                const fpStatusMessage = document.getElementById('fp-status-message');

                fpStatusMessage.innerHTML = ''; // Selalu bersihkan pesan sebelumnya

                if (!otp || !newPassword) {
                    fpStatusMessage.textContent = 'OTP dan Password Baru tidak boleh kosong.';
                    fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    return;
                }
                
                // [KODE YANG DIPERBAIKI]
                // Memanggil fungsi validasi password yang sudah ada
                const passwordErrors = validatePassword(newPassword);
                if (passwordErrors.length > 0) {
                    // Menggunakan backtick (`) untuk string template
                    let errorHtml = '<strong class="block text-center">Password baru belum memenuhi syarat:</strong><ul class="list-disc list-inside text-left mt-1 text-sm">';
                    passwordErrors.forEach(error => {
                        errorHtml += `<li>${error}</li>`; // <-- PERBAIKAN DI SINI
                    });
                    errorHtml += '</ul>';
                    fpStatusMessage.innerHTML = errorHtml;
                    fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    return; // Menghentikan proses jika password tidak valid
                }
                // [AKHIR DARI KODE YANG DIPERBAIKI]

                const btn = document.getElementById('fp-reset-btn');
                const btnText = btn.querySelector('.btn-text');
                const spinner = btn.querySelector('.btn-spinner');

                btn.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');

                google.script.run
                    .withSuccessHandler(response => {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');

                        if (response.status === 'success') {
                            fpStatusMessage.textContent = response.message + ' Anda akan dialihkan ke halaman login.';
                            fpStatusMessage.className = 'mt-4 text-center text-sm text-green-600';
                            setTimeout(() => {
                                closeForgotPasswordModal();
                                const loginInfoMessageDiv = document.getElementById('login-info-message');
                                loginInfoMessageDiv.textContent = "Password berhasil direset. Silakan login dengan password baru Anda.";
                                loginInfoMessageDiv.className = "mb-4 text-center text-sm p-3 bg-green-100 text-green-800 rounded-lg";
                            }, 3000);
                        } else {
                            fpStatusMessage.textContent = response.message;
                            fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                        }
                    })
                    .withFailureHandler(error => {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                        fpStatusMessage.textContent = 'Error: ' + error.message;
                        fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    })
                    .resetPasswordWithOtp(email, otp, newPassword);
            });
        });

        function setupPasswordToggles() {
            document.querySelectorAll('[data-toggle-password]').forEach(button => {
                button.addEventListener('click', () => {
                    const inputId = button.getAttribute('data-toggle-password');
                    const passwordInput = document.getElementById(inputId);
                    if (passwordInput) {
                        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                        passwordInput.setAttribute('type', type);
                        button.querySelector('.eye-icon').classList.toggle('hidden');
                        button.querySelector('.eye-slash-icon').classList.toggle('hidden');
                    }
                });
            });
        }

        /**
         * [VERSI BARU] Membersihkan semua sesi dan memuat ulang aplikasi ke halaman login.
         * Ini memastikan semua state aplikasi di-reset total untuk semua jenis pengguna.
         */
        function logoutUser() {
            // [1] Ambil URL aplikasi web yang bersih dari session storage.
            // URL ini didapat saat login berhasil dan disimpan untuk keperluan ini.
            const webAppUrl = sessionStorage.getItem('webAppUrl');

            // [2] Hentikan timer logout otomatis jika ada.
            clearTimeout(inactivityTimer);

            // [3] Bersihkan semua data sesi dan penyimpanan lokal.
            // Ini akan menghapus 'userSpreadsheetId', 'userEmail', 'userRole', dll.
            // Efektif untuk logout baik Pengguna biasa maupun Superadmin.
            sessionStorage.clear();
            localStorage.clear(); // Membersihkan semua localStorage untuk reset total.

            // [4] Alihkan pengguna untuk memuat ulang aplikasi.
            // Ini adalah cara paling efektif untuk kembali ke halaman login yang bersih.
            if (webAppUrl) {
                // Mengarahkan ke URL deploy utama akan me-reset semuanya.
                window.top.location.href = webAppUrl;
            } else {
                // Fallback jika URL tidak ditemukan, cukup muat ulang halaman saat ini.
                // Ini akan berfungsi 99% sama baiknya.
                window.top.location.reload();
            }
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(logoutUser, 30 * 60 * 1000); // 30 menit
        }

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            const loginSpinner = document.getElementById('loginSpinner');
            const errorMessageDiv = document.getElementById('login-error-message');

            errorMessageDiv.textContent = '';
            loginButton.disabled = true;
            loginButtonText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');

            google.script.run
                .withSuccessHandler(response => {
                    loginButton.disabled = false;
                    loginButtonText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');

                    if (response && response.status === 'success') {
                        // Simpan data sesi dasar
                        sessionStorage.setItem('userEmail', response.email);
                        sessionStorage.setItem('userRole', response.role);

                        sessionStorage.setItem('webAppUrl', response.webAppUrl);

                        document.getElementById('auth-wrapper').classList.add('hidden');
                        document.getElementById('app-container').classList.remove('hidden');

                        // === LOGIKA PEMILIHAN TAMPILAN ===
                        if (response.role === 'Superadmin') {
                            // Jika Superadmin, panggil fungsi inisialisasi khusus superadmin
                            initializeSuperadminApp();
                        } else {
                            // Jika pengguna biasa, simpan spreadsheetId dan panggil inisialisasi normal
                            userSpreadsheetId = response.spreadsheetId;
                            sessionStorage.setItem('userSpreadsheetId', userSpreadsheetId);
                            initializeApp('dashboard');
                        }

                        // ===========================================
                        // ===== TAMBAHKAN BLOK IF DI BAWAH INI =====
                        // ===========================================
                        // Cek apakah server mengirimkan data changelog baru
                        if (response.newChangelog) {
                            // Tunda sedikit agar transisi halaman selesai, lalu tampilkan pop-up
                            setTimeout(() => {
                                showNewChangelogPopup(response.newChangelog);
                            }, 500); // jeda 0.5 detik
                        }
                        // =======================================
                        // ===== AKHIR DARI BLOK TAMBAHAN =====
                        // =======================================

                    } else {
                        errorMessageDiv.textContent = response ? response.message : 'Login gagal.';
                    }
                })
                .withFailureHandler(error => {
                    errorMessageDiv.textContent = 'Terjadi kesalahan: ' + error.message;
                    loginButton.disabled = false;
                    loginButtonText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');
                })
                .checkLogin(email, password);
        }

        function validatePassword(password) {
            const errors = [];

            if (password.length < 8) {
                errors.push("Password minimal harus 8 karakter.");
            }
            if (!/[A-Z]/.test(password)) {
                errors.push("Harus memiliki setidaknya 1 huruf besar (A-Z).");
            }
            if (!/[a-z]/.test(password)) {
                errors.push("Harus memiliki setidaknya 1 huruf kecil (a-z).");
            }
            if (!/[0-9]/.test(password)) {
                errors.push("Harus memiliki setidaknya 1 angka (0-9).");
            }
            // Pengecekan untuk karakter spesial
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(password)) {
                errors.push("Harus memiliki setidaknya 1 karakter spesial (cth: !@#$).");
            }
            
            return errors;
        }
        
        function handleRequestOtp() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const namaSekolah = document.getElementById('signup-namasekolah').value;
            const jenjang = document.getElementById('signup-jenjang').value;

            const requestOtpButton = document.getElementById('requestOtpButton');
            const requestOtpBtnText = document.getElementById('requestOtpButtonText');
            const requestOtpSpinner = document.getElementById('requestOtpSpinner');
            const messageDiv = document.getElementById('signup-message');

            messageDiv.innerHTML = ''; // Bersihkan pesan sebelumnya
            messageDiv.classList.remove('text-red-600', 'text-green-600');

            // Validasi awal (apakah semua field terisi)
            if (!email || !password || !namaSekolah || !jenjang || !confirmPassword) {
                messageDiv.textContent = 'Semua field wajib diisi.';
                messageDiv.classList.add('text-red-600');
                return;
            }

            // Validasi kecocokan kata sandi
            if (password !== confirmPassword) {
                messageDiv.textContent = 'Kata sandi dan konfirmasi kata sandi tidak cocok.';
                messageDiv.classList.add('text-red-600');
                return;
            }

            // BARU: Validasi kekuatan kata sandi
            const passwordErrors = validatePassword(password);
            if (passwordErrors.length > 0) {
                let errorHtml = '<strong class="block text-center">Password belum memenuhi syarat:</strong><ul class="list-disc list-inside text-left mt-1 text-sm">';
                passwordErrors.forEach(error => {
                    errorHtml += `<li>${error}</li>`;
                });
                errorHtml += '</ul>';
                messageDiv.innerHTML = errorHtml;
                messageDiv.classList.add('text-red-600');
                return; // Hentikan proses jika password tidak valid
            }

            // Tampilkan loading
            requestOtpButton.disabled = true;
            requestOtpBtnText.classList.add('hidden');
            requestOtpSpinner.classList.remove('hidden');

            google.script.run
                .withSuccessHandler(response => {
                    requestOtpButton.disabled = false;
                    requestOtpBtnText.classList.remove('hidden');
                    requestOtpSpinner.classList.add('hidden');

                    if (response.status === 'success') {
                        messageDiv.textContent = response.message;
                        messageDiv.classList.add('text-green-600');

                        // Sembunyikan field awal dan tombol minta OTP
                        document.getElementById('initial-fields').querySelectorAll('input, select').forEach(el => el.disabled = true);
                        requestOtpButton.classList.add('hidden');

                        // Tampilkan field OTP dan tombol daftar final
                        document.getElementById('otp-section').classList.remove('hidden');
                        document.getElementById('final-signup-button-container').classList.remove('hidden');

                    } else {
                        messageDiv.textContent = response.message;
                        messageDiv.classList.add('text-red-600');
                    }
                })
                .withFailureHandler(error => {
                    messageDiv.textContent = 'Terjadi kesalahan: ' + error.message;
                    messageDiv.classList.add('text-red-600');
                    requestOtpButton.disabled = false;
                    requestOtpBtnText.classList.remove('hidden');
                    requestOtpSpinner.classList.add('hidden');
                })
                .sendVerificationEmail(email);
        }


        // --- [MODIFIKASI] Fungsi signup sekarang menangani submit final dengan OTP ---
        function handleSignup(event) {
            event.preventDefault(); 
            const namaSekolah = document.getElementById('signup-namasekolah').value;
            const jenjang = document.getElementById('signup-jenjang').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            // [PERBAIKAN] Ambil kode OTP dan hapus spasi di awal/akhir menggunakan .trim()
            const otp = document.getElementById('signup-otp').value.trim(); 

            const signupButton = document.getElementById('signupButton');
            const signupButtonText = document.getElementById('signupButtonText');
            const signupSpinner = document.getElementById('signupSpinner');
            const messageDiv = document.getElementById('signup-message');

            messageDiv.textContent = '';
            messageDiv.classList.remove('text-red-600', 'text-green-600');
            
            if (!otp) {
                messageDiv.textContent = 'Kode OTP wajib diisi.';
                messageDiv.classList.add('text-red-600');
                return;
            }

            signupButton.disabled = true;
            signupButtonText.classList.add('hidden');
            signupSpinner.classList.remove('hidden');

            const userData = {
                email: email,
                password: password,
                namaSekolah: namaSekolah,
                jenjang: jenjang
            };

            // Memanggil fungsi `registerUser` yang sudah dimodifikasi di backend dengan menyertakan OTP
            google.script.run
                .withSuccessHandler(response => {
                    signupButton.disabled = false;
                    signupButtonText.classList.remove('hidden');
                    signupSpinner.classList.add('hidden');
                    
                    if (response && response.status === 'success') {
                        // Reset dan alihkan ke halaman login
                        document.getElementById('signupForm').reset();
                        document.getElementById('initial-fields').querySelectorAll('input, select').forEach(el => el.disabled = false);
                        document.getElementById('requestOtpButton').classList.remove('hidden');
                        document.getElementById('otp-section').classList.add('hidden');
                        document.getElementById('final-signup-button-container').classList.add('hidden');

                        document.getElementById('signup-container').classList.add('hidden');
                        document.getElementById('login-container').classList.remove('hidden');
                        
                        const loginInfoMessageDiv = document.getElementById('login-info-message');
                        loginInfoMessageDiv.textContent = "Pendaftaran berhasil! Silakan masuk dengan akun yang baru Anda buat.";
                        loginInfoMessageDiv.className = "mb-4 text-center text-sm p-3 bg-green-100 text-green-800 rounded-lg";
                    } else {
                        messageDiv.textContent = response ? response.message : 'Gagal mendaftar karena respons tidak valid dari server.';
                        messageDiv.classList.add('text-red-600');
                    }
                })
                .withFailureHandler(error => {
                    messageDiv.textContent = 'Terjadi kesalahan: ' + error.message;
                    messageDiv.classList.add('text-red-600');
                    signupButton.disabled = false;
                    signupButtonText.classList.remove('hidden');
                    signupSpinner.classList.add('hidden');
                })
                .registerUser(userData, otp); // Parameter OTP ditambahkan di sini
        }

        function loadDashboardData() {
            document.getElementById('studentCount').textContent = '...';
            document.getElementById('mapelCount').textContent = '...';

            // Helper function untuk membuat grafik batang horizontal
            const createAverageChart = (canvasId, chartInstance, chartData, chartLabel) => {
                if (chartInstance) {
                    chartInstance.destroy();
                }
                if (!chartData || !chartData.labels || !chartData.data) return null;

                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, {
                    type: 'bar', // Menggunakan grafik batang
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: chartLabel,
                            data: chartData.data,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Membuat grafik menjadi horizontal
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) { if (value % 1 === 0) { return value; } } // Tampilkan hanya integer
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // Sembunyikan legenda karena sudah ada di judul
                            }
                        }
                    }
                });
            };

            google.script.run
                .withSuccessHandler(response => {
                    if (response && response.status === 'success') {
                        // --- Kode untuk kartu statistik (tidak berubah) ---
                        document.getElementById('studentCount').textContent = response.studentCount || 0;
                        document.getElementById('mapelCount').textContent = response.mapelCount || 0;

                        // --- Kode untuk grafik distribusi jenis ujian (tidak berubah) ---
                        let madrasahCount = 0, praktekCount = 0, keduanyaCount = 0;
                        if (response.mapelList && response.mapelList.length > 0) {
                            response.mapelList.forEach(mapel => {
                                if (mapel.jenisUjian === 'Ujian Madrasah') madrasahCount++;
                                else if (mapel.jenisUjian === 'Ujian Praktek') praktekCount++;
                                else if (mapel.jenisUjian === 'Keduanya') keduanyaCount++;
                            });
                        }
                        const ctx = document.getElementById('mapelChart').getContext('2d');
                        if (mapelChartInstance) {
                            mapelChartInstance.destroy();
                        }
                        mapelChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Ujian Madrasah', 'Ujian Praktek', 'Keduanya'],
                                datasets: [{
                                    label: 'Jumlah Mapel',
                                    data: [madrasahCount, praktekCount, keduanyaCount],
                                    backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(249, 115, 22, 0.7)'],
                                    borderColor: ['rgba(59, 130, 246, 1)', 'rgba(16, 185, 129, 1)', 'rgba(249, 115, 22, 1)'],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                                plugins: { legend: { display: false } }
                            }
                        });

                        // --- [BARU] Kode untuk membuat grafik rata-rata nilai ---
                        if (response.subjectAverages) {
                            ujianChartInstance = createAverageChart('ujianAverageChart', ujianChartInstance, response.subjectAverages.ujian, 'Rata-rata Nilai Ujian');
                            raporChartInstance = createAverageChart('raporAverageChart', raporChartInstance, response.subjectAverages.rapor, 'Rata-rata Nilai Rapor');
                            ijazahChartInstance = createAverageChart('ijazahAverageChart', ijazahChartInstance, response.subjectAverages.ijazah, 'Rata-rata Nilai Ijazah');
                        }


                        // [MODIFIKASI] Seluruh blok ini diubah untuk mendukung grafik vertikal dan scrolling
                        if (response.examScoreShare) {
                            // 1. Filter dan Urutkan Data (High to Low)
                            // Kabar baiknya, kode Anda sudah mengurutkan data dari skor tertinggi ke terendah,
                            // jadi kita tidak perlu mengubah bagian ini.
                            const studentData = response.examScoreShare
                                .filter(s => s.nama && s.nama.trim() !== '')
                                .sort((a, b) => b.skor - a.skor);

                            // [MODIFIKASI] Tambahkan nomor peringkat pada label nama siswa
                            const studentLabels = studentData.map((s, index) => {
                                return `${index + 1}. ${s.nama.toUpperCase()}`;
                            });
                            const studentScores = studentData.map(s => s.skor);

                            // 2. [MODIFIKASI] Atur lebar dinamis untuk scrolling
                            const numStudents = studentData.length;
                            // Beri lebar 60px untuk setiap siswa, dengan lebar minimum 600px
                            const chartWidth = Math.max(600, numStudents * 60); 
                            
                            const wrapper = document.getElementById('examScoreChartWrapper');
                            if (wrapper) {
                                wrapper.style.width = `${chartWidth}px`;
                            }

                            // 3. Buat atau perbarui grafik
                            const ctxBar = document.getElementById('examScoreDistributionChart').getContext('2d');
                            if (examScoreShareChartInstance) {
                                examScoreShareChartInstance.destroy();
                            }
                            
                            examScoreShareChartInstance = new Chart(ctxBar, {
                                type: 'bar', // Tipe grafik tetap bar
                                data: {
                                    labels: studentLabels,
                                    datasets: [{
                                        label: 'Rata-rata Nilai Ujian',
                                        data: studentScores,
                                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                        borderColor: 'rgba(59, 130, 246, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    // [MODIFIKASI] Hapus indexAxis: 'y' untuk menjadikannya bar vertikal
                                    responsive: true,
                                    maintainAspectRatio: false, // Penting untuk scrolling
                                    scales: {
                                        x: { // Ini sekarang adalah sumbu Nama Siswa
                                            ticks: {
                                                // [MODIFIKASI] Atur rotasi label nama siswa
                                                maxRotation: 45,
                                                minRotation: 45,
                                                autoSkip: false, // Pastikan semua nama ditampilkan
                                                font: {
                                                    size: 10
                                                }
                                            }
                                        },
                                        y: { // Ini sekarang adalah sumbu Nilai
                                            beginAtZero: true
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false // Sembunyikan legenda
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    let label = context.dataset.label || '';
                                                    if (label) { label += ': '; }
                                                    if (context.parsed.y !== null) {
                                                        label += parseFloat(context.parsed.y.toFixed(2));
                                                    }
                                                    return label;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }

                        // --- [DIUBAH] Kode untuk grafik peringkat siswa berdasarkan nilai rata-rata ijazah (Bar Chart) ---
                        // [MODIFIKASI] Seluruh blok ini diubah untuk mendukung grafik vertikal dan scrolling
                        if (response.ijazahRanking) {
                            // Data dari backend sudah diurutkan dari tertinggi ke terendah.
                            const peringkatData = response.ijazahRanking.map(item => parseFloat(item.nilai.toFixed(2)));
                            // [MODIFIKASI] Tambahkan nomor peringkat pada label nama siswa
                            const namaSiswa = response.ijazahRanking.map((item, index) => {
                                return `${index + 1}. ${item.nama.toUpperCase()}`;
                            });

                            // [MODIFIKASI] Atur lebar dinamis untuk scrolling
                            const numStudents = response.ijazahRanking.length;
                            const chartWidth = Math.max(600, numStudents * 60); // 60px per siswa
                            
                            const wrapper = document.getElementById('ijazahRankingChartWrapper');
                            if (wrapper) {
                                wrapper.style.width = `${chartWidth}px`;
                            }

                            // Buat atau perbarui grafik
                            const ctxRanking = document.getElementById('ijazahRankingChart').getContext('2d');
                            if (ijazahRankingChartInstance) {
                                ijazahRankingChartInstance.destroy();
                            }
                            
                            ijazahRankingChartInstance = new Chart(ctxRanking, {
                                type: 'bar',
                                data: {
                                    labels: namaSiswa,
                                    datasets: [{
                                        label: 'Rata-rata Nilai Ijazah',
                                        data: peringkatData,
                                        // [MODIFIKASI] Warna diubah agar berbeda dari grafik sebelumnya
                                        backgroundColor: 'rgba(255, 159, 64, 0.7)', 
                                        borderColor: 'rgba(255, 159, 64, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    // [MODIFIKASI] Hapus indexAxis: 'y' untuk menjadikannya bar vertikal
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: { // Sumbu Nama Siswa
                                            ticks: {
                                                // [MODIFIKASI] Atur rotasi label nama siswa
                                                maxRotation: 45,
                                                minRotation: 45,
                                                autoSkip: false,
                                                font: {
                                                    size: 10
                                                }
                                            }
                                        },
                                        y: { // Sumbu Nilai
                                            beginAtZero: true
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    }
                                }
                            });
                        }

                        // PENAMBAHAN KODE DIMULAI DI SINI
                        const studentCard = document.getElementById('student-card');
                        const mapelCard = document.getElementById('mapel-card');

                        if (studentCard) {
                          studentCard.onclick = () => {
                            document.querySelector('.nav-link[data-page="data-siswa"]').click();
                          };
                        }

                        if (mapelCard) {
                          mapelCard.onclick = () => {
                            document.querySelector('.nav-link[data-page="mapel"]').click();
                          };
                        }
                        // PENAMBAHAN KODE BERAKHIR DI SINI
                    } else {
                        showGlobalStatus(response ? response.message : 'Gagal memuat data dashboard.', false);
                    }
                })
                .withFailureHandler(error => {
                    showGlobalStatus(`Gagal memuat dashboard: ${error.message}`, false);
                })
                .getDashboardData(userSpreadsheetId);
        }

        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
        function initializeApp(lastPage = 'dashboard') {
            const oldNav = document.getElementById('main-nav');
            const newNav = oldNav.cloneNode(true);
            oldNav.parentNode.replaceChild(newNav, oldNav);

            // TAMBAHKAN BLOK KODE DI BAWAH INI
            // Memastikan semua garis pemisah terlihat untuk pengguna biasa
            document.querySelectorAll('#main-nav > .border-t').forEach(separator => {
                separator.classList.remove('hidden');
            });
            // AKHIR DARI BLOK TAMBAHAN

            checkForImpersonation();
            if (!userSpreadsheetId) {
                alert("Error: Sesi pengguna tidak valid. Silakan login ulang.");
                logoutUser();
                return;
            }

            resetInactivityTimer();
            ['mousemove', 'mousedown', 'touchstart', 'click', 'keydown', 'scroll'].forEach(event => {
                document.addEventListener(event, resetInactivityTimer, true);
            });

            const allowedUserPages = [
                'dashboard', 'data-sekolah', 'data-siswa', 'mapel',
                'input-ujian', 'input-rapor', 'rekapitulasi', 'pengajuan',
                'ubah-password', 'backup-restore', 'update-info', 'validasi-nilai', 'pengaturan'
            ];

            document.querySelectorAll('.nav-link').forEach(link => {
                const page = link.dataset.page;
                if (page && allowedUserPages.includes(page)) {
                    link.classList.remove('hidden');
                } else {
                    link.classList.add('hidden');
                }
            });
            document.getElementById('logoutButton').classList.remove('hidden');

            loadSchoolData();
            setupCompletenessCheck();

            const navContainer = document.getElementById('main-nav');
            const contentPages = document.querySelectorAll('.content-page');

            // --- AWAL PERUBAHAN UTAMA (EVENT DELEGATION) ---
            navContainer.addEventListener('click', (e) => {
                const navLink = e.target.closest('.nav-link');
                if (!navLink) return; // Jika yang diklik bukan link navigasi, abaikan

                // ---- TAMBAHKAN BARIS DI BAWAH INI ----
                if (navLink.id === 'logoutButton') return; // Abaikan tombol logout, biarkan listenernya sendiri yang bekerja
                // ---- AKHIR DARI PENAMBAHAN ----

                e.preventDefault(); // Mencegah aksi default link
                const targetPageId = navLink.dataset.page;

                if (!targetPageId || !allowedUserPages.includes(targetPageId)) return;

                clearHistoryAndHideButtons();
                sessionStorage.setItem('lastActivePage', targetPageId);
                contentPages.forEach(p => p.classList.add('hidden'));
                document.getElementById('page-' + targetPageId)?.classList.remove('hidden');

                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                navLink.classList.add('active');

                // Logika pemuatan data spesifik untuk setiap halaman
                if (targetPageId === 'dashboard') loadDashboardData();
                if (targetPageId === 'data-siswa') loadStudentsData();
                if (targetPageId === 'mapel') { loadMapelData(); loadBobotData(); }
                if (targetPageId === 'input-ujian') { calculateUjianAverage(); }
                if (targetPageId === 'input-rapor') initRaporPage();
                if (targetPageId === 'rekapitulasi') initRekapitulasiPage();
                if (targetPageId === 'pengaturan') loadPengaturanPage();
                if (targetPageId === 'validasi-nilai') initValidationPage();
                if (targetPageId === 'backup-restore') loadBackupRestorePage();
                if (targetPageId === 'update-info') loadFullChangelog();
                if (targetPageId === 'pengajuan') loadPengajuanPage();
            });
            // --- AKHIR PERUBAHAN UTAMA ---

            const lastActiveLink = document.querySelector(`.nav-link[data-page="${lastPage}"]`);
            if (lastActiveLink && allowedUserPages.includes(lastPage)) {
                lastActiveLink.click();
            } else {
                document.querySelector('.nav-link[data-page="dashboard"]').click();
            }


            // ===== GANTI FUNGSI loadSchoolData LAMA DENGAN INI =====
            function loadSchoolData() {
                google.script.run
                    .withSuccessHandler(data => {
                        if (data) {
                            const schoolNameSidebar = document.getElementById('school-name-sidebar');
                            if (data.namaSekolah) schoolNameSidebar.textContent = data.namaSekolah.toUpperCase();
                            for (const key in data) {
                                const element = document.getElementById(key === 'email' ? 'email-sekolah' : key);
                                if (element) element.value = data[key] || '';
                            }
                        }
                        // [TAMBAHAN KUNCI] Panggil pengecekan indikator SETELAH data sekolah berhasil dimuat
                        // Ini memastikan sesi pengguna sudah 100% aktif.
                        syncAndShowPengajuanIndicator();
                    })
                    .withFailureHandler(err => {
                        // Jika gagal memuat data sekolah, kita juga coba muat indikator sebagai fallback
                        syncAndShowPengajuanIndicator(); 
                        console.error("Gagal memuat data sekolah:", err);
                    })
                    .getSchoolData(userSpreadsheetId);
            }

            // [BARU] Event listener untuk kolom pencarian siswa
            const searchSiswaInput = document.getElementById('searchSiswaInput');
            if (searchSiswaInput) {
                searchSiswaInput.addEventListener('input', () => {
                    const keyword = searchSiswaInput.value.toLowerCase().trim();
                    const filteredStudents = allStudentsData.filter(student => {
                        const nameMatch = student.nama.toLowerCase().includes(keyword);
                        const nisnMatch = student.nisn.toString().includes(keyword);
                        return nameMatch || nisnMatch;
                    });
                    renderSiswaTable(filteredStudents);
                });
            }

            document.getElementById('schoolDataForm')?.addEventListener('submit', function(event) {
                event.preventDefault();
                const btn = this.querySelector('button[type="submit"]');
                const btnText = btn.querySelector('#schoolSubmitBtnText');
                const btnSpinner = btn.querySelector('#schoolLoadingSpinner');

                btn.disabled = true;
                btnText.classList.add('hidden');
                btnSpinner.classList.remove('hidden');

                const dataObj = Object.fromEntries(new FormData(this).entries());
                dataObj.jenjang = document.getElementById('jenjang').value;
                dataObj.namaSekolah = document.getElementById('namaSekolah').value;

                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        btnSpinner.classList.add('hidden');
                        if (response.status === 'success') loadSchoolData();
                    })
                    .withFailureHandler(error => {
                        showGlobalStatus('Error: ' + error.message, false);
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        btnSpinner.classList.add('hidden');
                    })
                    .saveSchoolData(userSpreadsheetId, dataObj);
            });

            // --- DATA SISWA FUNCTIONS ---
            const addStudentBtn = document.getElementById('addStudentBtn');
            const siswaModal = document.getElementById('siswa-modal');
            const closeSiswaModalBtn = document.getElementById('closeSiswaModalBtn');
            const cancelSiswaBtn = document.getElementById('cancelSiswaBtn');
            const siswaForm = document.getElementById('siswaForm');
            const siswaModalTitle = document.getElementById('siswa-modal-title');
            const studentRowInput = document.getElementById('studentRow');
            const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
            const importSiswaBtn = document.getElementById('importSiswaBtn');
            const siswaFileInput = document.getElementById('siswaFileInput');
            const fileNameSpan = document.getElementById('fileName');
            const importStatusDiv = document.getElementById('importStatus');
            const deleteAllStudentsBtn = document.getElementById('deleteAllStudentsBtn');

            const openSiswaModal = () => {
                siswaModal.classList.remove('hidden');
                setTimeout(() => {
                    siswaModal.querySelector('.modal-content').style.transform = 'scale(1)';
                }, 10);
            };
            const closeSiswaModal = () => {
                siswaModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => siswaModal.classList.add('hidden'), 300);
            };
            if (addStudentBtn) {
                addStudentBtn.addEventListener('click', () => {
                    siswaForm.reset();
                    studentRowInput.value = '';
                    siswaModalTitle.textContent = "Tambah Siswa Baru";
                    
                    // [TAMBAHAN] Hapus pesan error lama dan pasang listener baru
                    document.getElementById('nisn-error-msg').textContent = '';
                    setupRealtimeNisnCheck();

                    openSiswaModal();
                });
                closeSiswaModalBtn.addEventListener('click', closeSiswaModal);
                cancelSiswaBtn.addEventListener('click', closeSiswaModal);
            }
            if (deleteAllStudentsBtn) {
                deleteAllStudentsBtn.addEventListener('click', function() {
                    showTypeToConfirmModal({
                        title: 'Hapus Semua Data Siswa',
                        body: 'Anda akan menghapus **SELURUH** data siswa di database Anda. Tindakan ini tidak dapat dibatalkan.',
                        onConfirm: () => {
                            // Fungsi ini akan dijalankan setelah konfirmasi berhasil
                            const btn = this;
                            btn.disabled = true;
                            showGlobalStatus('Menghapus semua data siswa...', true);

                            google.script.run
                                .withSuccessHandler(response => {
                                    showGlobalStatus(response.message, response.status === 'success');
                                    if (response.status === 'success') { // <-- Tambahkan pengecekan ini
                                        sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                                        checkAndApplyRekapIndicator();                   // <-- TAMBAHKAN
                                    }
                                    loadStudentsData();
                                    btn.disabled = false;
                                })
                                .withFailureHandler(err => {
                                    showGlobalStatus('Error: ' + err.message, false);
                                    btn.disabled = false;
                                })
                                .deleteAllStudents(userSpreadsheetId);
                        }
                    });
                });
            }
            if (downloadTemplateBtn) {
                downloadTemplateBtn.addEventListener('click', () => {
                    const btn = downloadTemplateBtn;
                    btn.disabled = true;
                    btn.textContent = 'Membuat Template...';
                    google.script.run
                        .withSuccessHandler(result => {
                            btn.disabled = false;
                            btn.textContent = 'Download Template';
                            if (result.base64Data) {
                                const link = document.createElement('a');
                                link.href = `data:${result.mimeType};base64,${result.base64Data}`;
                                link.download = result.fileName;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                showGlobalStatus('Template berhasil diunduh.', true);
                            } else {
                                showGlobalStatus('Gagal membuat template: ' + (result.error || 'Unknown error'), false);
                            }
                        })
                        .withFailureHandler(error => {
                            showGlobalStatus('Error: ' + error.message, false);
                            btn.disabled = false;
                            btn.textContent = 'Download Template';
                        })
                        .generateSiswaTemplate();
                });
            }
            if (siswaFileInput) {
                siswaFileInput.addEventListener('change', () => {
                    const file = siswaFileInput.files[0];
                    if (file) {
                        fileNameSpan.textContent = file.name;
                        importSiswaBtn.disabled = false;
                    } else {
                        fileNameSpan.textContent = 'Tidak ada file dipilih';
                        importSiswaBtn.disabled = true;
                    }
                });
            }
            /**
             * =======================================================================
             * INSTRUKSI:
             * Ganti seluruh event listener untuk 'importSiswaBtn' di file Index.html Anda
             * dengan kode di bawah ini.
             * * Perubahan ini akan:
             * 1. Selalu menampilkan notifikasi pop-up ringkas di pojok atas.
             * 2. Hanya menampilkan laporan detail di bawah jika ada KONFLIK data.
             * 3. Tidak menampilkan rincian hasil impor jika semuanya sukses.
             * =======================================================================
             */

            // Ganti seluruh blok 'if (importSiswaBtn)' Anda dengan ini.
            if (importSiswaBtn) {
                importSiswaBtn.addEventListener('click', () => {
                    const file = siswaFileInput.files[0];
                    if (!file) {
                        showGlobalStatus('Silakan pilih file untuk diimpor.', false);
                        return;
                    }
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        const fileData = {
                            fileName: file.name,
                            mimeType: file.type,
                            content: reader.result.split(',')[1]
                        };
                        const importStatusDiv = document.getElementById('importStatus');
                        importStatusDiv.innerHTML = '<p class="text-blue-600 loading-animation">Mengimpor data, mohon tunggu...</p>';
                        importSiswaBtn.disabled = true;
                        importSiswaBtn.textContent = 'Mengimpor...';
                        
                        google.script.run
                            .withSuccessHandler(response => {
                                // --- AWAL PERUBAHAN DI SINI (SUCCESS HANDLER) ---
                                importSiswaBtn.textContent = 'Import Data';
                                document.getElementById('fileName').textContent = 'Tidak ada file dipilih';
                                siswaFileInput.value = '';
                                
                                // Baris ini diubah dari 'false' menjadi 'true' agar tombol kembali nonaktif
                                importSiswaBtn.disabled = true; 
                                // --- AKHIR PERUBAHAN (SUCCESS HANDLER) ---

                                // 1. Tampilkan notifikasi ringkasan global (pop-up) untuk setiap hasil
                                if (response.status !== 'error') {
                                    // [PERBAIKAN] Tambahkan info siswa yang dilewati karena limit ke notifikasi
                                    const summaryMessage = `Impor Selesai: <strong>${response.newCount || 0}</strong> baru, ` +
                                                          `<strong>${response.enrichedCount || 0}</strong> diperkaya, ` +
                                                          `<strong>${response.skippedLimitCount || 0}</strong> dilewati (kuota), ` +
                                                          `<strong>${response.conflictCount || 0}</strong> konflik.`;
                                    showGlobalStatus(summaryMessage, true);
                                } else {
                                    showGlobalStatus(response.message, false);
                                    importStatusDiv.innerHTML = `<p class="p-4 bg-red-100 text-red-700 rounded-md">${response.message}</p>`;
                                    return;
                                }

                                // 2. Hanya bangun dan tampilkan laporan detail jika ada konflik ATAU siswa yang dilewati
                                if (response.conflictCount > 0 || response.skippedLimitCount > 0) {
                                    let reportHtml = `<div class="p-4 border rounded-md bg-gray-50 mt-4">`;

                                    // Bagian untuk KONFLIK DATA (jika ada)
                                    if (response.conflictCount > 0) {
                                        currentImportConflicts = response.conflicts;
                                        reportHtml += `
                                            <h4 class="font-bold text-lg text-yellow-800">Tinjau Konflik Data</h4>
                                            <p class="text-sm text-gray-600 mb-2">Ditemukan ${response.conflictCount} data dengan NISN yang sama namun isinya berbeda. Pilih data yang ingin Anda perbarui.</p>
                                            <div class="my-2"><input type="checkbox" id="selectAllConflicts" class="mr-2 h-4 w-4 align-middle"><label for="selectAllConflicts" class="align-middle">Pilih Semua</label></div>
                                            <div class="max-h-60 overflow-y-auto border rounded-md">
                                                <table class="min-w-full text-sm">
                                                    <thead class="bg-gray-200 sticky top-0">
                                                        <tr>
                                                            <th class="p-2">Pilih</th><th class="p-2 text-left">NISN (Klik Detail)</th>
                                                            <th class="p-2 text-left">Nama Lama</th><th class="p-2 text-left">Nama Baru</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>`;
                                        currentImportConflicts.forEach((c, index) => {
                                            reportHtml += `
                                                <tr class="border-b" data-conflict-index="${index}">
                                                    <td class="p-2 text-center"><input type="checkbox" class="conflict-checkbox h-4 w-4"></td>
                                                    <td class="p-2 font-mono"><a href="#" class="text-blue-600 hover:underline conflict-detail-link" data-index="${index}">${c.nisn}</a></td>
                                                    <td class="p-2">${c.oldData.nama}</td>
                                                    <td class="p-2 text-green-700 font-medium">${c.newData.nama}</td>
                                                </tr>`;
                                        });
                                        reportHtml += `</tbody></table></div>
                                            <div class="mt-4 flex flex-wrap gap-3">
                                                <button id="updateSelectedBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Update yang Dipilih</button>
                                                <button id="updateAllBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Update Semua Konflik</button>
                                                <button id="cancelImportUpdateBtn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Batal & Tutup</button>
                                            </div>`;
                                    }

                                    // [BARU] Bagian untuk SISWA YANG DILEWATI KARENA KUOTA (jika ada)
                                    if (response.skippedLimitCount > 0) {
                                        reportHtml += `<div class="mt-6 pt-4 border-t">
                                                <h4 class="font-bold text-lg text-orange-800">Siswa Dilewati (Batas Kuota Penuh)</h4>
                                                <p class="text-sm text-gray-600 mb-2">${response.skippedLimitCount} siswa dari file tidak diimpor karena akan melebihi batas kuota Anda.</p>
                                                <div class="max-h-48 overflow-y-auto border rounded-md">
                                                    <table class="min-w-full text-sm">
                                                        <thead class="bg-orange-100 sticky top-0">
                                                            <tr><th class="p-2 text-left">NISN</th><th class="p-2 text-left">Nama Siswa</th></tr>
                                                        </thead>
                                                        <tbody>`;
                                        response.skippedLimitData.forEach(s => {
                                            reportHtml += `<tr class="border-b"><td class="p-2 font-mono">${s.nisn}</td><td class="p-2">${s.nama}</td></tr>`;
                                        });
                                        reportHtml += `</tbody></table></div></div>`;
                                    }
                                    
                                    reportHtml += `</div>`; // Penutup div utama
                                    importStatusDiv.innerHTML = reportHtml;
                                    if(response.conflictCount > 0) {
                                      setupConflictResolutionListeners(response);
                                    }
                                } else {
                                    importStatusDiv.innerHTML = '';
                                }

                                // 3. Muat ulang tabel siswa jika ada data yang ditambahkan atau diperkaya
                                if (response.newCount > 0 || response.enrichedCount > 0) {
                                    loadStudentsData();
                                }
                            })
                            .withFailureHandler(error => {
                                showGlobalStatus('Error: ' + error.message, false);
                                
                                // --- AWAL PERUBAHAN DI SINI (FAILURE HANDLER) ---
                                importSiswaBtn.textContent = 'Import Data';
                                document.getElementById('fileName').textContent = 'Tidak ada file dipilih';
                                siswaFileInput.value = '';
                                
                                // Baris ini juga diubah menjadi 'true' agar tombol nonaktif jika gagal
                                importSiswaBtn.disabled = true;
                                // --- AKHIR PERUBAHAN (FAILURE HANDLER) ---
                                
                                importStatusDiv.innerHTML = `<p class="p-4 bg-red-100 text-red-700 rounded-md">${error.message}</p>`;
                            })
                            .importFromExcel(userSpreadsheetId, fileData, 'Data Siswa', sessionStorage.getItem('userEmail'));
                    };
                    reader.onerror = () => {
                        showGlobalStatus('Gagal membaca file.', false);
                    };
                });
            }

            /**
             * [BARU] Fungsi helper untuk memasang semua event listener pada UI penyelesaian konflik.
             * Ini membuat kode lebih rapi dan terorganisir.
             * @param {object} response - Objek respons dari server yang berisi data konflik.
             */
            function setupConflictResolutionListeners(response) {
                document.getElementById('selectAllConflicts').onchange = (e) => {
                    document.querySelectorAll('.conflict-checkbox').forEach(cb => cb.checked = e.target.checked);
                };

                const handleBatchUpdate = (selectedIndices) => {
                    if (selectedIndices.length === 0) {
                        showGlobalStatus("Tidak ada data yang dipilih untuk diupdate.", false);
                        return;
                    }
                    const studentsToUpdate = selectedIndices.map(index => {
                        const conflict = response.conflicts[index];
                        return { ...conflict.newData, studentRow: conflict.rowToUpdate };
                    });
                    showGlobalStatus(`Mengupdate ${studentsToUpdate.length} data...`, true);
                    google.script.run
                        .withSuccessHandler(res => {
                            showGlobalStatus(res.message, res.status === 'success');
                            if (res.status === 'success') { // <-- Tambahkan pengecekan ini
                                sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                                checkAndApplyRekapIndicator();                   // <-- TAMBAHKAN
                            }
                            const importStatusDiv = document.getElementById('importStatus');
                            importStatusDiv.innerHTML = `<p class="p-4 bg-green-100 text-green-800 rounded-md">${res.message}. Memuat ulang data siswa...</p>`;
                            setTimeout(() => {
                                loadStudentsData();
                                importStatusDiv.innerHTML = '';
                            }, 2000);
                        })
                        .withFailureHandler(err => showGlobalStatus("Gagal update massal: " + err.message, false))
                        .batchUpdateStudents(userSpreadsheetId, studentsToUpdate);
                };

                document.getElementById('updateSelectedBtn').onclick = () => {
                    const selectedIndices = [];
                    document.querySelectorAll('.conflict-checkbox:checked').forEach(cb => {
                        const index = cb.closest('tr').dataset.conflictIndex;
                        selectedIndices.push(parseInt(index));
                    });
                    handleBatchUpdate(selectedIndices);
                };

                document.getElementById('updateAllBtn').onclick = () => {
                    const allIndices = response.conflicts.map((_, index) => index);
                    handleBatchUpdate(allIndices);
                };

                document.getElementById('cancelImportUpdateBtn').onclick = () => {
                    document.getElementById('importStatus').innerHTML = '';
                    showGlobalStatus("Proses update dari file dibatalkan.", true);
                };

                setupConflictDetailListeners();
            }


            // Ganti seluruh event listener 'siswaForm' Anda dengan ini:
            if (siswaForm) {
                siswaForm.addEventListener('submit', e => {
                    e.preventDefault();
                    if (document.getElementById('nisn-error-msg').textContent) {
                        showGlobalStatus('Form belum valid. Periksa kembali pesan error yang ada.', false);
                        return;
                    }

                    const studentData = Object.fromEntries(new FormData(e.target).entries());
                    const isEditing = !!studentData.studentRow;
                    
                    // Atur pesan dinamis untuk overlay
                    const overlay = document.getElementById('loading-overlay');
                    const overlayTitle = document.getElementById('overlay-title');
                    const overlaySubtitle = document.getElementById('overlay-subtitle');
                    
                    overlayTitle.innerHTML = isEditing 
                        ? `Menyimpan Perubahan <br class="sm:hidden"> <strong class="text-blue-600">"${studentData.nama}"</strong>`
                        : `Menambahkan Siswa <br class="sm:hidden"> <strong class="text-blue-600">"${studentData.nama}"</strong>`;
                    overlaySubtitle.textContent = "Proses sedang berjalan, mohon tunggu...";
                    overlay.classList.remove('hidden');

                    const handler = isEditing ? 'updateStudent' : 'addStudent';
                    
                    google.script.run
                        .withSuccessHandler(response => {
                            overlay.classList.add('hidden'); // Sembunyikan overlay
                            showGlobalStatus(response.message, response.status !== 'error');

                            if (response.status === 'success' && response.updatedStudentList) {
                                sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                                checkAndApplyRekapIndicator();   
                                closeSiswaModal();
                                allStudentsData = response.updatedStudentList;
                                renderSiswaTable(response.updatedStudentList);
                            } else if (response.status === 'conflict') {
                                closeSiswaModal();
                                displayConflictModal(response.oldData, response.newData);
                            }
                        })
                        .withFailureHandler(error => {
                            overlay.classList.add('hidden');
                            showGlobalStatus(error.message, false);
                        })
                        [handler](userSpreadsheetId, studentData, sessionStorage.getItem('userEmail'));
                });
            }

            // Tambahkan fungsi baru untuk menampilkan modal konflik
            function displayConflictModal(oldData, newData) {
                document.getElementById('conflictNisn').textContent = oldData.nisn;

                // Fungsi helper untuk membuat tampilan data
                const createDataHtml = (data) => `
                    <p><strong>Nama:</strong> ${data.nama}</p>
                    <p><strong>NIS:</strong> ${data.nis || '-'}</p>
                    <p><strong>Tempat Lahir:</strong> ${toProperCase(data.tempatLahir) || '-'}</p>
                    <p><strong>Tgl Lahir:</strong> ${formatIndonesianDate(data.tanggalLahir) || '-'}</p>
                `;

                document.getElementById('old-data-display').innerHTML = createDataHtml(oldData);
                document.getElementById('new-data-display').innerHTML = createDataHtml(newData);

                const modal = document.getElementById('update-confirm-modal');
                modal.classList.remove('hidden');
                
                // Fungsi untuk menutup modal
                const closeModal = () => modal.classList.add('hidden');
                document.getElementById('cancelUpdateBtn').onclick = closeModal;

                // Logika saat tombol "Ya, Update Data" diklik
                document.getElementById('confirmUpdateBtn').onclick = () => {
                    const studentUpdateData = { ...newData, studentRow: oldData.row };
                    
                    showGlobalStatus('Mengirim permintaan update...', true);
                    google.script.run
                        .withSuccessHandler(res => {
                            showGlobalStatus(res.message, res.status === 'success');
                            if (res.status === 'success') {
                                loadStudentsData();
                            }
                        })
                        .withFailureHandler(err => showGlobalStatus('Gagal update: ' + err.message, false))
                        .updateStudent(userSpreadsheetId, studentUpdateData);
                    
                    closeModal();
                };
            }

            /**
             * [MODIFIKASI] Fungsi untuk mengambil data siswa dari server.
             * Kini juga memanggil fungsi untuk menampilkan kuota.
             */
            // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
            function loadStudentsData() {
                // BARIS BARU: Bersihkan notifikasi/tombol refresh lama
                document.getElementById('importStatus').innerHTML = ''; 

                const container = document.getElementById('siswaTableContainer');
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Memuat data siswa...</p>`;

                loadAndDisplayStudentQuota(); 

                google.script.run
                    .withSuccessHandler(students => {
                        allStudentsData = students || []; 
                        renderSiswaTable(allStudentsData); 
                    })
                    .withFailureHandler(err => {
                        container.innerHTML = `<p class="text-center text-red-500 py-4">Gagal memuat data: ${err.message}</p>`;
                    })
                    .getStudents(userSpreadsheetId);
            }

            /**
             * [MODIFIKASI] Menampilkan data siswa ke dalam tabel HTML, dengan tambahan kolom JK.
             * @param {Array<object>} studentsToRender - Array data siswa yang ingin ditampilkan.
             */
            function renderSiswaTable(studentsToRender) {
                const container = document.getElementById('siswaTableContainer');
                container.innerHTML = ''; 

                if (studentsToRender && studentsToRender.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'min-w-full divide-y divide-gray-200';
                    table.innerHTML = `
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                    <input type="checkbox" id="select-all-students-checkbox" class="h-4 w-4 rounded border-gray-300">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">JK</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TEMPAT, TANGGAL LAHIR</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200"></tbody>`;
                    
                    const tbody = table.querySelector('tbody');
                    studentsToRender.forEach(s => {
                        const tr = document.createElement('tr');
                        const formattedDate = formatIndonesianDate(s.tanggalLahir);
                        const tempat = toProperCase(s.tempatLahir || '');
                        const tanggal = formattedDate || '';
                        let ttl = (!tempat && !tanggal) ? `<em class="text-gray-400">(data kosong)</em>` : (tempat && tanggal ? `${tempat}, ${tanggal}` : tempat || tanggal);

                        tr.innerHTML = `
                            <td class="px-4 py-4 whitespace-nowrap">
                                <input type="checkbox" class="student-checkbox h-4 w-4 rounded border-gray-300" data-row="${s.row}">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${s.nisn}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 nama-siswa-cell">${s.nama.toUpperCase()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500 font-medium">${s.jenisKelamin || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ttl}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button class="text-green-600 hover:text-green-900 font-bold" data-action="transcript" title="Lihat Transkrip">Transkrip</button>
                                <button class="text-indigo-600 hover:text-indigo-900 ml-4" data-action="edit">Edit</button>
                                <button class="text-red-600 hover:text-red-900 ml-4" data-action="delete">Hapus</button>
                            </td>`;
                        
                        tr.querySelector('[data-action="transcript"]').addEventListener('click', () => handleShowTranscript(s.nisn));
                        tr.querySelector('[data-action="edit"]').addEventListener('click', () => handleEditStudent(s));
                        tr.querySelector('[data-action="delete"]').addEventListener('click', (e) => handleDeleteStudent(s, e.target));
                        
                        tbody.appendChild(tr);
                    });
                    
                    container.appendChild(table);
                    attachTableCheckboxListeners();
                } else {
                    container.innerHTML = `<p class="text-center text-gray-500 py-4">Belum ada data siswa atau data tidak ditemukan.</p>`;
                }
                updateBulkActionBar();
            }

            /**
             * [MODIFIKASI] Menyiapkan modal saat tombol 'Edit' diklik.
             * Kini juga membersihkan pesan error NISN lama sebelum menampilkan modal.
             * @param {object} student Objek data siswa yang akan diedit.
             */
            function handleEditStudent(student) {
                const siswaModalTitle = document.getElementById('siswa-modal-title');
                const studentRowInput = document.getElementById('studentRow');
                const siswaForm = document.getElementById('siswaForm');

                // Kosongkan form dan pesan error sebelumnya
                siswaForm.reset(); 
                document.getElementById('nisn-error-msg').textContent = ''; // <-- [PERBAIKAN] Baris ini ditambahkan

                siswaModalTitle.textContent = "Edit Data Siswa";
                studentRowInput.value = student.row;
                
                // Isi semua field dengan data siswa yang akan diedit
                document.getElementById('nama').value = student.nama;
                document.getElementById('nisn').value = student.nisn;
                document.getElementById('nis').value = student.nis;
                document.getElementById('jenisKelamin').value = student.jenisKelamin;
                document.getElementById('tempatLahir').value = toProperCase(student.tempatLahir);
                document.getElementById('tanggalLahir').value = student.tanggalLahir;
                document.getElementById('alamatSiswa').value = student.alamat || '';
                document.getElementById('teleponSiswa').value = student.telepon || '';
                document.getElementById('emailSiswa').value = student.emailSiswa || '';
                document.getElementById('tahunMasuk').value = student.tahunMasuk || '';
                document.getElementById('tahunLulus').value = student.tahunLulus || '';

                openSiswaModal();
            }

            /**
             * [UX UPGRADE] Menangani aksi hapus siswa dengan konfirmasi 2 langkah
             * dan menampilkan overlay loading dinamis.
             */
            function handleDeleteStudent(student, targetButton) {
                if (targetButton.dataset.confirming) {
                    // Tampilkan loading overlay dengan nama siswa
                    const overlay = document.getElementById('loading-overlay');
                    const overlayTitle = document.getElementById('overlay-title');
                    const overlaySubtitle = document.getElementById('overlay-subtitle');
                    overlayTitle.innerHTML = `Menghapus Data Siswa <br class="sm:hidden"> <strong class="text-red-600">"${student.nama}"</strong>`;
                    overlaySubtitle.textContent = "Proses sedang berjalan, mohon tunggu...";
                    overlay.classList.remove('hidden');
                    
                    google.script.run
                        .withSuccessHandler(response => {
                            overlay.classList.add('hidden');
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.status === 'success' && response.updatedStudentList) {
                                sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                                checkAndApplyRekapIndicator();  
                                allStudentsData = response.updatedStudentList;
                                renderSiswaTable(response.updatedStudentList);
                            }
                        })
                        .withFailureHandler(err => {
                            overlay.classList.add('hidden');
                            showGlobalStatus(err.message, false);
                        })
                        .deleteStudent(userSpreadsheetId, student.row);
                } else {
                    // Logika untuk klik pertama (konfirmasi)
                    targetButton.textContent = 'Yakin?';
                    targetButton.dataset.confirming = true;
                    targetButton.classList.add('text-yellow-500', 'font-bold');
                    targetButton.classList.remove('text-red-600');

                    setTimeout(() => {
                        if (targetButton.dataset.confirming) {
                            targetButton.textContent = 'Hapus';
                            delete targetButton.dataset.confirming;
                            targetButton.classList.remove('text-yellow-500', 'font-bold');
                            targetButton.classList.add('text-red-600');
                        }
                    }, 3000);
                }
            }

            // --- MAPEL & BOBOT FUNCTIONS ---
            const bobotUjianInput = document.getElementById('bobotUjian');
            const bobotRaporInput = document.getElementById('bobotRapor');
            const bobotForm = document.getElementById('bobotForm');

            function syncBobot(source, target) {
                source.addEventListener('input', () => {
                    const sourceVal = parseInt(source.value, 10);
                    if (!isNaN(sourceVal) && sourceVal >= 0 && sourceVal <= 100) target.value = 100 - sourceVal;
                    else if (source.value === '') target.value = '';
                    else if (sourceVal > 100) {
                        source.value = 100;
                        target.value = 0;
                    }
                });
            }
            if (bobotUjianInput && bobotRaporInput) {
                syncBobot(bobotUjianInput, bobotRaporInput);
                syncBobot(bobotRaporInput, bobotUjianInput);
            }
            if (bobotForm) {
                bobotForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const saveBtn = e.currentTarget.querySelector('button[type="submit"]');
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Menyimpan...';
                    const bobotData = {
                        bobotUjian: bobotUjianInput.value,
                        bobotRapor: bobotRaporInput.value
                    };
                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.status === 'success') {
                                sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                                checkAndApplyRekapIndicator();                   // <-- TAMBAHKAN
                            }
                            saveBtn.disabled = false;
                            saveBtn.textContent = 'Simpan Bobot';
                        })
                        .withFailureHandler(err => {
                            showGlobalStatus('Gagal menyimpan bobot: ' + err.message, false);
                            saveBtn.disabled = false;
                            saveBtn.textContent = 'Simpan Bobot';
                        })
                        .saveBobot(userSpreadsheetId, bobotData);
                });
            }

            function loadBobotData() {
                google.script.run
                    .withSuccessHandler(data => {
                        if (data) {
                            bobotUjianInput.value = data.bobotUjian || '';
                            bobotRaporInput.value = data.bobotRapor || '';
                        }
                    })
                    .getBobot(userSpreadsheetId);
            }

            const addMapelBtn = document.getElementById('addMapelBtn');
            const mapelModal = document.getElementById('mapel-modal');
            const closeMapelModalBtn = document.getElementById('closeMapelModalBtn');
            const cancelMapelBtn = document.getElementById('cancelMapelBtn');
            const mapelForm = document.getElementById('mapelForm');
            const mapelModalTitle = document.getElementById('mapel-modal-title');
            const mapelRowInput = document.getElementById('mapelRow');
            const downloadMapelTemplateBtn = document.getElementById('downloadMapelTemplateBtn');
            const importMapelBtn = document.getElementById('importMapelBtn');
            const mapelFileInput = document.getElementById('mapelFileInput');
            const mapelFileNameSpan = document.getElementById('mapelFileName');
            const importMapelStatusDiv = document.getElementById('importMapelStatus');
            const importMapelSystemBtn = document.getElementById('importMapelSystemBtn');
            const deleteAllMapelBtn = document.getElementById('deleteAllMapelBtn');

            const openMapelModal = () => {
                mapelModal.classList.remove('hidden');
                setTimeout(() => mapelModal.style.opacity = '1', 10);
            };
            const closeMapelModal = () => {
                mapelModal.style.opacity = '0';
                setTimeout(() => mapelModal.classList.add('hidden'), 300);
            };
            if (addMapelBtn) {
                addMapelBtn.addEventListener('click', () => {
                    mapelForm.reset();
                    mapelRowInput.value = '';
                    mapelModalTitle.textContent = "Tambah Mata Pelajaran";
                    openMapelModal();
                });
                closeMapelModalBtn.addEventListener('click', closeMapelModal);
                cancelMapelBtn.addEventListener('click', closeMapelModal);
            }
            if (deleteAllMapelBtn) {
                deleteAllMapelBtn.addEventListener('click', function() {
                    showTypeToConfirmModal({
                        title: 'Hapus Semua Mata Pelajaran',
                        body: 'Anda akan menghapus **SELURUH** data mata pelajaran. Anda harus mengimpor atau menambahkannya lagi dari awal. Tindakan ini tidak dapat dibatalkan.',
                        onConfirm: () => {
                            const btn = this;
                            btn.disabled = true;
                            showGlobalStatus('Menghapus semua mapel...', true);

                            google.script.run
                                .withSuccessHandler(response => {
                                    showGlobalStatus(response.message, response.status === 'success');
                                    if (response.status === 'success') { // <-- Tambahkan pengecekan ini
                                        sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                                        checkAndApplyRekapIndicator();                   // <-- TAMBAHKAN
                                    }
                                    loadMapelData();
                                    btn.disabled = false;
                                })
                                .withFailureHandler(err => {
                                    showGlobalStatus('Error: ' + err.message, false);
                                    btn.disabled = false;
                                })
                                .deleteAllMapel(userSpreadsheetId);
                        }
                    });
                });
            }
            // HAPUS event listener lama untuk importMapelSystemBtn dan GANTI dengan ini:
            if (importMapelSystemBtn) {
                importMapelSystemBtn.addEventListener('click', function() {
                    openMapelImportModal();
                });
            }

            function loadMapelData() {
                console.log("[DEBUG] Fungsi loadMapelData() dipanggil.");
                const container = document.getElementById('mapelTableContainer');
                container.innerHTML = `<p class="text-center text-gray-500 py-4 loading-animation">Memuat data mapel</p>`;
                google.script.run
                    .withSuccessHandler(mapelList => {
                        console.log("[DEBUG] Menerima data dari getMapel. Jumlah mapel: " + (mapelList ? mapelList.length : 0));
                        allMapelData = mapelList || [];
                        console.log("[DEBUG] Memanggil renderMapelTable dari dalam loadMapelData().");
                        renderMapelTable(allMapelData);
                    })
                    .withFailureHandler(err => {
                        console.error("[DEBUG] Gagal dalam loadMapelData:", err);
                        container.innerHTML = `<p class="text-center text-red-500 py-4">Gagal memuat data: ${err.message}</p>`;
                    })
                    .getMapel(userSpreadsheetId);
            }


            // --- DENGAN KUMPULAN KODE BARU INI ---

            // Variabel baru untuk tabel mapel
            const mapelInputTbody = document.getElementById('mapel-input-tbody');
            const addMapelRowBtn = document.getElementById('addMapelRowBtn');
            const saveAllMapelBtn = document.getElementById('saveAllMapelBtn');

            // Fungsi untuk membuat satu baris input mapel
            function createMapelInputRow() {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `
                    <td class="p-1"><input type="text" name="kode" class="w-full p-2 border rounded-md" required></td>
                    <td class="p-1"><input type="text" name="nama" class="w-full p-2 border rounded-md" required></td>
                    <td class="p-1">
                        <select name="kelompok" class="w-full p-2 border rounded-md bg-white">
                            <option>Umum</option><option>Peminatan</option><option>Muatan Lokal</option>
                        </select>
                    </td>
                    <td class="p-1">
                        <select name="jenisUjian" class="w-full p-2 border rounded-md bg-white">
                            <option>Ujian Madrasah</option><option>Ujian Praktek</option><option>Keduanya</option>
                        </select>
                    </td>
                    <td class="p-1 text-center">
                        <button type="button" class="delete-mapel-row text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
                    </td>
                `;
                // Tambahkan event listener untuk tombol hapus baris ini
                tr.querySelector('.delete-mapel-row').addEventListener('click', () => {
                    tr.remove();
                });
                return tr;
            }

            // Event listener untuk membuka modal dan menyiapkan baris pertama
            if (addMapelBtn) {
                addMapelBtn.addEventListener('click', () => {
                    // Kosongkan tabel dan tambahkan satu baris baru setiap kali modal dibuka
                    mapelInputTbody.innerHTML = '';
                    mapelInputTbody.appendChild(createMapelInputRow());
                    
                    mapelModalTitle.textContent = "Tambah Mata Pelajaran Massal";
                    openMapelModal();
                });
            }

            // Event listener untuk tombol "+ Tambah Baris"
            if (addMapelRowBtn) {
                addMapelRowBtn.addEventListener('click', () => {
                    mapelInputTbody.appendChild(createMapelInputRow());
                });
            }

            // Ganti seluruh blok 'if (saveAllMapelBtn)' Anda dengan ini:
            if (saveAllMapelBtn) {
                saveAllMapelBtn.addEventListener('click', () => {
                    const rows = mapelInputTbody.querySelectorAll('tr');
                    const mapelArray = [];
                    let hasError = false;

                    rows.forEach(row => {
                        const kodeInput = row.querySelector('input[name="kode"]');
                        const namaInput = row.querySelector('input[name="nama"]');
                        const kode = kodeInput.value.trim();
                        const nama = namaInput.value.trim();

                        if (!kode || !nama) {
                            kodeInput.style.borderColor = !kode ? 'red' : '';
                            namaInput.style.borderColor = !nama ? 'red' : '';
                            hasError = true;
                        } else {
                            kodeInput.style.borderColor = '';
                            namaInput.style.borderColor = '';
                            mapelArray.push({
                                kode: kode,
                                nama: nama,
                                kelompok: row.querySelector('select[name="kelompok"]').value,
                                jenisUjian: row.querySelector('select[name="jenisUjian"]').value
                            });
                        }
                    });

                    if (hasError) {
                        showGlobalStatus("Kode Mapel dan Nama Mapel tidak boleh kosong.", false);
                        return;
                    }

                    if (mapelArray.length === 0) {
                        showGlobalStatus("Tidak ada data mapel untuk disimpan.", false);
                        return;
                    }
                    
                    // Tampilkan loading overlay SEBELUM memanggil server
                    const overlay = document.getElementById('loading-overlay');
                    const overlayTitle = document.getElementById('overlay-title');
                    overlayTitle.textContent = "Menyimpan Data Mapel...";
                    overlay.classList.remove('hidden');

                    google.script.run
                        .withSuccessHandler(response => {
                            overlay.classList.add('hidden'); // Sembunyikan overlay setelah selesai
                            showGlobalStatus(response.message, response.status === 'success');
                            
                            if (response.status === 'success' && response.updatedMapelList) {
                                sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                                checkAndApplyRekapIndicator();   
                                closeMapelModal();
                                // Langsung render data baru dari server
                                allMapelData = response.updatedMapelList;
                                renderMapelTable(response.updatedMapelList);
                            }
                        })
                        .withFailureHandler(error => {
                            overlay.classList.add('hidden'); // Sembunyikan overlay jika error
                            showGlobalStatus(error.message, false);
                        })
                        .addMultipleMapel(userSpreadsheetId, mapelArray);
                });
            }

            // [MODIFIKASI] Mengembalikan fungsi edit mapel dengan modal terpisah

            // Dapatkan elemen dari modal edit yang baru
            const editMapelModal = document.getElementById('edit-mapel-modal');
            const editMapelForm = document.getElementById('editMapelForm');
            const closeEditMapelModalBtn = document.getElementById('closeEditMapelModalBtn');
            const cancelEditMapelBtn = document.getElementById('cancelEditMapelBtn');

            // Fungsi untuk menutup modal edit
            const closeEditMapelModal = () => {
                editMapelModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => editMapelModal.classList.add('hidden'), 300);
            };

            // Pasang event listener untuk tombol tutup dan batal pada modal edit
            closeEditMapelModalBtn.addEventListener('click', closeEditMapelModal);
            cancelEditMapelBtn.addEventListener('click', closeEditMapelModal);

            // --- INPUT NILAI FUNCTIONS ---
            // Kode Baru
            document.getElementById('btn-show-ujian-madrasah').addEventListener('click', () => {
                updateUjianButtonState('btn-show-ujian-madrasah');
                buildScoreTable('madrasah', 'Tabel Input Nilai Ujian Madrasah');
            });
            document.getElementById('btn-show-ujian-praktek').addEventListener('click', () => {
                updateUjianButtonState('btn-show-ujian-praktek');
                buildScoreTable('praktek', 'Tabel Input Nilai Ujian Praktek');
            });
            document.getElementById('btn-cek-rata-ujian').addEventListener('click', () => {
                updateUjianButtonState('btn-cek-rata-ujian');
                calculateUjianAverage();
            });

            // GANTI SELURUH FUNGSI LAMA ANDA DENGAN VERSI BARU INI

            // GANTI FUNGSI LAMA DENGAN VERSI YANG SUDAH DIPERBAIKI INI
            function buildScoreTable(jenis, title) {
                clearHistoryAndHideButtons(); 
                document.getElementById('undo-redo-container').classList.remove('hidden'); 
                setupScoreInputListeners('input-ujian-container'); 

                const container = document.getElementById('input-ujian-container');
                container.innerHTML = `<div class="text-center p-8"><p class="font-bold loading-animation">Memuat data untuk tabel nilai</p><p>Silakan tunggu sebentar...</p></div>`;

                const sheetName = jenis === 'madrasah' ? 'Nilai Ujian Madrasah' : 'Nilai Ujian Praktek';

                Promise.all([
                    new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getStudents(userSpreadsheetId)),
                    new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getMapelByJenis(userSpreadsheetId, jenis)),
                    new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, sheetName)),
                    new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getKkm(userSpreadsheetId))
                ]).then(([students, mapelList, existingScores, kkmResponse]) => {
                    activeTableKey = jenis;
                    container.innerHTML = ''; 

                    if (!students || students.length === 0) {
                        container.innerHTML = `<p class="text-center text-red-500 p-4">Data siswa tidak ditemukan. Harap isi data siswa terlebih dahulu.</p>`;
                        return;
                    }
                    if (!mapelList || mapelList.length === 0) {
                        container.innerHTML = `<p class="text-center text-red-500 p-4">Tidak ada mata pelajaran yang ditandai untuk Ujian ${jenis}. Silahkan edit dan ubah Jenis Ujian pada Mata Pelajaran.</p>`;
                        return;
                    }
                    
                    const kkmValue = (kkmResponse && kkmResponse.status === 'success') ? kkmResponse.kkm : 75;

                    const mainWrapper = document.createElement('div');
                    mainWrapper.className = 'bg-white p-6 rounded-lg shadow-md'; 

                    const tableHtml = `
                        <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800">${title}</h2>
                                <p class="mt-1 text-gray-600">Klik "Ubah Nilai" untuk mulai mengisi. Rata-rata di bawah KKM (${kkmValue}) akan ditandai merah.</p>
                            </div>
                            <div>
                                <button type="button" id="edit-scores-btn-${jenis}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                    Ubah Nilai
                                </button>
                            </div>
                        </div>
                        <form id="form-nilai-${jenis}">
                            <div class="overflow-x-auto">
                                <table id="score-table-${jenis}" class="score-table min-w-full divide-y divide-gray-200" data-kkm="${kkmValue}">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                                            ${mapelList.map(m => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}
                                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-Rata</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${students.map((s, index) => {
                                            const studentScores = existingScores[s.nisn] || {};
                                            let rowHtml = `<tr data-nisn="${s.nisn}" data-nama="${s.nama.toUpperCase()}"><td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${index + 1}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${s.nisn}</td><td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 nama-siswa-cell">${s.nama.toUpperCase()}</td>`;
                                            mapelList.forEach(m => {
                                                const score = studentScores[m.kode] ?? '';
                                                const numericScore = parseFloat(score);
                                                // Tambahkan baris ini untuk menentukan class berdasarkan KKM
                                                const kkmClass = (!isNaN(numericScore) && numericScore < kkmValue) ? 'text-red-600 font-bold' : '';
                                                // Tambahkan variabel kkmClass ke dalam class input
                                                rowHtml += `<td class="px-2 py-1"><input type="number" min="0" max="100" class="score-input p-1 border rounded-md ${kkmClass}" data-mapel-kode="${m.kode}" value="${score}" readonly></td>`;
                                            });
                                            rowHtml += `<td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell jumlah-nilai">0</td><td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell rata-rata-nilai">0.00</td></tr>`;
                                            return rowHtml;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div id="actions-container-${jenis}" class="mt-6 pt-4 border-t flex justify-end space-x-3 hidden">
                                <button type="button" class="clear-scores-btn bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Bersihkan</button>
                                <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Simpan Nilai</button>
                            </div>
                        </form>
                    `;
                    
                    mainWrapper.innerHTML = tableHtml;
                    container.appendChild(mainWrapper);

                    document.getElementById(`edit-scores-btn-${jenis}`).addEventListener('click', () => enableScoreEditing(jenis));

                    const scoreTable = document.getElementById(`score-table-${jenis}`);
                    scoreTable.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
                    scoreTable.addEventListener('input', handleScoreInput);
                    scoreTable.addEventListener('paste', handleSmartPaste);
                    document.getElementById(`form-nilai-${jenis}`).addEventListener('submit', (e) => handleSaveNilai(e, jenis));
                    
                    // ▼▼▼ BAGIAN YANG DIPERBAIKI ADA DI SINI ▼▼▼
                    mainWrapper.querySelector('.clear-scores-btn').addEventListener('click', (e) => {
                        const form = e.target.closest('form');
                        showConfirmationModal({
                            title: "Konfirmasi Membersihkan Tabel",
                            body: "Anda yakin ingin menghapus semua nilai yang telah diisi di tabel ini? <br><br><strong class='text-yellow-700'>Aksi ini hanya membersihkan tampilan dan tidak akan menghapus data yang sudah tersimpan sampai Anda menekan tombol 'Simpan'.</strong>",
                            confirmText: "Ya, Bersihkan",
                            confirmColor: "bg-yellow-500 hover:bg-yellow-600",
                            onConfirm: () => {
                                form.querySelectorAll('.score-input').forEach(input => input.value = '');
                                form.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
                                showGlobalStatus("Tabel berhasil dibersihkan.", true);
                            }
                        });
                    });
                    // ▲▲▲ AKHIR DARI BAGIAN YANG DIPERBAIKI ▲▲▲

                    initializeCellSelection(`score-table-${jenis}`, jenis);

                }).catch(err => {
                    container.innerHTML = `<p class="text-center text-red-500 p-4">Terjadi kesalahan saat memuat data: ${err.message}</p>`;
                });
            }

            function handleSaveNilai(event, jenisUjian) {
                event.preventDefault();
                const form = event.target;
                const saveBtn = form.querySelector('button[type="submit"]');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Menyimpan...';
                const allRows = form.querySelectorAll('tbody tr');
                const nilaiData = [];
                allRows.forEach(row => {
                    const studentScores = {
                        nisn: row.dataset.nisn,
                        nama: row.dataset.nama,
                        scores: {}
                    };
                    const inputs = row.querySelectorAll('.score-input');
                    inputs.forEach(input => {
                        studentScores.scores[input.dataset.mapelKode] = input.value;
                    });
                    nilaiData.push(studentScores);
                });
                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        if (response.status === 'success') { // <-- Tambahkan pengecekan ini
                            sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                            checkAndApplyRekapIndicator();                   // <-- TAMBAHKAN
                            disableScoreEditing(jenisUjian); 
                        }
                        saveBtn.disabled = false;
                        saveBtn.textContent = `Simpan Nilai ${jenisUjian}`;
                    })
                    .withFailureHandler(err => {
                        showGlobalStatus(`Gagal menyimpan: ${err.message}`, false);
                        saveBtn.disabled = false;
                        saveBtn.textContent = `Simpan Nilai ${jenisUjian}`;
                    })
                    .saveNilai(userSpreadsheetId, {
                        jenis: jenisUjian,
                        nilai: nilaiData
                    });
            }

            // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
            function initRaporPage() {
                const container = document.getElementById('rapor-container');
                container.innerHTML = '<p>Memeriksa data sekolah...</p>';
                google.script.run
                    .withSuccessHandler(schoolData => {
                        if (!schoolData || !schoolData.jenjang) {
                            container.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">Harap atur <b>Jenjang Sekolah</b> di halaman <a href="#" onclick="document.querySelector('[data-page=data-sekolah]').click()" class="font-bold underline">Data Sekolah</a> terlebih dahulu.</div>`;
                            return;
                        }
                        const jenjang = schoolData.jenjang;
                        const semesterList = semesters[jenjang];
                        let html = '';
                        for (const key in semesterList) {
                            html += `
                                <div class="mb-6 bg-white p-4 rounded-lg shadow-sm rapor-semester-container">
                                    <h3 class="text-xl font-bold text-gray-700">${semesterList[key]}</h3>
                                    <div class="flex flex-wrap gap-4 mt-3">
                                        <button onclick="buildRaporScoreTable(this, '${key}', 'Pengetahuan')" class="rapor-semester-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors text-sm">Input Nilai Pengetahuan</button>
                                        <button onclick="buildRaporScoreTable(this, '${key}', 'Keterampilan')" class="rapor-semester-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors text-sm">Input Nilai Keterampilan</button>
                                        <button onclick="calculateRaporAverage(this, '${key}')" class="rapor-semester-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors text-sm">Cek Rata-Rata Nilai</button>
                                        <button class="delete-rapor-semester-btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 text-sm" data-semester-key="${key}" data-semester-name="${semesterList[key]}">Hapus Data Semester Ini</button>
                                    </div>
                                    <div id="table-container-${key}" class="mt-4 rapor-table-display-area"></div>
                                </div>
                            `;
                        }
                        container.innerHTML = html;
                    })
                    .getSchoolData(userSpreadsheetId);
            }

            // GANTI FUNGSI LAMA ANDA DENGAN VERSI BARU INI

            // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
            // GANTI SELURUH FUNGSI LAMA DENGAN VERSI BARU YANG SUDAH DIPERBAIKI INI
            function calculateUjianAverage() {
                clearHistoryAndHideButtons();
                updateUjianButtonState('btn-cek-rata-ujian');
                const container = document.getElementById('input-ujian-container');
                container.innerHTML = `<div class="text-center p-8"><p class="font-bold loading-animation">Menghitung rata-rata</p><p>Silakan tunggu...</p></div>`;

                Promise.all([
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getStudents(userSpreadsheetId)),
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getMapel(userSpreadsheetId)),
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, 'Nilai Ujian Madrasah')),
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, 'Nilai Ujian Praktek')),
                    // ▼▼▼ LANGKAH 1: Tambahkan pemanggilan untuk mengambil KKM ▼▼▼
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getKkm(userSpreadsheetId))
                ]).then(([students, allMapel, nilaiMadrasah, nilaiPraktek, kkmResponse]) => {
                    
                    container.innerHTML = ''; 

                    if (!students || students.length === 0) {
                        container.innerHTML = `<p class="text-red-500 text-center p-4">Data siswa tidak ditemukan.</p>`;
                        return;
                    }
                    if (!allMapel || allMapel.length === 0) {
                        container.innerHTML = `<p class="text-red-500 text-center p-4">Data mata pelajaran tidak ditemukan.</p>`;
                        return;
                    }
                    
                    // ▼▼▼ LANGKAH 2: Simpan nilai KKM ▼▼▼
                    const kkmValue = (kkmResponse && kkmResponse.status === 'success') ? kkmResponse.kkm : 75;

                    const mainWrapper = document.createElement('div');
                    mainWrapper.className = 'bg-white p-6 rounded-lg shadow-md mt-4';

                    let tableHtml = `
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Tabel Rata-Rata Nilai Ujian</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="border border-gray-300 px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">No</th>
                                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">NISN</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                                        ${allMapel.map(m => `<th class="border border-gray-300 px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}
                                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-Rata</th>
                                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Pembulatan (Input PDUM)</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    students.forEach((student, index) => {
                        tableHtml += `<tr>
                                        <td class="border border-gray-300 px-3 py-2 text-sm text-center">${index + 1}</td>
                                        <td class="border border-gray-300 px-4 py-2 text-sm text-center">${student.nisn}</td>
                                        <td class="border border-gray-300 px-4 py-2 text-sm font-medium nama-siswa-cell">${student.nama.toUpperCase()}</td>`;
                        
                        const studentScores = [];
                        allMapel.forEach(mapel => {
                            const nilaiM = parseFloat((nilaiMadrasah[student.nisn] || {})[mapel.kode]);
                            const nilaiP = parseFloat((nilaiPraktek[student.nisn] || {})[mapel.kode]);
                            
                            let avgScore = null;
                            const hasM = !isNaN(nilaiM);
                            const hasP = !isNaN(nilaiP);

                            if (hasM && hasP) avgScore = (nilaiM + nilaiP) / 2;
                            else if (hasM) avgScore = nilaiM;
                            else if (hasP) avgScore = nilaiP;

                            studentScores.push(avgScore);
                            
                            // ▼▼▼ LANGKAH 3: Tambahkan logika pewarnaan KKM untuk setiap sel nilai ▼▼▼
                            const roundedAvgScore = avgScore !== null ? Math.round(avgScore) : null;
                            const kkmClass = (roundedAvgScore !== null && roundedAvgScore < kkmValue) ? 'text-red-600 font-bold' : '';
                            tableHtml += `<td class="border border-gray-300 px-2 py-1 text-center average-score-cell ${kkmClass}">${roundedAvgScore !== null ? roundedAvgScore : '-'}</td>`;
                        });

                        const validScores = studentScores.filter(s => s !== null);
                        const total = validScores.reduce((sum, score) => sum + Math.round(score), 0);
                        const count = validScores.length;
                        const average = count > 0 ? (total / count) : 0;
                        
                        const roundedAverage = Math.round(average);

                        // ▼▼▼ LANGKAH 4: Tambahkan logika pewarnaan KKM untuk rata-rata akhir dan pembulatan ▼▼▼
                        const avgClass = (average < kkmValue && count > 0) ? 'text-red-600 font-bold' : 'font-bold';
                        const roundedAvgClass = (roundedAverage < kkmValue && count > 0) ? 'text-red-600 font-bold' : 'text-blue-600 font-bold';

                        tableHtml += `<td class="border border-gray-300 px-4 py-2 text-center font-bold">${total}</td>
                                      <td class="border border-gray-300 px-4 py-2 text-center ${avgClass}">${average.toFixed(2)}</td>
                                      <td class="border border-gray-300 px-4 py-2 text-center ${roundedAvgClass}">${roundedAverage}</td>
                                    </tr>`;
                    });

                    tableHtml += `</tbody></table></div>`;
                    
                    mainWrapper.innerHTML = tableHtml;
                    container.appendChild(mainWrapper);

                }).catch(err => {
                    container.innerHTML = `<p class="text-red-500 text-center p-4">Gagal memuat data rata-rata: ${err.message}</p>`;
                });
            }

            // --- REKAPITULASI FUNCTIONS ---
            function initRekapitulasiPage() {
                const loader = document.getElementById('rekap-loader');
                const content = document.getElementById('rekap-content');
                const setupDiv = document.getElementById('rekap-setup');
                const displayArea = document.getElementById('rekap-display-area');

                loader.classList.remove('hidden');
                content.classList.add('hidden');
                setupDiv.classList.add('hidden');
                displayArea.innerHTML = '';

                google.script.run
                    .withSuccessHandler(sheetsExist => {
                        if (sheetsExist) {
                            // Panggil fungsi baru yang sudah dioptimasi
                            google.script.run
                                .withSuccessHandler(response => {
                                    if (response.status === 'success') {
                                        rekapitulasiData = response.data; // Ambil data dari properti 'data'
                                        loader.classList.add('hidden');
                                        content.classList.remove('hidden');
                                        const activeBtn = document.querySelector('.rekap-btn.active') || document.querySelector('[data-rekap="ijazah"]');
                                        activeBtn.click();
                                    } else {
                                        loader.classList.add('hidden');
                                        showGlobalStatus('Error: ' + response.message, false);
                                    }
                                })
                                .getRekapitulasiData_Optimized(userSpreadsheetId); // Panggil fungsi baru
                        } else {
                            loader.classList.add('hidden');
                            setupDiv.classList.remove('hidden');
                        }
                    })
                    .checkRekapSheetsExist(userSpreadsheetId);
            }

            document.querySelectorAll('.rekap-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.rekap-btn').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    const type = e.currentTarget.dataset.rekap;
                    if (rekapitulasiData) displayRekap(type, rekapitulasiData);
                });
            });

            document.getElementById('updateRekapBtn')?.addEventListener('click', function() {
                const btn = this;
                const btnText = document.getElementById('updateRekapBtnText');
                const spinner = document.getElementById('updateRekapSpinner');

                btn.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');

                google.script.run
                    .withSuccessHandler(response => {
                        if (response.status === 'success') {
                            sessionStorage.setItem('rekapNeedsUpdate', 'false'); // <-- TAMBAHKAN
                            checkAndApplyRekapIndicator();   
                            showGlobalStatus(response.message, true);
                            initRekapitulasiPage();
                        } else {
                            showGlobalStatus(response.message, false);
                        }
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    })
                    .withFailureHandler(err => {
                        showGlobalStatus('Gagal memperbarui: ' + err.message, false);
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    })
                    .updateRekapitulasi(userSpreadsheetId);
            });

            /**
             * [DIPERBARUI] Menampilkan tabel rekapitulasi berdasarkan tipe yang dipilih.
             * Kolom status Ijazah sekarang dihitung secara real-time di frontend dan teksnya tidak terpotong.
             * @param {string} type Jenis rekap ('ujian', 'rapor', 'ijazah').
             * @param {object} rekapData Objek data lengkap dari server.
             */
            function displayRekap(type, rekapData) {
                const { students, mapel, bobot, kkm, rekapUjian, rekapRapor, rekapIjazah } = rekapData;
                const displayArea = document.getElementById('rekap-display-area');
                
                let dataToShow;
                let title;
                let subtitleHtml = '';
                
                const mapelCount = (mapel || []).length;
                const kkmValue = kkm || 75; // Ambil KKM, fallback ke 75 jika tidak ada

                switch (type) {
                    case 'ujian':
                        dataToShow = rekapUjian;
                        title = 'Rekapitulasi Nilai Ujian';
                        subtitleHtml = `<p class="text-sm font-normal text-gray-600 mt-1">Jumlah Mata Pelajaran: <strong>${mapelCount}</strong> | KKM: <strong>${kkmValue}</strong></p>`;
                        break;
                    case 'rapor':
                        dataToShow = rekapRapor;
                        title = 'Rekapitulasi Nilai Rapor';
                        subtitleHtml = `<p class="text-sm font-normal text-gray-600 mt-1">Jumlah Mata Pelajaran: <strong>${mapelCount}</strong> | KKM: <strong>${kkmValue}</strong></p>`;
                        break;
                    case 'ijazah':
                    default:
                        dataToShow = rekapIjazah;
                        title = 'Rekapitulasi Nilai Ijazah';
                        if (bobot) {
                            subtitleHtml = `<p class="text-sm font-normal text-gray-600 mt-1">
                                Bobot Ujian: <strong>${bobot.bobotUjian}%</strong> | 
                                Bobot Rapor: <strong>${bobot.bobotRapor}%</strong> | 
                                KKM: <strong>${kkmValue}</strong>
                            </p>`;
                        }
                        break;
                }

                let tableHtml = `<div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-start flex-wrap gap-2">
                        <div>
                            <h3 class="text-xl font-bold">${title}</h3>
                            ${subtitleHtml}
                        </div>
                        <div class="flex space-x-2">
                            <button id="showExportModalButton" data-rekap-type="${type}" class="bg-blue-600 text-white font-medium py-2 px-3 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center space-x-1.5 text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 btn-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                <span class="btn-text">Pengaturan & Ekspor</span>
                                <span class="btn-spinner hidden loading-animation">Memuat...</span>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto mt-4">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-300 px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">No</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">NISN</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                                    ${mapel.map(m => `<th class="border border-gray-300 px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}
                                    <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-rata</th>
                                    ${type === 'ujian' ? '<th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Pembulatan (Input PDUM)</th>' : ''}
                                    ${type === 'ijazah' ? '<th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>`;

                if (students && students.length > 0) {
                    students.forEach((student, index) => {
                        const scores = dataToShow[student.nisn] || {};
                        let total = 0;
                        // Kita tidak lagi memerlukan validScoresCount untuk perhitungan rata-rata
                        
                        // Dapatkan jumlah total mapel di awal
                        const mapelCount = mapel.length;

                        let rowHtml = `<tr>
                            <td class="border border-gray-300 px-3 py-2 text-center">${index + 1}</td>
                            <td class="border border-gray-300 px-4 py-2 text-center">${student.nisn}</td>
                            <td class="border border-gray-300 px-4 py-2 nama-siswa-cell">${student.nama.toUpperCase()}</td>`;

                        mapel.forEach(m => {
                            const rawScore = scores[m.kode];
                            const numericScore = parseFloat(rawScore);
                            
                            let displayValue = 0;
                            let kkmClass = '';

                            if (!isNaN(numericScore)) {
                                displayValue = Math.round(numericScore);
                                // Total tetap dihitung dari nilai yang ada
                                total += displayValue; 
                                
                                if (displayValue < kkmValue) {
                                    kkmClass = 'text-red-600 font-bold';
                                }
                            }
                            
                            rowHtml += `<td class="border border-gray-300 text-center ${kkmClass}">${displayValue}</td>`;
                        });

                        // =================================================================
                        // PERUBAHAN UTAMA ADA DI SINI: RUMUS RATA-RATA BARU
                        // Pembagi sekarang adalah jumlah total mapel (mapelCount)
                        const average = mapelCount > 0 ? (total / mapelCount) : 0;
                        // =================================================================
                        
                        rowHtml += `<td class="border border-gray-300 text-center font-bold">${total}</td>
                                    <td class="border border-gray-300 text-center font-bold">${average.toFixed(2).replace('.', ',')}</td>`;
                        
                        if (type === 'ujian') {
                            const roundedAverage = Math.round(average);
                            rowHtml += `<td class="border border-gray-300 text-center font-bold text-blue-600">${roundedAverage}</td>`;
                        }
                        
                        if (type === 'ijazah') {
                            let status = '-'; 
                            // Cek jika ada setidaknya satu nilai untuk menentukan status
                            if (mapelCount > 0) {
                                status = (average >= kkmValue) ? 'LULUS' : 'TIDAK LULUS';
                            }

                            let statusClass = 'text-gray-700';
                            if (status === 'LULUS') {
                                statusClass = 'bg-green-100 text-green-800 font-bold';
                            } else if (status === 'TIDAK LULUS') {
                                statusClass = 'bg-red-100 text-red-800 font-bold';
                            }
                            
                            rowHtml += `<td class="border border-gray-300 text-center whitespace-nowrap ${statusClass}">${status}</td>`;
                        }
                        
                        rowHtml += `</tr>`;
                        tableHtml += rowHtml;
                    });
                }

                tableHtml += `</tbody></table></div></div>`;
                displayArea.innerHTML = tableHtml;

                document.getElementById('showExportModalButton')?.addEventListener('click', function() {
                    const btn = this;
                    const btnIcon = btn.querySelector('.btn-icon');
                    const btnText = btn.querySelector('.btn-text');
                    const spinner = btn.querySelector('.btn-spinner');
                    btn.disabled = true;
                    btnIcon.classList.add('hidden');
                    btnText.textContent = '';
                    spinner.classList.remove('hidden');
                    const rekapType = this.dataset.rekapType;
                    document.getElementById('exportForm').dataset.rekapType = rekapType;
                    const savedOptions = JSON.parse(localStorage.getItem('exportOptions'));
                    google.script.run
                        .withSuccessHandler(schoolData => {
                            btn.disabled = false;
                            btnIcon.classList.remove('hidden');
                            btnText.textContent = 'Pengaturan & Ekspor';
                            spinner.classList.add('hidden');
                            document.getElementById('exportNamaSekolah').value = schoolData.namaSekolah || '';
                            document.getElementById('exportNamaKamad').value = schoolData.namaKepsek || '';
                            document.getElementById('exportNip').value = schoolData.nipKepsek || '';
                            const tahunAjaranSelect = document.getElementById('exportTahunAjaran');
                            tahunAjaranSelect.innerHTML = '';
                            const currentYear = new Date().getFullYear();
                            const years = [`${currentYear - 2}/${currentYear - 1}`, `${currentYear - 1}/${currentYear}`, `${currentYear}/${currentYear + 1}`, `${currentYear + 1}/${currentYear + 2}`, `${currentYear + 2}/${currentYear + 3}`];
                            years.forEach(year => {
                                const option = document.createElement('option');
                                option.value = year;
                                option.textContent = year;
                                tahunAjaranSelect.appendChild(option);
                            });
                            if (savedOptions) {
                                tahunAjaranSelect.value = savedOptions.tahunAjaran || years[2];
                                document.getElementById('exportTempatTTD').value = savedOptions.tempatTTD || '';
                                document.getElementById('exportTanggalTTD').value = savedOptions.tanggalTTD || new Date().toISOString().split('T')[0];
                                document.getElementById('exportTipeKamad').value = savedOptions.tipeKamad || 'Kepala Madrasah';
                            } else {
                                tahunAjaranSelect.value = years[2];
                                document.getElementById('exportTanggalTTD').valueAsDate = new Date();
                            }
                            document.getElementById('export-modal').classList.remove('hidden');
                        })
                        .withFailureHandler(error => {
                            btn.disabled = false;
                            btnIcon.classList.remove('hidden');
                            btnText.textContent = 'Pengaturan & Ekspor';
                            spinner.classList.add('hidden');
                            showGlobalStatus('Gagal memuat pengaturan: ' + error.message, false);
                        })
                        .getSchoolData(userSpreadsheetId);
                });
            }

            // GANTI LAGI SELURUH BLOK EVENT LISTENER INI DI DALAM FUNGSI initializeApp()

            const changePasswordForm = document.getElementById('changePasswordForm');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const currentPassword = document.getElementById('current-password').value;
                    const newPassword = document.getElementById('new-password-change').value;
                    const confirmPassword = document.getElementById('confirm-password-change').value;
                    const statusDiv = document.getElementById('changePasswordStatusMessage');
                    
                    const showStatus = (message, isSuccess, isHtml = false) => {
                        if (isHtml) {
                            statusDiv.innerHTML = message;
                        } else {
                            statusDiv.textContent = message;
                        }
                        statusDiv.className = `mt-6 p-4 rounded-md text-center transition-opacity duration-300 ${isSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                        statusDiv.style.opacity = '1';
                    };

                    // Mengosongkan pesan error sebelumnya
                    statusDiv.innerHTML = '';
                    statusDiv.style.opacity = '0';

                    if (!currentPassword || !newPassword || !confirmPassword) {
                        showStatus('Semua kolom wajib diisi.', false);
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        showStatus('Password baru dan konfirmasi tidak cocok.', false);
                        return;
                    }

                    const passwordErrors = validatePassword(newPassword);
                    if (passwordErrors.length > 0) {
                        let errorHtml = '<strong class="block text-center">Password baru belum memenuhi syarat:</strong><ul class="list-disc list-inside text-left mt-1 text-sm">';
                        passwordErrors.forEach(error => {
                            errorHtml += `<li>${error}</li>`;
                        });
                        errorHtml += '</ul>';
                        showStatus(errorHtml, false, true);
                        return;
                    }

                    const btn = document.getElementById('changePasswordBtn');
                    const btnText = document.getElementById('changePasswordBtnText');
                    const spinner = document.getElementById('changePasswordSpinner');
                    btn.disabled = true;
                    btnText.classList.add('hidden');
                    spinner.classList.remove('hidden');

                    const email = sessionStorage.getItem('userEmail');
                    if (!email) {
                        showStatus('Sesi tidak valid, silakan login ulang.', false);
                        logoutUser();
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(response => {
                            showStatus(response.message, response.status === 'success');
                            if (response.status === 'success') {
                                changePasswordForm.reset();
                                // Sembunyikan pesan sukses setelah beberapa detik
                                setTimeout(() => { statusDiv.style.opacity = '0'; }, 5000);
                            }
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .withFailureHandler(error => {
                            showStatus('Error: ' + error.message, false);
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .changeUserPassword(email, currentPassword, newPassword);
                });
            }

            // Di dalam fungsi initializeApp() atau DOMContentLoaded
            document.getElementById('createBackupBtn')?.addEventListener('click', handleCreateBackup);
            document.getElementById('restoreFromCodeBtn')?.addEventListener('click', handleRestoreFromInput);

            // Letakkan ini di dalam fungsi initializeApp()

            const deleteAllUjianScoresBtn = document.getElementById('deleteAllUjianScoresBtn');
            if (deleteAllUjianScoresBtn) {
                deleteAllUjianScoresBtn.addEventListener('click', function() {
                    showTypeToConfirmModal({
                        title: 'Hapus Semua Nilai Ujian',
                        body: 'Anda akan menghapus <b>**SEMUA**</b> nilai dari tabel Ujian Madrasah dan Ujian Praktek. Tindakan ini tidak dapat dibatalkan.',
                        onConfirm: () => {
                            showGlobalStatus('Menghapus nilai ujian...', true);
                            
                            google.script.run
                                .withSuccessHandler(response => {
                                    showGlobalStatus(response.message, response.status !== 'error');
                                    if (response.status !== 'error') { // <-- Kondisi sudah tepat
                                        sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                                        checkAndApplyRekapIndicator();                   // <-- TAMBAHKAN
                                    }
                                    document.getElementById('input-ujian-container').innerHTML = '';
                                })
                                .withFailureHandler(err => {
                                    showGlobalStatus('Gagal: ' + err.message, false);
                                })
                                .deleteAllUjianScores(userSpreadsheetId);
                        }
                    });
                });
            }

            // Letakkan ini juga di dalam fungsi initializeApp()

            const raporContainer = document.getElementById('rapor-container');
            if (raporContainer) {
                raporContainer.addEventListener('click', function(event) {
                    // Cek apakah yang diklik adalah tombol hapus kita
                    if (event.target.classList.contains('delete-rapor-semester-btn')) {
                        const btn = event.target;
                        const semesterKey = btn.dataset.semesterKey;
                        const semesterName = btn.dataset.semesterName;

                        showTypeToConfirmModal({
                            title: `Hapus Nilai Rapor ${semesterName}`,
                            body: `Anda akan menghapus <b>**SEMUA**</b> data nilai rapor (Pengetahuan & Keterampilan) untuk <strong>${semesterName}</strong>. Tindakan ini tidak dapat dibatalkan.`,
                            onConfirm: () => {
                                showGlobalStatus(`Menghapus nilai rapor ${semesterName}...`, true);
                                
                                google.script.run
                                    .withSuccessHandler(response => {
                                        showGlobalStatus(response.message, response.status !== 'error');
                                        if (response.status !== 'error') { // <-- Kondisi sudah tepat
                                            sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                                            checkAndApplyRekapIndicator();                   // <-- TAMBAHKAN
                                        }
                                        const tableContainer = document.getElementById(`table-container-${semesterKey}`);
                                        if(tableContainer) tableContainer.innerHTML = '';
                                    })
                                    .withFailureHandler(err => {
                                        showGlobalStatus('Gagal: ' + err.message, false);
                                    })
                                    .deleteAllRaporScoresBySemester(userSpreadsheetId, semesterKey);
                            }
                        });
                    }
                });
            }

            const searchMapelInput = document.getElementById('searchMapelInput');
            if (searchMapelInput) {
                searchMapelInput.addEventListener('input', () => {
                    const keyword = searchMapelInput.value.toLowerCase().trim();
                    const filteredMapel = allMapelData.filter(mapel => {
                        const nameMatch = mapel.nama.toLowerCase().includes(keyword);
                        const codeMatch = mapel.kode.toLowerCase().includes(keyword);
                        return nameMatch || codeMatch;
                    });
                    renderMapelTable(filteredMapel);
                });
            }

            // Tampilkan menu admin jika user adalah Superadmin
            if (sessionStorage.getItem('isSuperAdminSession') === 'true') {
                document.getElementById('admin-menu-item').classList.remove('hidden');
            }

            // Tambahkan event listener untuk tombol-tombol baru
            document.getElementById('adminBackupBtn')?.addEventListener('click', handleAdminBackup);
            document.getElementById('adminRestoreBtn')?.addEventListener('click', handleAdminRestore);
            //document.getElementById('addVersionBtn')?.addEventListener('click', () => openVersionModal(null));//
            document.getElementById('closeVersionModalBtn')?.addEventListener('click', () => document.getElementById('version-modal').classList.add('hidden'));
            document.getElementById('cancelVersionBtn')?.addEventListener('click', () => document.getElementById('version-modal').classList.add('hidden'));
            document.getElementById('versionForm')?.addEventListener('submit', handleVersionFormSubmit);

            // Letakkan ini di dalam fungsi initializeApp()
            document.getElementById('edit-scores-floating-btn')?.addEventListener('click', () => {
                if (activeTableKey) {
                    enableScoreEditing(activeTableKey);
                }
            });
        }

        /**
         * Mengubah string menjadi format Proper Case (Setiap Kata Diawali Huruf Besar).
         * @param {string} str - Teks yang akan diubah.
         * @returns {string} Teks dalam format Proper Case.
         */
        function toProperCase(str) {
          if (!str || typeof str !== 'string') return '';
          return str.replace(/\w\S*/g, function(txt) {
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
          });
        }

        function formatIndonesianDate(dateInput) {
            // Jika input kosong, null, atau undefined, langsung kembalikan string kosong
            if (!dateInput) {
                return "";
            }

            // Coba buat objek Date dari input. Ini bisa menangani string "YYYY-MM-DD" atau objek Date
            const date = new Date(dateInput);

            // Periksa apakah tanggal yang dihasilkan valid.
            // `getTime()` akan menghasilkan NaN untuk tanggal yang tidak valid.
            if (isNaN(date.getTime())) {
                return ""; // Kembalikan string kosong jika tanggal tidak valid
            }

            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            
            // Gunakan getUTCDate, dll. untuk menghindari masalah pergeseran tanggal karena timezone
            const day = date.getUTCDate();
            const monthIndex = date.getUTCMonth();
            const year = date.getUTCFullYear();

            // Hindari menampilkan tanggal epoch "1 Januari 1970"
            if (year === 1970 && monthIndex === 0 && day === 1) {
                return "";
            }

            return `${day} ${months[monthIndex]} ${year}`;
        }
        
        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
        function handleSaveRapor(event, semesterKey, jenisNilai) {
            event.preventDefault();
            const form = event.target;
            // --- PERBAIKAN DI SINI: Targetkan tombol Simpan di dalam form yang benar ---
            const saveBtn = form.querySelector('button[type="submit"]'); 
            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';

            const allRows = form.querySelectorAll('tbody tr');
            const nilaiData = [];
            allRows.forEach(row => {
                const studentScores = { nisn: row.dataset.nisn, nama: row.dataset.nama, scores: {} };
                row.querySelectorAll('.score-input').forEach(input => {
                    studentScores.scores[input.dataset.mapelKode] = input.value;
                });
                nilaiData.push(studentScores);
            });

            google.script.run
                .withSuccessHandler(response => {
                    showGlobalStatus(response.message, response.status === 'success');
                    if (response.status === 'success') { 
                        sessionStorage.setItem('rekapNeedsUpdate', 'true');
                        checkAndApplyRekapIndicator();
                        const tableKey = `${semesterKey}-${jenisNilai}`;
                        disableScoreEditing(tableKey); 
                    }
                    // --- PERBAIKAN DI SINI: Pastikan tombol selalu kembali normal ---
                    saveBtn.disabled = false;
                    saveBtn.textContent = `Simpan Nilai`; 
                })
                .withFailureHandler(err => {
                    showGlobalStatus(`Gagal menyimpan: ${err.message}`, false);
                    // --- PERBAIKAN DI SINI: Pastikan tombol selalu kembali normal ---
                    saveBtn.disabled = false;
                    saveBtn.textContent = `Simpan Nilai`; 
                })
                .saveNilaiRapor(userSpreadsheetId, { semesterKey, jenisNilai, nilai: nilaiData });
        }

        // GANTI FUNGSI LAMA DENGAN VERSI YANG SUDAH DIPERBAIKI INI
        function buildRaporScoreTable(btnElement, semesterKey, jenisNilai) {
            document.querySelectorAll('.rapor-table-display-area').forEach(area => {
                if (area.id !== `table-container-${semesterKey}`) {
                    area.innerHTML = '';
                }
            });
            document.querySelectorAll('.rapor-semester-btn').forEach(button => {
                if (button !== btnElement) {
                    button.classList.remove('active');
                }
            });

            updateRaporButtonState(btnElement);
            clearHistoryAndHideButtons();
            document.getElementById('undo-redo-container').classList.remove('hidden');
            setupScoreInputListeners(`table-container-${semesterKey}`);

            const container = document.getElementById(`table-container-${semesterKey}`);
            container.innerHTML = `<div class="text-center p-8"><p class="font-bold loading-animation">Memuat data</p></div>`;
            const sheetName = `Rapor_${jenisNilai}_${semesterKey}`;
            const tableKey = `${semesterKey}-${jenisNilai}`; 

            activeTableKey = tableKey;

            Promise.all([
                new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getStudents(userSpreadsheetId)),
                new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getMapel(userSpreadsheetId)),
                new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, sheetName)),
                new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getKkm(userSpreadsheetId))
            ]).then(([students, mapelList, existingScores, kkmResponse]) => {
                if (!students || students.length === 0) { container.innerHTML = `<p class="text-center text-red-500 p-4">Data siswa tidak ditemukan.</p>`; return; }
                if (!mapelList || mapelList.length === 0) { container.innerHTML = `<p class="text-center text-red-500 p-4">Data mata pelajaran tidak ditemukan.</p>`; return; }
                
                const kkmValue = (kkmResponse && kkmResponse.status === 'success') ? kkmResponse.kkm : 75;

                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'p-4 border rounded-lg mt-3';
                
                tableWrapper.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-semibold">Tabel Nilai ${jenisNilai}</h4>
                        <button type="button" id="edit-scores-btn-${tableKey}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2 text-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            Ubah Nilai
                        </button>
                    </div>
                    <p class="text-sm mt-1 mb-3 text-gray-600">Klik "Ubah Nilai" untuk mulai mengisi. Rata-rata di bawah KKM (${kkmValue}) akan ditandai merah.</p>
                    <form id="form-nilai-${tableKey}">
                        <div class="overflow-x-auto">
                            <table id="score-table-${sheetName}" class="score-table min-w-full divide-y divide-gray-200" data-kkm="${kkmValue}">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                                        ${mapelList.map(m => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-Rata</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${students.map((s, index) => {
                                        const studentScores = existingScores[s.nisn] || {};
                                        let rowHtml = `<tr data-nisn="${s.nisn}" data-nama="${s.nama.toUpperCase()}"><td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${index + 1}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${s.nisn}</td><td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 nama-siswa-cell">${s.nama.toUpperCase()}</td>`;
                                        mapelList.forEach(m => {
                                            const score = studentScores[m.kode] ?? '';
                                            const numericScore = parseFloat(score);
                                            // Tambahkan baris ini untuk menentukan class berdasarkan KKM
                                            const kkmClass = (!isNaN(numericScore) && numericScore < kkmValue) ? 'text-red-600 font-bold' : '';
                                            // Tambahkan variabel kkmClass ke dalam class input
                                            rowHtml += `<td class="px-2 py-1"><input type="number" min="0" max="100" class="score-input p-1 border rounded-md ${kkmClass}" data-mapel-kode="${m.kode}" value="${score}" readonly></td>`;
                                        });
                                        rowHtml += `<td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell jumlah-nilai">0</td><td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell rata-rata-nilai">0.00</td></tr>`;
                                        return rowHtml;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div id="actions-container-${tableKey}" class="mt-6 pt-4 border-t flex justify-end space-x-3 hidden">
                          <button type="button" class="clear-scores-btn bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Bersihkan</button>
                          <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Simpan Nilai</button>
                        </div>
                    </form>
                `;
                
                container.innerHTML = '';
                container.appendChild(tableWrapper);
                
                document.getElementById(`edit-scores-btn-${tableKey}`).addEventListener('click', () => enableScoreEditing(tableKey));

                const scoreTable = document.getElementById(`score-table-${sheetName}`);
                scoreTable.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
                scoreTable.addEventListener('input', handleScoreInput);
                scoreTable.addEventListener('paste', handleSmartPaste);
                document.getElementById(`form-nilai-${tableKey}`).addEventListener('submit', (e) => handleSaveRapor(e, semesterKey, jenisNilai));

                // ▼▼▼ BAGIAN YANG DIPERBAIKI ADA DI SINI ▼▼▼
                tableWrapper.querySelector('.clear-scores-btn').addEventListener('click', (e) => {
                    const form = e.target.closest('form');
                    showConfirmationModal({
                        title: "Konfirmasi Membersihkan Tabel",
                        body: "Anda yakin ingin menghapus semua nilai yang telah diisi di tabel ini? <br><br><strong class='text-yellow-700'>Aksi ini hanya membersihkan tampilan dan tidak akan menghapus data yang sudah tersimpan sampai Anda menekan tombol 'Simpan'.</strong>",
                        confirmText: "Ya, Bersihkan",
                        confirmColor: "bg-yellow-500 hover:bg-yellow-600",
                        onConfirm: () => {
                            form.querySelectorAll('.score-input').forEach(input => input.value = '');
                            form.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
                            showGlobalStatus("Tabel berhasil dibersihkan.", true);
                        }
                    });
                });
                // ▲▲▲ AKHIR DARI BAGIAN YANG DIPERBAIKI ▲▲▲

                const semesterContainer = btnElement.closest('.rapor-semester-container');
                if (semesterContainer) {
                    semesterContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }).catch(err => {
                container.innerHTML = `<p class="text-red-500 text-center p-4">Terjadi kesalahan saat memuat data: ${err.message}</p>`;
            });
        }

        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU YANG SUDAH DIPERBAIKI INI =====
        function calculateRaporAverage(btnElement, semesterKey) {
            // ===== AWAL BLOK KODE YANG DITAMBAHKAN =====
            // 1. Tutup semua kontainer tabel di semester LAIN
            document.querySelectorAll('.rapor-table-display-area').forEach(area => {
                if (area.id !== `table-container-${semesterKey}`) {
                    area.innerHTML = '';
                }
            });
            // 2. Hapus status 'active' dari SEMUA tombol rapor di seluruh halaman
            document.querySelectorAll('.rapor-semester-btn').forEach(button => {
                if (button !== btnElement) {
                    button.classList.remove('active');
                }
            });
            // ===== AKHIR BLOK KODE YANG DITAMBAHKAN =====

            clearHistoryAndHideButtons();
            updateRaporButtonState(btnElement);

            const container = document.getElementById(`table-container-${semesterKey}`);
            container.innerHTML = `<div class="text-center p-8"><p class="font-bold loading-animation">Menghitung rata-rata</p><p>Silakan tunggu...</p></div>`;
            
            const sheetNameP = `Rapor_Pengetahuan_${semesterKey}`;
            const sheetNameK = `Rapor_Keterampilan_${semesterKey}`;

            Promise.all([
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getStudents(userSpreadsheetId)),
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getMapel(userSpreadsheetId)),
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, sheetNameP)),
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, sheetNameK)),
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getKkm(userSpreadsheetId))
            ]).then(([students, mapelList, nilaiPengetahuan, nilaiKeterampilan, kkmResponse]) => {
                if (!students || students.length === 0) { container.innerHTML = `<p class="text-red-500 text-center p-4">Data siswa tidak ditemukan.</p>`; return; }
                if (!mapelList || mapelList.length === 0) { container.innerHTML = `<p class="text-red-500 text-center p-4">Data mata pelajaran tidak ditemukan.</p>`; return; }
                
                const kkmValue = (kkmResponse && kkmResponse.status === 'success') ? kkmResponse.kkm : 75;

                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'bg-white p-6 rounded-lg shadow-md'; 

                let tableHtml = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Tabel Rata-Rata Nilai</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-300 px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">No</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">NISN</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                                    ${mapelList.map(m => `<th class="border border-gray-300 px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}
                                    <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-Rata</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                students.forEach((student, index) => {
                    let rowInitialHtml = `<tr>
                                            <td class="border border-gray-300 px-3 py-2 text-sm text-center">${index + 1}</td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm text-center">${student.nisn}</td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm font-medium nama-siswa-cell">${student.nama.toUpperCase()}</td>`;
                    
                    let scoresForThisRow = [];
                    let scoreCellsHtml = '';
                    
                    mapelList.forEach(mapel => {
                        const nilaiP = parseFloat((nilaiPengetahuan[student.nisn] || {})[mapel.kode]);
                        const nilaiK = parseFloat((nilaiKeterampilan[student.nisn] || {})[mapel.kode]);
                        
                        let avgScore = null;
                        const hasP = !isNaN(nilaiP);
                        const hasK = !isNaN(nilaiK);

                        if (hasP && hasK) avgScore = (nilaiP + nilaiK) / 2;
                        else if (hasP) avgScore = nilaiP;
                        else if (hasK) avgScore = nilaiK;
                        
                        scoresForThisRow.push(avgScore);
                        
                        const roundedAvgScore = avgScore !== null ? Math.round(avgScore) : null;
                        const kkmClass = (roundedAvgScore !== null && roundedAvgScore < kkmValue) ? 'text-red-600 font-bold' : '';
                        scoreCellsHtml += `<td class="border border-gray-300 px-2 py-1 text-center average-score-cell ${kkmClass}">${roundedAvgScore !== null ? roundedAvgScore : '-'}</td>`;
                    });

                    const validScores = scoresForThisRow.filter(s => s !== null);
                    const total = validScores.reduce((sum, score) => sum + Math.round(score), 0);
                    const average = validScores.length > 0 ? (total / validScores.length) : 0;
                    
                    const avgClass = (average < kkmValue && validScores.length > 0) ? 'text-red-600 font-bold' : 'font-bold';

                    const rowTotalsHtml = `<td class="border border-gray-300 px-4 py-2 text-center font-bold">${total}</td>
                                          <td class="border border-gray-300 px-4 py-2 text-center ${avgClass}">${average.toFixed(2)}</td>`;

                    tableHtml += rowInitialHtml + scoreCellsHtml + rowTotalsHtml + `</tr>`;
                });

                tableHtml += `</tbody></table></div>`;
                
                container.innerHTML = '';
                tableWrapper.innerHTML = tableHtml;
                container.appendChild(tableWrapper);

                const semesterContainer = btnElement.closest('.rapor-semester-container');
                if (semesterContainer) {
                    semesterContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

            }).catch(err => {
                container.innerHTML = `<p class="text-red-500 text-center p-4">Gagal memuat data rata-rata: ${err.message}</p>`;
            });
        }

        const semesters = {
            MI: { k4_ganjil: 'Kelas 4 Ganjil', k4_genap: 'Kelas 4 Genap', k5_ganjil: 'Kelas 5 Ganjil', k5_genap: 'Kelas 5 Genap', k6_ganjil: 'Kelas 6 Ganjil' },
            MTS: { k7_ganjil: 'Kelas 7 Ganjil', k7_genap: 'Kelas 7 Genap', k8_ganjil: 'Kelas 8 Ganjil', k8_genap: 'Kelas 8 Genap', k9_ganjil: 'Kelas 9 Ganjil' },
            MA: { k10_ganjil: 'Kelas 10 Ganjil', k10_genap: 'Kelas 10 Genap', k11_ganjil: 'Kelas 11 Ganjil', k11_genap: 'Kelas 11 Genap', k12_ganjil: 'Kelas 12 Ganjil' }
        };

        /**
         * [MODIFIKASI] Ubah fungsi showGlobalStatus agar menerima tipe 'info'.
         */
        function showGlobalStatus(message, type) { // type bisa 'success', 'error', atau 'info'
            const statusDiv = document.createElement('div');
            let bgColor = 'bg-green-500'; // Default untuk success
            if (type === 'error') {
                bgColor = 'bg-red-500';
            } else if (type === 'info') {
                bgColor = 'bg-gray-600'; // Warna abu-abu untuk info
            }
            
            statusDiv.className = `toast-notification ${bgColor}`;
            statusDiv.innerHTML = message;
            document.getElementById('globalStatusMessage').appendChild(statusDiv);

            setTimeout(() => {
                statusDiv.remove();
            }, 4000);
        }

        // GANTI FUNGSI LAMA DENGAN VERSI BARU YANG LEBIH CERDAS INI
        function updateRowTotals(rowElement) {
            const inputs = rowElement.querySelectorAll('.score-input');
            const table = rowElement.closest('table');
            // Ambil KKM dari atribut data-kkm yang kita simpan di tabel
            const kkm = table ? parseFloat(table.dataset.kkm) : 75; 

            let total = 0;
            let count = 0;
            inputs.forEach(input => {
                const value = parseFloat(input.value);
                if (!isNaN(value)) { 
                    total += value; 
                    count++; 
                }
            });

            const average = count > 0 ? (total / count) : 0;
            const totalCell = rowElement.querySelector('.jumlah-nilai');
            const avgCell = rowElement.querySelector('.rata-rata-nilai');
            
            if (totalCell) {
                totalCell.textContent = Math.round(total);
            }
            if (avgCell) {
                avgCell.textContent = average.toFixed(2);
                
                // Selalu hapus style lama terlebih dahulu
                avgCell.classList.remove('text-red-600', 'font-bold');
                
                // Tambahkan style hanya jika rata-rata di bawah KKM dan ada nilai yang diinput
                if (average < kkm && count > 0) {
                    avgCell.classList.add('text-red-600', 'font-bold');
                }
            }
        }

        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
        /**
         * Menangani input pada kolom nilai, menghitung total, dan melakukan validasi real-time.
         */
        function handleScoreInput(event) {
            const input = event.target;
            if (input.classList.contains('score-input')) {
                const value = parseFloat(input.value);

                // --- BLOK VALIDASI REAL-TIME BARU ---
                // Cek jika input tidak kosong DAN (nilainya bukan angka ATAU di luar rentang 0-100)
                if (input.value.trim() !== '' && (isNaN(value) || value < 0 || value > 100)) {
                    // Tambahkan style error untuk menandakan input tidak valid
                    input.classList.add('border-red-500', 'ring-2', 'ring-red-300');
                    input.classList.remove('focus:ring-blue-500', 'focus:border-blue-500');
                } else {
                    // Hapus style error jika input valid atau kosong
                    input.classList.remove('border-red-500', 'ring-2', 'ring-red-300');
                    input.classList.add('focus:ring-blue-500', 'focus:border-blue-500');
                }
                // --- AKHIR BLOK VALIDASI ---

                // Fungsi untuk menghitung total baris tetap dijalankan
                updateRowTotals(input.closest('tr'));
            }
        }

        // ===== GANTI FUNGSI LAMA handleSmartPaste DENGAN VERSI BARU INI =====

        function handleSmartPaste(event) {
            if (!event.target.classList.contains('score-input')) return;
            event.preventDefault();

            const pastedText = (event.clipboardData || window.clipboardData).getData('text');
            const pastedRows = pastedText.split(/\r?\n/).filter(r => r).map(row => row.split('\t'));
            const tableBody = event.target.closest('tbody');
            if (!tableBody) return;

            const allTableRows = Array.from(tableBody.querySelectorAll('tr'));
            const startRowElement = event.target.closest('tr');
            const startRowIndex = allTableRows.indexOf(startRowElement);
            const allRowInputs = Array.from(startRowElement.querySelectorAll('.score-input'));
            const startColIndex = allRowInputs.indexOf(event.target);

            // [MODIFIKASI] Buat array untuk menampung semua perubahan dari aksi paste ini
            const changes = [];

            pastedRows.forEach((rowData, r_offset) => {
                const targetRow = allTableRows[startRowIndex + r_offset];
                if (targetRow) {
                    const targetRowInputs = Array.from(targetRow.querySelectorAll('.score-input'));
                    rowData.forEach((cellData, c_offset) => {
                        const targetInput = targetRowInputs[startColIndex + c_offset];
                        if (targetInput) {
                            const oldValue = targetInput.value;
                            const newValue = cellData.trim();

                            if (oldValue !== newValue) {
                                // [MODIFIKASI] Simpan perubahan ke dalam array 'changes'
                                changes.push({ element: targetInput, oldValue: oldValue, newValue: newValue });
                                targetInput.value = newValue; // Terapkan perubahan ke input
                            }
                        }
                    });
                    updateRowTotals(targetRow); // Update total untuk baris yang terkena paste
                }
            });

            // [MODIFIKASI] Setelah semua loop selesai, jika ada perubahan,
            // simpan seluruh grup 'changes' sebagai satu entri di riwayat undo.
            if (changes.length > 0) {
                undoHistory.push(changes);
                redoHistory = []; // Hapus riwayat redo
                updateUndoRedoButtonsState();
            }
        }

        // File: Index.html (di dalam <script>)

        // Fungsi untuk memasang event listener pada link NISN
        function setupConflictDetailListeners() {
            document.querySelectorAll('.conflict-detail-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const index = e.target.dataset.index;
                    showConflictDetail(index);
                });
            });
        }

        // Fungsi untuk menampilkan modal dengan data perbandingan
        function showConflictDetail(index) {
            const conflict = currentImportConflicts[index];
            if (!conflict) return;

            const oldDataContainer = document.getElementById('conflict-old-data');
            const newDataContainer = document.getElementById('conflict-new-data');

            // Helper untuk membandingkan dan memberi highlight
            const createFieldHtml = (label, oldValue, newValue) => {
                const isDifferent = oldValue !== newValue;
                const highlightClass = isDifferent ? 'bg-yellow-100 p-2 rounded-md' : 'p-2';
                return `
                    <div class="field-pair">
                        <p><strong>${label}:</strong></p>
                        <div class="${highlightClass}">${oldValue || '<em>(kosong)</em>'}</div>
                        <div class="${highlightClass}">${newValue || '<em>(kosong)</em>'}</div>
                    </div>
                `;
            };
            
            // Format data untuk ditampilkan
            const formatData = (data) => ({
                'Nama Lengkap': data.nama,
                'NISN': data.nisn,
                'NIS': data.nis,
                'Jenis Kelamin': data.jenisKelamin,
                'Tempat Lahir': toProperCase(data.tempatLahir),
                'Tanggal Lahir': formatIndonesianDate(data.tanggalLahir),
                'Alamat Lengkap': data.alamat,
                'Nomor Telepon': data.telepon,
                'Email Siswa': data.emailSiswa,
                'Tahun Masuk': data.tahunMasuk,
                'Tahun Lulus': data.tahunLulus
            });
            
            const oldF = formatData(conflict.oldData);
            const newF = formatData(conflict.newData);

            let oldHtml = '';
            let newHtml = '';

            // Loop melalui setiap field untuk dibandingkan
            for (const key in oldF) {
                const isDifferent = (oldF[key] || '') !== (newF[key] || '');
                const highlightClass = isDifferent ? 'bg-yellow-200 font-bold p-2 rounded' : 'p-2';
                
                oldHtml += `<div class="${highlightClass} mb-2"><strong>${key}:</strong><br>${oldF[key] || '<em>(kosong)</em>'}</div>`;
                newHtml += `<div class="${highlightClass} mb-2"><strong>${key}:</strong><br>${newF[key] || '<em>(kosong)</em>'}</div>`;
            }

            oldDataContainer.innerHTML = oldHtml;
            newDataContainer.innerHTML = newHtml;

            // Tampilkan modal
            const modal = document.getElementById('conflict-detail-modal');
            modal.classList.remove('hidden');

            // Pasang event listener untuk tombol tutup
            document.getElementById('closeConflictDetailModalBtn').onclick = () => modal.classList.add('hidden');
            document.getElementById('closeConflictDetailModalBtn2').onclick = () => modal.classList.add('hidden');
        }

        /**
         * [BARU] Menampilkan validasi password secara real-time di bawah input.
         * @param {HTMLInputElement} passwordInput - Elemen input password pertama.
         * @param {HTMLElement} requirementsContainer - Elemen div untuk menampilkan daftar kriteria.
         */
        function setupRealtimePasswordValidation(passwordInput, requirementsContainer) {
            const requirements = [
                { regex: /.{8,}/, text: "Minimal 8 karakter" },
                { regex: /[A-Z]/, text: "Minimal satu huruf besar (A-Z)" },
                { regex: /[a-z]/, text: "Minimal satu huruf kecil (a-z)" },
                { regex: /[0-9]/, text: "Minimal satu angka (0-9)" },
                { regex: /[^A-Za-z0-9]/, text: "Minimal satu karakter spesial (!@#$)" }
            ];

            const icon_check = `<svg class="w-4 h-4 inline-block mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            const icon_cross = `<svg class="w-4 h-4 inline-block mr-1 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;

            passwordInput.addEventListener('input', () => {
                const password = passwordInput.value;
                requirementsContainer.innerHTML = ''; // Kosongkan daftar setiap kali ada input
                
                if (!password) return; // Jika input kosong, jangan tampilkan apa-apa

                requirements.forEach(req => {
                    const isValid = req.regex.test(password);
                    const textClass = isValid ? 'text-gray-600' : 'text-gray-500';
                    const icon = isValid ? icon_check : icon_cross;
                    requirementsContainer.innerHTML += `<div class="${textClass}">${icon}<span>${req.text}</span></div>`;
                });
            });
        }

        /**
         * [BARU] Memeriksa kecocokan password konfirmasi secara real-time.
         * @param {HTMLInputElement} passwordInput - Elemen input password pertama.
         * @param {HTMLInputElement} confirmInput - Elemen input password konfirmasi.
         * @param {HTMLElement} messageContainer - Elemen div untuk menampilkan pesan error.
         */
        function setupPasswordConfirmation(passwordInput, confirmInput, messageContainer) {
            const checkPasswords = () => {
                const pass1 = passwordInput.value;
                const pass2 = confirmInput.value;
                
                if (pass2 && pass1 !== pass2) {
                    messageContainer.textContent = 'Password tidak cocok.';
                } else {
                    messageContainer.textContent = '';
                }
            };

            passwordInput.addEventListener('input', checkPasswords);
            confirmInput.addEventListener('input', checkPasswords);
        }

        function loadAndRenderCompletenessTable() {
            const container = document.getElementById('completeness-table-container');
            container.innerHTML = `<p class="text-center text-gray-500 py-8 loading-animation">Menganalisis data siswa</p>`;

            google.script.run
                .withSuccessHandler(students => {
                    if (!students || students.length === 0) {
                        container.innerHTML = `<p class="text-center text-gray-500 py-8">Tidak ada data siswa untuk dianalisis.</p>`;
                        return;
                    }

                    const fieldsToCheck = [
                        { key: 'nama', label: 'Nama Lengkap' }, { key: 'nisn', label: 'NISN' }, { key: 'nis', label: 'NIS' },
                        { key: 'jenisKelamin', label: 'J. Kelamin' }, { key: 'tempatLahir', label: 'Tmpt Lahir' }, { key: 'tanggalLahir', label: 'Tgl Lahir' },
                        { key: 'alamat', label: 'Alamat' }, { key: 'telepon', label: 'Telepon' }, { key: 'emailSiswa', label: 'Email' },
                        { key: 'tahunMasuk', label: 'Thn Masuk' }, { key: 'tahunLulus', label: 'Thn Lulus' }
                    ];

                    let tableHTML = `<div class="border rounded-lg overflow-hidden"><table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-gray-600 sticky left-0 bg-gray-100 z-10 w-1/4 whitespace-nowrap">Nama Siswa</th>
                                ${fieldsToCheck.slice(1).map(field => `<th class="px-4 py-3 text-center font-medium text-gray-600 whitespace-nowrap">${field.label}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="completeness-tbody" class="bg-white divide-y divide-gray-200">`; // <-- Beri ID pada tbody

                    students.forEach(student => {
                        tableHTML += `<tr>
                            <td class="px-4 py-2 font-medium text-gray-800 whitespace-nowrap sticky left-0 bg-white">${student.nama.toUpperCase()}</td>`;
                        
                        fieldsToCheck.slice(1).forEach(field => {
                            const value = student[field.key] || '';
                            const hasData = value && value.toString().trim() !== '';
                            const icon = hasData ? '✅' : '❌';
                            
                            // [PERBAIKAN] Hapus title, ganti dengan data-value dan cursor-pointer
                            tableHTML += `<td class="text-center p-2 cursor-pointer" data-value="${String(value).replace(/"/g, '&quot;')}">${icon}</td>`;
                        });

                        tableHTML += `</tr>`;
                    });

                    tableHTML += `</tbody></table></div>`;
                    container.innerHTML = tableHTML;

                    // [BARU] Tambahkan satu event listener pada tbody untuk menangani semua klik (event delegation)
                    const tableBody = document.getElementById('completeness-tbody');
                    if (tableBody) {
                        tableBody.addEventListener('click', function(event) {
                            // Cek apakah yang diklik adalah sel data (bukan header atau bagian lain)
                            if (event.target && event.target.tagName === 'TD' && event.target.dataset.value) {
                                showDataTooltip(event.target);
                            }
                        });
                    }
                })
                .withFailureHandler(err => {
                    container.innerHTML = `<p class="text-center text-red-500 py-8">Gagal memuat data: ${err.message}</p>`;
                })
                .getStudents(userSpreadsheetId);
        }

        // ==========================================================
        // ===== [BARU] FUNGSI-FUNGSI UNTUK TOOLTIP DATA =====
        // ==========================================================

        /**
         * Menampilkan tooltip dengan data dari sel yang diklik.
         * @param {HTMLElement} targetCell - Elemen <td> yang diklik.
         */
        function showDataTooltip(targetCell) {
            const tooltip = document.getElementById('data-viewer-tooltip');
            const value = targetCell.dataset.value;

            // Jika tooltip sudah tampil di sel yang sama, sembunyikan saja.
            if (!tooltip.classList.contains('hidden') && tooltip.dataset.currentTarget === targetCell) {
                hideDataTooltip();
                return;
            }

            // Isi tooltip dengan data dan tampilkan
            tooltip.textContent = value || '(Data Kosong)';
            tooltip.classList.remove('hidden');
            tooltip.dataset.currentTarget = targetCell; // Tandai sel target

            // Posisikan tooltip di dekat sel yang diklik
            const cellRect = targetCell.getBoundingClientRect();
            tooltip.style.left = `${cellRect.left + window.scrollX}px`;
            tooltip.style.top = `${cellRect.bottom + window.scrollY + 5}px`; // 5px di bawah sel
        }

        /**
         * Menyembunyikan tooltip.
         */
        function hideDataTooltip() {
            const tooltip = document.getElementById('data-viewer-tooltip');
            tooltip.classList.add('hidden');
            delete tooltip.dataset.currentTarget; // Hapus penanda sel target
        }

        /**
         * Listener global untuk menyembunyikan tooltip saat mengklik di luar area target.
         */
        document.addEventListener('click', function(event) {
            const tooltip = document.getElementById('data-viewer-tooltip');
            // Sembunyikan jika yang diklik BUKAN sel data dan BUKAN tooltip itu sendiri
            if (!event.target.closest('td[data-value]') && !event.target.closest('#data-viewer-tooltip')) {
                hideDataTooltip();
            }
        }, true); // Gunakan 'true' untuk event capturing agar berjalan lebih dulu


        function loadAndRenderCompletenessTable() {
            const container = document.getElementById('completeness-table-container');
            const summaryDiv = document.getElementById('completeness-summary');
            container.innerHTML = `<p class="text-center text-gray-500 py-8 loading-animation">Menganalisis data siswa</p>`;
            summaryDiv.innerHTML = '';

            google.script.run
                .withSuccessHandler(students => {
                    if (!students || students.length === 0) {
                        container.innerHTML = `<p class="text-center text-gray-500 py-8">Tidak ada data siswa untuk dianalisis.</p>`;
                        return;
                    }

                    // Langkah 1: Proses data sekali saja untuk menghitung data kosong
                    const fieldsToCheck = [
                        'nama', 'nisn', 'nis', 'jenisKelamin', 'tempatLahir', 'tanggalLahir',
                        'alamat', 'telepon', 'emailSiswa', 'tahunMasuk', 'tahunLulus'
                    ];
                    
                    processedStudents = students.map(student => {
                        let missingCount = 0;
                        fieldsToCheck.forEach(field => {
                            const value = student[field] || '';
                            if (!value.toString().trim()) {
                                missingCount++;
                            }
                        });
                        return { ...student, missingDataCount: missingCount };
                    });

                    // Langkah 2: Render tampilan awal
                    renderCompletenessView();
                })
                .withFailureHandler(err => {
                    container.innerHTML = `<p class="text-center text-red-500 py-8">Gagal memuat data: ${err.message}</p>`;
                })
                .getStudents(userSpreadsheetId);
        }

        // FUNGSI BARU untuk me-render tampilan berdasarkan filter dan sort
        function renderCompletenessView() {
            const container = document.getElementById('completeness-table-container');
            const summaryDiv = document.getElementById('completeness-summary');
            const filterCheckbox = document.getElementById('completeness-filter-checkbox');
            const sortSelect = document.getElementById('completeness-sort-select');

            let studentsToRender = [...processedStudents];

            // Update Ringkasan Statistik
            const incompleteCount = studentsToRender.filter(s => s.missingDataCount > 0).length;
            summaryDiv.innerHTML = `Diperiksa: <strong>${studentsToRender.length} siswa</strong>. Ditemukan: <strong class="text-red-600">${incompleteCount} siswa</strong> dengan data tidak lengkap.`;

            // Terapkan Filter
            if (filterCheckbox.checked) {
                studentsToRender = studentsToRender.filter(s => s.missingDataCount > 0);
            }

            // Terapkan Sortir
            const sortValue = sortSelect.value;
            if (sortValue === 'name_asc') {
                studentsToRender.sort((a, b) => a.nama.localeCompare(b.nama));
            } else if (sortValue === 'missing_desc') {
                studentsToRender.sort((a, b) => b.missingDataCount - a.missingDataCount);
            }
            
            // --- Render Tabel ---
            const fields = [
                { key: 'nama', label: 'Nama Siswa' }, { key: 'nisn', label: 'NISN' }, { key: 'nis', label: 'NIS' },
                { key: 'jenisKelamin', label: 'J.K' }, { key: 'tempatLahir', label: 'Tmpt Lahir' }, { key: 'tanggalLahir', label: 'Tgl Lahir' },
                { key: 'alamat', label: 'Alamat' }, { key: 'telepon', label: 'Telepon' }, { key: 'emailSiswa', label: 'Email' },
                { key: 'tahunMasuk', label: 'Masuk' }, { key: 'tahunLulus', label: 'Lulus' }
            ];
            
            let tableHTML = `<div class="border rounded-lg overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-3 text-left font-medium text-gray-600 sticky left-0 bg-gray-100 z-10 whitespace-nowrap w-48">Nama Siswa</th>
                        ${fields.slice(1).map(field => `<th class="px-2 py-3 text-center font-medium text-gray-600 whitespace-nowrap" title="${field.label}">${field.label}</th>`).join('')}
                    </tr>
                </thead>
                <tbody id="completeness-tbody" class="bg-white divide-y divide-gray-200">`;

            if (studentsToRender.length === 0) {
                tableHTML += `<tr><td colspan="${fields.length}" class="text-center p-8 text-gray-500">Tidak ada data yang cocok dengan filter.</td></tr>`;
            } else {
                studentsToRender.forEach(student => {
                    const rowClass = student.missingDataCount > 0 ? 'bg-red-50' : ''; // Highlight baris
                    tableHTML += `<tr class="${rowClass}">
                        <td class="px-3 py-2 font-medium text-gray-800 whitespace-nowrap sticky left-0 ${rowClass ? rowClass : 'bg-white'}">${student.nama.toUpperCase()}</td>`;
                    
                    fields.slice(1).forEach(field => {
                        const value = student[field.key] || '';
                        const hasData = value && value.toString().trim() !== '';
                        const icon = hasData ? '✅' : '❌';
                        tableHTML += `<td class="text-center p-2 cursor-pointer" data-value="${String(value).replace(/"/g, '&quot;')}">${icon}</td>`;
                    });
                    tableHTML += `</tr>`;
                });
            }

            tableHTML += `</tbody></table></div>`;
            container.innerHTML = tableHTML;

            // ===================================================================
            // ===== [TAMBAHAN] PASANG EVENT LISTENER UNTUK TOOLTIP =====
            // ===================================================================
            const tableBody = document.getElementById('completeness-tbody');
            if (tableBody) {
                tableBody.addEventListener('click', function(event) {
                    // Cek apakah elemen yang diklik atau parent-nya adalah <td> dengan data-value
                    const targetCell = event.target.closest('td[data-value]');
                    
                    if (targetCell) {
                        // Jika ya, panggil fungsi untuk menampilkan tooltip
                        showDataTooltip(targetCell);
                    }
                });
            }
        }

        // FUNGSI LAMA `setupCompletenessCheck` PERLU DIMODIFIKASI untuk menambahkan event listener baru
        function setupCompletenessCheck() {
            const modal = document.getElementById('completeness-modal');
            const openBtn = document.getElementById('checkCompletenessBtn');
            const closeBtn1 = document.getElementById('closeCompletenessModalBtn');
            const closeBtn2 = document.getElementById('closeCompletenessModalBtn2');

            // [BARU] Ambil elemen filter dan sort
            const filterCheckbox = document.getElementById('completeness-filter-checkbox');
            const sortSelect = document.getElementById('completeness-sort-select');

            const openModal = () => {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.querySelector('.modal-content').style.transform = 'scale(1)';
                }, 10);
                loadAndRenderCompletenessTable(); // Panggil fungsi utama saat modal dibuka
            };

            const closeModal = () => {
                modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => modal.classList.add('hidden'), 300);
            };

            openBtn.addEventListener('click', openModal);
            closeBtn1.addEventListener('click', closeModal);
            closeBtn2.addEventListener('click', closeModal);
            
            // [BARU] Tambahkan event listener untuk kontrol dinamis
            filterCheckbox.addEventListener('change', renderCompletenessView);
            sortSelect.addEventListener('change', renderCompletenessView);
        }

        // Letakkan fungsi ini di dalam tag <script> Anda

        /**
         * [BARU] Menginisialisasi dan memulai tur aplikasi untuk pengguna baru.
         */
        function initializeAndStartTour() {
            const tour = new Shepherd.Tour({
                useModalOverlay: true,
                defaultStepOptions: {
                    classes: 'shadow-lg shepherd-custom-theme',
                    cancelIcon: {
                        enabled: true
                    },
                    scrollTo: { behavior: 'smooth', block: 'center' }
                }
            });

            // Teks untuk checkbox
            const dontShowAgainCheckbox = `
                <div class="shepherd-dont-show-again">
                    <input type="checkbox" id="dont-show-tour-again">
                    <label for="dont-show-tour-again">Jangan tampilkan lagi</label>
                </div>
            `;

            // Mendefinisikan langkah-langkah tur
            tour.addStep({
                id: 'step-1-dashboard',
                title: 'Selamat Datang!',
                text: 'Ini adalah halaman Dashboard, tempat Anda melihat ringkasan data sekolah.' + dontShowAgainCheckbox,
                attachTo: { element: '.nav-link[data-page="dashboard"]', on: 'right' },
                buttons: [
                    {
                        text: 'Selesai',
                        action: tour.cancel,
                        classes: 'shepherd-button-secondary'
                    },
                    {
                        text: 'Selanjutnya &rarr;',
                        action: tour.next
                    }
                ]
            });

            tour.addStep({
                id: 'step-2-data-sekolah',
                title: 'Data Sekolah',
                text: 'Kelola informasi detail sekolah Anda seperti NPSN, alamat, dan nama kepala sekolah di sini.',
                attachTo: { element: '.nav-link[data-page="data-sekolah"]', on: 'right' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });

            tour.addStep({
                id: 'step-3-data-siswa',
                title: 'Data Siswa',
                text: 'Menu ini adalah pusat manajemen data siswa. Anda bisa menambah, mengedit, menghapus, dan mengimpor data siswa dari file Excel.',
                attachTo: { element: '.nav-link[data-page="data-siswa"]', on: 'right' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });
            
            tour.addStep({
                id: 'step-4-mapel',
                title: 'Mapel & Bobot',
                text: 'Atur semua mata pelajaran yang ada dan tentukan bobot persentase antara nilai ujian dan rapor di halaman ini.',
                attachTo: { element: '.nav-link[data-page="mapel"]', on: 'right' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });
            
            tour.addStep({
                id: 'step-5-input-nilai-ujian',
                title: 'Input Nilai Ujian',
                text: 'Setelah siswa dan mapel siap, gunakan menu ini untuk menginput semua nilai ujian madrasah dan ujian praktek.',
                attachTo: { element: '.nav-link[data-page="input-ujian"]', on: 'right' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });

            tour.addStep({
                id: 'step-6-input-nilai-rapor',
                title: 'Input Nilai Rapor',
                text: 'Setelah siswa dan mapel siap, gunakan menu ini untuk menginput semua nilai rapor per semester.',
                attachTo: { element: '.nav-link[data-page="input-rapor"]', on: 'right' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });
            
            tour.addStep({
                id: 'step-7-rekapitulasi',
                title: 'Rekapitulasi (Paling Penting)',
                text: 'Di sinilah semua keajaiban terjadi! Aplikasi akan mengkalkulasi semua nilai dan menampilkannya di sini. Anda juga bisa mencetak laporan dari halaman ini.',
                attachTo: { element: '.nav-link[data-page="rekapitulasi"]', on: 'right' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });

            tour.addStep({
                id: 'step-8-ubah-password',
                title: 'Keamanan Akun',
                text: 'Anda dapat mengubah password akun Anda secara berkala melalui menu ini untuk menjaga keamanan.',
                attachTo: { element: '.nav-link[data-page="ubah-password"]', on: 'top' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });

            tour.addStep({
                id: 'step-9-logout',
                title: 'Selesai!',
                text: 'Terakhir, gunakan tombol ini untuk keluar dari aplikasi dengan aman. Selamat bekerja!',
                attachTo: { element: '#logoutButton', on: 'top' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });

            tour.addStep({
                id: 'step-10-contact', // ID diubah agar lebih deskriptif
                title: 'Dukungan & Bantuan',
                text: 'Menemukan kendala atau punya saran? Jangan ragu untuk menghubungi kami dengan mengklik kartu ini. Masukan Anda sangat berharga!',
                attachTo: { element: '#hubungi-admin-card', on: 'bottom' }, // <-- Selector diubah ke kartu baru
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selesai!', action: tour.complete } // Gunakan tour.complete untuk menandai tur selesai
                ]
            });

            // Logika untuk menyimpan pilihan "Jangan tampilkan lagi"
            const handleTourEnd = () => {
                const checkbox = document.getElementById('dont-show-tour-again');
                if (checkbox && checkbox.checked) {
                    localStorage.setItem('hasCompletedAppTour', 'true');
                }
            };

            tour.on('complete', handleTourEnd);
            tour.on('cancel', handleTourEnd);

            tour.start();
        }

        // Letakkan ini di dalam event listener DOMContentLoaded atau di area fungsi-fungsi utama
        // --- SUPERADMIN FUNCTIONS ---

        // Panggil fungsi ini saat menu 'Manajemen Akun' diklik
        // GANTI FUNGSI INI
        function loadUserManagementPage() {
            const container = document.getElementById('userManagementTableContainer');
            container.innerHTML = `<p class="text-center p-8 loading-animation">Memuat data pengguna</p>`;
            
            const adminEmail = sessionStorage.getItem('userEmail');
            if (!adminEmail) {
                container.innerHTML = `<p class="text-center text-red-500 p-4">Error: Sesi admin tidak valid.</p>`;
                return;
            }
            
            google.script.run
                .withSuccessHandler(users => { renderUserManagementTable(users); })
                .withFailureHandler(err => { container.innerHTML = `<p class="text-center text-red-500 p-4">Gagal memuat pengguna: ${err.message}</p>`; })
                .getAllUsers_Superadmin(adminEmail);
        }

        // TAMBAHKAN FUNGSI BARU INI
        function loadPengajuanListPage_Superadmin() {
            const pengajuanContainer = document.getElementById('pengajuanContainer_Superadmin');
            pengajuanContainer.innerHTML = `<p class="text-center p-4 loading-animation">Memuat daftar pengajuan</p>`;

            const adminEmail = sessionStorage.getItem('userEmail');
            if (!adminEmail) {
                pengajuanContainer.innerHTML = `<p class="text-center text-red-500 p-4">Error: Sesi admin tidak valid.</p>`;
                return;
            }

            google.script.run
                .withSuccessHandler(requests => { renderChangeRequestsTable(requests); })
                .withFailureHandler(err => { pengajuanContainer.innerHTML = `<p class="text-center text-red-500 p-4">Gagal memuat pengajuan: ${err.message}</p>`; })
                .getChangeRequests_Superadmin(adminEmail);
        }

        // Render tabel semua pengguna
        function renderUserManagementTable(users) {
            const container = document.getElementById('userManagementTableContainer');
            if (!users || users.length === 0) {
                container.innerHTML = `<p class="text-center p-4">Tidak ada pengguna lain yang terdaftar.</p>`;
                return;
            }

            let tableHtml = `<table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Sekolah</th>
                        <!-- KOLOM BARU -->
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Siswa (Saat Ini / Batas)</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Aksi</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">`;

            users.forEach(user => {
                const isSelf = user.email === sessionStorage.getItem('userEmail');
                const statusClass = user.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const statusBtnText = user.status === 'Aktif' ? 'Nonaktifkan' : 'Aktifkan';
                const statusBtnClass = user.status === 'Aktif' ? 'text-yellow-600 hover:text-yellow-900' : 'text-green-600 hover:text-green-900';
                
                // --- PERUBAHAN DI SINI: Menambahkan tombol "Masuk sebagai" ---
                tableHtml += `<tr>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${user.email} ${user.role === 'Superadmin' ? '<span class="text-xs font-bold text-blue-600">(Superadmin)</span>' : ''}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${user.namaSekolah}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center font-mono">
                        ${user.currentStudentCount} / ${user.studentLimit}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-center">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${user.status}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                        ${user.role !== 'Superadmin' ? `<button class="text-cyan-600 hover:text-cyan-900" onclick='handleImpersonate(${JSON.stringify(user)})'>Masuk sbg</button>` : ''}
                        <button class="ml-4 text-indigo-600 hover:text-indigo-900" onclick='handleEditUser_Superadmin(${JSON.stringify(user)})'>Edit</button>
                        <button class="ml-4 text-purple-600 hover:text-purple-900" onclick='handleSetLimit_Superadmin(${user.row}, "${user.studentLimit}")'>Limit</button>
                        ${!isSelf ? `<button class="ml-4 ${statusBtnClass}" onclick='handleSetStatus_Superadmin(${user.row}, "${statusBtnText}")'>${statusBtnText}</button>` : ''}
                    </td>
                </tr>`;
            });

            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;
        }

        // Buka modal edit dengan data pengguna
        function handleEditUser_Superadmin(user) {
            document.getElementById('edit-user-row').value = user.row;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-namasekolah').value = user.namaSekolah;
            document.getElementById('edit-user-jenjang').value = user.jenjang;

            const modal = document.getElementById('edit-user-modal');
            modal.classList.remove('hidden');
            
            document.getElementById('closeEditUserModalBtn').onclick = () => modal.classList.add('hidden');
            document.getElementById('cancelEditUserBtn').onclick = () => modal.classList.add('hidden');
            
            document.getElementById('editUserForm').onsubmit = (e) => {
                e.preventDefault();
                const updatedData = {
                    row: document.getElementById('edit-user-row').value,
                    email: document.getElementById('edit-user-email').value,
                    namaSekolah: document.getElementById('edit-user-namasekolah').value,
                    jenjang: document.getElementById('edit-user-jenjang').value
                };
                const adminEmail = sessionStorage.getItem('userEmail');
                
                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        if (response.status === 'success') {
                            modal.classList.add('hidden');
                            loadUserManagementPage();
                        }
                    })
                    .updateUserBySuperadmin(adminEmail, updatedData);
            };
        }

        // Ubah status akun
        function handleSetStatus_Superadmin(row, action) {
            const newStatus = action === 'Nonaktifkan' ? 'Nonaktif' : 'Aktif';
            if (confirm(`Anda yakin ingin ${action.toLowerCase()} akun ini?`)) {
                const adminEmail = sessionStorage.getItem('userEmail');
                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        if (response.status === 'success') {
                            loadUserManagementPage();
                        }
                    })
                    .setUserStatus_Superadmin(adminEmail, row, newStatus);
            }
        }

        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
        function initializeSuperadminApp() {
            const oldNav = document.getElementById('main-nav');
            const newNav = oldNav.cloneNode(true);
            oldNav.parentNode.replaceChild(newNav, oldNav);

            // TAMBAHKAN BLOK KODE DI BAWAH INI
            // Menyembunyikan semua garis pemisah untuk tampilan Superadmin yang lebih bersih
            document.querySelectorAll('#main-nav > .border-t').forEach(separator => {
                separator.classList.add('hidden');
            });
            // AKHIR DARI BLOK TAMBAHAN

            checkForImpersonation();

            const allowedAdminPages = [
                'superadmin-dashboard', 'manajemen-akun', 'daftar-pengajuan', 
                'admin-tools', 'kelola-update', 'ubah-password'
            ];

            const pageToLinkMap = { 'dashboard': 'superadmin-dashboard' };

            document.querySelectorAll('.nav-link').forEach(link => {
                const page = link.dataset.page;
                // PERBAIKAN: Cek apakah 'page' ada di dalam 'pageToLinkMap'
                if (page && (allowedAdminPages.includes(page) || (page in pageToLinkMap))) {
                    link.classList.remove('hidden');
                } else {
                    link.classList.add('hidden');
                }
            });
            document.getElementById('logoutButton').classList.remove('hidden');
            document.getElementById('school-name-sidebar').textContent = 'SUPERADMIN PANEL';

            const navContainer = document.getElementById('main-nav');
            const contentPages = document.querySelectorAll('.content-page');

            // --- AWAL PERUBAHAN UTAMA (EVENT DELEGATION) ---
            navContainer.addEventListener('click', (e) => {
                const navLink = e.target.closest('.nav-link');
                if (!navLink) return;

                e.preventDefault();
                let targetPageId = navLink.dataset.page;

                if (targetPageId === 'dashboard') targetPageId = 'superadmin-dashboard';

                if (!targetPageId || !allowedAdminPages.includes(targetPageId)) return;

                contentPages.forEach(p => p.classList.add('hidden'));
                document.getElementById('page-' + targetPageId)?.classList.remove('hidden');

                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                const linkToActivate = document.querySelector(`.nav-link[data-page="${navLink.dataset.page}"]`);
                if(linkToActivate) linkToActivate.classList.add('active');

                if (targetPageId === 'superadmin-dashboard') loadSuperadminDashboardData();
                if (targetPageId === 'manajemen-akun') loadUserManagementPage();
                if (targetPageId === 'daftar-pengajuan') loadPengajuanListPage_Superadmin();
                if (targetPageId === 'kelola-update') loadVersionManagementPage();
            });
            // --- AKHIR PERUBAHAN UTAMA ---

            // Inisiasi event listener untuk elemen lain di halaman superadmin
            const totalAkunCard = document.getElementById('sa-card-total-akun');
            if (totalAkunCard) {
                totalAkunCard.addEventListener('click', () => {
                    const manajemenAkunLink = document.querySelector('.nav-link[data-page="manajemen-akun"]');
                    if (manajemenAkunLink) manajemenAkunLink.click();
                });
            }
            const ajuanMenungguCard = document.getElementById('sa-card-ajuan-menunggu');
            if (ajuanMenungguCard) {
                ajuanMenungguCard.addEventListener('click', () => {
                    const daftarPengajuanLink = document.querySelector('.nav-link[data-page="daftar-pengajuan"]');
                    if (daftarPengajuanLink) daftarPengajuanLink.click();
                });
            }

            setupDefaultLimitManager();
            updatePengajuanBadge();

            const dashboardLink = document.querySelector('.nav-link[data-page="dashboard"]');
            if (dashboardLink) dashboardLink.click();
        }

        function loadSuperadminDashboardData() {
            const statIds = ['sa-total-akun', 'sa-total-siswa', 'sa-akun-aktif', 'sa-akun-nonaktif', 'sa-total-ajuan', 'sa-ajuan-menunggu', 'sa-ajuan-diterima', 'sa-ajuan-ditolak'];
            statIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '...';
            });
            
            const historyContainer = document.getElementById('login-history-container');
            historyContainer.innerHTML = `<p class="text-center p-4 loading-animation">Memuat riwayat login</p>`;
            
            const adminEmail = sessionStorage.getItem('userEmail');
            if (!adminEmail) return;

            // Fungsi untuk mengisi kartu dengan data
            const populateCards = (data) => {
                if (!data) return;
                document.getElementById('sa-total-akun').textContent = data.totalAccounts;
                document.getElementById('sa-total-siswa').textContent = data.totalStudents;
                document.getElementById('sa-akun-aktif').textContent = data.activeAccounts;
                document.getElementById('sa-akun-nonaktif').textContent = data.inactiveAccounts;
                document.getElementById('sa-total-ajuan').textContent = data.totalRequests;
                document.getElementById('sa-ajuan-menunggu').textContent = data.pendingRequests;
                document.getElementById('sa-ajuan-diterima').textContent = data.approvedRequests;
                document.getElementById('sa-ajuan-ditolak').textContent = data.rejectedRequests;

                const lastUpdatedEl = document.getElementById('last-updated-text');
                if (lastUpdatedEl) {
                    if (data.lastUpdated && data.lastUpdated !== "Belum pernah") {
                        lastUpdatedEl.textContent = 'Data terakhir diperbarui: ' + new Date(data.lastUpdated).toLocaleString('id-ID');
                    } else {
                        lastUpdatedEl.textContent = 'Data belum pernah diperbarui. Klik tombol di samping untuk memuat.';
                    }
                }
            };
            
            // Panggil data statistik dari cache
            google.script.run
                .withSuccessHandler(populateCards) // Cukup panggil fungsi populateCards
                .withFailureHandler(err => { showGlobalStatus(`Gagal memuat statistik: ${err.message}`, false); })
                .getSuperadminDashboardData(adminEmail);

            // Panggil data riwayat login
            google.script.run
                .withSuccessHandler(renderLoginHistory)
                .withFailureHandler(err => { historyContainer.innerHTML = `<p class="text-center text-red-500 p-4">Gagal memuat riwayat: ${err.message}</p>`; })
                .getLoginHistory_Superadmin(adminEmail);

            // Pasang listener untuk tombol refresh manual
            const refreshBtn = document.getElementById('force-refresh-btn');
            if (refreshBtn) {
                refreshBtn.onclick = () => {
                    refreshBtn.disabled = true;
                    refreshBtn.querySelector('span').textContent = 'Memperbarui...';
                    
                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.status === 'success') {
                                // Langsung isi kartu dengan data baru yang dikirim dari backend
                                populateCards(response.dashboardData);
                            }
                            refreshBtn.disabled = false;
                            refreshBtn.querySelector('span').textContent = 'Perbarui Data Sekarang';
                        })
                        .withFailureHandler(err => {
                            showGlobalStatus(`Error: ${err.message}`, false);
                            refreshBtn.disabled = false;
                            refreshBtn.querySelector('span').textContent = 'Perbarui Data Sekarang';
                        })
                        .forceDashboardCacheUpdate_Superadmin(adminEmail);
                };
            }
        }

        // Letakkan ini bersama fungsi-fungsi JavaScript lainnya

        // Fungsi untuk menangani klik tombol "Ubah Limit"
        function handleSetLimit_Superadmin(rowNumber, currentLimit) {
            const newLimit = prompt(`Masukkan batas siswa baru untuk akun ini.\nBatas saat ini: ${currentLimit}`, currentLimit);
            
            if (newLimit !== null && newLimit.trim() !== "") {
                const adminEmail = sessionStorage.getItem('userEmail');
                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        if (response.status === 'success') {
                            loadUserManagementPage(); // Muat ulang tabel untuk melihat perubahan
                        }
                    })
                    .setStudentLimit_Superadmin(adminEmail, rowNumber, newLimit);
            }
        }

        // Pasang event listener untuk pengaturan default di dashboard
        function setupDefaultLimitManager() {
            const adminEmail = sessionStorage.getItem('userEmail');
            const input = document.getElementById('default-limit-input');
            const saveBtn = document.getElementById('save-default-limit-btn');
            const statusDiv = document.getElementById('default-limit-status');
            
            if (!saveBtn) return;

            // 1. Ambil nilai saat ini saat halaman dimuat
            google.script.run
                .withSuccessHandler(response => {
                    if (response.status === 'success') {
                        input.value = response.currentLimit;
                    }
                })
                .manageDefaultStudentLimit_Superadmin(adminEmail);

            // 2. Simpan nilai baru saat tombol diklik
            saveBtn.addEventListener('click', () => {
                const newLimit = input.value;
                saveBtn.disabled = true;
                saveBtn.textContent = 'Menyimpan...';
                statusDiv.textContent = '';

                google.script.run
                    .withSuccessHandler(response => {
                        statusDiv.textContent = response.message;
                        statusDiv.className = response.status === 'success' ? 'text-green-600 text-sm mt-2' : 'text-red-600 text-sm mt-2';
                        saveBtn.disabled = false;
                        saveBtn.textContent = 'Simpan';
                    })
                    .manageDefaultStudentLimit_Superadmin(adminEmail, newLimit);
            });
        }

        /**
         * [MODIFIKASI] Memasang listener untuk validasi NISN ganda secara real-time.
         * Pengecekan kini hanya aktif saat menambah siswa baru (studentRow kosong).
         */
        function setupRealtimeNisnCheck() {
            const nisnInput = document.getElementById('nisn');
            const errorMsgDiv = document.getElementById('nisn-error-msg');
            const studentRowInput = document.getElementById('studentRow');

            const nisnBlurHandler = () => {
                // [PERBAIKAN] Logika ini memastikan pengecekan HANYA berjalan jika
                // input studentRow kosong, yang menandakan mode "Tambah Siswa".
                if (studentRowInput.value) {
                    errorMsgDiv.textContent = ''; // Pastikan pesan error selalu bersih di mode edit
                    return;
                }

                const nisnValue = nisnInput.value.trim();
                if (!nisnValue) {
                    errorMsgDiv.textContent = '';
                    return;
                }

                const isDuplicate = allStudentsData.some(student => student.nisn === nisnValue);

                if (isDuplicate) {
                    errorMsgDiv.textContent = 'NISN ini sudah digunakan. Silakan gunakan NISN lain.';
                } else {
                    errorMsgDiv.textContent = '';
                }
            };
            
            // Menggunakan pola listener yang lebih aman untuk mencegah penumpukan
            if (nisnInput.nisnBlurHandler) {
                nisnInput.removeEventListener('blur', nisnInput.nisnBlurHandler);
            }
            nisnInput.nisnBlurHandler = nisnBlurHandler;
            nisnInput.addEventListener('blur', nisnInput.nisnBlurHandler);
        }

        /**
         * [BARU] Memuat dan menampilkan informasi kuota siswa di halaman Data Siswa.
         */
        function loadAndDisplayStudentQuota() {
            const quotaContainer = document.getElementById('student-quota-info');
            if (!quotaContainer) return;

            quotaContainer.innerHTML = `<span class="loading-animation">Memuat info kuota</span>`;

            const userEmail = sessionStorage.getItem('userEmail');
            if (!userEmail) {
                quotaContainer.innerHTML = 'Gagal memuat info kuota: Sesi tidak ditemukan.';
                return;
            }

            google.script.run
                .withSuccessHandler(response => {
                    if (response && response.status === 'success') {
                        const { totalLimit, usedCount, remaining } = response;
                        quotaContainer.innerHTML = `
                            <span class="font-semibold">Jumlah Total Kuota: <span class="text-lg">${totalLimit}</span></span>
                            <span class="font-semibold">Jumlah Yang Digunakan: <span class="text-lg">${usedCount}</span></span>
                            <span class="font-semibold text-green-600">Sisa Kuota Siswa: <span class="text-lg">${remaining}</span></span>
                        `;
                    } else {
                        quotaContainer.innerHTML = response.message || 'Gagal memuat info kuota.';
                    }
                })
                .withFailureHandler(err => {
                    quotaContainer.innerHTML = `Error: ${err.message}`;
                })
                .getStudentQuotaInfo(userEmail);
        }

        // ===== GANTI SELURUH FUNGSI loadPengajuanPage LAMA DENGAN VERSI FINAL INI =====
        function loadPengajuanPage() {
            const currentJenjangEl = document.getElementById('currentJenjang');
            const currentNamaSekolahEl = document.getElementById('currentNamaSekolah');
            const userEmail = sessionStorage.getItem('userEmail');

            setPengajuanUiState('loading');
            document.getElementById('ajuanHistoryContainer').innerHTML = `<p class="text-center text-gray-500 py-4 loading-animation">Memuat riwayat</p>`;
            
            if (!userEmail) return;

            google.script.run
                .withSuccessHandler(history => {
                    // **AWAL LOGIKA "MARK AS READ" YANG DIPERBAIKI**
                    if (history && history.length > 0) {
                        const latestRequest = history[0];
                        
                        // Jika statusnya belum dibaca, panggil backend untuk mengubahnya.
                        if (latestRequest.statusBaca === 'Belum Dibaca') {
                            // 1. Langsung hapus ikon di UI untuk respons instan
                            document.getElementById('pengajuan-indicator-container').innerHTML = '';
                            
                            // 2. Panggil fungsi backend dengan DUA argumen: requestId dan userEmail
                            google.script.run
                                .withSuccessHandler(response => {
                                    // Cukup catat di console jika berhasil/gagal, tidak perlu notifikasi ke pengguna
                                    if (response.status !== 'success') {
                                        console.error('Gagal menandai "sudah dibaca" di server:', response.message);
                                    } else {
                                        console.log('Status "sudah dibaca" berhasil disimpan di server.');
                                    }
                                })
                                .withFailureHandler(err => {
                                    console.error('Error saat mencoba menandai "sudah dibaca":', err);
                                })
                                .markRequestAsRead_User(latestRequest.requestId, userEmail); // Kirim email pengguna
                        }
                    }
                    // **AKHIR LOGIKA "MARK AS READ"**
                    
                    // Lanjutkan merender halaman seperti biasa
                    google.script.run.withSuccessHandler(schoolData => {
                        if (schoolData) {
                            currentJenjangEl.textContent = schoolData.jenjang || '(Belum diatur)';
                            currentNamaSekolahEl.textContent = schoolData.namaSekolah || '(Belum diatur)';
                        }
                    }).getSchoolData(userSpreadsheetId);

                    const latestRequest = (history && history.length > 0) ? history[0] : null;
                    if (latestRequest) {
                        if (latestRequest.status === 'Menunggu Persetujuan') setPengajuanUiState('pending', latestRequest);
                        else if (latestRequest.status === 'Ditolak') setPengajuanUiState('rejected', latestRequest);
                        else if (latestRequest.status === 'Disetujui') setPengajuanUiState('approved', latestRequest);
                        else setPengajuanUiState('idle');
                    } else {
                        setPengajuanUiState('idle');
                    }
                    renderRequestHistoryTable(history);
                })
                .withFailureHandler(err => {
                    document.getElementById('ajuanHistoryContainer').innerHTML = `<p class="text-center text-red-500 py-4">Gagal memuat riwayat pengajuan.</p>`;
                })
                .getChangeRequestHistory_User(userEmail);
        }

        // ===== GANTI SELURUH BLOK EVENT LISTENER INI DENGAN VERSI BARU =====
        document.getElementById('pengajuanForm')?.addEventListener('submit', function(e) {
            e.preventDefault();

            const newJenjang = document.getElementById('newJenjang').value;
            const newNamaSekolah = document.getElementById('newNamaSekolah').value.trim();

            if (!newJenjang && !newNamaSekolah) {
                showGlobalStatus("Anda harus mengisi minimal salah satu data baru.", false);
                return;
            }
            
            // Mengganti `confirm()` lama dengan modal kustom
            showConfirmationModal({
                title: "Konfirmasi Pengajuan",
                body: "Anda yakin ingin mengajukan perubahan data ini? Permintaan akan ditinjau oleh Superadmin sebelum diterapkan.",
                confirmText: "Ya, Ajukan",
                confirmColor: "bg-blue-600 hover:bg-blue-700", // Menggunakan warna biru untuk aksi submit
                onConfirm: () => {
                    // Semua logika yang tadinya berjalan setelah confirm()
                    // sekarang dipindahkan ke dalam callback onConfirm ini.
                    const btn = document.getElementById('submitPengajuanBtn');
                    const btnText = document.getElementById('pengajuanBtnText');
                    const spinner = document.getElementById('pengajuanSpinner');

                    btn.disabled = true;
                    btnText.classList.add('hidden');
                    spinner.classList.remove('hidden');

                    const newData = { newJenjang, newNamaSekolah };
                    const userEmail = sessionStorage.getItem('userEmail');

                    google.script.run
                        .withSuccessHandler(response => {
                            spinner.classList.add('hidden');
                            showGlobalStatus(response.message, response.status === 'success');
                            
                            if (response.status === 'success') {
                                syncAndShowPengajuanIndicator();
                                loadPengajuanPage(); 
                            } else {
                                btn.disabled = false;
                                btnText.classList.remove('hidden');
                            }
                        })
                        .withFailureHandler(err => {
                            showGlobalStatus('Gagal: ' + err.message, false);
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .submitChangeRequest(userEmail, newData);
                } // Akhir dari onConfirm
            }); // Akhir dari showConfirmationModal
        });

        /**
         * [VERSI FINAL] Merender tabel daftar pengajuan perubahan data untuk Superadmin
         * dengan layout 6 kolom dan hanya menampilkan data yang berubah.
         */
        function renderChangeRequestsTable(requests) {
            const container = document.getElementById('pengajuanContainer_Superadmin');
            if (!requests || requests.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 p-4">Tidak ada pengajuan perubahan data saat ini.</p>`;
                return;
            }

            // 1. [UBAH] Header tabel diubah menjadi 6 kolom
            let tableHtml = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase">Tanggal</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase">Email</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase">Data Lama</th>
                        <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase">Data Baru</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-500 uppercase">Aksi</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">`;

            requests.forEach(req => {
                let statusClass, statusText, actionButtons;

                // Logika untuk status dan tombol (tidak berubah)
                switch(req.status) {
                    case 'Menunggu Persetujuan':
                        statusClass = 'bg-yellow-100 text-yellow-800';
                        statusText = 'Menunggu';
                        actionButtons = `
                            <button class="text-sm font-medium text-green-600 hover:text-green-900" onclick="handleResolveRequest_Superadmin('${req.requestId}', 'Disetujui', this)">Setujui</button>
                            <button class="ml-4 text-sm font-medium text-red-600 hover:text-red-900" onclick="handleResolveRequest_Superadmin('${req.requestId}', 'Ditolak', this)">Tolak</button>
                        `;
                        break;
                    case 'Disetujui':
                        statusClass = 'bg-green-100 text-green-800'; statusText = 'Disetujui';
                        actionButtons = `<span class="text-sm text-gray-500">Selesai</span>`; break;
                    case 'Ditolak':
                        statusClass = 'bg-red-100 text-red-800'; statusText = 'Ditolak';
                        actionButtons = `<span class="text-sm text-gray-500">Selesai</span>`; break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800'; statusText = 'Tidak Diketahui';
                        actionButtons = '-';
                }

                // 2. [BARU] Logika untuk hanya menampilkan data yang berubah
                let dataLamaHtml = '';
                let dataBaruHtml = '';

                if (req.oldNamaSekolah !== req.newNamaSekolah) {
                    dataLamaHtml += `<div class="font-semibold">${req.oldNamaSekolah}</div>`;
                    dataBaruHtml += `<div class="font-semibold text-blue-600">${req.newNamaSekolah}</div>`;
                }
                if (req.oldJenjang !== req.newJenjang) {
                    dataLamaHtml += `<div>(${req.oldJenjang})</div>`;
                    dataBaruHtml += `<div class="text-blue-600">(${req.newJenjang})</div>`;
                }

                // Jika tidak ada perubahan sama sekali (seharusnya tidak terjadi, tapi untuk keamanan)
                if (!dataLamaHtml) dataLamaHtml = '<span class="text-gray-400">-</span>';
                if (!dataBaruHtml) dataBaruHtml = '<span class="text-gray-400">-</span>';

                // 3. [UBAH] Struktur baris (tr) disesuaikan dengan 6 kolom baru
                tableHtml += `
                    <tr>
                        <td class="px-4 py-4 whitespace-nowrap">${new Date(req.requestDate).toLocaleDateString('id-ID', {day: '2-digit', month: 'numeric', year:'numeric'})}</td>
                        <td class="px-4 py-4 whitespace-nowrap font-medium text-gray-900">${req.userEmail}</td>
                        <td class="px-4 py-4">${dataLamaHtml}</td>
                        <td class="px-4 py-4">${dataBaruHtml}</td>
                        <td class="px-4 py-4 text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${statusText}</span>
                            ${ req.status === 'Ditolak' && req.adminNotes 
                              ? `<div class="mt-1 text-xs text-red-700 italic p-1 bg-red-50 rounded-md">"${req.adminNotes}"</div>` 
                              : ''
                            }
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-right">${actionButtons}</td>
                    </tr>`;
            });

            tableHtml += `</tbody></table></div>`;
            container.innerHTML = tableHtml;
        }

        /**
         * [MODIFIKASI] Menangani klik tombol Setujui/Tolak.
         * Jika ditolak, akan membuka modal untuk mengisi catatan.
         */
        function handleResolveRequest_Superadmin(requestId, resolution, btnElement) {
            const adminEmail = sessionStorage.getItem('userEmail');

            const processResolution = (notes = "") => {
                const parentTd = btnElement.parentElement;
                parentTd.innerHTML = `<span class="text-sm loading-animation">Memproses</span>`;
                
                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        loadPengajuanListPage_Superadmin();
                        updatePengajuanBadge();
                    })
                    .withFailureHandler(err => {
                        showGlobalStatus("Gagal memproses: " + err.message, false);
                        loadPengajuanListPage_Superadmin();
                    })
                    .resolveChangeRequest_Superadmin(adminEmail, requestId, resolution, notes);
            };

            if (resolution === 'Disetujui') {
                if (confirm("Anda yakin ingin MENYETUJUI pengajuan ini?")) {
                    processResolution();
                }
            } else if (resolution === 'Ditolak') {
                // Buka modal untuk catatan penolakan
                const modal = document.getElementById('rejection-notes-modal');
                const confirmBtn = document.getElementById('confirm-rejection-btn');
                const cancelBtn = document.getElementById('cancel-rejection-btn');
                const textarea = document.getElementById('rejection-notes-textarea');
                textarea.value = '';

                modal.classList.remove('hidden');

                const closeModal = () => modal.classList.add('hidden');
                
                cancelBtn.onclick = closeModal;

                confirmBtn.onclick = () => {
                    const adminNotes = textarea.value.trim();
                    if (!adminNotes) {
                        alert("Alasan penolakan tidak boleh kosong.");
                        return;
                    }
                    closeModal();
                    processResolution(adminNotes);
                };
            }
        }

        /**
         * [DIPERBARUI] Fungsi terpusat untuk mengatur tampilan halaman pengajuan.
         * @param {string} state - Kondisi tampilan ('loading', 'idle', 'pending', 'rejected', 'approved').
         * @param {object} [data={}] - Data opsional seperti status dari server.
         */
        function setPengajuanUiState(state, data = {}) {
            const form = document.getElementById('pengajuanForm');
            const newJenjangEl = document.getElementById('newJenjang');
            const newNamaSekolahEl = document.getElementById('newNamaSekolah');
            const submitBtn = document.getElementById('submitPengajuanBtn');
            const btnText = document.getElementById('pengajuanBtnText');
            const statusContainer = document.getElementById('currentAjuanStatusContainer');

            // Default state: form aktif, status kosong
            statusContainer.innerHTML = '';
            newJenjangEl.disabled = false;
            newNamaSekolahEl.disabled = false;
            submitBtn.disabled = false;
            btnText.textContent = 'Ajukan Perubahan';

            switch (state) {
                case 'loading':
                    newJenjangEl.disabled = true;
                    newNamaSekolahEl.disabled = true;
                    submitBtn.disabled = true;
                    btnText.textContent = 'Memuat...';
                    break;

                case 'pending':
                    statusContainer.innerHTML = `<div class="p-3 rounded-md text-sm bg-yellow-100 text-yellow-800 font-medium">
                        <strong>Status Terakhir:</strong> Menunggu Persetujuan
                    </div>`;
                    newJenjangEl.disabled = true;
                    newNamaSekolahEl.disabled = true;
                    submitBtn.disabled = true;
                    btnText.textContent = 'Ajuan Telah Dikirim';
                    break;

                case 'rejected':
                    // [PERBAIKAN DI SINI] Tambahkan logika untuk menampilkan catatan admin.
                    const catatanAdmin = data.adminNotes ? ` || <strong>Catatan Admin:</strong> ${data.adminNotes}` : '';
                    statusContainer.innerHTML = `<div class="p-3 rounded-md text-sm bg-red-100 text-red-800">
                        <strong>Status Terakhir:</strong> Ditolak${catatanAdmin}
                    </div>`;
                    // Form tetap aktif agar bisa mengajukan lagi
                    break;

                case 'approved':
                    statusContainer.innerHTML = `<div class="p-3 rounded-md text-sm bg-green-100 text-green-800 font-medium">
                        <strong>Status Terakhir:</strong> Disetujui
                    </div>`;
                    // Form bisa dikunci atau tidak, tergantung preferensi. Kita biarkan aktif jika ingin mengajukan perubahan lagi.
                    // Jika ingin dikunci, uncomment baris di bawah:
                    // newJenjangEl.disabled = true;
                    // newNamaSekolahEl.disabled = true;
                    // submitBtn.disabled = true;
                    // btnText.textContent = 'Perubahan Disetujui';
                    break;
                    
                case 'idle':
                default:
                    // Tidak melakukan apa-apa, form sudah diaktifkan di atas.
                    break;
            }
        }

        // TAMBAHKAN FUNGSI BARU INI
        /**
         * Memanggil backend untuk mendapatkan jumlah pengajuan yang menunggu
         * dan memperbarui emblem notifikasi di sidebar.
         */
        function updatePengajuanBadge() {
            const adminEmail = sessionStorage.getItem('userEmail');
            if (!adminEmail || sessionStorage.getItem('userRole') !== 'Superadmin') {
                return; // Hanya jalankan untuk Superadmin
            }

            google.script.run
                .withSuccessHandler(response => {
                    const badge = document.getElementById('pengajuan-badge');
                    if (!badge) return;

                    if (response && response.status === 'success' && response.count > 0) {
                        badge.textContent = response.count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                })
                .getPendingRequestCount_Superadmin(adminEmail);
        }

        // TAMBAHKAN FUNGSI BARU INI
        /**
         * Merender tabel riwayat pengajuan untuk pengguna.
         * @param {Array<object>} history - Array objek riwayat dari backend.
         */
        function renderRequestHistoryTable(history) {
            const container = document.getElementById('ajuanHistoryContainer');
            if (!history || history.length === 0) {
                container.innerHTML = ''; // Kosongkan jika tidak ada riwayat
                return;
            }

            let tableHtml = `
                <h3 class="text-xl font-bold text-gray-800 mb-4 border-t pt-6">Riwayat Pengajuan Anda</h3>
                <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase">Tanggal</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase">Data Lama</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase">Data Baru Diajukan</th>
                                <th class="px-4 py-3 text-center font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-4 py-3 text-left font-medium text-gray-500 uppercase">Catatan Admin</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;

            history.forEach(req => {
                let statusClass, statusText;
                switch(req.status) {
                    case 'Menunggu Persetujuan':
                        statusClass = 'bg-yellow-100 text-yellow-800'; statusText = 'Menunggu'; break;
                    case 'Disetujui':
                        statusClass = 'bg-green-100 text-green-800'; statusText = 'Disetujui'; break;
                    case 'Ditolak':
                        statusClass = 'bg-red-100 text-red-800'; statusText = 'Ditolak'; break;
                    default:
                        statusClass = 'bg-gray-100 text-gray-800'; statusText = req.status;
                }

                const catatan = req.status === 'Ditolak' && req.adminNotes ? req.adminNotes : '-';

                tableHtml += `
                    <tr>
                        <td class="px-4 py-4 whitespace-nowrap">${new Date(req.requestDate).toLocaleDateString('id-ID', {day: '2-digit', month: 'short', year: 'numeric'})}</td>
                        <td class="px-4 py-4"><span class="block">${req.oldNamaSekolah}</span><span class="text-xs text-gray-500">${req.oldJenjang}</span></td>
                        <td class="px-4 py-4 text-blue-600 font-medium"><span class="block">${req.newNamaSekolah}</span><span class="text-xs">${req.newJenjang}</span></td>
                        <td class="px-4 py-4 text-center"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${statusText}</span></td>
                        <td class="px-4 py-4 text-gray-600">${catatan}</td>
                    </tr>
                `;
            });

            tableHtml += `</tbody></table></div>`;
            container.innerHTML = tableHtml;
        }

        /**
         * [DIPERBAIKI] Menampilkan modal konfirmasi "ketik untuk hapus" yang generik.
         * @param {object} options Opsi untuk modal.
         * @param {string} options.title Judul modal.
         * @param {string} options.body Teks deskripsi tentang apa yang akan dihapus.
         * @param {function} options.onConfirm Fungsi callback yang akan dijalankan jika konfirmasi berhasil.
         */
        function showTypeToConfirmModal(options) {
            const modal = document.getElementById('type-to-confirm-modal');
            const titleEl = document.getElementById('confirm-modal-title');
            const bodyEl = document.getElementById('confirm-modal-body');
            const inputEl = document.getElementById('confirm-modal-input');
            const cancelBtn = document.getElementById('confirm-modal-cancel-btn');
            const actionBtn = document.getElementById('confirm-modal-action-btn');

            // Isi konten modal sesuai opsi
            titleEl.textContent = options.title;
            bodyEl.innerHTML = options.body;

            // Reset kondisi modal
            inputEl.value = '';
            
            // --- PERBAIKAN LOGIKA DIMULAI DI SINI ---

            // 1. Ganti tombol lama dengan kloningannya untuk menghapus listener lama.
            // Lakukan ini SEBELUM kita menambahkan listener baru.
            const newActionBtn = actionBtn.cloneNode(true);
            actionBtn.parentNode.replaceChild(newActionBtn, actionBtn);
            
            // 2. Set tombol baru ke kondisi non-aktif (disabled)
            newActionBtn.disabled = true;

            // Fungsi untuk menutup modal
            const closeModal = () => {
                modal.classList.add('hidden');
                inputEl.removeEventListener('input', inputHandler);
            };

            // Handler untuk input teks, SEKARANG MENGACU KE newActionBtn
            const inputHandler = () => {
                // .trim() untuk menghapus spasi tidak sengaja
                if (inputEl.value.trim() === 'HAPUS SEMUA') { 
                    newActionBtn.disabled = false;
                } else {
                    newActionBtn.disabled = true;
                }
            };
            
            // Handler untuk tombol aksi
            const actionHandler = () => {
                closeModal();
                options.onConfirm(); // Jalankan fungsi callback
            };

            // 3. Pasang semua event listener yang diperlukan
            inputEl.addEventListener('input', inputHandler);
            cancelBtn.onclick = closeModal;
            newActionBtn.addEventListener('click', actionHandler);
            
            // Tampilkan modal
            modal.classList.remove('hidden');
            modal.querySelector('.modal-content').style.transform = 'scale(1)';
            inputEl.focus();
        }

        // File: Index.html (di dalam tag <script>)

        /**
         * [BARU] Mengubah timestamp menjadi format waktu relatif (misal: "5 menit lalu").
         * @param {string} isoString - Timestamp dalam format ISO 8601.
         * @returns {string} String waktu relatif dalam Bahasa Indonesia.
         */
        function formatRelativeTime(isoString) {
            if (!isoString) return 'Belum pernah login';

            const now = new Date();
            const past = new Date(isoString);
            const seconds = Math.floor((now - past) / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const weeks = Math.floor(days / 7);

            if (seconds < 60) {
                return "Baru saja";
            } else if (minutes < 60) {
                return `${minutes} menit lalu`;
            } else if (hours < 24) {
                return `${hours} jam lalu`;
            } else if (days === 1) {
                return "Kemarin";
            } else if (days < 7) {
                return `${days} hari lalu`;
            } else if (weeks === 1) {
                return `1 minggu lalu`;
            } else if (weeks < 4) {
                return `${weeks} minggu lalu`;
            } else {
                // Jika lebih dari sebulan, tampilkan tanggal saja
                return past.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            }
        }

        /**
         * [BARU] Merender tabel riwayat login pengguna.
         * @param {Array<object>} historyData - Data riwayat login dari backend.
         */
        function renderLoginHistory(historyData) {
            const container = document.getElementById('login-history-container');
            if (!container) return;

            if (!historyData || historyData.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 p-4">Tidak ada riwayat login dari pengguna.</p>`;
                return;
            }

            let tableHtml = `<table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenjang</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aktivitas</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">`;

            historyData.forEach(item => {
                const relativeTime = formatRelativeTime(item.loginTimestamp);
                tableHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${item.namaSekolah || '(Nama Sekolah Kosong)'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.jenjang || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${relativeTime}</td>
                    </tr>`;
            });

            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;
        }

        // Letakkan ini bersama fungsi-fungsi JavaScript lainnya di dalam tag <script>

        /**
         * [BARU] Mengecek pembaruan saat aplikasi dimuat.
         */
        function checkForUpdates() {
            google.script.run
                .withSuccessHandler(latestVersionInfo => {
                    if (!latestVersionInfo || !latestVersionInfo.version) {
                        console.log("Info versi tidak ditemukan.");
                        return;
                    }
                    
                    // Bandingkan versi saat ini dengan versi terbaru dari server
                    if (CURRENT_APP_VERSION !== latestVersionInfo.version) {
                        // Cek localStorage apakah pengguna sudah menutup modal untuk versi ini
                        const dismissedVersion = localStorage.getItem('dismissedAppVersion');
                        if (dismissedVersion !== latestVersionInfo.version) {
                            showUpdateModal(latestVersionInfo);
                        }
                        // Tampilkan badge notifikasi terlepas dari apakah modal sudah ditutup
                        document.getElementById('update-badge')?.classList.remove('hidden');
                    } else {
                        // Jika versi sudah sama, pastikan badge disembunyikan
                        document.getElementById('update-badge')?.classList.add('hidden');
                    }

                    // Muat changelog ke halaman Info & Update
                    renderChangelogPage(latestVersionInfo);
                })
                .getAppVersionInfo();
        }

        /**
         * [BARU] Merender halaman Info & Update dengan data changelog.
         */
        function renderChangelogPage(info) {
            const container = document.getElementById('changelog-container');
            if (!container) return;

            if (!info) {
                container.innerHTML = `<p class="text-gray-600">Gagal memuat informasi versi.</p>`;
                return;
            }
            
            container.innerHTML = `
                <div class="p-6 bg-white rounded-lg shadow-md">
                    <div class="flex items-center justify-between">
                        <h2 class="text-2xl font-bold text-gray-800">Versi ${info.version}</h2>
                        <span class="text-sm text-gray-500">Dirilis: ${new Date(info.releaseDate).toLocaleDateString('id-ID', { dateStyle: 'long' })}</span>
                    </div>
                    <div class="mt-4 border-t pt-4">
                        <h3 class="font-semibold text-lg text-gray-700 mb-2">Catatan Perubahan:</h3>
                        <ul class="list-disc list-inside space-y-2 text-gray-600">
                            ${info.changelog.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }

        /**
         * [VERSI FINAL - DIPERBAIKI] Menampilkan modal info umum (misalnya: "Versi sudah terbaru").
         * Kini juga memasang event listener untuk tombol tutupnya secara dinamis.
         * @param {'success'|'error'} type - Tipe pesan untuk menentukan ikon dan warna.
         * @param {string} title - Judul modal.
         * @param {string} message - Pesan yang akan ditampilkan.
         */
        function showStatusInfoModal(type, title, message) {
            const modal = document.getElementById('status-info-modal');
            const iconContainer = document.getElementById('status-info-icon');
            const titleEl = document.getElementById('status-info-title');
            const messageEl = document.getElementById('status-info-message');
            
            // [BARU] Ambil elemen tombol tutupnya
            const closeBtn = document.getElementById('status-info-close-btn');

            titleEl.textContent = title;
            messageEl.textContent = message;

            if (type === 'success') {
                iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100';
                iconContainer.innerHTML = `<svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>`;
            } else { // error atau info lainnya
                iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100';
                iconContainer.innerHTML = `<svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            }

            // ▼▼▼ PERBAIKAN UTAMA ADA DI SINI ▼▼▼
            // Pasang listener langsung ke tombol setiap kali modal ini dipanggil.
            // Menggunakan .onclick adalah cara yang simpel dan efektif untuk memastikan hanya ada satu aksi.
            closeBtn.onclick = () => {
                closeStatusInfoModal();
            };
            // ▲▲▲ AKHIR DARI PERBAIKAN ▲▲▲

            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('.modal-content').style.transform = 'scale(1)', 10);
        }

        // Fungsi untuk menutup modal info
        function closeStatusInfoModal() {
            const modal = document.getElementById('status-info-modal');
            modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        /**
         * [DIPERBAIKI] Memuat dan menampilkan seluruh riwayat changelog.
         * Versi teratas sekarang akan memiliki label "(Latest Version)".
         */
        function loadFullChangelog() {
            // Hanya muat data sekali saja untuk efisiensi
            if (isChangelogLoaded) {
                return;
            }

            const container = document.getElementById('full-changelog-container');
            container.innerHTML = '<p class="text-gray-500">Memuat riwayat versi...</p>';

            google.script.run
                .withFailureHandler(error => {
                    console.error("Gagal memanggil getAllVersionChangelogs:", error);
                    container.innerHTML = `<p class="text-red-500">Terjadi kesalahan: ${error.message}. Silakan periksa Apps Script Log untuk detail.</p>`;
                })
                .withSuccessHandler(versions => {
                    if (!versions || versions.length === 0) {
                        container.innerHTML = '<p class="text-gray-500">Tidak ada riwayat versi yang ditemukan.</p>';
                        return;
                    }

                    // Kosongkan container dari pesan "Memuat..."
                    container.innerHTML = '';
                    
                    // ---- [PERUBAHAN UTAMA DIMULAI DI SINI] ----
                    versions.forEach((versionData, index) => {
                        const entryDiv = document.createElement('div');
                        entryDiv.className = 'border rounded-lg bg-white shadow-sm';
                        
                        const header = document.createElement('div');
                        header.className = 'p-4 cursor-pointer flex justify-between items-center';

                        // Cek apakah ini adalah versi teratas (indeks 0)
                        const isLatest = index === 0;
                        
                        // Buat label tambahan jika ini versi terbaru, dengan style tebal dan miring
                        const latestLabel = isLatest 
                            ? ' <span class="font-bold italic text-blue-600">(Latest Version)</span>' 
                            : '';

                        // Sisipkan variabel latestLabel setelah nomor versi
                        header.innerHTML = `
                            <div>
                                <p class="font-bold text-lg text-gray-800">Versi ${versionData.version}${latestLabel}</p>
                                <p class="text-xs text-gray-500">${versionData.releaseDate}</p>
                            </div>
                            <svg class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        `;
                        
                        const content = document.createElement('div');
                        content.className = 'px-4 pb-4 border-t hidden';
                        const changelogList = versionData.changelog.map(item => `<li class="text-gray-700">${item}</li>`).join('');
                        content.innerHTML = `<ul class="list-disc list-inside space-y-2 mt-3">${changelogList}</ul>`;

                        header.addEventListener('click', () => {
                            content.classList.toggle('hidden');
                            header.querySelector('svg').classList.toggle('rotate-180');
                        });

                        entryDiv.appendChild(header);
                        entryDiv.appendChild(content);
                        container.appendChild(entryDiv);
                    });
                    // ---- [PERUBAHAN UTAMA SELESAI] ----
                    
                    isChangelogLoaded = true;
                })
                .getAllVersionChangelogs();
        }

        // Tambahkan dua fungsi handler baru ini
        function handleAdminBackup() {
            const targetId = document.getElementById('admin-backup-target-id').value.trim();
            if (!targetId) {
                alert("Silakan masukkan ID Spreadsheet pengguna.");
                return;
            }
            
            const btn = document.getElementById('adminBackupBtn');
            const originalText = btn.textContent;

            if (confirm(`Anda yakin ingin membuat backup untuk spreadsheet dengan ID:\n${targetId}?`)) {
                btn.disabled = true;
                btn.textContent = 'Memproses...';
                
                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        btn.disabled = false;
                        btn.textContent = originalText;
                    })
                    .withFailureHandler(err => {
                        showGlobalStatus(`Error: ${err.message}`, false);
                        btn.disabled = false;
                        btn.textContent = originalText;
                    })
                    .adminCreateBackup(targetId);
            }
        }

        function handleAdminRestore() {
            const targetId = document.getElementById('admin-restore-target-id').value.trim();
            const sourceInput = document.getElementById('admin-restore-source').value.trim();

            if (!targetId || !sourceInput) {
                alert("ID Tujuan dan Sumber harus diisi.");
                return;
            }
            
            const confirmationMessage = `PERINGATAN SANGAT PENTING!\n\nAnda akan MENGHAPUS SEMUA DATA di spreadsheet tujuan dan menggantinya dengan data dari sumber.\n\nTujuan (data akan ditimpa):\nID: ${targetId}\n\nSumber (data akan disalin):\n${sourceInput}\n\nTINDAKAN INI TIDAK DAPAT DIBATALKAN. Lanjutkan?`;

            if (confirm(confirmationMessage)) {
                showGlobalStatus("Memulai proses restore...", "loading");
                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        if (response.status === 'success') {
                            alert("Proses restore berhasil diselesaikan. Data di spreadsheet tujuan telah diperbarui.");
                        }
                    })
                    .withFailureHandler(err => {
                        showGlobalStatus(`Error: ${err.message}`, false);
                    })
                    .adminRestoreFromSource(targetId, sourceInput);
            }
        }

        /**
         * [PERBAIKAN] Memuat halaman manajemen versi dan memastikan
         * tombol "Tambah Versi Baru" selalu memiliki event listener yang aktif.
         */
        function loadVersionManagementPage() {
            const container = document.getElementById('versionsTableContainer');
            container.innerHTML = `<p class="text-center p-8 loading-animation">Memuat data versi</p>`;

            // --- [TAMBAHAN KODE] ---
            // Pasang listener untuk tombol "Tambah Versi Baru" di sini.
            // Ini memastikan tombolnya berfungsi setiap kali halaman ini dimuat.
            const addBtn = document.getElementById('addVersionBtn');
            if (addBtn) {
                addBtn.onclick = () => openVersionModal(null);
            }
            // --- Akhir dari Tambahan Kode ---

            google.script.run
                .withSuccessHandler(renderVersionsTable)
                .withFailureHandler(err => {
                    container.innerHTML = `<p class="text-center text-red-500 p-8">Gagal memuat: ${err.message}</p>`;
                })
                .getVersionsForAdmin();
        }

        /**
         * Merender data versi ke dalam tabel HTML.
         * @param {Array<object>} versions Array data versi dari backend.
         */
        function renderVersionsTable(versions) {
            const container = document.getElementById('versionsTableContainer');
            if (!versions || versions.length === 0) {
                container.innerHTML = `<p class="text-center p-8">Belum ada data versi yang ditambahkan.</p>`;
                return;
            }

            let tableHtml = `<table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Versi</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tanggal Rilis</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Catatan Perubahan</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Aksi</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">`;

            versions.forEach(v => {
                tableHtml += `
                    <tr data-version-data='${JSON.stringify(v)}'>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${v.version}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(v.releaseDate + 'T00:00:00').toLocaleDateString('id-ID', {dateStyle: 'long'})}</td>
                        <td class="px-4 py-4 text-sm text-gray-600"><pre class="whitespace-pre-wrap font-sans">${v.changelog}</pre></td>
                        <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="edit-version-btn text-indigo-600 hover:text-indigo-900">Edit</button>
                            <button class="delete-version-btn ml-4 text-red-600 hover:text-red-900">Hapus</button>
                        </td>
                    </tr>`;
            });

            tableHtml += `</tbody></table>`;
            container.innerHTML = tableHtml;

            // Pasang event listener untuk tombol-tombol yang baru dibuat
            container.querySelectorAll('.edit-version-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const versionData = JSON.parse(e.target.closest('tr').dataset.versionData);
                    openVersionModal(versionData);
                };
            });
            container.querySelectorAll('.delete-version-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const versionData = JSON.parse(e.target.closest('tr').dataset.versionData);
                    handleDeleteVersion(versionData);
                };
            });
        }

        /**
         * [PERBAIKAN FINAL] Membuka modal dan memastikan SEMUA event handler
         * (Simpan, Batal, dan Tutup) terpasang dengan kuat setiap kali modal dibuka.
         */
        function openVersionModal(data = null) {
            const modal = document.getElementById('version-modal');
            const title = document.getElementById('version-modal-title');
            const form = document.getElementById('versionForm');
            
            // Ambil elemen tombol Batal dan Tutup (X)
            const closeBtn = document.getElementById('closeVersionModalBtn');
            const cancelBtn = document.getElementById('cancelVersionBtn');

            form.reset(); 

            if (data) { // Mode Edit
                title.textContent = "Edit Versi Aplikasi";
                document.getElementById('versionRow').value = data.row;
                document.getElementById('versionNumber').value = data.version;
                document.getElementById('releaseDate').value = data.releaseDate;
                document.getElementById('changelog').value = data.changelog;
            } else { // Mode Tambah
                title.textContent = "Tambah Versi Baru";
                document.getElementById('versionRow').value = '';
            }

            // --- [PERBAIKAN UTAMA] ---
            // Kita definisikan dan pasang semua event handler untuk modal ini di sini agar selalu berfungsi.

            // 1. Buat satu fungsi untuk menutup modal
            const closeModal = () => {
                modal.classList.add('hidden');
            };
            
            // 2. Pasang fungsi `closeModal` ke tombol Batal dan X menggunakan .onclick
            closeBtn.onclick = closeModal;
            cancelBtn.onclick = closeModal;
            
            // 3. Pasang handler untuk tombol Simpan menggunakan .onsubmit (seperti perbaikan sebelumnya)
            form.onsubmit = handleVersionFormSubmit; 
            
            // Tampilkan modal setelah semua siap
            modal.classList.remove('hidden');
        }

        /**
         * [FINAL DENGAN ANIMASI] Menangani submit form tambah/edit versi
         * dengan animasi loading pada tombol.
         */
        function handleVersionFormSubmit(event) {
            event.preventDefault();

            // --- [LOGIKA ANIMASI DIMULAI] ---
            const saveBtn = document.getElementById('saveVersionBtn');
            const btnText = saveBtn.querySelector('.btn-text');
            const btnSpinner = saveBtn.querySelector('.btn-spinner');

            saveBtn.disabled = true;
            btnText.classList.add('hidden');
            btnSpinner.classList.remove('hidden');
            // --- [LOGIKA ANIMASI BERAKHIR] ---

            const formData = new FormData(event.target);
            const versionData = Object.fromEntries(formData.entries());
            const isEditing = !!versionData.row;

            // Fungsi untuk mengembalikan tombol ke keadaan normal setelah proses selesai
            const finalizeButtonState = () => {
                saveBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
            };

            const successCallback = (response) => {
                showGlobalStatus(response.message, response.status === 'success');
                if (response.status === 'success') {
                    document.getElementById('version-modal').classList.add('hidden');
                    loadVersionManagementPage();
                }
                finalizeButtonState(); // Kembalikan tombol ke normal
            };

            const failureCallback = (err) => {
                showGlobalStatus(`Error: ${err.message}`, false);
                finalizeButtonState(); // Kembalikan tombol ke normal
            };

            if (isEditing) {
                google.script.run
                    .withSuccessHandler(successCallback)
                    .withFailureHandler(failureCallback)
                    .updateVersion(versionData);
            } else {
                google.script.run
                    .withSuccessHandler(successCallback)
                    .withFailureHandler(failureCallback)
                    .addVersion(versionData);
            }
        }

        /**
         * Menangani penghapusan data versi.
         */
        function handleDeleteVersion(versionData) {
            if (confirm(`Anda yakin ingin menghapus data untuk Versi ${versionData.version}?`)) {
                showGlobalStatus("Menghapus data versi...", true);
                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        if (response.status === 'success') {
                            loadVersionManagementPage();
                        }
                    })
                    .withFailureHandler(err => {
                        showGlobalStatus(`Error: ${err.message}`, false);
                    })
                    .deleteVersion(versionData.row);
            }
        }

        // ==========================================================
        // ===== FUNGSI-FUNGSI BARU UNTUK BACKUP & RESTORE v3.0 =====
        // ==========================================================

        function loadBackupRestorePage() {
          const container = document.getElementById('backupListContainer');
          const resultCodeContainer = document.getElementById('newBackupCodeResult');
          if (!container) return;
          
          container.innerHTML = `<p class="text-center text-gray-500 py-4 loading-animation">Memuat daftar backup</p>`;
          resultCodeContainer.innerHTML = ''; // Kosongkan hasil kode sebelumnya

          const userEmail = sessionStorage.getItem('userEmail');
          if (!userEmail) {
            showGlobalStatus("Error: Sesi pengguna tidak valid.", false);
            return;
          }
          
          google.script.run
            .withSuccessHandler(response => {
              if (response.status === 'success') {
                renderBackupList(response.backups);
              } else {
                container.innerHTML = `<p class="text-red-600 text-center py-4">${response.message}</p>`;
              }
            })
            .withFailureHandler(err => {
              container.innerHTML = `<p class="text-red-600 text-center py-4">Error: ${err.message}</p>`;
            })
            .getBackupListForUser(userEmail);
        }
        
        function renderBackupList(backups) {
          const container = document.getElementById('backupListContainer');
          if (!container) return;

          if (!backups || backups.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 py-4">Belum ada file backup yang dibuat.</p>`;
            return;
          }

          let tableHtml = `<table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50 sticky top-0">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Detail Backup</th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Aksi</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">`;
          
          backups.forEach(backup => {
            const date = new Date(backup.date);
            const formattedDate = date.toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' });
            tableHtml += `
              <tr>
                <td class="px-4 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900">${backup.name}</div>
                  <div class="text-xs text-gray-500">
                    Dibuat: ${formattedDate}
                  </div>
                  <div class="mt-1 text-xs font-mono bg-gray-100 p-1 rounded inline-block">
                    Kode: <span class="font-bold text-blue-700">${backup.code}</span>
                  </div>
                </td>
                <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                  <button class="restore-btn text-green-600 hover:text-green-900" data-backup-code="${backup.code}" data-backup-name="${backup.name}">Pulihkan</button>
                  <button class="delete-btn ml-4 text-red-600 hover:text-red-900" data-backup-id="${backup.id}">Hapus</button>
                </td>
              </tr>`;
          });

          tableHtml += `</tbody></table>`;
          container.innerHTML = tableHtml;

          // Pasang event listener untuk semua tombol aksi yang baru dibuat
          container.querySelectorAll('.restore-btn').forEach(btn => btn.addEventListener('click', handleRestoreFromList));
          container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDeleteBackup));
        }

        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
        function handleCreateBackup() {
            showConfirmationModal({
                title: "Konfirmasi Buat Backup",
                body: "Tindakan ini akan membuat salinan dari seluruh data Anda saat ini dan menghasilkan <strong>Kode Restore</strong> baru. Pastikan Anda menyimpan kode tersebut dengan baik. Lanjutkan?",
                confirmText: "Ya, Buat Backup",
                confirmColor: "bg-blue-600 hover:bg-blue-700", // Warna biru untuk aksi positif
                onConfirm: () => {
                    // Logika yang tadinya di dalam `if(confirm(...))` dipindahkan ke sini
                    const btn = document.getElementById('createBackupBtn');
                    const btnText = document.getElementById('createBackupBtnText');
                    const spinner = document.getElementById('createBackupSpinner');
                    const resultCodeContainer = document.getElementById('newBackupCodeResult');
                    
                    btn.disabled = true;
                    btnText.classList.add('hidden');
                    spinner.classList.remove('hidden');
                    resultCodeContainer.innerHTML = '';

                    const userEmail = sessionStorage.getItem('userEmail');

                    google.script.run
                        .withSuccessHandler(response => {
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                            showGlobalStatus(response.message, response.status === 'success');

                            if (response.status === 'success') {
                                resultCodeContainer.innerHTML = `
                                    <div class="p-4 bg-yellow-100 border border-yellow-300 rounded-lg text-center">
                                        <p class="text-sm text-yellow-800">Kode Restore Anda (Simpan Baik-baik):</p>
                                        <div class="text-2xl font-mono font-bold text-yellow-900 tracking-widest my-2 p-2 bg-white rounded">${response.code}</div>
                                    </div>`;
                                loadBackupRestorePage(); 
                            }
                        })
                        .withFailureHandler(err => {
                            showGlobalStatus(`Error: ${err.message}`, false);
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .createBackupWithCode(userSpreadsheetId, userEmail);
                }
            });
        }
        
        function handleDeleteBackup(event) {
            const btn = event.target;
            const backupId = btn.dataset.backupId;
            
            showConfirmationModal({
                title: "Konfirmasi Hapus",
                body: "Anda yakin ingin menghapus file backup ini? Tindakan ini tidak akan menghapus data di aplikasi, hanya file backupnya. Ini tidak dapat dibatalkan.",
                confirmText: "Ya, Hapus",
                confirmColor: "bg-red-600 hover:bg-red-700",
                onConfirm: () => {
                    // Logika penghapusan yang sudah ada, dijalankan setelah pengguna mengklik "Ya, Hapus"
                    btn.textContent = 'Menghapus...';
                    btn.disabled = true;
                    
                    const userEmail = sessionStorage.getItem('userEmail');
                    
                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.status === 'success') {
                                loadBackupRestorePage(); // Muat ulang daftar
                            } else {
                                // Kembalikan tombol ke keadaan semula jika gagal
                                btn.textContent = 'Hapus';
                                btn.disabled = false;
                            }
                        })
                        .withFailureHandler(err => {
                            showGlobalStatus(`Error saat menghapus: ${err.message}`, false)
                            btn.textContent = 'Hapus';
                            btn.disabled = false;
                        })
                        .deleteBackupForUser(backupId, userEmail);
                }
            });
        }

        function handleRestoreFromList(event) {
          const uniqueCode = event.target.dataset.backupCode;
          const backupName = event.target.dataset.backupName;
          performRestoreProcess(uniqueCode, backupName);
        }

        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
        function handleRestoreFromInput() {
            const codeInput = document.getElementById('restore-code-input');
            const uniqueCode = codeInput.value.trim().toUpperCase();
            
            // Mengganti alert() lama dengan modal kustom
            if (!uniqueCode) {
                showStatusInfoModal('error', 'Input Diperlukan', 'Silakan masukkan Kode Restore pada kolom yang tersedia sebelum melanjutkan.');
                return;
            }
            
            performRestoreProcess(uniqueCode, `backup dengan kode ${uniqueCode}`);
        }
        
        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
        function performRestoreProcess(uniqueCode, backupName) {
            const schoolName = document.getElementById('school-name-sidebar').textContent;

            showRestoreConfirmModal({
                schoolName: schoolName,
                backupName: backupName,
                onConfirm: () => {
                    // Logika yang tadinya ada setelah prompt() sekarang ada di sini
                    const overlay = document.getElementById('loading-overlay');
                    const overlayTitle = document.getElementById('overlay-title');
                    const overlaySubtitle = document.getElementById('overlay-subtitle');
                    const overlayButtonContainer = document.getElementById('overlay-button-container');

                    overlayButtonContainer.innerHTML = '';
                    overlayTitle.textContent = "Memulai Proses Pemulihan...";
                    overlayTitle.classList.add('loading-animation');
                    overlaySubtitle.textContent = "Mohon tunggu, proses berjalan di latar belakang...";
                    overlay.classList.remove('hidden');

                    const userEmail = sessionStorage.getItem('userEmail');
                    google.script.run.restoreFromCode(userSpreadsheetId, uniqueCode, userEmail);

                    let pollCount = 0;
                    const maxPolls = 60; // Max 3 menit
                    const pollingInterval = setInterval(() => {
                        pollCount++;
                        google.script.run
                            .withSuccessHandler(status => {
                                if (pollCount > maxPolls || (status && status !== 'running')) {
                                    clearInterval(pollingInterval);
                                    overlayTitle.classList.remove('loading-animation');
                                    
                                    if (status === 'complete') {
                                        overlayTitle.textContent = "Proses Berhasil!";
                                        overlaySubtitle.innerHTML = `Data Anda telah dipulihkan.<br><strong class="text-blue-600 text-lg">Silakan klik tombol di bawah untuk memuat ulang halaman.</strong>`;
                                        const webAppUrl = sessionStorage.getItem('webAppUrl');
                                        if (webAppUrl) {
                                            overlayButtonContainer.innerHTML = `<a href="${webAppUrl}" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 text-lg">Muat Ulang Halaman</a>`;
                                        }
                                    } else { 
                                        overlayTitle.textContent = "Proses Gagal!";
                                        const errorMessage = status ? status : "Proses memakan waktu terlalu lama. Coba muat ulang halaman untuk melihat hasilnya.";
                                        overlaySubtitle.textContent = errorMessage;
                                        overlayButtonContainer.innerHTML = `<button onclick="document.getElementById('loading-overlay').classList.add('hidden')" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Tutup</button>`;
                                    }
                                }
                            })
                            .getRestoreStatusForUser(userSpreadsheetId, userEmail);
                    }, 3000); 
                }
            });
        }

        /**
         * [BARU] Menampilkan modal konfirmasi kustom yang lebih profesional.
         * @param {object} options - Opsi untuk modal.
         * @param {string} options.title - Judul modal.
         * @param {string} options.body - Teks isi/pesan modal.
         * @param {function} options.onConfirm - Fungsi yang akan dijalankan jika pengguna menekan "Ya, Lanjutkan".
         * @param {string} [options.confirmText='Ya, Lanjutkan'] - Teks untuk tombol konfirmasi.
         * @param {string} [options.confirmColor='bg-red-600'] - Warna tombol konfirmasi (Tailwind class).
         */
        function showConfirmationModal(options) {
            const modal = document.getElementById('confirmation-modal');
            document.getElementById('confirm-custom-title').textContent = options.title;
            document.getElementById('confirm-custom-body').innerHTML = options.body; // Gunakan innerHTML agar bisa parsing tag <strong>, dll.
            
            const actionBtn = document.getElementById('confirm-custom-action-btn');
            const cancelBtn = document.getElementById('confirm-custom-cancel-btn');

            // Atur teks dan warna tombol konfirmasi
            actionBtn.textContent = options.confirmText || 'Ya, Lanjutkan';
            actionBtn.className = `py-2 px-6 rounded-md font-medium text-white ${options.confirmColor || 'bg-red-600 hover:bg-red-700'}`;

            // Tampilkan modal
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.modal-content').style.transform = 'scale(1)';
            }, 10);

            // Fungsi untuk menutup modal dan membersihkan listener
            const closeModal = () => {
                modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => {
                    modal.classList.add('hidden');
                    // Hapus event listener agar tidak menumpuk
                    actionBtn.replaceWith(actionBtn.cloneNode(true));
                }, 300);
            };

            cancelBtn.onclick = closeModal;
            
            // Ganti .onclick dengan .addEventListener untuk memastikan hanya satu aksi yang terpasang
            actionBtn.addEventListener('click', function onConfirmClick() {
                closeModal();
                options.onConfirm(); // Jalankan aksi yang diinginkan
                // Hapus listener ini setelah diklik agar tidak terpicu lagi
                this.removeEventListener('click', onConfirmClick);
            }, { once: true }); // Opsi { once: true } memastikan listener hanya berjalan sekali
        }

        /**
         * [PERBAIKAN FINAL] Membuka modal dan memuat daftar mapel default dari backend.
         * Menggunakan kutip ganda pada atribut data-mapel untuk mengatasi error JSON.
         */
        function openMapelImportModal() {
            const modal = document.getElementById('mapel-import-modal');
            const listContainer = document.getElementById('mapel-import-list');
            
            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('.modal-content').style.transform = 'scale(1)', 10);
            listContainer.innerHTML = `<p class="text-center text-gray-500 loading-animation">Memuat daftar mata pelajaran sesuai jenjang Anda...</p>`;

            google.script.run
                .withSuccessHandler(mapelList => {
                    if (!mapelList || mapelList.length === 0) {
                        listContainer.innerHTML = `<p class="text-center text-red-500 p-4">Tidak ada mata pelajaran default yang ditemukan untuk jenjang sekolah Anda.</p>`;
                        return;
                    }

                    let listHtml = '<div class="space-y-3">';
                    mapelList.forEach((mapel, index) => {
                        const mapelDataString = JSON.stringify(mapel).replace(/"/g, '&quot;');
                        
                        // --- PERUBAHAN ADA DI BARIS BERIKUTNYA ---
                        listHtml += `
                            <div class="p-3 border rounded-md flex items-center hover:bg-gray-50">
                                <input type="checkbox" id="mapel-check-${index}" class="mapel-import-checkbox h-5 w-5 rounded border-gray-300" data-mapel="${mapelDataString}">
                                <label for="mapel-check-${index}" class="ml-4 flex-grow cursor-pointer">
                                    <p class="font-bold text-gray-800">${mapel.nama} <span class="font-normal text-gray-600">(${mapel.kode})</span></p>
                                    <p class="text-xs text-gray-500">Kelompok: ${mapel.kelompok} | Jenis: ${mapel.jenisUjian}</p>
                                </label>
                            </div>
                        `;
                    });
                    listHtml += '</div>';
                    listContainer.innerHTML = listHtml;

                    document.getElementById('importSelectedMapelBtn').onclick = handleImportSelectedMapel;
                    document.getElementById('closeMapelImportModalBtn').onclick = closeMapelImportModal;
                    document.getElementById('cancelMapelImportBtn').onclick = closeMapelImportModal;
                    document.getElementById('selectAllMapelImport').onchange = function(e) {
                        document.querySelectorAll('.mapel-import-checkbox').forEach(checkbox => {
                            checkbox.checked = e.target.checked;
                        });
                    };
                })
                .withFailureHandler(err => {
                    listContainer.innerHTML = `<p class="text-center text-red-500 p-4">Error: ${err.message}</p>`;
                })
                .getDefaultMapelList(userSpreadsheetId);
        }

        /**
         * [UPGRADE] Merender tabel mapel, kini dengan tombol panah naik/turun
         * dan memasang semua listener yang diperlukan.
         */
        function renderMapelTable(mapelToRender) {
            const container = document.getElementById('mapelTableContainer');
            container.innerHTML = ''; 

            if (mapelToRender && mapelToRender.length > 0) {
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Mata Pelajaran</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Ujian</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>`;
                
                const tbody = table.querySelector('tbody');
                mapelToRender.forEach((m, index) => {
                    const isFirst = index === 0;
                    const isLast = index === mapelToRender.length - 1;

                    const tr = document.createElement('tr');
                    // --- Perubahan pada kolom Aksi ---
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${m.kode}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 nama-siswa-cell">${m.nama}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${m.jenisUjian}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button title="Pindah ke Atas" data-action="up" class="p-1 text-gray-400 hover:text-blue-600 disabled:opacity-25 disabled:cursor-not-allowed" ${isFirst ? 'disabled' : ''}>
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                            </button>
                            <button title="Pindah ke Bawah" data-action="down" class="p-1 text-gray-400 hover:text-blue-600 disabled:opacity-25 disabled:cursor-not-allowed" ${isLast ? 'disabled' : ''}>
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                            </button>
                            <button class="text-indigo-600 hover:text-indigo-900 ml-2" data-action="edit">Edit</button>
                            <button class="text-red-600 hover:text-red-900 ml-4" data-action="delete">Hapus</button>
                        </td>`;
                    
                    // Pasang listener untuk tombol yang baru dibuat
                    if (!isFirst) {
                        tr.querySelector('[data-action="up"]').addEventListener('click', () => handleMoveMapel(index, 'up'));
                    }
                    if (!isLast) {
                        tr.querySelector('[data-action="down"]').addEventListener('click', () => handleMoveMapel(index, 'down'));
                    }
                    tr.querySelector('[data-action="edit"]').addEventListener('click', () => handleEditMapel(m));
                    tr.querySelector('[data-action="delete"]').addEventListener('click', (e) => handleDeleteMapel(m, e.target));
                    
                    tbody.appendChild(tr);
                });
                
                container.appendChild(table);
            } else {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Belum ada data mata pelajaran atau data tidak ditemukan.</p>`;
            }
        }

        function handleImportSelectedMapel() {
            console.log("[DEBUG] 1. Tombol 'Impor yang Dipilih' diklik.");
            const selectedCheckboxes = document.querySelectorAll('.mapel-import-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                showGlobalStatus("Tidak ada mata pelajaran yang dipilih.", false);
                return;
            }
            const selectedMapelArray = [];
            selectedCheckboxes.forEach(checkbox => {
                selectedMapelArray.push(JSON.parse(checkbox.dataset.mapel));
            });
            const btn = document.getElementById('importSelectedMapelBtn');
            const btnText = btn.querySelector('.btn-text');
            const spinner = btn.querySelector('.btn-spinner');
            btn.disabled = true;
            btnText.classList.add('hidden');
            spinner.classList.remove('hidden');
            console.log("[DEBUG] 2. Mengirim " + selectedMapelArray.length + " mapel ke server...");
            google.script.run
                .withSuccessHandler(response => {
                    btn.disabled = false;
                    btnText.classList.remove('hidden');
                    spinner.classList.add('hidden');
                    
                    showGlobalStatus(response.message, response.status === 'success');

                    if (response.status === 'success' && response.updatedMapelList) {
                        sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                        checkAndApplyRekapIndicator(); 
                        closeMapelImportModal();
                        
                        // =========================================================
                        // === METODE BARU: MENGGUNAKAN LOADING OVERLAY ===
                        // =========================================================

                        // 1. Ambil elemen-elemen overlay yang sudah ada di HTML Anda
                        const overlay = document.getElementById('loading-overlay');
                        const overlayTitle = document.getElementById('overlay-title');
                        const overlaySubtitle = document.getElementById('overlay-subtitle');

                        // 2. Atur teks dan tampilkan overlay
                        overlayTitle.textContent = "Memuat Ulang Data";
                        overlaySubtitle.textContent = "Menyiapkan tabel mata pelajaran terbaru...";
                        // Pastikan kontainer tombol di overlay kosong
                        document.getElementById('overlay-button-container').innerHTML = ''; 
                        overlay.classList.remove('hidden');

                        // 3. Gunakan jeda untuk memastikan overlay sempat terlihat oleh pengguna
                        setTimeout(() => {
                            // Update variabel global
                            allMapelData = response.updatedMapelList;
                            
                            // Render tabel baru (ini terjadi di belakang overlay, tidak terlihat oleh pengguna)
                            renderMapelTable(response.updatedMapelList);
                            
                            // Sembunyikan kembali overlay setelah semuanya siap
                            overlay.classList.add('hidden');

                        }, 500); // Jeda 0.5 detik agar terasa mulus

                        // =========================================================
                        // === AKHIR DARI METODE BARU ===
                        // =========================================================
                    }
                })
                .withFailureHandler(err => {
                    console.error("[DEBUG] GAGAL TOTAL saat impor:", err);
                    btn.disabled = false;
                    btnText.classList.remove('hidden');
                    spinner.classList.add('hidden');
                    showGlobalStatus(`Error: ${err.message}`, false);
                })
                .importSelectedMapel(userSpreadsheetId, selectedMapelArray);
        }

        /**
        * [BARU] Menutup modal impor mapel.
        */
        function closeMapelImportModal() {
            const modal = document.getElementById('mapel-import-modal');
            modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // Fungsi untuk menutup modal edit mapel
        function closeEditMapelModal() {
            const editMapelModal = document.getElementById('edit-mapel-modal');
            if (editMapelModal) {
                editMapelModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => editMapelModal.classList.add('hidden'), 300);
            }
        }

        /**
         * [UX UPGRADE] Menangani aksi hapus mapel dengan konfirmasi 2 langkah.
         * Kini menampilkan judul dinamis pada loading overlay.
         * @param {object} mapel Objek data mapel yang akan dihapus.
         * @param {HTMLElement} targetButton Tombol hapus yang diklik.
         */
        function handleDeleteMapel(mapel, targetButton) {
            if (targetButton.dataset.confirming) {
                // Tampilkan loading overlay
                const overlay = document.getElementById('loading-overlay');
                const overlayTitle = document.getElementById('overlay-title');
                const overlaySubtitle = document.getElementById('overlay-subtitle');

                // =========================================================
                // === PERUBAHAN ADA DI SINI: Mengubah teks menjadi dinamis ===
                // =========================================================
                overlayTitle.innerHTML = `Menghapus Data Mapel <br class="sm:hidden"> <strong class="text-red-600">"${mapel.nama}"</strong>`;
                overlaySubtitle.textContent = "Proses sedang berjalan, mohon tunggu...";
                // =========================================================
                
                overlay.classList.remove('hidden');

                google.script.run
                    .withSuccessHandler(response => {
                        overlay.classList.add('hidden');
                        
                        showGlobalStatus(response.message, response.status === 'success');

                        if (response.status === 'success' && response.updatedMapelList) {
                            sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                            checkAndApplyRekapIndicator();  
                            allMapelData = response.updatedMapelList;
                            renderMapelTable(response.updatedMapelList);
                        }
                    })
                    .withFailureHandler(err => {
                        overlay.classList.add('hidden');
                        showGlobalStatus(err.message, false);
                    })
                    .deleteMapel(userSpreadsheetId, mapel.row);
            } else {
                // Logika untuk klik pertama (konfirmasi)
                targetButton.textContent = 'Yakin?';
                targetButton.dataset.confirming = true;
                targetButton.classList.add('text-yellow-500', 'font-bold');
                targetButton.classList.remove('text-red-600');

                setTimeout(() => {
                    if (targetButton.dataset.confirming) {
                        targetButton.textContent = 'Hapus';
                        delete targetButton.dataset.confirming;
                        targetButton.classList.remove('text-yellow-500', 'font-bold');
                        targetButton.classList.add('text-red-600');
                    }
                }, 3000);
            }
        }

        /**
         * Menyiapkan dan menampilkan modal untuk mengedit data mapel yang ada.
         * @param {object} mapel Objek data mapel yang akan diedit.
         */
        function handleEditMapel(mapel) {
            // Ambil elemen dari modal edit
            const editMapelModal = document.getElementById('edit-mapel-modal');
            const editMapelForm = document.getElementById('editMapelForm');
            const closeEditMapelModalBtn = document.getElementById('closeEditMapelModalBtn');
            const cancelEditMapelBtn = document.getElementById('cancelEditMapelBtn');

            // Isi form dengan data dari mapel yang dipilih
            document.getElementById('mapelRowEdit').value = mapel.row;
            document.getElementById('kodeEdit').value = mapel.kode;
            document.getElementById('namaMapelEdit').value = mapel.nama;
            document.getElementById('kelompokEdit').value = mapel.kelompok;

            const radioBtn = document.querySelector(`input[name="jenisUjian"][value="${mapel.jenisUjian}"]`);
            if (radioBtn) {
                radioBtn.checked = true;
            } else {
                document.getElementById('jenisUjianMadrasahEdit').checked = true;
            }

            // Tampilkan modal
            editMapelModal.classList.remove('hidden');
            setTimeout(() => {
                editMapelModal.querySelector('.modal-content').style.transform = 'scale(1)';
            }, 10);
        }

        // Ganti seluruh event listener 'editMapelForm' Anda dengan ini:
        editMapelForm.addEventListener('submit', e => {
            e.preventDefault();
            const saveBtn = document.getElementById('saveEditMapelBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';
            
            // Ambil data dari form terlebih dahulu agar kita bisa mendapatkan nama mapelnya
            const mapelData = Object.fromEntries(new FormData(e.target).entries());

            // Ambil elemen-elemen overlay
            const overlay = document.getElementById('loading-overlay');
            const overlayTitle = document.getElementById('overlay-title');
            const overlaySubtitle = document.getElementById('overlay-subtitle');

            // =============================================================
            // === PERUBAHAN ADA DI SINI: Mengubah teks menjadi dinamis ===
            // =============================================================
            overlayTitle.innerHTML = `Menyimpan Perubahan Mapel <br class="sm:hidden"> <strong class="text-blue-600">"${mapelData.nama}"</strong>`;
            overlaySubtitle.textContent = "Proses sedang berjalan, mohon tunggu...";
            // =============================================================

            // Tampilkan overlay setelah teks diatur
            overlay.classList.remove('hidden');
            
            google.script.run
                .withSuccessHandler(response => {
                    overlay.classList.add('hidden');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Simpan Perubahan';

                    showGlobalStatus(response.message, response.status === 'success');
                    
                    if (response.status === 'success' && response.updatedMapelList) {
                        sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                        checkAndApplyRekapIndicator();  
                        closeEditMapelModal();
                        allMapelData = response.updatedMapelList;
                        renderMapelTable(response.updatedMapelList);
                    }
                })
                .withFailureHandler(error => {
                    overlay.classList.add('hidden');
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Simpan Perubahan';
                    showGlobalStatus(error.message, false);
                })
                .updateMapel(userSpreadsheetId, mapelData);
        });

        /**
         * [BARU] Menangani klik tombol panah. Mengatur ulang array di frontend,
         * menggambar ulang tabel, dan memicu penyimpanan ke backend.
         * @param {number} index - Posisi item yang akan dipindahkan.
         * @param {'up'|'down'} direction - Arah perpindahan.
         */
        function handleMoveMapel(index, direction) {
            // Tukar posisi elemen dalam array global 'allMapelData'
            if (direction === 'up' && index > 0) {
                [allMapelData[index - 1], allMapelData[index]] = [allMapelData[index], allMapelData[index - 1]];
            } else if (direction === 'down' && index < allMapelData.length - 1) {
                [allMapelData[index], allMapelData[index + 1]] = [allMapelData[index + 1], allMapelData[index]];
            }

            // Gambar ulang tabel dengan urutan baru secara instan untuk 'real-time effect'
            renderMapelTable(allMapelData);

            // Panggil fungsi untuk menyimpan urutan ke backend
            saveNewMapelOrder();
        }

        /**
         * [BARU] Memicu penyimpanan urutan ke backend dengan 'debounce'.
         * Ini mencegah aplikasi mengirim data ke server setiap kali panah diklik,
         * dan hanya akan mengirim setelah pengguna selesai mengklik.
         */
        function saveNewMapelOrder() {
            // Hapus timer lama jika ada
            clearTimeout(saveOrderTimer);

            // Tampilkan indikator status kecil
            showGlobalStatus("Menyimpan urutan...", 'info');

            // Atur timer baru. Fungsi penyimpanan akan dijalankan setelah 2 detik tanpa ada klik baru.
            saveOrderTimer = setTimeout(() => {
                google.script.run
                    .withSuccessHandler(response => {
                        // Tampilkan notifikasi hijau setelah berhasil disimpan
                        showGlobalStatus(response.message, response.status === 'success');
                        if (response.status === 'success') { // <-- Tambahkan pengecekan ini
                            sessionStorage.setItem('rekapNeedsUpdate', 'true'); // <-- TAMBAHKAN
                            checkAndApplyRekapIndicator();                   // <-- TAMBAHKAN
                        }
                    })
                    .withFailureHandler(err => {
                        showGlobalStatus(err.message, false);
                    })
                    .saveMapelOrder(userSpreadsheetId, allMapelData);
            }, 2000); // Jeda 2 detik
        }

        // Fungsi untuk mengelola tombol mana yang aktif secara visual
        function updateUjianButtonState(activeButtonId) {
            const buttons = document.querySelectorAll('#page-input-ujian .ujian-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            const activeButton = document.getElementById(activeButtonId);
            if(activeButton) activeButton.classList.add('active');
        }

        // ===== [BARU] FUNGSI-FUNGSI UNTUK UNDO & REDO =====

        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
        function clearHistoryAndHideButtons() {
            undoHistory = [];
            redoHistory = [];
            activeTableKey = null; // <-- TAMBAHKAN BARIS INI
            document.getElementById('undo-redo-container').classList.add('hidden');
            updateUndoRedoButtonsState();
        }

        /**
         * Memperbarui status disabled/enabled pada tombol undo/redo.
         */
        function updateUndoRedoButtonsState() {
            document.getElementById('undo-btn').disabled = undoHistory.length === 0;
            document.getElementById('redo-btn').disabled = redoHistory.length === 0;
        }

        /**
         * Merekam perubahan yang terjadi pada sebuah input field.
         * @param {HTMLElement} element - Elemen input yang berubah.
         * @param {string} oldValue - Nilai sebelum diubah.
         * @param {string} newValue - Nilai setelah diubah.
         */
        function recordChange(element, oldValue, newValue) {
            if (isUndoingOrRedoing) return; // Jangan rekam aksi dari undo/redo itu sendiri

            undoHistory.push({ element, oldValue, newValue });
            redoHistory = []; // Hapus riwayat redo setiap ada aksi baru
            updateUndoRedoButtonsState();
        }

        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====

        /**
         * Menjalankan aksi Undo. Kini bisa menangani aksi tunggal atau grup (paste).
         */
        function performUndo() {
            if (undoHistory.length === 0) return;

            isUndoingOrRedoing = true; // Set flag untuk mencegah perekaman ulang
            const lastAction = undoHistory.pop();
            
            // Cek apakah aksi ini adalah sebuah grup (array) atau tunggal (objek)
            if (Array.isArray(lastAction)) {
                // Ini adalah grup dari aksi paste, kembalikan nilai semua elemen
                lastAction.forEach(action => {
                    action.element.value = action.oldValue;
                    updateRowTotals(action.element.closest('tr'));
                });
            } else {
                // Ini adalah aksi tunggal dari pengetikan
                lastAction.element.value = lastAction.oldValue;
                updateRowTotals(lastAction.element.closest('tr'));
            }

            redoHistory.push(lastAction);
            updateUndoRedoButtonsState();
            isUndoingOrRedoing = false; // Unset flag
        }

        /**
         * Menjalankan aksi Redo. Kini bisa menangani aksi tunggal atau grup (paste).
         */
        function performRedo() {
            if (redoHistory.length === 0) return;

            isUndoingOrRedoing = true; // Set flag
            const nextAction = redoHistory.pop();

            if (Array.isArray(nextAction)) {
                // Ini adalah grup dari aksi paste
                nextAction.forEach(action => {
                    action.element.value = action.newValue;
                    updateRowTotals(action.element.closest('tr'));
                });
            } else {
                // Ini adalah aksi tunggal
                nextAction.element.value = nextAction.newValue;
                updateRowTotals(nextAction.element.closest('tr'));
            }

            undoHistory.push(nextAction);
            updateUndoRedoButtonsState();
            isUndoingOrRedoing = false; // Unset flag
        }

        /**
         * Memasang listener pada container tabel nilai untuk melacak perubahan.
         * @param {string} containerId - ID dari div yang membungkus tabel nilai.
         */
        function setupScoreInputListeners(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Simpan nilai saat input mendapat fokus
            container.addEventListener('focusin', (e) => {
                if (e.target.classList.contains('score-input')) {
                    currentFocusedInput = {
                        element: e.target,
                        value: e.target.value
                    };
                }
            });

            // Catat perubahan saat nilai input berubah
            container.addEventListener('input', (e) => {
                if (e.target.classList.contains('score-input') && currentFocusedInput) {
                    if (e.target === currentFocusedInput.element && e.target.value !== currentFocusedInput.value) {
                        recordChange(e.target, currentFocusedInput.value, e.target.value);
                        // Update nilai lama untuk fokus berikutnya
                        currentFocusedInput.value = e.target.value;
                    }
                }
            });
        }

        // ===== [BARU] FUNGSI-FUNGSI UNTUK BLOK SELEKSI & HAPUS =====

        /**
         * Menghapus semua highlight dari sel dan mengosongkan set seleksi.
         */
        function clearSelection() {
            selectedCells.forEach(cell => cell.classList.remove('cell-selected'));
            selectedCells.clear();
        }

        /**
         * Menghitung dan menerapkan highlight pada blok sel antara sel awal dan sel akhir.
         * @param {HTMLElement} endCell - Elemen input terakhir yang di-hover oleh mouse.
         */
        function highlightSelection(endCell) {
            clearSelection(); // Hapus seleksi lama sebelum membuat yang baru
            if (!startCell || !endCell) return;

            const table = startCell.closest('table');
            const allRows = Array.from(table.querySelectorAll('tbody tr'));
            const startTr = startCell.closest('tr');
            const endTr = endCell.closest('tr');

            // Dapatkan index baris dan kolom
            const startRowIndex = allRows.indexOf(startTr);
            const endRowIndex = allRows.indexOf(endTr);
            const startCellIndex = Array.from(startTr.cells).indexOf(startCell.closest('td'));
            const endCellIndex = Array.from(endTr.cells).indexOf(endCell.closest('td'));

            // Tentukan area blok (min/max row dan col)
            const minRow = Math.min(startRowIndex, endRowIndex);
            const maxRow = Math.max(startRowIndex, endRowIndex);
            const minCol = Math.min(startCellIndex, endCellIndex);
            const maxCol = Math.max(startCellIndex, endCellIndex);

            // Loop melalui semua baris dalam blok
            for (let i = minRow; i <= maxRow; i++) {
                const rowCells = allRows[i].cells;
                // Loop melalui semua kolom dalam blok
                for (let j = minCol; j <= maxCol; j++) {
                    const cell = rowCells[j];
                    const input = cell ? cell.querySelector('.score-input') : null;
                    if (input) {
                        input.classList.add('cell-selected');
                        selectedCells.add(input);
                    }
                }
            }
        }

        /**
         * Menangani aksi penghapusan data pada sel yang terseleksi.
         * Terintegrasi dengan sistem Undo/Redo.
         */
        function handleSelectionDeletion() {
            if (selectedCells.size === 0) return;

            const changes = [];
            selectedCells.forEach(cell => {
                if (cell.value !== '') {
                    changes.push({
                        element: cell,
                        oldValue: cell.value,
                        newValue: ''
                    });
                }
            });

            if (changes.length > 0) {
                // Rekam semua perubahan sebagai satu aksi grup
                undoHistory.push(changes);
                redoHistory = []; // Hapus riwayat redo
                updateUndoRedoButtonsState();

                // Terapkan penghapusan
                changes.forEach(change => {
                    change.element.value = '';
                    updateRowTotals(change.element.closest('tr'));
                });
                
                showGlobalStatus(`${changes.length} nilai berhasil dihapus.`, true);
            }
            
            clearSelection();
        }

        // ===== GANTI FUNGSI LAMA initializeCellSelection DENGAN VERSI BARU INI =====
        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
        /**
         * Memasang listener MOUSE yang spesifik pada sebuah tabel nilai.
         * VERSI 6: Memeriksa status form (terkunci/tidak) sebelum memulai seleksi.
         * @param {string} tableId - ID dari tabel nilai yang akan diberi fungsionalitas.
         * @param {string} key - Kunci unik yang berhubungan dengan tombol edit tabel ini.
         */
        function initializeCellSelection(tableId, key) {
            const table = document.getElementById(tableId);
            if (!table || table.hasMouseListeners) return;

            table.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('score-input')) {
                    // --- AWAL PERUBAHAN ---
                    // Cek apakah tombol edit sedang ditampilkan. Jika ya, berarti form terkunci.
                    const editBtn = document.getElementById(`edit-scores-btn-${key}`);
                    if (editBtn && !editBtn.classList.contains('hidden')) {
                        // Jika form terkunci (tombol edit terlihat), batalkan semua aksi.
                        e.preventDefault();
                        return; 
                    }
                    // --- AKHIR PERUBAHAN ---

                    isSelecting = true;
                    clearSelection();
                    startCell = e.target;
                    document.body.classList.add('no-select');
                }
            });

            table.addEventListener('mouseover', (e) => {
                if (isSelecting && e.target.classList.contains('score-input')) {
                    highlightSelection(e.target);
                }
            });

            table.hasMouseListeners = true; 
        }

        // ===== [BARU] FUNGSI UNTUK INDIKATOR REKAPITULASI =====

        /**
         * Memeriksa status 'rekapNeedsUpdate' dari sessionStorage
         * dan menampilkan/menyembunyikan indikator animasi.
         */
        function checkAndApplyRekapIndicator() {
            const indicator = document.getElementById('rekap-indicator');
            if (!indicator) return;

            if (sessionStorage.getItem('rekapNeedsUpdate') === 'true') {
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        /**
         * [VERSI FINAL - SPREADSHEET-BASED] Menampilkan ikon notifikasi berdasarkan 'Status Dibaca' dari server.
         */
        function syncAndShowPengajuanIndicator() {
            const indicatorContainer = document.getElementById('pengajuan-indicator-container');
            const userEmail = sessionStorage.getItem('userEmail');
            if (!indicatorContainer || !userEmail) return;

            google.script.run
                .withSuccessHandler(history => {
                    indicatorContainer.innerHTML = '';

                    if (!history || history.length === 0) return;

                    const latestRequest = history[0];
                    const status = latestRequest.status;
                    const statusBaca = latestRequest.statusBaca;

                    let indicatorHtml = '';

                    if (statusBaca === 'Proses') {
                        const pingClasses = "animate-ping absolute inline-flex h-full w-full rounded-full opacity-75";
                        const baseClasses = "relative inline-flex rounded-full h-3 w-3";
                        indicatorHtml = `<span class="relative flex h-3 w-3"><span class="${pingClasses} bg-yellow-400"></span><span class="${baseClasses} bg-yellow-500"></span></span>`;
                    
                    } else if (statusBaca === 'Belum Dibaca') {
                        if (status === 'Disetujui') {
                            indicatorHtml = `<span class="relative flex h-5 w-5 text-green-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg></span>`;
                        } else if (status === 'Ditolak') {
                            indicatorHtml = `<span class="relative flex h-5 w-5 text-red-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></span>`;
                        }
                    }
                    // Jika statusBaca adalah 'Sudah Dibaca', indicatorHtml akan kosong dan tidak ada yang ditampilkan.

                    indicatorContainer.innerHTML = indicatorHtml;
                })
                .getChangeRequestHistory_User(userEmail);
        }

        /**
         * [BARU] Menangani restore oleh admin dengan menampilkan loading overlay
         * selama proses backend berjalan.
         */
        function handleAdminRestoreFromCode() {
          const uniqueCode = document.getElementById('admin-restore-code').value.trim();
          const targetId = document.getElementById('admin-restore-target-id-new').value.trim();

          if (!uniqueCode || !targetId) {
            alert("Kode Restore dan ID Spreadsheet Tujuan harus diisi.");
            return;
          }

          const confirmationMessage = `PERINGATAN SANGAT PENTING!\n\nAnda akan menimpa seluruh data pada spreadsheet:\nID: ${targetId}\n\ndengan data dari backup kode: ${uniqueCode}\n\nTINDAKAN INI TIDAK DAPAT DIBATALKAN. Lanjutkan?`;
          
          if (confirm(confirmationMessage)) {
            // === AWAL PERUBAHAN: TAMPILKAN OVERLAY ===
            const overlay = document.getElementById('loading-overlay');
            const overlayTitle = document.getElementById('overlay-title');
            const overlaySubtitle = document.getElementById('overlay-subtitle');

            overlayTitle.textContent = "Memulihkan Data Pengguna...";
            overlaySubtitle.textContent = `Proses restore dari kode ${uniqueCode} sedang berjalan. Ini bisa memakan waktu beberapa menit. Mohon jangan menutup atau me-refresh halaman ini.`;
            document.getElementById('overlay-button-container').innerHTML = ''; // Hapus tombol lama jika ada
            overlay.classList.remove('hidden');
            // === AKHIR PERUBAHAN ===
            
            const adminEmail = sessionStorage.getItem('userEmail');
            
            google.script.run
              .withSuccessHandler(response => {
                // Sembunyikan overlay setelah proses selesai
                overlay.classList.add('hidden'); 
                
                showGlobalStatus(response.message, response.status === 'success');
                if (response.status === 'success') {
                  alert("Proses restore berhasil diselesaikan.");
                }
              })
              .withFailureHandler(err => {
                // Sembunyikan overlay jika terjadi error
                overlay.classList.add('hidden');
                
                showGlobalStatus(`Error: ${err.message}`, false);
              })
              .adminRestoreFromCode_Superadmin(adminEmail, uniqueCode, targetId);
          }
        }

        /**
         * [BARU] Mengelola status aktif untuk tombol di halaman rapor per semester.
         * @param {HTMLElement} activeBtnElement - Tombol yang baru saja diklik.
         */
        function updateRaporButtonState(activeBtnElement) {
            if (!activeBtnElement) return;
            // Cari kontainer semester terdekat dari tombol yang diklik
            const semesterContainer = activeBtnElement.closest('.rapor-semester-container');
            if (!semesterContainer) return;

            // Hapus kelas 'active' dari semua tombol di dalam kontainer semester ini
            semesterContainer.querySelectorAll('.rapor-semester-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Tambahkan kelas 'active' hanya ke tombol yang diklik
            activeBtnElement.classList.add('active');
        }

        /**
         * [BARU] Menginisialisasi halaman validasi nilai dengan dua tombol mode.
         */
        function initValidationPage() {
            const resultContainer = document.getElementById('validationResultContainer');
            const validateBySheetBtn = document.getElementById('validateBySheetBtn');
            const validateBySubjectBtn = document.getElementById('validateBySubjectBtn');

            resultContainer.innerHTML = '<p class="text-center text-gray-500">Pilih salah satu mode validasi di atas untuk memulai.</p>';

            validateBySheetBtn.onclick = () => handleValidationRequest('per_ujian');
            validateBySubjectBtn.onclick = () => handleValidationRequest('per_mapel');
        }

        /**
         * [BARU] Fungsi pusat untuk menangani permintaan validasi.
         * @param {'per_ujian'|'per_mapel'} mode - Mode validasi yang dipilih.
         */
        function handleValidationRequest(mode) {
            const btns = document.querySelectorAll('.validation-mode-btn');
            const resultContainer = document.getElementById('validationResultContainer');

            btns.forEach(btn => {
                btn.disabled = true;
                btn.classList.add('animate-pulse');
            });

            resultContainer.innerHTML = `<div class="text-center p-8">
                <p class="font-bold text-lg text-blue-700 loading-animation">Memeriksa semua data nilai</p>
                <p class="text-gray-600 mt-2">Proses ini mungkin memerlukan beberapa saat...</p>
            </div>`;

            const backendFunction = mode === 'per_ujian' ? 'validateAllScores' : 'validateScoresBySubject';
            const successRenderer = mode === 'per_ujian' ? renderValidationBySheet : renderValidationBySubject;

            google.script.run
                .withSuccessHandler(response => {
                    btns.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('animate-pulse');
                    });

                    if (response.status === 'success') {
                        successRenderer(response);
                    } else {
                        resultContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-md text-center">${response.message}</div>`;
                    }
                })
                .withFailureHandler(err => {
                    btns.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('animate-pulse');
                    });
                    resultContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-md text-center">Error: ${err.message}</div>`;
                })
                [backendFunction](userSpreadsheetId); // Panggil fungsi backend secara dinamis
        }

        /**
         * [DIPERBARUI] Merender hasil validasi per Jenis Ujian/Sheet dengan header horizontal.
         */
        function renderValidationBySheet(response) {
            const container = document.getElementById('validationResultContainer');
            const { data, sheetHeaders } = response;

            const fullyCompleteCount = data.filter(student => !Object.values(student.completeness).includes(false)).length;

            let html = `
                <div class="p-4 mb-6 rounded-lg bg-blue-50 border border-blue-200 text-center">
                    <h3 class="text-lg font-bold text-blue-800">Hasil Validasi per Jenis Ujian</h3>
                    <p class="text-blue-700">Ditemukan <strong>${fullyCompleteCount} dari ${data.length} siswa</strong> dengan data nilai yang 100% lengkap.</p>
                </div>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-3 text-left font-medium text-gray-600 sticky left-0 bg-gray-100 z-10 w-48 align-middle">Nama Siswa</th>
                                ${sheetHeaders.map(header => `
                                    <th class="p-2 text-center align-middle border-l border-gray-200" title="${header.replace(/_/g, ' ')}">
                                        ${formatSheetHeader(header)}
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;

            data.forEach(student => {
                html += `
                    <tr>
                        <td class="px-3 py-2 font-medium text-gray-800 whitespace-nowrap sticky left-0 bg-white z-10">${student.nama.toUpperCase()}</td>
                        ${sheetHeaders.map(header => {
                            const isComplete = student.completeness[header];
                            const icon = isComplete === undefined ? '<span title="Sheet tidak ditemukan">-</span>' : (isComplete ? '<span title="Lengkap">✅</span>' : '<span title="Tidak Lengkap">❌</span>');
                            return `<td class="text-center p-2 border-l border-gray-200 align-middle">${icon}</td>`;
                        }).join('')}
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        /**
         * [BARU] Merender hasil validasi ke dalam tabel.
         */
        function renderValidationResults(response) {
            const container = document.getElementById('validationResultContainer');
            const { data, sheetHeaders } = response;

            const fullyCompleteCount = data.filter(student => !Object.values(student.completeness).includes(false)).length;

            let html = `
                <div class="p-4 mb-6 rounded-lg bg-blue-50 border border-blue-200 text-center">
                    <h3 class="text-lg font-bold text-blue-800">Hasil Validasi</h3>
                    <p class="text-blue-700">Ditemukan <strong>${fullyCompleteCount} dari ${data.length} siswa</strong> dengan data nilai yang 100% lengkap.</p>
                </div>
                <div class="overflow-x-auto border rounded-lg">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-3 text-left font-medium text-gray-600 sticky left-0 bg-gray-100 z-10 w-48">Nama Siswa</th>
                                ${sheetHeaders.map(header => `<th class="p-2 border-l border-gray-200" title="${header}"><div class="transform -rotate-90 whitespace-nowrap h-28 flex items-center justify-center">${header.replace(/_/g, ' ')}</div></th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;

            data.forEach(student => {
                html += `
                    <tr>
                        <td class="px-3 py-2 font-medium text-gray-800 whitespace-nowrap sticky left-0 bg-white z-10">${student.nama.toUpperCase()}</td>
                        ${sheetHeaders.map(header => {
                            const isComplete = student.completeness[header];
                            const icon = isComplete ? '<span title="Lengkap">✅</span>' : '<span title="Tidak Lengkap/Kosong">❌</span>';
                            return `<td class="text-center p-2 border-l border-gray-200">${icon}</td>`;
                        }).join('')}
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        /**
         * [DIPERBARUI] Merender hasil validasi per Mata Pelajaran dengan rasio yang bisa diklik.
         */
        function renderValidationBySubject(response) {
            const container = document.getElementById('validationResultContainer');
            const { data, mapelHeaders } = response;

            let html = `
                <div class="p-4 mb-6 rounded-lg bg-green-50 border border-green-200 text-center">
                    <h3 class="text-lg font-bold text-green-800">Hasil Validasi per Mata Pelajaran</h3>
                    <p class="text-green-700">Tabel menunjukkan jumlah nilai terisi / total nilai seharusnya. <strong>Klik pada angka rasio untuk melihat detail nilai yang kosong.</strong></p>
                </div>
                <div class="overflow-x-auto border rounded-lg">
                    <table id="validation-by-subject-table" class="min-w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-3 text-left font-medium text-gray-600 sticky left-0 bg-gray-100 z-10 w-48">Nama Siswa</th>
                                ${mapelHeaders.map(mapel => `<th class="p-2 border-l border-gray-200" title="${mapel.nama}"><div class="transform -rotate-90 whitespace-nowrap h-20 flex items-center justify-center">${mapel.kode}</div></th>`).join('')}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
            `;

            data.forEach(student => {
                html += `
                    <tr>
                        <td class="px-3 py-2 font-medium text-gray-800 whitespace-nowrap sticky left-0 bg-white z-10">${student.nama.toUpperCase()}</td>
                        ${mapelHeaders.map(mapel => {
                            const status = student.subjectCompleteness[mapel.kode];
                            if (!status) return '<td class="text-center p-2 border-l border-gray-200">-</td>';

                            const { complete, total, missing } = status;
                            let bgColorClass = 'bg-red-100 text-red-800';
                            if (total > 0) {
                                const percentage = (complete / total) * 100;
                                if (percentage === 100) {
                                    bgColorClass = 'bg-green-100 text-green-800';
                                } else if (percentage > 0) {
                                    bgColorClass = 'bg-yellow-100 text-yellow-800';
                                }
                            } else if (total === 0) {
                              bgColorClass = 'bg-gray-100 text-gray-500';
                            }

                            // [PERUBAHAN INTI] Buat elemen bisa diklik jika tidak lengkap
                            if (complete < total) {
                                const detailsPayload = JSON.stringify({
                                    studentName: student.nama,
                                    mapelName: mapel.nama,
                                    missingList: missing
                                }).replace(/"/g, '&quot;'); // Ganti kutip ganda agar aman di atribut HTML

                                return `<td class="text-center p-2 border-l border-gray-200">
                                    <span class="px-2 py-1 rounded-md font-bold ${bgColorClass} clickable-ratio" data-details="${detailsPayload}">${complete}/${total}</span>
                                </td>`;
                            } else {
                                // Jika sudah lengkap, tidak perlu bisa diklik
                                return `<td class="text-center p-2 border-l border-gray-200">
                                    <span class="px-2 py-1 rounded-md font-bold ${bgColorClass}">${complete}/${total}</span>
                                </td>`;
                            }
                        }).join('')}
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;

            // [BARU] Pasang event listener pada tabel menggunakan event delegation
            document.getElementById('validation-by-subject-table').addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('clickable-ratio')) {
                    const detailsString = e.target.getAttribute('data-details').replace(/&quot;/g, '"');
                    showMissingDetailsModal(JSON.parse(detailsString));
                }
            });
        }

        /**
         * [BARU] Menampilkan modal pop-up dengan detail nilai yang hilang.
         * @param {object} details - Objek berisi nama siswa, nama mapel, dan daftar nilai yang hilang.
         */
        function showMissingDetailsModal(details) {
            const modal = document.getElementById('missing-details-modal');
            const titleEl = document.getElementById('missing-details-title');
            const listEl = document.getElementById('missing-details-list');
            const closeBtn1 = document.getElementById('closeMissingDetailsBtn');
            const closeBtn2 = document.getElementById('closeMissingDetailsBtn2');

            titleEl.innerHTML = `Nilai Kosong: <span class="text-blue-600">${details.studentName}</span><br><span class="text-lg font-medium text-gray-600">Mapel: ${details.mapelName}</span>`;

            if (details.missingList && details.missingList.length > 0) {
                listEl.innerHTML = '<ul class="list-disc list-inside space-y-2 text-gray-700"></ul>';
                const ul = listEl.querySelector('ul');
                details.missingList.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    ul.appendChild(li);
                });
            } else {
                listEl.innerHTML = '<p class="text-center text-gray-500">Tidak ada detail yang ditemukan.</p>';
            }

            const closeModal = () => {
                modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => modal.classList.add('hidden'), 300);
            };

            closeBtn1.onclick = closeModal;
            closeBtn2.onclick = closeModal;

            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('.modal-content').style.transform = 'scale(1)', 10);
        }

        /**
         * [BARU] Helper untuk memformat nama sheet menjadi header tabel yang tersusun.
         * @param {string} sheetName - Nama sheet dari backend (cth: Rapor_Pengetahuan_k4_ganjil).
         * @returns {string} - String HTML untuk header tabel.
         */
        function formatSheetHeader(sheetName) {
            const semesterNameMap = {
              k4_ganjil: 'Kelas 4 Ganjil', k4_genap: 'Kelas 4 Genap', k5_ganjil: 'Kelas 5 Ganjil',
              k5_genap: 'Kelas 5 Genap', k6_ganjil: 'Kelas 6 Ganjil',
              k7_ganjil: 'Kelas 7 Ganjil', k7_genap: 'Kelas 7 Genap', k8_ganjil: 'Kelas 8 Ganjil',
              k8_genap: 'Kelas 8 Genap', k9_ganjil: 'Kelas 9 Ganjil',
              k10_ganjil: 'Kelas 10 Ganjil', k10_genap: 'Kelas 10 Genap', k11_ganjil: 'Kelas 11 Ganjil',
              k11_genap: 'Kelas 11 Genap', k12_ganjil: 'Kelas 12 Ganjil'
            };

            const parts = sheetName.split('_');

            if (parts[0] === 'Rapor') {
                const type = parts.slice(0, 2).join(' '); // "Rapor Pengetahuan" atau "Rapor Keterampilan"
                const semesterKey = parts.slice(2).join('_');
                const semesterText = semesterNameMap[semesterKey] || semesterKey;
                // Membuat format 2 baris
                return `<div class="font-medium text-gray-700">${type}</div><div class="text-xs font-normal text-gray-500">${semesterText}</div>`;
            }
            
            // Untuk header lain seperti "Nilai Ujian Praktek", biarkan apa adanya.
            return `<div class="font-medium text-gray-700">${sheetName.replace(/_/g, ' ')}</div>`;
        }

        function enableScoreEditing(key) {
            const editBtn = document.getElementById(`edit-scores-btn-${key}`);
            const floatingEditBtn = document.getElementById('edit-scores-floating-btn');
            const actionsContainer = document.getElementById(`actions-container-${key}`);
            const form = document.getElementById(`form-nilai-${key}`); 
            
            if (!form) return;
            const scoreInputs = form.querySelectorAll('.score-input');

            // Modifikasi di sini
            scoreInputs.forEach(input => {
                input.readOnly = false;
                // Hapus style KKM saat mode edit diaktifkan
                input.classList.remove('text-red-600', 'font-bold'); 
            });

            if (editBtn) editBtn.classList.add('hidden');
            if (floatingEditBtn) floatingEditBtn.classList.add('hidden'); 
            if (actionsContainer) actionsContainer.classList.remove('hidden');
        }

        function disableScoreEditing(key) {
            const editBtn = document.getElementById(`edit-scores-btn-${key}`);
            const floatingEditBtn = document.getElementById('edit-scores-floating-btn'); 
            const actionsContainer = document.getElementById(`actions-container-${key}`);
            const form = document.getElementById(`form-nilai-${key}`);
            
            if (!form) return;
            const scoreInputs = form.querySelectorAll('.score-input');

            scoreInputs.forEach(input => input.readOnly = true);

            // Panggil helper function untuk menerapkan kembali style KKM
            applyKkmStylesOnView(form);

            if (editBtn) editBtn.classList.remove('hidden');
            if (floatingEditBtn) floatingEditBtn.classList.remove('hidden'); 
            if (actionsContainer) actionsContainer.classList.add('hidden');
        }

        /**
         * [VERSI FINAL & DIPERBAIKI] Menampilkan modal konfirmasi khusus untuk proses restore.
         * @param {object} options Opsi untuk modal.
         * @param {string} options.schoolName Nama sekolah yang harus diketik untuk konfirmasi.
         * @param {string} options.backupName Nama file backup yang akan dipulihkan.
         * @param {function} options.onConfirm Fungsi callback yang akan dijalankan jika konfirmasi berhasil.
         */
        function showRestoreConfirmModal(options) {
            const modal = document.getElementById('restore-confirm-modal');
            document.getElementById('restore-backup-name').textContent = options.backupName;
            document.getElementById('restore-confirm-school-name').textContent = options.schoolName;
            
            const inputEl = document.getElementById('restore-confirm-input');
            const cancelBtn = document.getElementById('restore-confirm-cancel-btn');
            const actionBtn = document.getElementById('restore-confirm-action-btn');

            // 1. Reset kondisi modal setiap kali dibuka
            inputEl.value = '';
            actionBtn.disabled = true;

            // 2. Buat fungsi handler untuk memeriksa input
            const inputHandler = () => {
                // Aktifkan tombol HANYA JIKA teks yang diketik sama persis dengan nama sekolah
                if (inputEl.value.trim() === options.schoolName) {
                    actionBtn.disabled = false;
                } else {
                    actionBtn.disabled = true;
                }
            };

            // 3. Buat fungsi untuk menutup modal dan membersihkan listener
            const closeModal = () => {
                modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => {
                    modal.classList.add('hidden');
                    // Hapus listener dari input agar tidak menumpuk saat modal dibuka lagi
                    inputEl.removeEventListener('input', inputHandler);
                }, 300);
            };

            // 4. Pasang listener yang diperlukan
            inputEl.addEventListener('input', inputHandler);
            cancelBtn.onclick = closeModal;
            
            // Gunakan .onclick untuk memastikan hanya ada satu aksi yang terpasang pada tombol pulihkan
            actionBtn.onclick = () => {
                closeModal(); // Tutup modal
                options.onConfirm(); // Jalankan aksi utama (restore)
            };

            // 5. Tampilkan modal
            modal.classList.remove('hidden');
            modal.querySelector('.modal-content').style.transform = 'scale(1)';
            inputEl.focus(); // Langsung fokus ke kolom input
        }

        // ===== TAMBAHKAN 3 FUNGSI BARU INI =====

        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
        /**
         * Memulai proses impersonasi saat tombol "Masuk sbg" diklik.
         */
        function handleImpersonate(targetUser) {
            showConfirmationModal({
                title: "Konfirmasi Masuk Sebagai Pengguna",
                body: `Anda akan masuk sebagai <strong>${targetUser.namaSekolah}</strong>. Anda akan dapat melihat dan mengubah data seolah-olah Anda adalah pengguna tersebut. <br><br>Anda bisa kembali ke akun Superadmin dengan mengklik banner di atas halaman. Lanjutkan?`,
                confirmText: "Ya, Lanjutkan",
                confirmColor: "bg-cyan-600 hover:bg-cyan-700",
                onConfirm: () => {
                    const overlay = document.getElementById('loading-overlay');
                    overlay.classList.remove('hidden');
                    overlay.querySelector('#overlay-title').textContent = `Beralih ke akun ${targetUser.namaSekolah}...`;

                    const adminEmail = sessionStorage.getItem('userEmail');
                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.status === 'success') {
                                const originalSession = {
                                    userEmail: sessionStorage.getItem('userEmail'),
                                    userRole: sessionStorage.getItem('userRole')
                                };
                                sessionStorage.setItem('impersonation_original_session', JSON.stringify(originalSession));

                                const impersonated = response.impersonationData;
                                sessionStorage.setItem('userEmail', impersonated.email);
                                sessionStorage.setItem('userRole', impersonated.role);
                                sessionStorage.setItem('userSpreadsheetId', impersonated.spreadsheetId);
                                
                                sessionStorage.setItem('impersonatedSchoolName', impersonated.namaSekolah);

                                // ===== INI PERBAIKANNYA =====
                                // Update juga variabel JavaScript global sebelum memuat ulang aplikasi.
                                userSpreadsheetId = impersonated.spreadsheetId; 
                                // ============================

                                initializeApp(); // Reload aplikasi sebagai pengguna baru
                            } else {
                                showGlobalStatus(response.message, false);
                            }
                            overlay.classList.add('hidden');
                        })
                        .withFailureHandler(err => {
                            overlay.classList.add('hidden');
                            showGlobalStatus(err.message, false);
                        })
                        .getImpersonationData_Superadmin(adminEmail, targetUser.row);
                }
            });
        }

        /**
         * Memeriksa apakah sedang dalam mode impersonasi dan menampilkan banner jika iya.
         */
        function checkForImpersonation() {
            const banner = document.getElementById('impersonation-exit-banner');
            const originalSession = sessionStorage.getItem('impersonation_original_session');

            if (originalSession) {
                document.getElementById('impersonated-school-name').textContent = sessionStorage.getItem('impersonatedSchoolName');
                banner.classList.remove('hidden');
                // Pindahkan #app-container ke bawah agar tidak tertutup banner
                document.getElementById('app-container').style.paddingTop = '40px'; 
                banner.onclick = exitImpersonation;
            } else {
                banner.classList.add('hidden');
                document.getElementById('app-container').style.paddingTop = '0';
                banner.onclick = null;
            }
        }

        /**
         * Keluar dari mode impersonasi dan kembali ke akun Superadmin.
         */
        function exitImpersonation() {
            const originalSessionJSON = sessionStorage.getItem('impersonation_original_session');
            if (originalSessionJSON) {
                const originalSession = JSON.parse(originalSessionJSON);
                sessionStorage.setItem('userEmail', originalSession.userEmail);
                sessionStorage.setItem('userRole', originalSession.userRole);
                
                sessionStorage.removeItem('userSpreadsheetId');
                sessionStorage.removeItem('impersonation_original_session');
                sessionStorage.removeItem('impersonatedSchoolName');
                
                initializeSuperadminApp(); // Kembali ke dashboard admin
            }
        }

        // ===== TAMBAHKAN SEMUA FUNGSI BARU INI =====

        /**
         * Memperbarui tampilan menu aksi massal (terlihat/tidak & jumlah terpilih).
         */
        function updateBulkActionBar() {
            const actionBar = document.getElementById('bulk-action-bar');
            const countSpan = document.getElementById('selected-student-count');
            const selectedCount = selectedStudentRows.size;

            if (selectedCount > 0) {
                countSpan.textContent = `${selectedCount} siswa dipilih`;
                actionBar.classList.remove('hidden');
            } else {
                actionBar.classList.add('hidden');
            }
        }

        /**
         * Memasang semua event listener yang dibutuhkan untuk checkbox di tabel siswa.
         */
        function attachTableCheckboxListeners() {
            const selectAllCheckbox = document.getElementById('select-all-students-checkbox');
            const studentCheckboxes = document.querySelectorAll('.student-checkbox');

            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    studentCheckboxes.forEach(cb => {
                        cb.checked = isChecked;
                        const rowNum = parseInt(cb.dataset.row);
                        if (isChecked) {
                            selectedStudentRows.add(rowNum);
                        } else {
                            selectedStudentRows.delete(rowNum);
                        }
                    });
                    updateBulkActionBar();
                });
            }

            studentCheckboxes.forEach(cb => {
                // Cek apakah baris ini sudah ada di set sebelumnya
                const rowNum = parseInt(cb.dataset.row);
                cb.checked = selectedStudentRows.has(rowNum);

                cb.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    if (isChecked) {
                        selectedStudentRows.add(rowNum);
                    } else {
                        selectedStudentRows.delete(rowNum);
                    }
                    // Cek apakah semua checkbox terpilih untuk update status 'select all'
                    if (!isChecked) {
                        selectAllCheckbox.checked = false;
                    } else {
                        if (studentCheckboxes.length === selectedStudentRows.size) {
                            selectAllCheckbox.checked = true;
                        }
                    }
                    updateBulkActionBar();
                });
            });

            // Pasang listener untuk tombol-tombol di menu aksi massal
            document.getElementById('bulk-delete-btn')?.addEventListener('click', handleBulkDelete);
            document.getElementById('bulk-update-tahun-lulus-btn')?.addEventListener('click', handleBulkUpdateTahunLulus);
        }

        // ===== GANTI KEDUA FUNGSI INI DENGAN VERSI FINAL =====

        /**
         * Menangani aksi klik pada tombol "Hapus Terpilih".
         */
        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
        function handleBulkDelete() {
            const selectedCount = selectedStudentRows.size;
            if (selectedCount === 0) {
                showGlobalStatus("Tidak ada siswa yang dipilih.", false);
                return;
            }

            showConfirmationModal({
                title: "Konfirmasi Hapus Massal",
                body: `Anda yakin ingin menghapus <strong>${selectedStudentRows.size} data siswa</strong> yang dipilih? Tindakan ini tidak dapat dibatalkan.`,
                confirmText: "Ya, Hapus",
                confirmColor: "bg-red-600 hover:bg-red-700",
                onConfirm: () => {
                    const overlay = document.getElementById('loading-overlay');
                    const overlayTitle = document.getElementById('overlay-title');
                    const overlaySubtitle = document.getElementById('overlay-subtitle');
                    const overlayButtonContainer = document.getElementById('overlay-button-container');

                    overlayButtonContainer.innerHTML = '';
                    overlayTitle.textContent = `Menghapus ${selectedStudentRows.size} siswa...`;
                    overlaySubtitle.textContent = "Mohon tunggu dan jangan menutup jendela ini...";
                    overlay.classList.remove('hidden');
                    
                    const rowsToDelete = Array.from(selectedStudentRows);
                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.status === 'success') {
                                overlayTitle.textContent = 'Proses Selesai';
                                overlaySubtitle.textContent = response.message + ' Klik tombol di bawah untuk melihat hasilnya.';
                                overlayButtonContainer.innerHTML = `
                                    <button id="force-refresh-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                                        Muat Ulang Data Siswa
                                    </button>
                                `;
                                // BARIS addEventListener TELAH DIHAPUS DARI SINI
                                selectedStudentRows.clear();
                                updateBulkActionBar();
                            } else {
                                overlay.classList.add('hidden');
                                showGlobalStatus(response.message, false);
                            }
                        })
                        .withFailureHandler(err => {
                            overlay.classList.add('hidden');
                            showGlobalStatus(err.message, false);
                        })
                        .bulkDeleteStudents(userSpreadsheetId, rowsToDelete);
                }
            });
        }

        /**
         * Menangani aksi klik pada tombol "Update Tahun Lulus".
         */
        // ===== GANTI FUNGSI LAMA DENGAN VERSI BARU INI =====
        function handleBulkUpdateTahunLulus() {
            const selectedCount = selectedStudentRows.size;
            if (selectedCount === 0) {
                showGlobalStatus("Tidak ada siswa yang dipilih.", false);
                return;
            }

            const tahunLulusInput = document.getElementById('bulk-tahun-lulus-input');
            const tahunLulus = tahunLulusInput.value.trim();
            if (!tahunLulus) {
                showGlobalStatus("Silakan isi kolom Tahun Lulus terlebih dahulu.", false);
                tahunLulusInput.focus();
                return;
            }

            showConfirmationModal({
                title: "Konfirmasi Update Massal",
                body: `Anda yakin ingin mengubah Tahun Lulus menjadi <strong>${document.getElementById('bulk-tahun-lulus-input').value.trim()}</strong> untuk <strong>${selectedStudentRows.size} siswa</strong> yang dipilih?`,
                confirmText: "Ya, Update",
                confirmColor: "bg-blue-600 hover:bg-blue-700",
                onConfirm: () => {
                    const overlay = document.getElementById('loading-overlay');
                    const overlayTitle = document.getElementById('overlay-title');
                    const overlaySubtitle = document.getElementById('overlay-subtitle');
                    const overlayButtonContainer = document.getElementById('overlay-button-container');

                    overlayButtonContainer.innerHTML = '';
                    overlayTitle.textContent = `Mengupdate ${selectedStudentRows.size} siswa...`;
                    overlaySubtitle.textContent = "Mohon tunggu dan jangan menutup jendela ini...";
                    overlay.classList.remove('hidden');

                    const rowsToUpdate = Array.from(selectedStudentRows);
                    const tahunLulus = document.getElementById('bulk-tahun-lulus-input').value.trim();
                    google.script.run
                        .withSuccessHandler(response => {
                            if (response.status === 'success') {
                                overlayTitle.textContent = 'Proses Selesai';
                                overlaySubtitle.textContent = response.message + ' Klik tombol di bawah untuk melihat hasilnya.';
                                overlayButtonContainer.innerHTML = `
                                    <button id="force-refresh-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg">
                                        Muat Ulang Data Siswa
                                    </button>
                                `;
                                // BARIS addEventListener TELAH DIHAPUS DARI SINI
                                selectedStudentRows.clear();
                                updateBulkActionBar();
                            } else {
                                overlay.classList.add('hidden');
                                showGlobalStatus(response.message, false);
                            }
                        })
                        .withFailureHandler(err => {
                            overlay.classList.add('hidden');
                            showGlobalStatus(err.message, false);
                        })
                        .bulkUpdateTahunLulus(userSpreadsheetId, rowsToUpdate, tahunLulus);
                }
            });
        }

        /**
         * [BARU] Memuat data untuk halaman Pengaturan.
         */
        function loadPengaturanPage() {
            const kkmInput = document.getElementById('kkmSekolah');
            kkmInput.disabled = true; // Nonaktifkan input saat memuat

            google.script.run
                .withSuccessHandler(response => {
                    if(response.status === 'success') {
                        kkmInput.value = response.kkm;
                    } else {
                        showGlobalStatus("Gagal memuat pengaturan KKM.", false);
                    }
                    kkmInput.disabled = false; // Aktifkan kembali setelah selesai
                })
                .withFailureHandler(err => {
                    showGlobalStatus("Error: " + err.message, false);
                    kkmInput.disabled = false;
                })
                .getKkm(userSpreadsheetId);
        }

        /**
         * [BARU] Helper untuk menerapkan/menghapus style KKM pada semua input dalam sebuah form.
         * Ini hanya berjalan saat form dalam mode "lihat" (terkunci).
         */
        function applyKkmStylesOnView(formElement) {
            if (!formElement) return;
            const table = formElement.querySelector('.score-table');
            if (!table) return;

            const kkmValue = parseFloat(table.dataset.kkm);
            const scoreInputs = formElement.querySelectorAll('.score-input');

            scoreInputs.forEach(input => {
                // Hapus style lama terlebih dahulu untuk mereset
                input.classList.remove('text-red-600', 'font-bold'); 
                
                const value = parseFloat(input.value);
                if (!isNaN(value) && value < kkmValue) {
                    // Tambahkan kembali style jika di bawah KKM
                    input.classList.add('text-red-600', 'font-bold');
                }
            });
        }

        /**
         * [BARU] Menampilkan modal pop-up dengan detail changelog terbaru.
         * @param {object} changelogData - Objek berisi detail versi baru dari server.
         */
        function showNewChangelogPopup(changelogData) {
            const modal = document.getElementById('changelog-popup-modal');
            if (!modal || !changelogData) return;

            // Isi konten modal
            document.getElementById('changelog-popup-version').textContent = changelogData.version;
            document.getElementById('changelog-popup-date').textContent = new Date(changelogData.releaseDate).toLocaleDateString('id-ID', { dateStyle: 'long' });
            document.getElementById('changelog-popup-list').innerHTML = changelogData.changelog.map(item => `<li>${item}</li>`).join('');

            // Tampilkan modal
            modal.classList.remove('hidden');
            setTimeout(() => modal.querySelector('.modal-content').style.transform = 'scale(1)', 10);

            // Tambahkan event listener untuk tombol tutup
            const closeBtn = document.getElementById('changelog-popup-close-btn');
            closeBtn.onclick = () => {
                // 1. Tutup modal secara visual
                modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => modal.classList.add('hidden'), 300);

                // 2. Ambil email pengguna dari session storage
                const loggedInUserEmail = sessionStorage.getItem('userEmail');
                if (!loggedInUserEmail) {
                    console.error("Tidak bisa update status changelog, email pengguna tidak ditemukan di sesi.");
                    return;
                }

                // 3. Kirim konfirmasi "sudah dilihat" ke backend DENGAN DUA PARAMETER
                google.script.run
                    .withSuccessHandler(r => console.log('Status changelog diperbarui.', r.message))
                    .withFailureHandler(e => console.error('Gagal memperbarui status changelog.', e.message))
                    .updateLastSeenChangelogVersion(loggedInUserEmail, changelogData.version); // <-- PERUBAHAN DI SINI
            };
        }

        /**
         * [BARU] Menangani klik tombol "Transkrip" untuk menampilkan modal.
         */
        function handleShowTranscript(nisn) {
            const modal = document.getElementById('transcript-modal');
            const loader = document.getElementById('transcript-loader');
            const printableArea = document.getElementById('transcript-printable-area');

            modal.classList.remove('hidden');
            loader.classList.remove('hidden');
            printableArea.classList.add('hidden');
            printableArea.innerHTML = ''; // Kosongkan konten lama

            google.script.run
                .withSuccessHandler(response => {
                    if (response.status === 'success') {
                        renderTranscriptModal(response.data);
                        loader.classList.add('hidden');
                        printableArea.classList.remove('hidden');
                    } else {
                        modal.classList.add('hidden');
                        showGlobalStatus(response.message, false);
                    }
                })
                .withFailureHandler(err => {
                    modal.classList.add('hidden');
                    showGlobalStatus(`Error: ${err.message}`, false);
                })
                .getTranscriptData(userSpreadsheetId, nisn);
        }

        /**
         * [MODIFIKASI FINAL] Merender data transkrip, dengan layout data siswa yang presisi dan anti-wrap.
         */
        function renderTranscriptModal(data) {
            const { student, school, subjects } = data;
            const printableArea = document.getElementById('transcript-printable-area');

            // Bagian untuk membuat variabel `html` tidak berubah, Anda bisa biarkan seperti adanya.
            const formatScore = (score) => { if (score === null || score === undefined || isNaN(score)) return '-'; const rounded = Math.round(score); const decimal = score.toFixed(2).replace('.', ','); return `${rounded} (${decimal})`; };
            const totalNilaiIjazah = subjects.reduce((sum, s) => sum + (s.nilaiIjazah !== null ? Math.round(s.nilaiIjazah) : 0), 0);
            const mapelCount = subjects.filter(s => s.nilaiIjazah !== null).length;
            const rataRataIjazah = mapelCount > 0 ? totalNilaiIjazah / mapelCount : 0;
            const nomorIndukGabungan = (school.nsm || '') + (student.nis || '');

            let html = `
                <div class="font-sans p-4">
                    <div class="text-center border-b-4 border-black pb-2 mb-4">
                        <h3 class="text-xl font-bold uppercase">TRANSKRIP NILAI AKHIR</h3>
                        <h4 class="text-lg font-semibold uppercase">${school.namaSekolah || 'NAMA SEKOLAH'}</h4>
                        <p class="text-xs">${school.alamat || 'Alamat Sekolah'}</p>
                    </div>
                    
                    <div class="w-full text-sm mb-4">
                        <div style="display: flex; align-items: baseline;">
                            <div style="width: 185px; display: flex; justify-content: space-between; padding-right: 0.5rem;">
                                <span class="font-medium">Nama Peserta Didik</span>
                                <span>:</span>
                            </div>
                            <div>${student.nama.toUpperCase()}</div>
                        </div>
                        <div style="display: flex; align-items: baseline;">
                            <div style="width: 185px; display: flex; justify-content: space-between; padding-right: 0.5rem;">
                                <span class="font-medium">Tempat, Tanggal Lahir</span>
                                <span>:</span>
                            </div>
                            <div>${toProperCase(student.tempatLahir)}, ${formatIndonesianDate(student.tanggalLahir)}</div>
                        </div>
                        <div style="display: flex; align-items: baseline;">
                            <div style="width: 185px; display: flex; justify-content: space-between; padding-right: 0.5rem;">
                                <span class="font-medium" style="white-space: nowrap;">Nomor Induk Siswa/NISN</span>
                                <span>:</span>
                            </div>
                            <div>${nomorIndukGabungan || '-'} / ${student.nisn}</div>
                        </div>
                    </div>

                    <table class="w-full text-sm border-collapse border border-black">
                        <thead class="bg-gray-200 font-bold">
                            <tr>
                                <th class="border border-black p-2 w-10" rowspan="2">No</th>
                                <th class="border border-black p-2 text-left" rowspan="2">Mata Pelajaran</th>
                                <th class="border border-black p-2" colspan="3">Nilai</th>
                            </tr>
                            <tr>
                                <th class="border border-black p-1 text-xs font-semibold w-32">Rata-Rata<br>Rapor</th>
                                <th class="border border-black p-1 text-xs font-semibold w-32">Ujian<br>Madrasah</th>
                                <th class="border border-black p-1 text-xs font-semibold w-32">Nilai<br>Ijazah</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${subjects.map((s, index) => `
                                <tr class="bg-white">
                                    <td class="border border-black p-2 text-center">${index + 1}</td>
                                    <td class="border border-black p-2">${s.nama}</td>
                                    <td class="border border-black p-2 text-center">${formatScore(s.nilaiRapor)}</td>
                                    <td class="border border-black p-2 text-center">${formatScore(s.nilaiUjian)}</td>
                                    <td class="border border-black p-2 text-center font-bold">${formatScore(s.nilaiIjazah)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot class="font-bold">
                            <tr>
                                <td class="border border-black p-2 text-center" colspan="4">Rata-rata Nilai Akhir Ijazah</td>
                                <td class="border border-black p-2 text-center bg-gray-200">${rataRataIjazah.toFixed(2).replace('.', ',')}</td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="mt-8 flex justify-end">
                        <div class="w-2/5 text-center text-sm">
                            <p>${school.kabupaten || 'Tempat'}, ${new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</p>
                            <p>Kepala Madrasah,</p>
                            <div class="h-20"></div>
                            <p class="font-bold underline">${school.namaKepsek || '(Nama Kepala Sekolah)'}</p>
                            <p>NIP. ${school.nipKepsek || '-'}</p>
                        </div>
                    </div>
                </div>
            `;

            printableArea.innerHTML = html;

            // --- PERUBAHAN UTAMA: Pasang listener multifungsi pada satu tombol ---
            const printBtn = document.getElementById('printTranscriptBtn');
            const newPrintBtn = printBtn.cloneNode(true);
            printBtn.parentNode.replaceChild(newPrintBtn, printBtn);

            newPrintBtn.addEventListener('click', () => {
                const deployUrl = sessionStorage.getItem('webAppUrl') || '';
                // Buat nama file dinamis berdasarkan data siswa
                const fileName = `${student.nama.toUpperCase()} - ${student.nisn} - Transkrip Nilai`;

                const printWindow = window.open('', '', 'height=800,width=800');
                
                // Gunakan 'fileName' sebagai judul dokumen
                printWindow.document.write(`<html><head><title>${fileName}</title>`);
                
                Array.from(document.styleSheets).forEach(styleSheet => { try { const cssRules = Array.from(styleSheet.cssRules).map(rule => rule.cssText).join(''); printWindow.document.write(`<style>${cssRules}</style>`); } catch (e) { if (styleSheet.href) { printWindow.document.write(`<link rel="stylesheet" href="${styleSheet.href}">`); } } });

                printWindow.document.write(`
                    <style>
                        @page { size: A4; margin: 15mm; }
                        body { margin: 0; font-family: 'Inter', sans-serif; font-size: 13px; padding-bottom: 25px; }
                        .print-footer { position: fixed; width: 95%; left: 2.5%; bottom: 5mm; display: flex; align-items: center; font-size: 9px; color: #888; }
                        .qr-code-img { width: 70px; height: 70px; margin-right: 10px; }
                        .p-2 { padding: 0.25rem 0.5rem !important; } .mb-4 { margin-bottom: 0.75rem !important; } .mt-8 { margin-top: 1.25rem !important; } .h-20 { height: 3.5rem !important; }
                    </style>
                `);
                
                printWindow.document.write('</head><body style="position: relative;">');
                printWindow.document.write(printableArea.innerHTML);
                
                if (deployUrl) {
                    const encodedUrl = encodeURIComponent(deployUrl);
                    // [DIUBAH] Perbesar ukuran gambar dan sederhanakan polanya (ecc=L)
                    const qrCodeApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=85x85&data=${encodedUrl}&ecc=L`;

                    printWindow.document.write(`
                        <div class="print-footer">
                            <img id="print-qr-code" src="${qrCodeApiUrl}" alt="QR Code Link Aplikasi" class="qr-code-img" />
                            <span>Scan untuk validasi online</span>
                        </div>
                    `);
                }
                
                printWindow.document.write('</body></html>');
                printWindow.document.close();

                const qrImage = printWindow.document.getElementById('print-qr-code');
                if (qrImage) {
                    let printTriggered = false;
                    const triggerPrint = () => {
                        if (!printTriggered) {
                            printTriggered = true;
                            printWindow.focus();
                            printWindow.print();
                            printWindow.close();
                        }
                    };
                    qrImage.onload = triggerPrint;
                    qrImage.onerror = () => { setTimeout(triggerPrint, 500); };
                    setTimeout(triggerPrint, 3000);
                } else {
                    setTimeout(() => { printWindow.focus(); printWindow.print(); printWindow.close(); }, 500);
                }
            });
        }
    </script>
</body>
</html>
