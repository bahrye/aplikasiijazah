<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link rel="icon" type="image/png" sizes="32x32" href="https://uploadimage.io/images/2025/06/12/appbySyamsulBahri.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .nav-link { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; border-left: 4px solid transparent; }
        .nav-link.active { background-color: #3b82f6; color: white; border-left-color: #facc15; }
        .nav-link:hover { background-color: #2563eb; color: white; }
        .content-page, #login-container, #signup-container { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content { 
            transition: transform 0.3s ease-in-out;
            display: flex; /* Tambahkan ini */
            flex-direction: column; /* Tambahkan ini */
            max-height: 90vh; /* Tambahkan ini: Batasi tinggi modal maksimal 90% dari tinggi layar */
        }
        .score-input { width: 60px; text-align: center; }
        .total-cell { font-weight: bold; }
        .rekap-table th, .rekap-table td { padding: 8px 12px; border: 1px solid #e5e7eb; }
        .rekap-btn.active {
            background-color: #2563eb;
            color: white;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }
        .gradient-bg {
            background-color: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, rgb(243, 244, 246) 0px, transparent 50%),
                radial-gradient(at 95% 20%, rgb(229, 231, 235) 0px, transparent 50%),
                radial-gradient(at 20% 90%, rgb(209, 213, 219) 0px, transparent 50%);
        }
        /* Animasi untuk titik-titik loading */
        .loading-animation::after {
            display: inline-block;
            animation: loading-dots 1.4s infinite;
            content: '.';
            width: 1em;
            text-align: left;
        }
        @keyframes loading-dots {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        .nama-siswa-cell {
            text-align: left;
        }
        /* CSS untuk Notifikasi Pop-up di Atas Tengah */
        #globalStatusMessage {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            width: 90%;
            max-width: 500px;
            pointer-events: none; /* Agar tidak menghalangi klik */
        }

        .toast-notification {
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: white;
            font-weight: 500;
            text-align: center;
            animation: fadeInOut 4s ease-in-out forwards;
            opacity: 0;
            pointer-events: auto; /* Aktifkan kembali pointer */
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(-20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
        }

        /* ===== [TAMBAHAN] KODE CSS UNTUK SCROLLBAR KUSTOM ===== */

        /* Untuk browser berbasis WebKit (Chrome, Safari, Edge) */
        .custom-scrollbar::-webkit-scrollbar {
          width: 8px; /* Lebar scrollbar */
        }

        .custom-scrollbar::-webkit-scrollbar-track {
          background: #1e3a8a; /* Warna track, sedikit lebih gelap dari sidebar */
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
          background-color: #3b82f6; /* Warna utama scrollbar (biru) */
          border-radius: 10px; /* Membuat ujungnya bulat */
          border: 2px solid #1e3a8a; /* Memberi sedikit jarak dari track */
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
          background-color: #2563eb; /* Warna saat mouse di atasnya */
        }

        /* Untuk Firefox */
        .custom-scrollbar {
          scrollbar-width: thin;
          scrollbar-color: #3b82f6 #1e3a8a; /* Format: warna thumb, warna track */
        }

        /* Letakkan ini di dalam tag <style> */

        .shepherd-custom-theme {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            max-width: 350px;
        }

        .shepherd-custom-theme .shepherd-header {
            background: #1e3a8a !important; /* Biru Tua - INI PERUBAHANNYA */
            padding: 1rem 1.5rem;
        }

        .shepherd-custom-theme .shepherd-title {
            color: #ffffff;
            font-weight: 700;
            font-size: 1.125rem;
        }

        .shepherd-custom-theme .shepherd-cancel-icon {
            color: #ffffff;
            opacity: 0.75;
        }
        .shepherd-custom-theme .shepherd-cancel-icon:hover {
            opacity: 1;
        }

        .shepherd-custom-theme .shepherd-text {
            padding: 1.5rem;
            color: #374151; /* Abu-abu gelap */
            line-height: 1.6;
        }

        .shepherd-custom-theme .shepherd-footer {
            padding: 0 1.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shepherd-custom-theme .shepherd-button {
            background: #3b82f6; /* Biru */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .shepherd-custom-theme .shepherd-button:not(.shepherd-button-secondary):hover {
            background: #2563eb;
        }

        .shepherd-custom-theme .shepherd-button.shepherd-button-secondary {
            background: #e5e7eb; /* Abu-abu terang */
            color: #374151;
        }

        .shepherd-custom-theme .shepherd-button.shepherd-button-secondary:hover {
            background: #d1d5db;
        }

        /* Styling untuk checkbox "Jangan tampilkan lagi" */
        .shepherd-dont-show-again {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            font-size: 0.875rem;
            color: #4b5563;
        }

        .shepherd-dont-show-again input {
            margin-right: 0.5rem;
            height: 1rem;
            width: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Auth Container -->
    <div id="auth-wrapper" class="gradient-bg flex flex-col min-h-screen">
        <div class="flex-grow flex items-center justify-center py-8 px-4">
            <div class="w-full max-w-md">
                <!-- Container untuk Login -->
                <div id="login-container">
                    <div class="bg-white rounded-2xl shadow-xl p-8 md:p-10">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Login Aplikasi<br>Pengolahan Nilai Ijazah</h1>
                            <p class="text-gray-500 mt-2">Silakan masuk untuk melanjutkan</p>
                        </div>
                        <div id="login-info-message" class="mb-4 text-center text-sm"></div>
                        <form id="loginForm">
                            <div class="space-y-6">
                                <div>
                                    <label for="email" class="text-sm font-medium text-gray-700 block mb-2">Alamat Email</label>
                                    <input type="email" name="email" id="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="nama@email.com" required>
                                </div>
                                <div>
                                    <label for="password" class="text-sm font-medium text-gray-700 block mb-2">Kata Sandi</label>
                                    <div class="relative">
                                        <input type="password" name="password" id="password" class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="••••••••" required>
                                        <button type="button" data-toggle-password="password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                            <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                            <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <button type="submit" id="loginButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 shadow-lg">
                                        <span id="loginButtonText">Masuk</span>
                                        <span id="loginSpinner" class="hidden loading-animation">Memproses</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                        <div id="login-error-message" class="mt-4 text-center text-red-600 text-sm h-4"></div>
                        <div class="text-center text-sm mt-4">
                            <a href="#" id="forgot-password-link" class="text-gray-500 hover:text-blue-600">Lupa Password?</a>
                        </div>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            Belum punya akun? 
                            <a href="#" id="show-signup" class="font-medium text-blue-600 hover:text-blue-500">Daftar sekarang</a>
                        </p>
                    </div>
                </div>

                <!-- Container untuk Signup (awalnya disembunyikan) -->
                <div id="signup-container" class="hidden">
                    <div class="bg-white rounded-2xl shadow-xl p-8 md:p-10">
                        <div class="text-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Buat Akun Sekolah</h1>
                            <p class="text-gray-500 mt-2">Isi form di bawah untuk mendaftar.</p>
                        </div>
                        <form id="signupForm">
                             <div id="signup-message" class="mb-4 text-center text-sm h-auto"></div>
                            <div class="space-y-4">
                                <div id="initial-fields" class="space-y-4">
                                    <div>
                                        <label for="signup-namasekolah" class="text-sm font-medium text-gray-700 block mb-2">Nama Sekolah</label>
                                        <input type="text" id="signup-namasekolah" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Contoh: MI Al-Hidayah" required>
                                    </div>
                                    <div>
                                      <label for="signup-jenjang" class="text-sm font-medium text-gray-700 block mb-2">Jenjang Sekolah</label>
                                      <select id="signup-jenjang" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white" required>
                                        <option value="" disabled selected>-- Pilih Jenjang --</option>
                                        <option value="MI">MI (Madrasah Ibtidaiyah)</option>
                                        <option value="MTS">MTS (Madrasah Tsanawiyah)</option>
                                        <option value="MA">MA (Madrasah Aliyah)</option>
                                      </select>
                                    </div>
                                    <div>
                                        <label for="signup-email" class="text-sm font-medium text-gray-700 block mb-2">Alamat Email</label>
                                        <input type="email" id="signup-email" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="nama@email.com" required>
                                    </div>
                                    <div>
                                        <label for="signup-password" class="text-sm font-medium text-gray-700 block mb-2">Kata Sandi</label>
                                        <div class="relative">
                                            <input type="password" id="signup-password" class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg shadow-sm" placeholder="••••••••" required>
                                            <button type="button" data-toggle-password="signup-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                            </button>
                                        </div>
                                        <div id="signup-password-req" class="text-xs space-y-1 mt-2"></div>
                                    </div>
                                    <div>
                                        <label for="confirm-password" class="text-sm font-medium text-gray-700 block mb-2">Konfirmasi Kata Sandi</label>
                                        <div class="relative">
                                            <input type="password" id="confirm-password" class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg shadow-sm" placeholder="••••••••" required>
                                            <button type="button" data-toggle-password="confirm-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                            </button>
                                        </div>
                                        <div id="signup-confirm-msg" class="text-red-600 text-xs mt-1 h-4 font-medium"></div>
                                    </div>
                                    <div class="pt-2">
                                        <button type="button" id="requestOtpButton" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 shadow-lg">
                                            <span id="requestOtpButtonText">Kirim Kode Verifikasi</span>
                                            <span id="requestOtpSpinner" class="hidden loading-animation">Mengirim</span>
                                        </button>
                                    </div>
                                </div>
                                <div id="otp-section" class="hidden">
                                    <label for="signup-otp" class="text-sm font-medium text-gray-700 block mb-2">Kode OTP</label>
                                    <input type="text" id="signup-otp" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Masukkan 6 digit kode dari email" required>
                                </div>
                                <div id="final-signup-button-container" class="hidden">
                                    <button type="submit" id="signupButton" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 shadow-lg">
                                        <span id="signupButtonText">Daftar</span>
                                        <span id="signupSpinner" class="hidden loading-animation">Memproses</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            Sudah punya akun? 
                            <a href="#" id="show-login" class="font-medium text-blue-600 hover:text-blue-500">Masuk di sini</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <footer class="text-center py-4">
            <a href="https://wa.me/qr/FMVS3NLDIRUAA1" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-500 hover:text-blue-600 transition-colors">
              &copy; <span id="currentYearAuth"></span> Created by Syamsul Bahri
            </a>
        </footer>
    </div>

    <!-- Container untuk Aplikasi Utama (awalnya disembunyikan) -->
    <div id="app-container" class="hidden">
        <div class="flex h-screen">
            <aside class="w-64 bg-blue-800 text-white flex flex-col">
                <div class="h-16 flex items-center justify-center text-xl font-bold border-b border-blue-700 text-center px-2 pt-4"><span id="school-name-sidebar">SYAMSUL BAHRI</span></div>
                <nav class="flex-1 px-4 py-4 space-y-2 overflow-y-auto custom-scrollbar">
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md active" data-page="dashboard"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg><span>Dashboard</span></a>
                    <div class="border-t border-blue-700 my-2"></div>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="data-sekolah"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg><span>Data Sekolah</span></a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="data-siswa">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <span>Data Siswa</span>
                    </a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="mapel">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                        </svg>
                        <span>Mapel & Bobot</span>
                    </a>
                    <div class="border-t border-blue-700 my-2"></div>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="input-ujian">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        <span>Input Nilai Ujian</span>
                    </a>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="input-rapor"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span>Input Nilai Rapor</span></a>
                    <div class="border-t border-blue-700 my-2"></div>
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="rekapitulasi"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><span>Rekapitulasi</span></a>
                </nav>
                <div class="mt-auto p-4 border-t border-blue-700">
                    <a href="#" class="nav-link flex items-center space-x-3 p-2 rounded-md" data-page="ubah-password">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 7a4 4 0 11-8 0 4 4 0 018 0zM9 15h6" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                        <span>Ubah Password</span>
                    </a>
                     <a href="#" id="logoutButton" class="nav-link flex items-center space-x-3 p-2 rounded-md"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg><span>Logout</span></a>
                </div>
            </aside>

            <main class="flex-1 p-6 md:p-10 overflow-y-auto flex flex-col">
                <div class="flex-grow">
                    <div id="page-dashboard" class="content-page">
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Dashboard</h1>
                        <p class="text-gray-600 mb-8">Ringkasan data akademik sekolah Anda.</p>
                        
                        <!-- Kartu Statistik -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                            <!-- Kartu Siswa (dapat diklik) -->
                            <div id="student-card" class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 cursor-pointer">
                                <div class="bg-blue-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Jumlah Siswa</p>
                                    <p id="studentCount" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                            <!-- Kartu Mapel (dapat diklik) -->
                            <div id="mapel-card" class="bg-white p-6 rounded-2xl shadow-lg flex items-center space-x-4 transition-transform transform hover:scale-105 cursor-pointer">
                                <div class="bg-green-100 p-4 rounded-full">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Jumlah Mata Pelajaran</p>
                                    <p id="mapelCount" class="text-3xl font-bold text-gray-800">0</p>
                                </div>
                            </div>
                        </div>

                        <!-- Grafik -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">Distribusi Jenis Ujian Mata Pelajaran</h2>
                            <div class="h-80">
                                <canvas id="mapelChart"></canvas>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-6 mt-8">
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Rata-rata Nilai Ujian per Mapel</h2>
                                <div class="h-96">
                                    <canvas id="ujianAverageChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Rata-rata Nilai Rapor per Mapel</h2>
                                <div class="h-96">
                                    <canvas id="raporAverageChart"></canvas>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Rata-rata Nilai Ijazah per Mapel</h2>
                                <div class="h-96">
                                    <canvas id="ijazahAverageChart"></canvas>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <div class="mb-4">
                                    <h2 class="text-xl font-bold text-gray-800">Distribusi Rata-rata Nilai Ujian Siswa</h2>
                                    <p class="text-sm text-gray-500">(Silahkan Perbarui Rekapitulasi Untuk Mendapatkan Grafik Terbaru)</p>
                                </div>
                                <div id="examScoreScrollContainer" class="h-96 w-full" style="overflow-x: auto; overflow-y: hidden;">
                                    <div id="examScoreChartWrapper" style="position: relative; height: 100%;">
                                        <canvas id="examScoreDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-2xl shadow-lg">
                                <div class="mb-4">
                                    <h2 class="text-xl font-bold text-gray-800">Peringkat Siswa Berdasarkan Rata-rata Nilai Ijazah</h2>
                                    <p class="text-sm text-gray-500">(Silahkan Perbarui Rekapitulasi Untuk Mendapatkan Grafik Terbaru)</p>
                                </div>
                                <div id="ijazahRankingScrollContainer" class="h-96 w-full" style="overflow-x: auto; overflow-y: hidden;">
                                    <div id="ijazahRankingChartWrapper" style="position: relative; height: 100%;">
                                        <canvas id="ijazahRankingChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="page-data-sekolah" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Data Sekolah</h1>
                        <p class="mt-2 text-gray-600 mb-8">Gunakan formulir ini untuk mengisi atau memperbarui informasi detail mengenai sekolah Anda.</p>
                        <div class="bg-white p-8 rounded-lg shadow-md max-w-4xl">
                            <form id="schoolDataForm">
                                <div class="mb-6 pb-6 border-b">
                                <label for="jenjang" class="block text-sm font-medium text-gray-700">Jenjang Sekolah</label>
                                <select id="jenjang" name="jenjang" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" disabled>
                                    <option value="">-- Pilih Jenjang --</option>
                                    <option value="MI">MI (Madrasah Ibtidaiyah)</option>
                                    <option value="MTS">MTS (Madrasah Tsanawiyah)</option>
                                    <option value="MA">MA (Madrasah Aliyah)</option>
                                </select>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                    <div>
                                        <label for="namaSekolah" class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                                        <input type="text" id="namaSekolah" name="namaSekolah" class="mt-1 w-full px-3 py-2 border border-gray-300 bg-gray-100 rounded-md shadow-sm" readonly>
                                        <label for="npsn" class="block text-sm font-medium text-gray-700 mt-4">NPSN</label>
                                        <input type="text" id="npsn" name="npsn" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="nsm" class="block text-sm font-medium text-gray-700 mt-4">NSM (Nomor Statistik Madrasah)</label>
                                        <input type="text" id="nsm" name="nsm" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="alamat" class="block text-sm font-medium text-gray-700 mt-4">Alamat Jalan</label>
                                        <textarea id="alamat" name="alamat" rows="3" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                                        <label for="kelurahan" class="block text-sm font-medium text-gray-700 mt-4">Kelurahan/Desa</label>
                                        <input type="text" id="kelurahan" name="kelurahan" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="kecamatan" class="block text-sm font-medium text-gray-700 mt-4">Kecamatan</label>
                                        <input type="text" id="kecamatan" name="kecamatan" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label for="kabupaten" class="block text-sm font-medium text-gray-700">Kabupaten/Kota</label>
                                        <input type="text" id="kabupaten" name="kabupaten" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="provinsi" class="block text-sm font-medium text-gray-700 mt-4">Provinsi</label>
                                        <input type="text" id="provinsi" name="provinsi" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="kodePos" class="block text-sm font-medium text-gray-700 mt-4">Kode Pos</label>
                                        <input type="text" id="kodePos" name="kodePos" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="telepon" class="block text-sm font-medium text-gray-700 mt-4">Nomor Telepon</label>
                                        <input type="tel" id="telepon" name="telepon" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="email-sekolah" class="block text-sm font-medium text-gray-700 mt-4">Email</label>
                                        <input type="email" id="email-sekolah" name="email" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        <label for="website" class="block text-sm font-medium text-gray-700 mt-4">Website</label>
                                        <input type="url" id="website" name="website" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                                <div class="mt-8 border-t pt-6">
                                    <h2 class="text-lg font-medium text-gray-900">Data Kepala Sekolah</h2>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mt-4">
                                        <div>
                                            <label for="namaKepsek" class="block text-sm font-medium text-gray-700">Nama Kepala Sekolah</label>
                                            <input type="text" id="namaKepsek" name="namaKepsek" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label for="nipKepsek" class="block text-sm font-medium text-gray-700">NIP Kepala Sekolah (Jika ada)</label>
                                            <input type="text" id="nipKepsek" name="nipKepsek" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-8 pt-5 border-t">
                                    <button type="submit" id="schoolSubmitBtn" class="w-full md:w-auto flex justify-center py-2 px-8 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                                        <span id="schoolSubmitBtnText">Simpan Data Sekolah</span>
                                        <span id="schoolLoadingSpinner" class="hidden loading-animation">Menyimpan</span>
                                    </button>
                                </div>
                            </form>
                            <div id="schoolStatusMessage" class="mt-6 p-4 rounded-md text-center opacity-0 transition-opacity"></div>
                        </div>
                    </div>
                    
                    <div id="page-data-siswa" class="content-page hidden">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800">Manajemen Data Siswa</h1>
                                <p class="mt-2 text-gray-600">Tambah, lihat, edit, atau hapus data siswa di sekolah Anda.</p>
                            </div>
                            <div class="flex space-x-2">
                                <button id="checkCompletenessBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors">Cek Kelengkapan Data</button>
                                <button id="addStudentBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors">+ Tambah Siswa</button>
                                <button id="deleteAllStudentsBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-md text-sm transition-colors">Hapus Semua Siswa</button>
                            </div>
                        </div>
                        <div class="mt-8 border-t pt-6">
                            <h2 class="text-xl font-bold text-gray-800">Import Data Siswa</h2>
                            <p class="mt-1 text-gray-600">Unggah data siswa secara massal menggunakan template Excel.</p>
                            <div class="mt-4 flex flex-wrap items-center gap-4">
                                <button id="downloadTemplateBtn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Download Template</button>
                                <input type="file" id="siswaFileInput" class="hidden" accept=".xlsx, .xls, .csv">
                                <label for="siswaFileInput" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg cursor-pointer hover:bg-green-700">Pilih File...</label>
                                <span id="fileName" class="text-gray-500">Tidak ada file dipilih</span>
                                <button id="importSiswaBtn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Import Data</button>
                            </div>
                            <div id="importStatus" class="mt-4"></div>
                        </div>
                        <div class="mt-8 pt-6 border-t">
                            <label for="searchSiswaInput" class="block text-sm font-medium text-gray-700">Cari Siswa (berdasarkan Nama atau NISN)</label>
                            <div class="relative mt-1 rounded-md shadow-sm">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <input type="text" id="searchSiswaInput" class="block w-full rounded-md border-gray-300 pl-10 py-2 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ketik untuk mencari...">
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-md mt-8">
                            <div id="siswaTableContainer" class="overflow-x-auto"></div>
                        </div>
                    </div>
                    
                    <div id="page-mapel" class="content-page hidden">
                        <div class="mb-10">
                            <h2 class="text-2xl font-bold text-gray-800">Pengaturan Bobot Nilai</h2>
                            <p class="mt-1 text-gray-600">Atur persentase bobot antara nilai ujian dan nilai rapor. Total keduanya harus 100%.</p>
                            <div class="mt-4 bg-white p-6 rounded-lg shadow-md max-w-xl">
                                <form id="bobotForm">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
                                        <div>
                                            <label for="bobotUjian" class="block text-sm font-medium text-gray-700">Bobot Nilai Ujian</label>
                                            <div class="mt-1 relative rounded-md shadow-sm">
                                                <input type="number" id="bobotUjian" name="bobotUjian" min="0" max="100" class="w-full p-2 pr-8 border rounded-md" required>
                                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><span class="text-gray-500 sm:text-sm">%</span></div>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="bobotRapor" class="block text-sm font-medium text-gray-700">Bobot Nilai Rapor</label>
                                            <div class="mt-1 relative rounded-md shadow-sm">
                                                <input type="number" id="bobotRapor" name="bobotRapor" min="0" max="100" class="w-full p-2 pr-8 border rounded-md" required>
                                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3"><span class="text-gray-500 sm:text-sm">%</span></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-6 pt-4 border-t">
                                        <button type="submit" id="saveBobotBtn" class="bg-blue-600 text-white font-medium py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400">Simpan Bobot</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="mb-10 border-t pt-8">
                            <h2 class="text-xl font-bold text-gray-800">Opsi Impor & Manajemen Data</h2>
                            <p class="mt-1 text-gray-600">Gunakan opsi di bawah untuk mengelola data mata pelajaran secara massal.</p>
                            
                            <!-- Area Import -->
                            <div class="mt-6 p-6 bg-white rounded-lg shadow-md">
                                <h3 class="font-semibold text-lg text-gray-800 mb-4">Impor Data Mata Pelajaran</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="border p-4 rounded-lg md:col-span-2">
                                        <h4 class="font-medium text-gray-700">Otomatis dari Sistem</h4>
                                        <p class="text-sm text-gray-500 mb-3">Impor daftar mata pelajaran standar sesuai dengan jenjang sekolah Anda (MI, MTS, atau MA). Kode mata pelajaran yang sudah ada akan dilewati secara otomatis.</p>
                                        <button id="importMapelSystemBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 w-full flex items-center justify-center disabled:bg-blue-400">
                                        <span id="importMapelSystemBtnText">Import Mapel by System</span>
                                        <span id="importMapelSystemSpinner" class="hidden loading-animation">Mengimpor</span>
                                        </button>
                                    </div>
                                </div>
                                <div id="importMapelStatus" class="mt-4"></div>
                            </div>

                            <!-- Area Manajemen -->
                            <div class="mt-6 flex justify-between items-center bg-white p-6 rounded-lg shadow-md">
                                <div>
                                    <h3 class="font-semibold text-lg text-gray-800">Manajemen Data</h3>
                                    <p class="text-sm text-gray-500">Tambah manual atau hapus semua data mapel.</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button id="addMapelBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">+ Tambah Mapel</button>
                                    <button id="deleteAllMapelBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors">Hapus Semua Mapel</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabel Mapel -->
                        <div class="mt-8">
                            <h2 class="text-2xl font-bold text-gray-800">Daftar Mata Pelajaran Saat Ini</h2>
                            <div class="bg-white p-4 rounded-lg shadow-md mt-4">
                                <div id="mapelTableContainer" class="overflow-x-auto"></div>
                            </div>
                        </div>
                    </div>

                    
                    <div id="page-input-ujian" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Input Nilai Ujian</h1>
                        <p class="mt-2 text-gray-600 mb-8">Pilih jenis ujian yang akan diinput nilainya atau cek rata-rata.</p>
                        <div class="flex flex-wrap items-center gap-3 mb-8">
                            <button id="btn-show-ujian-madrasah" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm">Input Nilai Ujian Madrasah</button>
                            <button id="btn-show-ujian-praktek" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors text-sm">Input Nilai Ujian Praktek</button>
                            <button id="btn-cek-rata-ujian" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">Cek Rata-Rata Nilai Ujian</button>
                            <button id="deleteAllUjianScoresBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors text-sm">Hapus Semua Nilai Ujian</button>
                        </div>
                        <div id="input-ujian-container"></div>
                    </div>
        
                    <div id="page-input-rapor" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Input Nilai Rapor</h1>
                        <div id="rapor-container" class="mt-4"></div>
                    </div>
                    <div id="page-rekapitulasi" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Rekapitulasi Nilai Akhir</h1>
                        <p class="mt-2 text-gray-600 mb-8">Lihat ringkasan nilai ujian, rapor, dan nilai akhir ijazah.</p>
                        
                        <div id="rekap-loader" class="text-center p-8">
                            <p class="font-bold loading-animation">Mengumpulkan dan memproses semua data nilai</p>
                            <p>Silakan tunggu, ini mungkin memakan waktu beberapa saat.</p>
                        </div>
                        
                        <div id="rekap-content" class="hidden">
                            <div class="flex space-x-4 mb-8 border-b pb-4">
                                <button data-rekap="ujian" class="rekap-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Rekap Nilai Ujian</button>
                                <button data-rekap="rapor" class="rekap-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Rekap Nilai Rapor</button>
                                <button data-rekap="ijazah" class="rekap-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">Rekap Nilai Ijazah</button>
                                <button id="updateRekapBtn" class="ml-auto bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center justify-center disabled:bg-green-400">
                                    <span id="updateRekapBtnText">Perbarui & Muat Ulang Data</span>
                                    <span id="updateRekapSpinner" class="hidden loading-animation">Memperbarui</span>
                                </button>
                            </div>
                            <div id="rekap-display-area">
                            </div>
                        </div>
        
                        <div id="rekap-setup" class="hidden text-center p-8 bg-yellow-100 rounded-lg">
                            <p class="font-bold text-yellow-800">Sheet Rekapitulasi belum dibuat.</p>
                            <p class="text-yellow-700 mt-2">Silakan klik tombol di bawah untuk membuat sheet yang diperlukan untuk menampilkan data rekapitulasi.</p>
                            <button id="createRekapSheetsBtn" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Buat Sheet Rekapitulasi</button>
                        </div>
                    </div>

                    <div id="page-ubah-password" class="content-page hidden">
                        <h1 class="text-3xl font-bold text-gray-800">Ubah Password Akun</h1>
                        <p class="mt-2 text-gray-600 mb-8">Gunakan formulir ini untuk mengubah password Anda.</p>
                        <div class="bg-white p-8 rounded-lg shadow-md max-w-lg">
                            <form id="changePasswordForm">
                                <div class="space-y-6">
                                    <div>
                                        <label for="current-password" class="block text-sm font-medium text-gray-700">Password Saat Ini</label>
                                        <div class="relative mt-1">
                                            <input type="password" id="current-password" class="w-full p-2 pr-10 border rounded-md" required>
                                            <button type="button" data-toggle-password="current-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="new-password-change" class="block text-sm font-medium text-gray-700">Password Baru</label>
                                        <div class="relative mt-1">
                                            <input type="password" id="new-password-change" class="w-full p-2 pr-10 border rounded-md" required>
                                            <button type="button" data-toggle-password="new-password-change" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                            </button>
                                        </div>
                                        <div id="change-password-req" class="text-xs space-y-1 mt-2"></div>
                                    </div>
                                    <div>
                                        <label for="confirm-password-change" class="block text-sm font-medium text-gray-700">Konfirmasi Password Baru</label>
                                        <div class="relative mt-1">
                                            <input type="password" id="confirm-password-change" class="w-full p-2 pr-10 border rounded-md" required>
                                            <button type="button" data-toggle-password="confirm-password-change" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                            </button>
                                        </div>
                                        <div id="change-confirm-msg" class="text-red-600 text-xs mt-1 h-4 font-medium"></div>
                                    </div>
                                </div>
                                <div class="mt-8 pt-5 border-t">
                                    <button type="submit" id="changePasswordBtn" class="w-full flex justify-center py-2 px-8 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                                        <span id="changePasswordBtnText">Ubah Password</span>
                                        <span id="changePasswordSpinner" class="hidden loading-animation">Menyimpan</span>
                                    </button>
                                </div>
                            </form>
                            <div id="changePasswordStatusMessage" class="mt-6 text-center"></div>
                        </div>
                    </div>
                </div>
                <footer class="text-center py-4 mt-8 border-t">
                    <a href="https://wa.me/qr/FMVS3NLDIRUAA1" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-500 hover:text-blue-600 transition-colors">
                      &copy; <span id="currentYearApp"></span> Created by Syamsul Bahri
                    </a>
                </footer>
            </main>
        </div>
    </div>
    
    <div id="siswa-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95 flex flex-col max-h-[90vh]">
          
            <div class="flex-shrink-0 flex justify-between items-center border-b pb-3 mb-5 px-6 pt-6">
                <h2 id="siswa-modal-title" class="text-2xl font-bold text-gray-800">Tambah Siswa Baru</h2>
                <button id="closeSiswaModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>

            <form id="siswaForm" class="flex flex-col flex-grow min-h-0">

                <div class="flex-grow overflow-y-auto px-6">
                    <input type="hidden" id="studentRow" name="studentRow">

                    <div class="space-y-4">
                        <div>
                            <label for="nama" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                            <input type="text" id="nama" name="nama" class="mt-1 w-full p-2 border rounded-md" required>
                        </div>

                        <div>
                            <label for="nisn" class="block text-sm font-medium text-gray-700">NISN</label>
                            <input type="text" id="nisn" name="nisn" class="mt-1 w-full p-2 border rounded-md" required>
                        </div>
                        
                        <div>
                            <label for="nis" class="block text-sm font-medium text-gray-700">
                                NIS 
                                <span class="text-xs text-gray-500">(2 digit thn masuk, 4 digit no. urut)</span>
                            </label>
                            <input type="text" id="nis" name="nis" class="mt-1 w-full p-2 border rounded-md" placeholder="Contoh: 210001">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="jenisKelamin" class="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
                                <select id="jenisKelamin" name="jenisKelamin" class="mt-1 w-full p-2 border rounded-md bg-white" required>
                                    <option value="" disabled selected>-- Pilih --</option>
                                    <option value="L">Laki-laki</option>
                                    <option value="P">Perempuan</option>
                                </select>
                            </div>
                            <div>
                                <label for="tempatLahir" class="block text-sm font-medium text-gray-700">Tempat Lahir</label>
                                <input type="text" id="tempatLahir" name="tempatLahir" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                        </div>
                        
                        <div>
                            <label for="tanggalLahir" class="block text-sm font-medium text-gray-700">Tanggal Lahir</label>
                            <input type="date" id="tanggalLahir" name="tanggalLahir" class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        
                        <div>
                            <label for="alamatSiswa" class="block text-sm font-medium text-gray-700">Alamat Lengkap Siswa</label>
                            <textarea id="alamatSiswa" name="alamat" rows="3" class="mt-1 w-full p-2 border rounded-md"></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="teleponSiswa" class="block text-sm font-medium text-gray-700">Nomor Telepon</label>
                                <input type="tel" id="teleponSiswa" name="telepon" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="emailSiswa" class="block text-sm font-medium text-gray-700">Email Siswa</label>
                                <input type="email" id="emailSiswa" name="emailSiswa" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="tahunMasuk" class="block text-sm font-medium text-gray-700">Tahun Masuk</label>
                                <input type="number" id="tahunMasuk" name="tahunMasuk" placeholder="Contoh: 2021" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="tahunLulus" class="block text-sm font-medium text-gray-700">Tahun Lulus</label>
                                <input type="number" id="tahunLulus" name="tahunLulus" placeholder="Contoh: 2024" class="mt-1 w-full p-2 border rounded-md">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 mt-auto pt-4 border-t flex justify-end px-6 pb-6">
                    <button type="button" id="cancelSiswaBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md mr-3 hover:bg-gray-300">Batal</button>
                    <button type="submit" id="saveSiswaBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="mapel-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl transform scale-95 flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0 flex justify-between items-center border-b p-6">
                <h2 id="mapel-modal-title" class="text-2xl font-bold text-gray-800">Tambah Mata Pelajaran Massal</h2>
                <button id="closeMapelModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-6">
                <p class="text-sm text-gray-600 mb-4">Masukkan data untuk satu atau beberapa mata pelajaran di bawah. Klik "+ Tambah Baris" untuk menambahkan lebih banyak.</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-100 text-sm">
                            <tr>
                                <th class="p-2 text-left w-1/5">Kode Mapel</th>
                                <th class="p-2 text-left w-2/5">Nama Mata Pelajaran</th>
                                <th class="p-2 text-left w-1/5">Kelompok</th>
                                <th class="p-2 text-left w-1/5">Jenis Ujian</th>
                                <th class="p-2 w-12">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="mapel-input-tbody">
                            </tbody>
                    </table>
                </div>
                <button type="button" id="addMapelRowBtn" class="mt-4 bg-gray-200 text-gray-700 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg text-sm">
                    + Tambah Baris
                </button>
            </div>

            <div class="flex-shrink-0 mt-auto p-6 border-t flex justify-end">
                <button type="button" id="cancelMapelBtn" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-md mr-3 hover:bg-gray-400">Batal</button>
                <button type="button" id="saveAllMapelBtn" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">
                    <span id="saveAllMapelBtnText">Simpan Semua</span>
                    <span id="saveAllMapelSpinner" class="hidden loading-animation">Menyimpan</span>
                </button>
            </div>

        </div>
    </div>

    <div id="export-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl transform scale-95 flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0 flex justify-between items-center border-b p-6">
                <h2 class="text-2xl font-bold text-gray-800">Input Data untuk Ekspor</h2>
                <button id="closeExportModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>

            <form id="exportForm" class="flex-grow contents">
                
                <div class="flex-grow overflow-y-auto p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div>
                            <label for="exportNamaSekolah" class="block text-sm font-medium text-gray-700">Nama Sekolah</label>
                            <input type="text" id="exportNamaSekolah" class="mt-1 w-full p-2 border bg-gray-100 rounded-md" readonly>
                            
                            <label for="exportTahunAjaran" class="block text-sm font-medium text-gray-700 mt-4">Tahun Ajaran</label>
                            <select id="exportTahunAjaran" class="mt-1 w-full p-2 border rounded-md bg-white"></select>
                            
                            <label for="exportTempatTTD" class="block text-sm font-medium text-gray-700 mt-4">Tempat Tanda Tangan</label>
                            <input type="text" id="exportTempatTTD" placeholder="Contoh: Bulukumba" class="mt-1 w-full p-2 border rounded-md">

                            <label for="exportTanggalTTD" class="block text-sm font-medium text-gray-700 mt-4">Tanggal Tanda Tangan</label>
                            <input type="date" id="exportTanggalTTD" class="mt-1 w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="exportTipeKamad" class="block text-sm font-medium text-gray-700">Tipe Kepala Madrasah</label>
                            <select id="exportTipeKamad" class="mt-1 w-full p-2 border rounded-md bg-white">
                                <option>Kepala Madrasah</option>
                                <option>Plt. Kepala Madrasah</option>
                            </select>

                            <label for="exportNamaKamad" class="block text-sm font-medium text-gray-700 mt-4">Nama Kepala Madrasah</label>
                            <input type="text" id="exportNamaKamad" class="mt-1 w-full p-2 border bg-gray-100 rounded-md" readonly>

                            <label for="exportNip" class="block text-sm font-medium text-gray-700 mt-4">NIP</label>
                            <input type="text" id="exportNip" class="mt-1 w-full p-2 border bg-gray-100 rounded-md" readonly>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 mt-auto p-6 border-t flex flex-wrap justify-end gap-3">
                    <button type="button" id="cancelExportBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-300">Batal</button>
                    <button type="button" id="generateExcelBtn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span class="btn-text">Unduh Excel</span>
                        <span class="btn-spinner hidden loading-animation">Memproses</span>
                    </button>
                    <button type="button" id="generatePdfBtn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <span class="btn-text">Unduh PDF</span>
                        <span class="btn-spinner hidden loading-animation">Memproses</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="forgot-password-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95 flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0 flex justify-between items-center border-b px-6 pt-6 pb-3">
                <h2 class="text-2xl font-bold text-gray-800">Reset Password</h2>
                <button id="closeForgotPasswordModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>

            <form id="forgotPasswordForm" class="flex-grow overflow-y-auto p-6">
                
                <div id="fp-step-1" class="space-y-4">
                    <p class="text-sm text-gray-600">Masukkan alamat email Anda yang terdaftar untuk menerima kode verifikasi (OTP).</p>
                    <div>
                        <label for="fp-email" class="block text-sm font-medium text-gray-700">Alamat Email</label>
                        <input type="email" id="fp-email" name="fp-email" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <button type="button" id="fp-send-otp-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">
                        <span class="btn-text">Kirim Kode OTP</span>
                        <span class="btn-spinner hidden loading-animation">Mengirim</span>
                    </button>
                </div>

                <div id="fp-step-2" class="space-y-4 hidden">
                    <p class="text-sm text-gray-600">Kode OTP telah dikirim. Silakan cek email Anda dan masukkan kode serta password baru Anda.</p>
                    <div>
                        <label for="fp-otp" class="block text-sm font-medium text-gray-700">Kode OTP (6 digit)</label>
                        <input type="text" id="fp-otp" name="fp-otp" class="mt-1 w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="fp-new-password" class="block text-sm font-medium text-gray-700">Password Baru</label>
                        <div class="relative mt-1">
                            <input type="password" id="fp-new-password" name="fp-new-password" class="w-full p-2 pr-10 border rounded-md" required>
                            <button type="button" data-toggle-password="fp-new-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                            </button>
                        </div>
                        <div id="fp-password-req" class="text-xs space-y-1 mt-2"></div>
                    </div>
                    <div>
                        <label for="fp-confirm-password" class="block text-sm font-medium text-gray-700">Konfirmasi Password Baru</label>
                        <div class="relative mt-1">
                            <input type="password" id="fp-confirm-password" name="fp-confirm-password" class="w-full p-2 pr-10 border rounded-md" required>
                        </div>
                        <div id="fp-confirm-msg" class="text-red-600 text-xs mt-1 h-4 font-medium"></div>
                    </div>
                    <button type="submit" id="fp-reset-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700">
                        <span class="btn-text">Reset Password</span>
                        <span class="btn-spinner hidden loading-animation">Memproses</span>
                    </button>
                </div>
            </form>

            <div id="fp-status-message" class="flex-shrink-0 px-6 pb-4 text-center text-sm"></div>
        </div>
    </div>

    <div id="update-confirm-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 transform scale-95">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-3 mb-5">Konfirmasi Pembaruan Data Siswa</h2>
            <p class="mb-4 text-yellow-800 bg-yellow-100 p-3 rounded-md">NISN <strong id="conflictNisn"></strong> sudah ada dengan data yang berbeda. Apakah Anda ingin memperbaruinya?</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="font-bold text-lg text-gray-700 mb-2">Data Lama</h3>
                    <div id="old-data-display" class="space-y-2 text-sm p-4 bg-gray-50 rounded-md border"></div>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-green-700 mb-2">Data Baru</h3>
                    <div id="new-data-display" class="space-y-2 text-sm p-4 bg-green-50 rounded-md border border-green-200"></div>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t flex justify-end space-x-3">
                <button id="cancelUpdateBtn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400">Batal</button>
                <button id="confirmUpdateBtn" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Ya, Update Data</button>
            </div>
        </div>
    </div>

    <div id="conflict-detail-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl p-6 transform scale-95">
            <div class="flex justify-between items-center border-b pb-3 mb-5">
                <h2 class="text-2xl font-bold text-gray-800">Detail Perubahan Data Siswa</h2>
                <button id="closeConflictDetailModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            
            <p class="mb-4">Berikut adalah perbandingan data lama yang tersimpan di sistem dengan data baru dari file yang Anda unggah. Perbedaan data ditandai dengan latar belakang kuning.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow overflow-y-auto pr-2 custom-scrollbar">
                <div>
                    <h3 class="font-bold text-lg text-gray-700 mb-2">Data Lama (di Sistem)</h3>
                    <div id="conflict-old-data" class="space-y-2 text-sm p-4 bg-gray-50 rounded-md border"></div>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-green-700 mb-2">Data Baru (dari File)</h3>
                    <div id="conflict-new-data" class="space-y-2 text-sm p-4 bg-green-50 rounded-md border border-green-200"></div>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t flex justify-end">
                <button id="closeConflictDetailModalBtn2" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">Tutup</button>
            </div>
        </div>
    </div>

    <div id="completeness-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-5xl transform scale-95 flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0 flex justify-between items-center border-b p-4 sm:p-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Kelengkapan Data Siswa</h2>
                <button id="closeCompletenessModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>

            <div class="flex-grow p-4 sm:p-6 overflow-y-auto custom-scrollbar">
                <p class="text-sm text-gray-600 mb-4">Tabel ini menunjukkan field data mana yang sudah terisi (✅) dan mana yang masih kosong (❌). Klik ikon untuk melihat data asli.</p>
                
                <div class="bg-gray-50 p-4 rounded-lg mb-4 flex flex-wrap items-center justify-between gap-4">
                    <div id="completeness-summary" class="text-sm font-medium text-gray-700">
                        </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="completeness-filter-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <label for="completeness-filter-checkbox" class="ml-2 block text-sm text-gray-900">
                                Hanya tampilkan yang tidak lengkap
                            </label>
                        </div>
                        <select id="completeness-sort-select" class="block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm bg-white">
                            <option value="name_asc">Urutkan berdasarkan Nama (A-Z)</option>
                            <option value="missing_desc">Urutkan berdasarkan Data Kosong (Terbanyak)</option>
                        </select>
                    </div>
                </div>

                <div id="completeness-table-container">
                    </div>
            </div>

            <div class="flex-shrink-0 mt-auto pt-4 border-t flex justify-end p-4 sm:p-6">
                <button type="button" id="closeCompletenessModalBtn2" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Tutup</button>
            </div>
        </div>
    </div>

    <div id="edit-mapel-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg transform scale-95 flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0 flex justify-between items-center border-b p-6">
                <h2 id="edit-mapel-modal-title" class="text-2xl font-bold text-gray-800">Edit Mata Pelajaran</h2>
                <button id="closeEditMapelModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            
            <form id="editMapelForm" class="flex flex-col flex-grow min-h-0">
                <div class="flex-grow overflow-y-auto p-6">
                    <input type="hidden" id="mapelRowEdit" name="mapelRow">
                    <div class="space-y-4">
                        <div>
                            <label for="kodeEdit" class="block text-sm font-medium text-gray-700">Kode Mata Pelajaran (Tidak bisa diubah)</label>
                            <input type="text" id="kodeEdit" name="kode" class="mt-1 w-full p-2 border rounded-md bg-gray-100" readonly>
                        </div>
                        <div>
                            <label for="namaMapelEdit" class="block text-sm font-medium text-gray-700">Nama Mata Pelajaran</label>
                            <input type="text" id="namaMapelEdit" name="nama" class="mt-1 w-full p-2 border rounded-md" required>
                        </div>
                        <div>
                            <label for="kelompokEdit" class="block text-sm font-medium text-gray-700">Kelompok</label>
                            <select id="kelompokEdit" name="kelompok" class="mt-1 w-full p-2 border rounded-md bg-white">
                                <option>Umum</option>
                                <option>Peminatan</option>
                                <option>Muatan Lokal</option>
                            </select>
                        </div>
                        <div class="pt-2">
                            <label class="block text-sm font-medium text-gray-700">Jenis Ujian</label>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center"><input type="radio" id="jenisUjianMadrasahEdit" name="jenisUjian" value="Ujian Madrasah" class="h-4 w-4 text-blue-600 border-gray-300"><label for="jenisUjianMadrasahEdit" class="ml-3 block text-sm text-gray-900">Ujian Madrasah Saja</label></div>
                                <div class="flex items-center"><input type="radio" id="jenisUjianPraktekEdit" name="jenisUjian" value="Ujian Praktek" class="h-4 w-4 text-blue-600 border-gray-300"><label for="jenisUjianPraktekEdit" class="ml-3 block text-sm text-gray-900">Ujian Praktek Saja</label></div>
                                <div class="flex items-center"><input type="radio" id="jenisKeduanyaEdit" name="jenisUjian" value="Keduanya" class="h-4 w-4 text-blue-600 border-gray-300"><label for="jenisKeduanyaEdit" class="ml-3 block text-sm text-gray-900">Keduanya (Madrasah & Praktek)</label></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 mt-auto p-6 border-t flex justify-end">
                    <button type="button" id="cancelEditMapelBtn" class="bg-gray-200 text-gray-700 py-2 px-4 rounded-md mr-3 hover:bg-gray-300">Batal</button>
                    <button type="submit" id="saveEditMapelBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="data-viewer-tooltip" class="hidden absolute z-50 px-3 py-2 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm"></div>
    <div id="globalStatusMessage"></div>

    <!-- Tambahkan library Chart.js di dalam <head> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>

    <script>
        // Global variable to hold the user's spreadsheet ID and chart instance
        let userSpreadsheetId = null;
        let allStudentsData = [];
        let inactivityTimer;
        let mapelChartInstance = null; // Untuk menyimpan instance grafik
        // [BARU] Tambahkan variabel untuk grafik rata-rata
        let ujianChartInstance = null;
        let raporChartInstance = null;
        let ijazahChartInstance = null;
        let examScoreShareChartInstance = null; // Nama variabel diubah
        let ijazahRankingChartInstance = null; // [BARU]
        let currentImportConflicts = [];
        // Variabel global untuk menyimpan data siswa yang sudah diproses
        let processedStudents = [];

        // Fungsi ini akan mengatur tahun saat ini pada elemen footer
        function setFooterYear() {
            const currentYear = new Date().getFullYear();
            const yearAuthSpan = document.getElementById('currentYearAuth');
            const yearAppSpan = document.getElementById('currentYearApp');
            if (yearAuthSpan) yearAuthSpan.textContent = currentYear;
            if (yearAppSpan) yearAppSpan.textContent = currentYear;
        }

        document.addEventListener('DOMContentLoaded', function() {
            setFooterYear();

            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const logoutButton = document.getElementById('logoutButton');
            const showSignupBtn = document.getElementById('show-signup');
            const showLoginBtn = document.getElementById('show-login');
            const requestOtpButton = document.getElementById('requestOtpButton'); // Tombol baru

            // Check for existing session on page load
            const storedId = sessionStorage.getItem('userSpreadsheetId');
            const lastPage = sessionStorage.getItem('lastActivePage') || 'dashboard';

            if (storedId) {
                userSpreadsheetId = storedId;
                document.getElementById('auth-wrapper').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                initializeApp(lastPage);
            } else {
                document.getElementById('auth-wrapper').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
            }

            // --- Event listener untuk Login, Signup, Logout ---
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            // Event listener submit sekarang akan memanggil fungsi handleSignup yang sudah dimodifikasi
            if (signupForm) signupForm.addEventListener('submit', handleSignup);
            // Event listener BARU untuk tombol permintaan OTP
            if (requestOtpButton) requestOtpButton.addEventListener('click', handleRequestOtp);

            if (logoutButton) logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                logoutUser();
            });

            // Event listener untuk beralih antara form login dan signup
            if (showSignupBtn) {
                showSignupBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('login-container').classList.add('hidden');
                    document.getElementById('signup-container').classList.remove('hidden');
                });
            }
            if (showLoginBtn) {
                showLoginBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('signup-container').classList.add('hidden');
                    document.getElementById('login-container').classList.remove('hidden');
                });
            }
            
            setupPasswordToggles();

            // Di dalam DOMContentLoaded atau initializeApp()

            // Pendaftaran
            setupRealtimePasswordValidation(document.getElementById('signup-password'), document.getElementById('signup-password-req'));
            setupPasswordConfirmation(
                document.getElementById('signup-password'),
                document.getElementById('confirm-password'),
                document.getElementById('signup-confirm-msg')
            );

            // Ubah Password
            setupRealtimePasswordValidation(document.getElementById('new-password-change'), document.getElementById('change-password-req'));
            setupPasswordConfirmation(
                document.getElementById('new-password-change'),
                document.getElementById('confirm-password-change'),
                document.getElementById('change-confirm-msg')
            );

            // Lupa Password
            setupRealtimePasswordValidation(document.getElementById('fp-new-password'), document.getElementById('fp-password-req'));
            setupPasswordConfirmation(
                document.getElementById('fp-new-password'),
                document.getElementById('fp-confirm-password'),
                document.getElementById('fp-confirm-msg')
            );


            // --- Event listener untuk modal ekspor ---
            const exportModal = document.getElementById('export-modal');
            const closeExportModalBtn = document.getElementById('closeExportModalBtn');
            const cancelExportBtn = document.getElementById('cancelExportBtn');
            const generatePdfBtn = document.getElementById('generatePdfBtn');
            const generateExcelBtn = document.getElementById('generateExcelBtn');

            const closeExportModal = () => {
                if(exportModal) {
                  exportModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                  setTimeout(() => exportModal.classList.add('hidden'), 300);
                }
            };

            if (closeExportModalBtn) closeExportModalBtn.addEventListener('click', closeExportModal);
            if (cancelExportBtn) cancelExportBtn.addEventListener('click', closeExportModal);

            // Handler untuk memicu ekspor
            const handleExport = (event, format) => {
                const rekapType = document.getElementById('exportForm').dataset.rekapType;
                const exportButton = event.currentTarget;

                const exportOptions = {
                    tahunAjaran: document.getElementById('exportTahunAjaran').value,
                    tempatTTD: document.getElementById('exportTempatTTD').value,
                    tanggalTTD: document.getElementById('exportTanggalTTD').value,
                    tipeKamad: document.getElementById('exportTipeKamad').value,
                };

                // Simpan Opsi ke Local Storage
                localStorage.setItem('exportOptions', JSON.stringify(exportOptions));

                const btnText = exportButton.querySelector('.btn-text');
                const spinner = exportButton.querySelector('.btn-spinner');

                exportButton.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');

                google.script.run
                    .withSuccessHandler(result => {
                        if (result && result.base64Data) {
                            const link = document.createElement('a');
                            link.href = `data:${result.mimeType};base64,${result.base64Data}`;
                            link.download = result.fileName;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            showGlobalStatus(`File '${result.fileName}' berhasil diunduh.`, true);
                            closeExportModal();
                        } else {
                            const errorMessage = result ? result.error : 'Terjadi kesalahan tidak diketahui di server.';
                            showGlobalStatus(`Gagal mengekspor: ${errorMessage}`, false);
                        }
                        exportButton.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    })
                    .withFailureHandler(error => {
                        showGlobalStatus(`Error Kritis: ${error.message}. Coba refresh halaman.`, false);
                        exportButton.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    })
                    .exportRekapData(userSpreadsheetId, rekapType, format, exportOptions);
            };

            if (generatePdfBtn) generatePdfBtn.addEventListener('click', (e) => handleExport(e, 'pdf'));
            if (generateExcelBtn) generateExcelBtn.addEventListener('click', (e) => handleExport(e, 'excel'));

            // --- [BARU] Event listener dan fungsi untuk Lupa Password ---
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const forgotPasswordModal = document.getElementById('forgot-password-modal');
            const closeForgotPasswordModalBtn = document.getElementById('closeForgotPasswordModalBtn');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            const fpStep1 = document.getElementById('fp-step-1');
            const fpStep2 = document.getElementById('fp-step-2');
            const fpSendOtpBtn = document.getElementById('fp-send-otp-btn');
            const fpResetBtn = document.getElementById('fp-reset-btn');
            const fpStatusMessage = document.getElementById('fp-status-message');

            const openForgotPasswordModal = () => {
                forgotPasswordModal.classList.remove('hidden');
                setTimeout(() => {
                    forgotPasswordModal.querySelector('.modal-content').style.transform = 'scale(1)';
                }, 10);
            };

            const closeForgotPasswordModal = () => {
                forgotPasswordModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => {
                    forgotPasswordModal.classList.add('hidden');
                    // Reset form ke step 1 saat ditutup
                    fpStep1.classList.remove('hidden');
                    fpStep2.classList.add('hidden');
                    forgotPasswordForm.reset();
                    fpStatusMessage.innerHTML = '';
                }, 300);
            };

            if (forgotPasswordLink) forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                openForgotPasswordModal();
            });

            if (closeForgotPasswordModalBtn) closeForgotPasswordModalBtn.addEventListener('click', closeForgotPasswordModal);

            // Tombol untuk mengirim OTP
            if (fpSendOtpBtn) fpSendOtpBtn.addEventListener('click', function() {
                const email = document.getElementById('fp-email').value;
                if (!email) {
                    fpStatusMessage.textContent = 'Email tidak boleh kosong.';
                    fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    return;
                }
                
                const btn = this;
                const btnText = btn.querySelector('.btn-text');
                const spinner = btn.querySelector('.btn-spinner');

                btn.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');
                fpStatusMessage.innerHTML = '';

                google.script.run
                    .withSuccessHandler(response => {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');

                        if (response.status === 'success') {
                            fpStatusMessage.textContent = response.message;
                            fpStatusMessage.className = 'mt-4 text-center text-sm text-green-600';
                            fpStep1.classList.add('hidden');
                            fpStep2.classList.remove('hidden');
                        } else {
                            fpStatusMessage.textContent = response.message;
                            fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                        }
                    })
                    .withFailureHandler(error => {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                        fpStatusMessage.textContent = 'Error: ' + error.message;
                        fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    })
                    .sendPasswordResetOtp(email);
            });

            // Tombol untuk submit OTP dan password baru
            if (forgotPasswordForm) forgotPasswordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('fp-email').value;
                const otp = document.getElementById('fp-otp').value;
                const newPassword = document.getElementById('fp-new-password').value;
                const fpStatusMessage = document.getElementById('fp-status-message');

                fpStatusMessage.innerHTML = ''; // Selalu bersihkan pesan sebelumnya

                if (!otp || !newPassword) {
                    fpStatusMessage.textContent = 'OTP dan Password Baru tidak boleh kosong.';
                    fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    return;
                }
                
                // [KODE YANG DIPERBAIKI]
                // Memanggil fungsi validasi password yang sudah ada
                const passwordErrors = validatePassword(newPassword);
                if (passwordErrors.length > 0) {
                    // Menggunakan backtick (`) untuk string template
                    let errorHtml = '<strong class="block text-center">Password baru belum memenuhi syarat:</strong><ul class="list-disc list-inside text-left mt-1 text-sm">';
                    passwordErrors.forEach(error => {
                        errorHtml += `<li>${error}</li>`; // <-- PERBAIKAN DI SINI
                    });
                    errorHtml += '</ul>';
                    fpStatusMessage.innerHTML = errorHtml;
                    fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    return; // Menghentikan proses jika password tidak valid
                }
                // [AKHIR DARI KODE YANG DIPERBAIKI]

                const btn = document.getElementById('fp-reset-btn');
                const btnText = btn.querySelector('.btn-text');
                const spinner = btn.querySelector('.btn-spinner');

                btn.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');

                google.script.run
                    .withSuccessHandler(response => {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');

                        if (response.status === 'success') {
                            fpStatusMessage.textContent = response.message + ' Anda akan dialihkan ke halaman login.';
                            fpStatusMessage.className = 'mt-4 text-center text-sm text-green-600';
                            setTimeout(() => {
                                closeForgotPasswordModal();
                                const loginInfoMessageDiv = document.getElementById('login-info-message');
                                loginInfoMessageDiv.textContent = "Password berhasil direset. Silakan login dengan password baru Anda.";
                                loginInfoMessageDiv.className = "mb-4 text-center text-sm p-3 bg-green-100 text-green-800 rounded-lg";
                            }, 3000);
                        } else {
                            fpStatusMessage.textContent = response.message;
                            fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                        }
                    })
                    .withFailureHandler(error => {
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                        fpStatusMessage.textContent = 'Error: ' + error.message;
                        fpStatusMessage.className = 'mt-4 text-center text-sm text-red-600';
                    })
                    .resetPasswordWithOtp(email, otp, newPassword);
            });
        });

        function setupPasswordToggles() {
            document.querySelectorAll('[data-toggle-password]').forEach(button => {
                button.addEventListener('click', () => {
                    const inputId = button.getAttribute('data-toggle-password');
                    const passwordInput = document.getElementById(inputId);
                    if (passwordInput) {
                        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                        passwordInput.setAttribute('type', type);
                        button.querySelector('.eye-icon').classList.toggle('hidden');
                        button.querySelector('.eye-slash-icon').classList.toggle('hidden');
                    }
                });
            });
        }

        function logoutUser() {
            // Hapus semua data sesi
            userSpreadsheetId = null;
            sessionStorage.clear();
            // [BARU] atau bisa lebih spesifik
            // sessionStorage.removeItem('userSpreadsheetId');
            // sessionStorage.removeItem('userEmail');
            localStorage.removeItem('exportOptions');
            clearTimeout(inactivityTimer);

            // Alihkan tampilan secara manual, tanpa memuat ulang halaman
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('auth-wrapper').classList.remove('hidden');

            // Opsional: Bersihkan form login dan tampilkan pesan logout
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.reset();
            }
            const errorMessageDiv = document.getElementById('login-error-message');
            if (errorMessageDiv) {
                errorMessageDiv.textContent = '';
            }
            const loginInfoMessageDiv = document.getElementById('login-info-message');
            if (loginInfoMessageDiv) {
                loginInfoMessageDiv.textContent = "Anda telah berhasil logout.";
                loginInfoMessageDiv.className = "mb-4 text-center text-sm p-3 bg-blue-100 text-blue-800 rounded-lg";
            }
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(logoutUser, 30 * 60 * 1000); // 30 menit
        }

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            const loginSpinner = document.getElementById('loginSpinner');
            const errorMessageDiv = document.getElementById('login-error-message');

            errorMessageDiv.textContent = '';
            loginButton.disabled = true;
            loginButtonText.classList.add('hidden');
            loginSpinner.classList.remove('hidden');

            google.script.run
                .withSuccessHandler(response => {
                    loginButton.disabled = false;
                    loginButtonText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');

                    if (response && response.status === 'success') {
                        userSpreadsheetId = response.spreadsheetId;
                        sessionStorage.setItem('userSpreadsheetId', userSpreadsheetId);
                        sessionStorage.setItem('userEmail', response.email); 
                        document.getElementById('auth-wrapper').classList.add('hidden');
                        document.getElementById('app-container').classList.remove('hidden');
                        initializeApp('dashboard');

                        // =======================================================
                        // [TAMBAHAN] PANGGIL FUNGSI TUR DI SINI
                        // =======================================================
                        // Cek apakah pengguna sudah pernah menyelesaikan tur
                        if (!localStorage.getItem('hasCompletedAppTour')) {
                            // Beri jeda sedikit agar transisi halaman selesai
                            setTimeout(initializeAndStartTour, 500); 
                        }
                        // =======================================================
                    } else {
                        errorMessageDiv.textContent = response ? response.message : 'Login gagal karena respons tidak valid.';
                    }
                })
                .withFailureHandler(error => {
                    errorMessageDiv.textContent = 'Terjadi kesalahan: ' + error.message;
                    loginButton.disabled = false;
                    loginButtonText.classList.remove('hidden');
                    loginSpinner.classList.add('hidden');
                })
                .checkLogin(email, password);
        }

        function validatePassword(password) {
            const errors = [];

            if (password.length < 8) {
                errors.push("Password minimal harus 8 karakter.");
            }
            if (!/[A-Z]/.test(password)) {
                errors.push("Harus memiliki setidaknya 1 huruf besar (A-Z).");
            }
            if (!/[a-z]/.test(password)) {
                errors.push("Harus memiliki setidaknya 1 huruf kecil (a-z).");
            }
            if (!/[0-9]/.test(password)) {
                errors.push("Harus memiliki setidaknya 1 angka (0-9).");
            }
            // Pengecekan untuk karakter spesial
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(password)) {
                errors.push("Harus memiliki setidaknya 1 karakter spesial (cth: !@#$).");
            }
            
            return errors;
        }
        
        function handleRequestOtp() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const namaSekolah = document.getElementById('signup-namasekolah').value;
            const jenjang = document.getElementById('signup-jenjang').value;

            const requestOtpButton = document.getElementById('requestOtpButton');
            const requestOtpBtnText = document.getElementById('requestOtpButtonText');
            const requestOtpSpinner = document.getElementById('requestOtpSpinner');
            const messageDiv = document.getElementById('signup-message');

            messageDiv.innerHTML = ''; // Bersihkan pesan sebelumnya
            messageDiv.classList.remove('text-red-600', 'text-green-600');

            // Validasi awal (apakah semua field terisi)
            if (!email || !password || !namaSekolah || !jenjang || !confirmPassword) {
                messageDiv.textContent = 'Semua field wajib diisi.';
                messageDiv.classList.add('text-red-600');
                return;
            }

            // Validasi kecocokan kata sandi
            if (password !== confirmPassword) {
                messageDiv.textContent = 'Kata sandi dan konfirmasi kata sandi tidak cocok.';
                messageDiv.classList.add('text-red-600');
                return;
            }

            // BARU: Validasi kekuatan kata sandi
            const passwordErrors = validatePassword(password);
            if (passwordErrors.length > 0) {
                let errorHtml = '<strong class="block text-center">Password belum memenuhi syarat:</strong><ul class="list-disc list-inside text-left mt-1 text-sm">';
                passwordErrors.forEach(error => {
                    errorHtml += `<li>${error}</li>`;
                });
                errorHtml += '</ul>';
                messageDiv.innerHTML = errorHtml;
                messageDiv.classList.add('text-red-600');
                return; // Hentikan proses jika password tidak valid
            }

            // Tampilkan loading
            requestOtpButton.disabled = true;
            requestOtpBtnText.classList.add('hidden');
            requestOtpSpinner.classList.remove('hidden');

            google.script.run
                .withSuccessHandler(response => {
                    requestOtpButton.disabled = false;
                    requestOtpBtnText.classList.remove('hidden');
                    requestOtpSpinner.classList.add('hidden');

                    if (response.status === 'success') {
                        messageDiv.textContent = response.message;
                        messageDiv.classList.add('text-green-600');

                        // Sembunyikan field awal dan tombol minta OTP
                        document.getElementById('initial-fields').querySelectorAll('input, select').forEach(el => el.disabled = true);
                        requestOtpButton.classList.add('hidden');

                        // Tampilkan field OTP dan tombol daftar final
                        document.getElementById('otp-section').classList.remove('hidden');
                        document.getElementById('final-signup-button-container').classList.remove('hidden');

                    } else {
                        messageDiv.textContent = response.message;
                        messageDiv.classList.add('text-red-600');
                    }
                })
                .withFailureHandler(error => {
                    messageDiv.textContent = 'Terjadi kesalahan: ' + error.message;
                    messageDiv.classList.add('text-red-600');
                    requestOtpButton.disabled = false;
                    requestOtpBtnText.classList.remove('hidden');
                    requestOtpSpinner.classList.add('hidden');
                })
                .sendVerificationEmail(email);
        }


        // --- [MODIFIKASI] Fungsi signup sekarang menangani submit final dengan OTP ---
        function handleSignup(event) {
            event.preventDefault(); 
            const namaSekolah = document.getElementById('signup-namasekolah').value;
            const jenjang = document.getElementById('signup-jenjang').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            // [PERBAIKAN] Ambil kode OTP dan hapus spasi di awal/akhir menggunakan .trim()
            const otp = document.getElementById('signup-otp').value.trim(); 

            const signupButton = document.getElementById('signupButton');
            const signupButtonText = document.getElementById('signupButtonText');
            const signupSpinner = document.getElementById('signupSpinner');
            const messageDiv = document.getElementById('signup-message');

            messageDiv.textContent = '';
            messageDiv.classList.remove('text-red-600', 'text-green-600');
            
            if (!otp) {
                messageDiv.textContent = 'Kode OTP wajib diisi.';
                messageDiv.classList.add('text-red-600');
                return;
            }

            signupButton.disabled = true;
            signupButtonText.classList.add('hidden');
            signupSpinner.classList.remove('hidden');

            const userData = {
                email: email,
                password: password,
                namaSekolah: namaSekolah,
                jenjang: jenjang
            };

            // Memanggil fungsi `registerUser` yang sudah dimodifikasi di backend dengan menyertakan OTP
            google.script.run
                .withSuccessHandler(response => {
                    signupButton.disabled = false;
                    signupButtonText.classList.remove('hidden');
                    signupSpinner.classList.add('hidden');
                    
                    if (response && response.status === 'success') {
                        // Reset dan alihkan ke halaman login
                        document.getElementById('signupForm').reset();
                        document.getElementById('initial-fields').querySelectorAll('input, select').forEach(el => el.disabled = false);
                        document.getElementById('requestOtpButton').classList.remove('hidden');
                        document.getElementById('otp-section').classList.add('hidden');
                        document.getElementById('final-signup-button-container').classList.add('hidden');

                        document.getElementById('signup-container').classList.add('hidden');
                        document.getElementById('login-container').classList.remove('hidden');
                        
                        const loginInfoMessageDiv = document.getElementById('login-info-message');
                        loginInfoMessageDiv.textContent = "Pendaftaran berhasil! Silakan masuk dengan akun yang baru Anda buat.";
                        loginInfoMessageDiv.className = "mb-4 text-center text-sm p-3 bg-green-100 text-green-800 rounded-lg";
                    } else {
                        messageDiv.textContent = response ? response.message : 'Gagal mendaftar karena respons tidak valid dari server.';
                        messageDiv.classList.add('text-red-600');
                    }
                })
                .withFailureHandler(error => {
                    messageDiv.textContent = 'Terjadi kesalahan: ' + error.message;
                    messageDiv.classList.add('text-red-600');
                    signupButton.disabled = false;
                    signupButtonText.classList.remove('hidden');
                    signupSpinner.classList.add('hidden');
                })
                .registerUser(userData, otp); // Parameter OTP ditambahkan di sini
        }

        function loadDashboardData() {
            document.getElementById('studentCount').textContent = '...';
            document.getElementById('mapelCount').textContent = '...';

            // Helper function untuk membuat grafik batang horizontal
            const createAverageChart = (canvasId, chartInstance, chartData, chartLabel) => {
                if (chartInstance) {
                    chartInstance.destroy();
                }
                if (!chartData || !chartData.labels || !chartData.data) return null;

                const ctx = document.getElementById(canvasId).getContext('2d');
                return new Chart(ctx, {
                    type: 'bar', // Menggunakan grafik batang
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: chartLabel,
                            data: chartData.data,
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Membuat grafik menjadi horizontal
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) { if (value % 1 === 0) { return value; } } // Tampilkan hanya integer
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // Sembunyikan legenda karena sudah ada di judul
                            }
                        }
                    }
                });
            };

            google.script.run
                .withSuccessHandler(response => {
                    if (response && response.status === 'success') {
                        // --- Kode untuk kartu statistik (tidak berubah) ---
                        document.getElementById('studentCount').textContent = response.studentCount || 0;
                        document.getElementById('mapelCount').textContent = response.mapelCount || 0;

                        // --- Kode untuk grafik distribusi jenis ujian (tidak berubah) ---
                        let madrasahCount = 0, praktekCount = 0, keduanyaCount = 0;
                        if (response.mapelList && response.mapelList.length > 0) {
                            response.mapelList.forEach(mapel => {
                                if (mapel.jenisUjian === 'Ujian Madrasah') madrasahCount++;
                                else if (mapel.jenisUjian === 'Ujian Praktek') praktekCount++;
                                else if (mapel.jenisUjian === 'Keduanya') keduanyaCount++;
                            });
                        }
                        const ctx = document.getElementById('mapelChart').getContext('2d');
                        if (mapelChartInstance) {
                            mapelChartInstance.destroy();
                        }
                        mapelChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Ujian Madrasah', 'Ujian Praktek', 'Keduanya'],
                                datasets: [{
                                    label: 'Jumlah Mapel',
                                    data: [madrasahCount, praktekCount, keduanyaCount],
                                    backgroundColor: ['rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)', 'rgba(249, 115, 22, 0.7)'],
                                    borderColor: ['rgba(59, 130, 246, 1)', 'rgba(16, 185, 129, 1)', 'rgba(249, 115, 22, 1)'],
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                                plugins: { legend: { display: false } }
                            }
                        });

                        // --- [BARU] Kode untuk membuat grafik rata-rata nilai ---
                        if (response.subjectAverages) {
                            ujianChartInstance = createAverageChart('ujianAverageChart', ujianChartInstance, response.subjectAverages.ujian, 'Rata-rata Nilai Ujian');
                            raporChartInstance = createAverageChart('raporAverageChart', raporChartInstance, response.subjectAverages.rapor, 'Rata-rata Nilai Rapor');
                            ijazahChartInstance = createAverageChart('ijazahAverageChart', ijazahChartInstance, response.subjectAverages.ijazah, 'Rata-rata Nilai Ijazah');
                        }


                        // [MODIFIKASI] Seluruh blok ini diubah untuk mendukung grafik vertikal dan scrolling
                        if (response.examScoreShare) {
                            // 1. Filter dan Urutkan Data (High to Low)
                            // Kabar baiknya, kode Anda sudah mengurutkan data dari skor tertinggi ke terendah,
                            // jadi kita tidak perlu mengubah bagian ini.
                            const studentData = response.examScoreShare
                                .filter(s => s.nama && s.nama.trim() !== '')
                                .sort((a, b) => b.skor - a.skor);

                            // [MODIFIKASI] Tambahkan nomor peringkat pada label nama siswa
                            const studentLabels = studentData.map((s, index) => {
                                return `${index + 1}. ${s.nama.toUpperCase()}`;
                            });
                            const studentScores = studentData.map(s => s.skor);

                            // 2. [MODIFIKASI] Atur lebar dinamis untuk scrolling
                            const numStudents = studentData.length;
                            // Beri lebar 60px untuk setiap siswa, dengan lebar minimum 600px
                            const chartWidth = Math.max(600, numStudents * 60); 
                            
                            const wrapper = document.getElementById('examScoreChartWrapper');
                            if (wrapper) {
                                wrapper.style.width = `${chartWidth}px`;
                            }

                            // 3. Buat atau perbarui grafik
                            const ctxBar = document.getElementById('examScoreDistributionChart').getContext('2d');
                            if (examScoreShareChartInstance) {
                                examScoreShareChartInstance.destroy();
                            }
                            
                            examScoreShareChartInstance = new Chart(ctxBar, {
                                type: 'bar', // Tipe grafik tetap bar
                                data: {
                                    labels: studentLabels,
                                    datasets: [{
                                        label: 'Rata-rata Nilai Ujian',
                                        data: studentScores,
                                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                        borderColor: 'rgba(59, 130, 246, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    // [MODIFIKASI] Hapus indexAxis: 'y' untuk menjadikannya bar vertikal
                                    responsive: true,
                                    maintainAspectRatio: false, // Penting untuk scrolling
                                    scales: {
                                        x: { // Ini sekarang adalah sumbu Nama Siswa
                                            ticks: {
                                                // [MODIFIKASI] Atur rotasi label nama siswa
                                                maxRotation: 45,
                                                minRotation: 45,
                                                autoSkip: false, // Pastikan semua nama ditampilkan
                                                font: {
                                                    size: 10
                                                }
                                            }
                                        },
                                        y: { // Ini sekarang adalah sumbu Nilai
                                            beginAtZero: true
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false // Sembunyikan legenda
                                        },
                                        tooltip: {
                                            callbacks: {
                                                label: function(context) {
                                                    let label = context.dataset.label || '';
                                                    if (label) { label += ': '; }
                                                    if (context.parsed.y !== null) {
                                                        label += parseFloat(context.parsed.y.toFixed(2));
                                                    }
                                                    return label;
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        }

                        // --- [DIUBAH] Kode untuk grafik peringkat siswa berdasarkan nilai rata-rata ijazah (Bar Chart) ---
                        // [MODIFIKASI] Seluruh blok ini diubah untuk mendukung grafik vertikal dan scrolling
                        if (response.ijazahRanking) {
                            // Data dari backend sudah diurutkan dari tertinggi ke terendah.
                            const peringkatData = response.ijazahRanking.map(item => parseFloat(item.nilai.toFixed(2)));
                            // [MODIFIKASI] Tambahkan nomor peringkat pada label nama siswa
                            const namaSiswa = response.ijazahRanking.map((item, index) => {
                                return `${index + 1}. ${item.nama.toUpperCase()}`;
                            });

                            // [MODIFIKASI] Atur lebar dinamis untuk scrolling
                            const numStudents = response.ijazahRanking.length;
                            const chartWidth = Math.max(600, numStudents * 60); // 60px per siswa
                            
                            const wrapper = document.getElementById('ijazahRankingChartWrapper');
                            if (wrapper) {
                                wrapper.style.width = `${chartWidth}px`;
                            }

                            // Buat atau perbarui grafik
                            const ctxRanking = document.getElementById('ijazahRankingChart').getContext('2d');
                            if (ijazahRankingChartInstance) {
                                ijazahRankingChartInstance.destroy();
                            }
                            
                            ijazahRankingChartInstance = new Chart(ctxRanking, {
                                type: 'bar',
                                data: {
                                    labels: namaSiswa,
                                    datasets: [{
                                        label: 'Rata-rata Nilai Ijazah',
                                        data: peringkatData,
                                        // [MODIFIKASI] Warna diubah agar berbeda dari grafik sebelumnya
                                        backgroundColor: 'rgba(255, 159, 64, 0.7)', 
                                        borderColor: 'rgba(255, 159, 64, 1)',
                                        borderWidth: 1
                                    }]
                                },
                                options: {
                                    // [MODIFIKASI] Hapus indexAxis: 'y' untuk menjadikannya bar vertikal
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: { // Sumbu Nama Siswa
                                            ticks: {
                                                // [MODIFIKASI] Atur rotasi label nama siswa
                                                maxRotation: 45,
                                                minRotation: 45,
                                                autoSkip: false,
                                                font: {
                                                    size: 10
                                                }
                                            }
                                        },
                                        y: { // Sumbu Nilai
                                            beginAtZero: true
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: false
                                        }
                                    }
                                }
                            });
                        }
                    } else {
                        showGlobalStatus(response ? response.message : 'Gagal memuat data dashboard.', false);
                    }
                })
                .withFailureHandler(error => {
                    showGlobalStatus(`Gagal memuat dashboard: ${error.message}`, false);
                })
                .getDashboardData(userSpreadsheetId);
        }

        function initializeApp(lastPage = 'dashboard') {
            if (!userSpreadsheetId) {
                alert("Error: Sesi tidak valid. Silakan login ulang.");
                logoutUser();
                return;
            }

            resetInactivityTimer();
            document.onmousemove = resetInactivityTimer;
            document.onmousedown = resetInactivityTimer;
            document.ontouchstart = resetInactivityTimer;
            document.onclick = resetInactivityTimer;
            document.onkeydown = resetInactivityTimer;
            document.addEventListener('scroll', resetInactivityTimer, true);

            let rekapitulasiData = null;
            const navLinks = document.querySelectorAll('.nav-link');
            const contentPages = document.querySelectorAll('.content-page');

            loadSchoolData();
            setupCompletenessCheck();

            navLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    if (e.currentTarget.id === 'logoutButton') return;

                    const targetPageId = e.currentTarget.dataset.page;
                    sessionStorage.setItem('lastActivePage', targetPageId);
                    contentPages.forEach(p => p.classList.add('hidden'));
                    document.getElementById('page-' + targetPageId)?.classList.remove('hidden');
                    navLinks.forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');

                    if (targetPageId === 'dashboard') loadDashboardData();
                    if (targetPageId === 'data-siswa') loadStudentsData();
                    if (targetPageId === 'mapel') { loadMapelData(); loadBobotData(); }
                    if (targetPageId === 'input-ujian') document.getElementById('input-ujian-container').innerHTML = '';
                    if (targetPageId === 'input-rapor') initRaporPage();
                    if (targetPageId === 'rekapitulasi') initRekapitulasiPage();
                });
            });
            
            document.getElementById('student-card')?.addEventListener('click', () => {
                document.querySelector('.nav-link[data-page="data-siswa"]').click();
            });
            document.getElementById('mapel-card')?.addEventListener('click', () => {
                document.querySelector('.nav-link[data-page="mapel"]').click();
            });

            const lastActiveLink = document.querySelector(`.nav-link[data-page="${lastPage}"]`);
            if (lastActiveLink) {
                lastActiveLink.click();
            } else {
                document.querySelector('.nav-link[data-page="dashboard"]').click();
            }

            function loadSchoolData() {
                google.script.run
                    .withSuccessHandler(data => {
                        if (data) {
                            const schoolNameSidebar = document.getElementById('school-name-sidebar');
                            if (data.namaSekolah) schoolNameSidebar.textContent = data.namaSekolah.toUpperCase();
                            for (const key in data) {
                                const element = document.getElementById(key === 'email' ? 'email-sekolah' : key);
                                if (element) element.value = data[key] || '';
                            }
                        }
                    })
                    .getSchoolData(userSpreadsheetId);
            }

            // [BARU] Event listener untuk kolom pencarian siswa
            const searchSiswaInput = document.getElementById('searchSiswaInput');
            if (searchSiswaInput) {
                searchSiswaInput.addEventListener('input', () => {
                    const keyword = searchSiswaInput.value.toLowerCase().trim();
                    const filteredStudents = allStudentsData.filter(student => {
                        const nameMatch = student.nama.toLowerCase().includes(keyword);
                        const nisnMatch = student.nisn.toString().includes(keyword);
                        return nameMatch || nisnMatch;
                    });
                    renderSiswaTable(filteredStudents);
                });
            }

            document.getElementById('schoolDataForm')?.addEventListener('submit', function(event) {
                event.preventDefault();
                const btn = this.querySelector('button[type="submit"]');
                const btnText = btn.querySelector('#schoolSubmitBtnText');
                const btnSpinner = btn.querySelector('#schoolLoadingSpinner');

                btn.disabled = true;
                btnText.classList.add('hidden');
                btnSpinner.classList.remove('hidden');

                const dataObj = Object.fromEntries(new FormData(this).entries());
                dataObj.jenjang = document.getElementById('jenjang').value;
                dataObj.namaSekolah = document.getElementById('namaSekolah').value;

                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        btnSpinner.classList.add('hidden');
                        if (response.status === 'success') loadSchoolData();
                    })
                    .withFailureHandler(error => {
                        showGlobalStatus('Error: ' + error.message, false);
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        btnSpinner.classList.add('hidden');
                    })
                    .saveSchoolData(userSpreadsheetId, dataObj);
            });

            // --- DATA SISWA FUNCTIONS ---
            const addStudentBtn = document.getElementById('addStudentBtn');
            const siswaModal = document.getElementById('siswa-modal');
            const closeSiswaModalBtn = document.getElementById('closeSiswaModalBtn');
            const cancelSiswaBtn = document.getElementById('cancelSiswaBtn');
            const siswaForm = document.getElementById('siswaForm');
            const siswaModalTitle = document.getElementById('siswa-modal-title');
            const studentRowInput = document.getElementById('studentRow');
            const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
            const importSiswaBtn = document.getElementById('importSiswaBtn');
            const siswaFileInput = document.getElementById('siswaFileInput');
            const fileNameSpan = document.getElementById('fileName');
            const importStatusDiv = document.getElementById('importStatus');
            const deleteAllStudentsBtn = document.getElementById('deleteAllStudentsBtn');

            const openSiswaModal = () => {
                siswaModal.classList.remove('hidden');
                setTimeout(() => {
                    siswaModal.querySelector('.modal-content').style.transform = 'scale(1)';
                }, 10);
            };
            const closeSiswaModal = () => {
                siswaModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => siswaModal.classList.add('hidden'), 300);
            };
            if (addStudentBtn) {
                addStudentBtn.addEventListener('click', () => {
                    siswaForm.reset();
                    studentRowInput.value = '';
                    siswaModalTitle.textContent = "Tambah Siswa Baru";
                    openSiswaModal();
                });
                closeSiswaModalBtn.addEventListener('click', closeSiswaModal);
                cancelSiswaBtn.addEventListener('click', closeSiswaModal);
            }
            if (deleteAllStudentsBtn) {
                deleteAllStudentsBtn.addEventListener('click', function() {
                    const btn = this;
                    if (btn.dataset.confirming) {
                        btn.disabled = true;
                        btn.textContent = 'Menghapus...';
                        google.script.run
                            .withSuccessHandler(response => {
                                showGlobalStatus(response.message, response.status === 'success');
                                if (response.status === 'success') {
                                    loadStudentsData();
                                }
                                btn.disabled = false;
                                btn.textContent = 'Hapus Semua Siswa';
                                delete btn.dataset.confirming;
                                // [MODIFIKASI] Kembalikan warna tombol ke merah
                                btn.classList.replace('bg-yellow-500', 'bg-red-600');
                                btn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
                            })
                            .withFailureHandler(err => {
                                showGlobalStatus('Error: ' + err.message, false);
                                btn.disabled = false;
                                btn.textContent = 'Hapus Semua Siswa';
                                delete btn.dataset.confirming;
                                // [MODIFIKASI] Kembalikan warna tombol ke merah
                                btn.classList.replace('bg-yellow-500', 'bg-red-600');
                                btn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
                            })
                            .deleteAllStudents(userSpreadsheetId);
                    } else {
                        btn.dataset.confirming = 'true';
                        btn.textContent = 'YAKIN? KLIK LAGI UNTUK HAPUS';
                        btn.classList.replace('bg-red-600', 'bg-yellow-500');
                        btn.classList.replace('hover:bg-red-700', 'hover:bg-yellow-600');

                        setTimeout(() => {
                            if (btn.dataset.confirming) {
                                btn.textContent = 'Hapus Semua Siswa';
                                delete btn.dataset.confirming;
                                btn.classList.replace('bg-yellow-500', 'bg-red-600');
                                btn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
                            }
                        }, 4000);
                    }
                });
            }
            if (downloadTemplateBtn) {
                downloadTemplateBtn.addEventListener('click', () => {
                    const btn = downloadTemplateBtn;
                    btn.disabled = true;
                    btn.textContent = 'Membuat Template...';
                    google.script.run
                        .withSuccessHandler(result => {
                            btn.disabled = false;
                            btn.textContent = 'Download Template';
                            if (result.base64Data) {
                                const link = document.createElement('a');
                                link.href = `data:${result.mimeType};base64,${result.base64Data}`;
                                link.download = result.fileName;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                showGlobalStatus('Template berhasil diunduh.', true);
                            } else {
                                showGlobalStatus('Gagal membuat template: ' + (result.error || 'Unknown error'), false);
                            }
                        })
                        .withFailureHandler(error => {
                            showGlobalStatus('Error: ' + error.message, false);
                            btn.disabled = false;
                            btn.textContent = 'Download Template';
                        })
                        .generateSiswaTemplate();
                });
            }
            if (siswaFileInput) {
                siswaFileInput.addEventListener('change', () => {
                    const file = siswaFileInput.files[0];
                    if (file) {
                        fileNameSpan.textContent = file.name;
                        importSiswaBtn.disabled = false;
                    } else {
                        fileNameSpan.textContent = 'Tidak ada file dipilih';
                        importSiswaBtn.disabled = true;
                    }
                });
            }
            if (importSiswaBtn) {
                importSiswaBtn.addEventListener('click', () => {
                    const file = siswaFileInput.files[0];
                    if (!file) {
                        showGlobalStatus('Silakan pilih file untuk diimpor.', false);
                        return;
                    }
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        const fileData = {
                            fileName: file.name,
                            mimeType: file.type,
                            content: reader.result.split(',')[1]
                        };
                        importStatusDiv.innerHTML = '<p class="text-blue-600 loading-animation">Mengimpor data</p>';
                        importSiswaBtn.disabled = true;
                        importSiswaBtn.textContent = 'Mengimpor...';
                        google.script.run
                            .withSuccessHandler(response => {
                                importSiswaBtn.disabled = true;
                                importSiswaBtn.textContent = 'Import Data';
                                
                                const fileNameSpan = document.getElementById('fileName');
                                fileNameSpan.textContent = 'Tidak ada file dipilih';
                                siswaFileInput.value = '';

                                const importStatusDiv = document.getElementById('importStatus');
                                
                                // [MODIFIKASI] Tampilkan notifikasi pop-up global terlebih dahulu
                                if (response.status !== 'error') {
                                    const summaryMessage = `Impor Selesai: ${response.newCount || 0} baru, ${response.enrichedCount || 0} diperkaya, ${response.conflictCount || 0} konflik.`;
                                    showGlobalStatus(summaryMessage, true);
                                } else {
                                    showGlobalStatus(response.message, false);
                                }

                                // Bangun dan tampilkan laporan detail di bawah tombol impor
                                let reportHtml = `<div class="p-4 border rounded-md bg-gray-50 mt-4">`;

                                if (response.status === 'error') {
                                    reportHtml += `<p class="text-red-600 font-bold">${response.message}</p>`;
                                } else {
                                    reportHtml += `<strong class="text-lg">Rincian Hasil Impor:</strong><ul class="list-disc list-inside mt-2 space-y-1">`;
                                    if (response.newCount > 0) reportHtml += `<li class="text-green-700">${response.newCount} siswa baru berhasil ditambahkan.</li>`;
                                    if (response.enrichedCount > 0) reportHtml += `<li class="text-blue-700">${response.enrichedCount} data siswa berhasil diperkaya (data kosong telah diisi otomatis).</li>`;
                                    if (response.skippedCount > 0) reportHtml += `<li class="text-yellow-700">${response.skippedCount} data duplikat (data identik atau duplikat di file) dilewati.</li>`;
                                    
                                    if (response.conflictCount > 0) {
                                        currentImportConflicts = response.conflicts;
                                        reportHtml += `<li class="text-red-700">${response.conflictCount} data terdeteksi memiliki NISN yang sama namun data berbeda (konflik).</li></ul>`;
                                        
                                        // Kode untuk menampilkan tabel konflik (tidak diubah, sudah bagus)
                                        reportHtml += `<div id="conflict-section" class="mt-4 border-t pt-4">
                                            <h4 class="font-bold text-lg">Tinjau Konflik Data</h4>
                                            <div class="my-2"><input type="checkbox" id="selectAllConflicts" class="mr-2"><label for="selectAllConflicts">Pilih Semua</label></div>
                                            <div class="max-h-60 overflow-y-auto border rounded-md">
                                                <table class="min-w-full text-sm">
                                                    <thead class="bg-gray-200 sticky top-0"><tr><th class="p-2">Pilih</th><th class="p-2 text-left">NISN (Klik untuk Detail)</th><th class="p-2 text-left">Nama Lama</th><th class="p-2 text-left">Nama Baru</th></tr></thead>
                                                    <tbody>`;
                                        currentImportConflicts.forEach((c, index) => {
                                            reportHtml += `<tr class="border-b" data-conflict-index="${index}">
                                                <td class="p-2 text-center"><input type="checkbox" class="conflict-checkbox"></td>
                                                <td class="p-2 font-mono"><a href="#" class="text-blue-600 hover:underline conflict-detail-link" data-index="${index}">${c.nisn}</a></td>
                                                <td class="p-2">${c.oldData.nama}</td>
                                                <td class="p-2 text-green-700">${c.newData.nama}</td>
                                            </tr>`;
                                        });
                                        reportHtml += `</tbody></table></div>
                                            <div class="mt-4 flex space-x-3">
                                                <button id="updateSelectedBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Update yang Dipilih</button>
                                                <button id="updateAllBtn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Update Semua Konflik</button>
                                                <button id="cancelImportUpdateBtn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Batal & Tutup</button>
                                            </div>
                                        </div>`;
                                    } else {
                                        reportHtml += `</ul>`;
                                    }
                                }
                                reportHtml += `</div>`;
                                importStatusDiv.innerHTML = reportHtml; // Tampilkan laporan

                                // [MODIFIKASI] Kode yang menghilangkan pesan secara otomatis dihapus agar laporan tetap terlihat.

                                // Muat ulang data siswa jika ada data baru atau diperkaya
                                if (response.newCount > 0 || response.enrichedCount > 0) {
                                    loadStudentsData();
                                }

                                // Pasang event listener untuk fungsionalitas di dalam laporan (jika ada konflik)
                                if (response.conflictCount > 0) {
                                    setupConflictDetailListeners();
                                    // (kode event listener untuk tombol update dan batal tidak perlu diubah)
                                    document.getElementById('selectAllConflicts').onchange = (e) => {
                                        document.querySelectorAll('.conflict-checkbox').forEach(cb => cb.checked = e.target.checked);
                                    };

                                    const handleBatchUpdate = (selectedIndices) => {
                                        if (selectedIndices.length === 0) {
                                            showGlobalStatus("Tidak ada data yang dipilih untuk diupdate.", false);
                                            return;
                                        }

                                        const studentsToUpdate = selectedIndices.map(index => {
                                            const conflict = response.conflicts[index];
                                            return { ...conflict.newData, studentRow: conflict.rowToUpdate };
                                        });

                                        showGlobalStatus(`Mengupdate ${studentsToUpdate.length} data...`, true);
                                        google.script.run
                                            .withSuccessHandler(res => {
                                                showGlobalStatus(res.message, res.status === 'success');
                                                const importStatusDiv = document.getElementById('importStatus');
                                                importStatusDiv.innerHTML = `<p class="p-4 bg-green-100 text-green-800 rounded-md">${res.message}. Halaman data siswa akan dimuat ulang.</p>`;
                                                setTimeout(loadStudentsData, 1500);
                                                // [MODIFIKASI] Sembunyikan pesan sukses setelah 5 detik
                                                setTimeout(() => {
                                                    if (importStatusDiv) {
                                                        // Buat efek menghilang (fade out) sebelum menghapus
                                                        importStatusDiv.style.transition = 'opacity 0.5s ease';
                                                        importStatusDiv.style.opacity = '0';
                                                        setTimeout(() => {
                                                            importStatusDiv.innerHTML = '';
                                                            importStatusDiv.style.opacity = '1'; // Reset opacity untuk penggunaan berikutnya
                                                        }, 500); // Hapus setelah transisi selesai
                                                    }
                                                }, 8000); // Pesan akan hilang setelah 5 detik
                                            })
                                            .withFailureHandler(err => showGlobalStatus("Gagal update massal: " + err.message, false))
                                            .batchUpdateStudents(userSpreadsheetId, studentsToUpdate);
                                    };
                                    
                                    document.getElementById('updateSelectedBtn').onclick = () => {
                                        const selectedIndices = [];
                                        document.querySelectorAll('.conflict-checkbox:checked').forEach(cb => {
                                            const index = cb.closest('tr').dataset.conflictIndex;
                                            selectedIndices.push(parseInt(index));
                                        });
                                        handleBatchUpdate(selectedIndices);
                                    };

                                    document.getElementById('updateAllBtn').onclick = () => {
                                        const allIndices = response.conflicts.map((_, index) => index);
                                        handleBatchUpdate(allIndices);
                                    };

                                    // [BARU] Event listener untuk tombol batal
                                    document.getElementById('cancelImportUpdateBtn').onclick = () => {
                                        document.getElementById('importStatus').innerHTML = ''; // Cukup kosongkan div status
                                        showGlobalStatus("Proses update dari file dibatalkan.", true);
                                    };
                                }
                            })
                            .withFailureHandler(error => {
                                showGlobalStatus('Error: ' + error.message, false);
                                // [MODIFIKASI] Tombol kembali nonaktif jika terjadi error
                                importSiswaBtn.disabled = true; 
                                importSiswaBtn.textContent = 'Import Data';
                                fileNameSpan.textContent = 'Tidak ada file dipilih';
                                siswaFileInput.value = '';
                                importStatusDiv.innerHTML = `<p class="text-red-600">${error.message}</p>`;
                            })
                            .importFromExcel(userSpreadsheetId, fileData, 'Data Siswa');
                    };
                    reader.onerror = (error) => {
                        showGlobalStatus('Gagal membaca file.', false);
                    };
                });
            }


            if (siswaForm) {
                siswaForm.addEventListener('submit', e => {
                    e.preventDefault();
                    const saveBtn = document.getElementById('saveSiswaBtn');
                    const originalBtnText = saveBtn.textContent;

                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Menyimpan';
                    saveBtn.classList.add('loading-animation');

                    const studentData = Object.fromEntries(new FormData(e.target).entries());
                    const handler = studentData.studentRow ? 'updateStudent' : 'addStudent';

                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.status === 'success') {
                                closeSiswaModal();
                                loadStudentsData();
                            } else if (response.status === 'conflict') {
                                // JIKA ADA KONFLIK, TAMPILKAN MODAL KONFIRMASI
                                closeSiswaModal(); // Tutup modal tambah/edit dulu
                                displayConflictModal(response.oldData, response.newData);
                            } else {
                                // Untuk status 'error' atau 'duplicate'
                                showGlobalStatus(response.message, false);
                            }
                            saveBtn.disabled = false;
                            saveBtn.textContent = originalBtnText;
                            saveBtn.classList.remove('loading-animation');
                        })
                        .withFailureHandler(error => {
                            showGlobalStatus(error.message, false);
                            saveBtn.disabled = false;
                            saveBtn.textContent = originalBtnText;
                            saveBtn.classList.remove('loading-animation');
                        })[handler](userSpreadsheetId, studentData);
                });
            }

            // Tambahkan fungsi baru untuk menampilkan modal konflik
            function displayConflictModal(oldData, newData) {
                document.getElementById('conflictNisn').textContent = oldData.nisn;

                // Fungsi helper untuk membuat tampilan data
                const createDataHtml = (data) => `
                    <p><strong>Nama:</strong> ${data.nama}</p>
                    <p><strong>NIS:</strong> ${data.nis || '-'}</p>
                    <p><strong>Tempat Lahir:</strong> ${toProperCase(data.tempatLahir) || '-'}</p>
                    <p><strong>Tgl Lahir:</strong> ${formatIndonesianDate(data.tanggalLahir) || '-'}</p>
                `;

                document.getElementById('old-data-display').innerHTML = createDataHtml(oldData);
                document.getElementById('new-data-display').innerHTML = createDataHtml(newData);

                const modal = document.getElementById('update-confirm-modal');
                modal.classList.remove('hidden');
                
                // Fungsi untuk menutup modal
                const closeModal = () => modal.classList.add('hidden');
                document.getElementById('cancelUpdateBtn').onclick = closeModal;

                // Logika saat tombol "Ya, Update Data" diklik
                document.getElementById('confirmUpdateBtn').onclick = () => {
                    const studentUpdateData = { ...newData, studentRow: oldData.row };
                    
                    showGlobalStatus('Mengirim permintaan update...', true);
                    google.script.run
                        .withSuccessHandler(res => {
                            showGlobalStatus(res.message, res.status === 'success');
                            if (res.status === 'success') {
                                loadStudentsData();
                            }
                        })
                        .withFailureHandler(err => showGlobalStatus('Gagal update: ' + err.message, false))
                        .updateStudent(userSpreadsheetId, studentUpdateData);
                    
                    closeModal();
                };
            }

          /**
           * [FINAL] Fungsi untuk mengambil data siswa dari server.
           * Tugasnya kini hanya mengambil data, menyimpannya ke variabel global,
           * dan memanggil fungsi renderSiswaTable untuk menampilkannya.
           */
          function loadStudentsData() {
              const container = document.getElementById('siswaTableContainer');
              container.innerHTML = `<p class="text-center text-gray-500 py-4">Memuat data siswa...</p>`;
              
              google.script.run
                  .withSuccessHandler(students => {
                      // Simpan data asli ke variabel global untuk digunakan oleh fitur pencarian
                      allStudentsData = students || []; 
                      // Panggil fungsi render untuk menampilkan semua data saat pertama kali dimuat
                      renderSiswaTable(allStudentsData); 
                  })
                  .withFailureHandler(err => {
                      container.innerHTML = `<p class="text-center text-red-500 py-4">Gagal memuat data: ${err.message}</p>`;
                  })
                  .getStudents(userSpreadsheetId);
          }

          /**
          * [FINAL] Fungsi untuk menampilkan data siswa ke dalam tabel HTML.
          * Fungsi ini bisa dipanggil berulang kali untuk menampilkan data lengkap atau data hasil filter.
          * @param {Array<object>} studentsToRender - Array data siswa yang ingin ditampilkan.
          */
          function renderSiswaTable(studentsToRender) {
              const container = document.getElementById('siswaTableContainer');
              container.innerHTML = ''; // Selalu kosongkan kontainer sebelum menampilkan data baru

              if (studentsToRender && studentsToRender.length > 0) {
                  const table = document.createElement('table');
                  table.className = 'min-w-full divide-y divide-gray-200';
                  table.innerHTML = `<thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Lengkap</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TEMPAT, TANGGAL LAHIR</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody class="bg-white divide-y divide-gray-200"></tbody>`;
                  
                  const tbody = table.querySelector('tbody');
                  studentsToRender.forEach(s => {
                      const tr = document.createElement('tr');

                      // 1. Format tanggal lahir dengan fungsi baru yang lebih tangguh
                      const formattedDate = formatIndonesianDate(s.tanggalLahir);

                      // 2. Siapkan variabel tempat dan tanggal secara terpisah
                      const tempat = toProperCase(s.tempatLahir || '');
                      const tanggal = formattedDate || '';

                      // 3. Gabungkan keduanya dengan logika yang jelas
                      let ttl = ''; // TTL: Tempat, Tanggal Lahir
                      if (tempat && tanggal) {
                          ttl = `${tempat}, ${tanggal}`;
                      } else if (tempat) {
                          ttl = tempat;
                      } else if (tanggal) {
                          ttl = tanggal;
                      } else {
                          // Jika keduanya kosong, tampilkan placeholder
                          ttl = `<em class="text-gray-400">(data kosong)</em>`;
                      }
                      
                      // 4. Masukkan hasil `ttl` yang sudah bersih ke dalam tabel
                      tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${s.nisn}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 nama-siswa-cell">${s.nama.toUpperCase()}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ttl}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="text-indigo-600 hover:text-indigo-900" data-action="edit">Edit</button><button class="text-red-600 hover:text-red-900 ml-4" data-action="delete">Hapus</button></td>`;
                      
                      // Pasang event listener
                      tr.querySelector('[data-action="edit"]').addEventListener('click', () => handleEditStudent(s));
                      tr.querySelector('[data-action="delete"]').addEventListener('click', (e) => handleDeleteStudent(s, e.target));
                      
                      tbody.appendChild(tr);
                  });
                  
                  container.appendChild(table);
              } else {
                  // Tampilkan pesan ini jika tidak ada siswa sama sekali ATAU tidak ada hasil pencarian
                  container.innerHTML = `<p class="text-center text-gray-500 py-4">Belum ada data siswa atau data tidak ditemukan.</p>`;
              }
          }

          /**
          * [FINAL] Fungsi untuk menyiapkan modal saat tombol 'Edit' diklik.
          * @param {object} student Objek data siswa yang akan diedit.
          */
          function handleEditStudent(student) {
              const siswaModalTitle = document.getElementById('siswa-modal-title');
              const studentRowInput = document.getElementById('studentRow');

              siswaModalTitle.textContent = "Edit Data Siswa";
              studentRowInput.value = student.row;
              
              document.getElementById('nama').value = student.nama;
              document.getElementById('nisn').value = student.nisn;
              document.getElementById('nis').value = student.nis;
              document.getElementById('jenisKelamin').value = student.jenisKelamin;
              document.getElementById('tempatLahir').value = toProperCase(student.tempatLahir);
              document.getElementById('tanggalLahir').value = student.tanggalLahir;
              // [PERBAIKAN] Menggunakan ID yang sudah unik
              document.getElementById('alamatSiswa').value = student.alamat || '';
              document.getElementById('teleponSiswa').value = student.telepon || '';
              document.getElementById('emailSiswa').value = student.emailSiswa || '';
              document.getElementById('tahunMasuk').value = student.tahunMasuk || '';
              document.getElementById('tahunLulus').value = student.tahunLulus || '';

              openSiswaModal();
          }

          /**
          * [FINAL] Fungsi untuk menangani penghapusan data siswa.
          * @param {object} student - Objek data siswa yang akan dihapus.
          * @param {HTMLElement} targetButton - Elemen tombol hapus yang diklik.
          */
          function handleDeleteStudent(student, targetButton) {
              if (targetButton.dataset.confirming) {
                  google.script.run
                      .withSuccessHandler(response => {
                          showGlobalStatus(response.message, response.status === 'success');
                          if (response.status === 'success') loadStudentsData();
                      })
                      .withFailureHandler(err => showGlobalStatus(err.message, false))
                      .deleteStudent(userSpreadsheetId, student.row);
              } else {
                  targetButton.textContent = 'Yakin?';
                  targetButton.dataset.confirming = true;
                  targetButton.classList.add('text-yellow-500', 'hover:text-yellow-700');
                  targetButton.classList.remove('text-red-600', 'hover:text-red-900');
                  
                  setTimeout(() => {
                      if (targetButton.dataset.confirming) {
                          targetButton.textContent = 'Hapus';
                          delete targetButton.dataset.confirming;
                          targetButton.classList.remove('text-yellow-500', 'hover:text-yellow-700');
                          targetButton.classList.add('text-red-600', 'hover:text-red-900');
                      }
                  }, 3000);
              }
          }

            // --- MAPEL & BOBOT FUNCTIONS ---
            const bobotUjianInput = document.getElementById('bobotUjian');
            const bobotRaporInput = document.getElementById('bobotRapor');
            const bobotForm = document.getElementById('bobotForm');

            function syncBobot(source, target) {
                source.addEventListener('input', () => {
                    const sourceVal = parseInt(source.value, 10);
                    if (!isNaN(sourceVal) && sourceVal >= 0 && sourceVal <= 100) target.value = 100 - sourceVal;
                    else if (source.value === '') target.value = '';
                    else if (sourceVal > 100) {
                        source.value = 100;
                        target.value = 0;
                    }
                });
            }
            if (bobotUjianInput && bobotRaporInput) {
                syncBobot(bobotUjianInput, bobotRaporInput);
                syncBobot(bobotRaporInput, bobotUjianInput);
            }
            if (bobotForm) {
                bobotForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const saveBtn = e.currentTarget.querySelector('button[type="submit"]');
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Menyimpan...';
                    const bobotData = {
                        bobotUjian: bobotUjianInput.value,
                        bobotRapor: bobotRaporInput.value
                    };
                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            saveBtn.disabled = false;
                            saveBtn.textContent = 'Simpan Bobot';
                        })
                        .withFailureHandler(err => {
                            showGlobalStatus('Gagal menyimpan bobot: ' + err.message, false);
                            saveBtn.disabled = false;
                            saveBtn.textContent = 'Simpan Bobot';
                        })
                        .saveBobot(userSpreadsheetId, bobotData);
                });
            }

            function loadBobotData() {
                google.script.run
                    .withSuccessHandler(data => {
                        if (data) {
                            bobotUjianInput.value = data.bobotUjian || '';
                            bobotRaporInput.value = data.bobotRapor || '';
                        }
                    })
                    .getBobot(userSpreadsheetId);
            }

            const addMapelBtn = document.getElementById('addMapelBtn');
            const mapelModal = document.getElementById('mapel-modal');
            const closeMapelModalBtn = document.getElementById('closeMapelModalBtn');
            const cancelMapelBtn = document.getElementById('cancelMapelBtn');
            const mapelForm = document.getElementById('mapelForm');
            const mapelModalTitle = document.getElementById('mapel-modal-title');
            const mapelRowInput = document.getElementById('mapelRow');
            const downloadMapelTemplateBtn = document.getElementById('downloadMapelTemplateBtn');
            const importMapelBtn = document.getElementById('importMapelBtn');
            const mapelFileInput = document.getElementById('mapelFileInput');
            const mapelFileNameSpan = document.getElementById('mapelFileName');
            const importMapelStatusDiv = document.getElementById('importMapelStatus');
            const importMapelSystemBtn = document.getElementById('importMapelSystemBtn');
            const deleteAllMapelBtn = document.getElementById('deleteAllMapelBtn');

            const openMapelModal = () => {
                mapelModal.classList.remove('hidden');
                setTimeout(() => mapelModal.style.opacity = '1', 10);
            };
            const closeMapelModal = () => {
                mapelModal.style.opacity = '0';
                setTimeout(() => mapelModal.classList.add('hidden'), 300);
            };
            if (addMapelBtn) {
                addMapelBtn.addEventListener('click', () => {
                    mapelForm.reset();
                    mapelRowInput.value = '';
                    mapelModalTitle.textContent = "Tambah Mata Pelajaran";
                    openMapelModal();
                });
                closeMapelModalBtn.addEventListener('click', closeMapelModal);
                cancelMapelBtn.addEventListener('click', closeMapelModal);
            }
            if (deleteAllMapelBtn) {
                deleteAllMapelBtn.addEventListener('click', function() {
                    const btn = this;
                    if (btn.dataset.confirming) {
                        btn.disabled = true;
                        btn.textContent = 'Menghapus...';
                        google.script.run
                            .withSuccessHandler(response => {
                                showGlobalStatus(response.message, response.status === 'success');
                                if (response.status === 'success') {
                                    loadMapelData();
                                }
                                btn.disabled = false;
                                btn.textContent = 'Hapus Semua Mapel';
                                delete btn.dataset.confirming;
                                // [MODIFIKASI] Kembalikan warna tombol ke merah
                                btn.classList.replace('bg-yellow-500', 'bg-red-600');
                                btn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
                            })
                            .withFailureHandler(err => {
                                showGlobalStatus('Error: ' + err.message, false);
                                btn.disabled = false;
                                btn.textContent = 'Hapus Semua Mapel';
                                delete btn.dataset.confirming;
                                // [MODIFIKASI] Kembalikan warna tombol ke merah
                                btn.classList.replace('bg-yellow-500', 'bg-red-600');
                                btn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
                            })
                            .deleteAllMapel(userSpreadsheetId);
                    } else {
                        btn.dataset.confirming = 'true';
                        btn.textContent = 'YAKIN? KLIK LAGI';
                        btn.classList.replace('bg-red-600', 'bg-yellow-500');
                        btn.classList.replace('hover:bg-red-700', 'hover:bg-yellow-600');

                        setTimeout(() => {
                            if (btn.dataset.confirming) {
                                btn.textContent = 'Hapus Semua Mapel';
                                delete btn.dataset.confirming;
                                btn.classList.replace('bg-yellow-500', 'bg-red-600');
                                btn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
                            }
                        }, 4000);
                    }
                });
            }
            if (importMapelSystemBtn) {
                importMapelSystemBtn.addEventListener('click', function() {
                    const btn = this;
                    const btnText = document.getElementById('importMapelSystemBtnText');
                    const spinner = document.getElementById('importMapelSystemSpinner');

                    btn.disabled = true;
                    btnText.classList.add('hidden');
                    spinner.classList.remove('hidden');

                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.newCount > 0 || response.status === 'success') {
                                loadMapelData();
                            }
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .withFailureHandler(err => {
                            showGlobalStatus('Error: ' + err.message, false);
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .importMapelBySystem(userSpreadsheetId);
                });
            }

            function loadMapelData() {
                const container = document.getElementById('mapelTableContainer');
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Memuat data mapel...</p>`;
                google.script.run
                    .withSuccessHandler(mapelList => {
                        if (mapelList && mapelList.length > 0) {
                            const table = document.createElement('table');
                            table.className = 'min-w-full divide-y divide-gray-200';
                            table.innerHTML = `<thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Mata Pelajaran</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jenis Ujian</th><th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody class="bg-white divide-y divide-gray-200"></tbody>`;
                            const tbody = table.querySelector('tbody');
                            mapelList.forEach(m => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${m.kode}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 nama-siswa-cell">${m.nama}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${m.jenisUjian}</td><td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="text-indigo-600 hover:text-indigo-900" data-action="edit">Edit</button><button class="text-red-600 hover:text-red-900 ml-4" data-action="delete">Hapus</button></td>`;
                                tr.querySelector('[data-action="edit"]').addEventListener('click', () => handleEditMapel(m));
                                tr.querySelector('[data-action="delete"]').addEventListener('click', (e) => handleDeleteMapel(m, e.target));
                                tbody.appendChild(tr);
                            });
                            container.innerHTML = '';
                            container.appendChild(table);
                        } else {
                            container.innerHTML = `<p class="text-center text-gray-500 py-4">Belum ada data mata pelajaran.</p>`;
                        }
                    })
                    .withFailureHandler(err => {
                        container.innerHTML = `<p class="text-center text-red-500 py-4">Gagal memuat data: ${err.message}</p>`;
                    })
                    .getMapel(userSpreadsheetId);
            }

            // --- DENGAN KUMPULAN KODE BARU INI ---

            // Variabel baru untuk tabel mapel
            const mapelInputTbody = document.getElementById('mapel-input-tbody');
            const addMapelRowBtn = document.getElementById('addMapelRowBtn');
            const saveAllMapelBtn = document.getElementById('saveAllMapelBtn');

            // Fungsi untuk membuat satu baris input mapel
            function createMapelInputRow() {
                const tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `
                    <td class="p-1"><input type="text" name="kode" class="w-full p-2 border rounded-md" required></td>
                    <td class="p-1"><input type="text" name="nama" class="w-full p-2 border rounded-md" required></td>
                    <td class="p-1">
                        <select name="kelompok" class="w-full p-2 border rounded-md bg-white">
                            <option>Umum</option><option>Peminatan</option><option>Muatan Lokal</option>
                        </select>
                    </td>
                    <td class="p-1">
                        <select name="jenisUjian" class="w-full p-2 border rounded-md bg-white">
                            <option>Ujian Madrasah</option><option>Ujian Praktek</option><option>Keduanya</option>
                        </select>
                    </td>
                    <td class="p-1 text-center">
                        <button type="button" class="delete-mapel-row text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
                    </td>
                `;
                // Tambahkan event listener untuk tombol hapus baris ini
                tr.querySelector('.delete-mapel-row').addEventListener('click', () => {
                    tr.remove();
                });
                return tr;
            }

            // Event listener untuk membuka modal dan menyiapkan baris pertama
            if (addMapelBtn) {
                addMapelBtn.addEventListener('click', () => {
                    // Kosongkan tabel dan tambahkan satu baris baru setiap kali modal dibuka
                    mapelInputTbody.innerHTML = '';
                    mapelInputTbody.appendChild(createMapelInputRow());
                    
                    mapelModalTitle.textContent = "Tambah Mata Pelajaran Massal";
                    openMapelModal();
                });
            }

            // Event listener untuk tombol "+ Tambah Baris"
            if (addMapelRowBtn) {
                addMapelRowBtn.addEventListener('click', () => {
                    mapelInputTbody.appendChild(createMapelInputRow());
                });
            }

            // Event listener untuk menyimpan SEMUA mapel dari tabel
            if (saveAllMapelBtn) {
                saveAllMapelBtn.addEventListener('click', () => {
                    const rows = mapelInputTbody.querySelectorAll('tr');
                    const mapelArray = [];
                    let hasError = false;

                    rows.forEach(row => {
                        const kodeInput = row.querySelector('input[name="kode"]');
                        const namaInput = row.querySelector('input[name="nama"]');
                        const kode = kodeInput.value.trim();
                        const nama = namaInput.value.trim();

                        // Validasi sederhana di frontend
                        if (!kode || !nama) {
                            kodeInput.style.borderColor = !kode ? 'red' : '';
                            namaInput.style.borderColor = !nama ? 'red' : '';
                            hasError = true;
                        } else {
                            kodeInput.style.borderColor = '';
                            namaInput.style.borderColor = '';
                            mapelArray.push({
                                kode: kode,
                                nama: nama,
                                kelompok: row.querySelector('select[name="kelompok"]').value,
                                jenisUjian: row.querySelector('select[name="jenisUjian"]').value
                            });
                        }
                    });

                    if (hasError) {
                        showGlobalStatus("Kode Mapel dan Nama Mapel tidak boleh kosong.", false);
                        return;
                    }

                    if (mapelArray.length === 0) {
                        showGlobalStatus("Tidak ada data mapel untuk disimpan.", false);
                        return;
                    }
                    
                    const btn = saveAllMapelBtn;
                    const btnText = document.getElementById('saveAllMapelBtnText');
                    const spinner = document.getElementById('saveAllMapelSpinner');

                    btn.disabled = true;
                    btnText.classList.add('hidden');
                    spinner.classList.remove('hidden');

                    // Panggil fungsi backend BARU: `addMultipleMapel`
                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.status === 'success') {
                                closeMapelModal();
                                loadMapelData();
                            }
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .withFailureHandler(error => {
                            showGlobalStatus(error.message, false);
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .addMultipleMapel(userSpreadsheetId, mapelArray);
                });
            }

            // [MODIFIKASI] Mengembalikan fungsi edit mapel dengan modal terpisah

            // Dapatkan elemen dari modal edit yang baru
            const editMapelModal = document.getElementById('edit-mapel-modal');
            const editMapelForm = document.getElementById('editMapelForm');
            const closeEditMapelModalBtn = document.getElementById('closeEditMapelModalBtn');
            const cancelEditMapelBtn = document.getElementById('cancelEditMapelBtn');

            // Fungsi untuk menutup modal edit
            const closeEditMapelModal = () => {
                editMapelModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => editMapelModal.classList.add('hidden'), 300);
            };

            // Pasang event listener untuk tombol tutup dan batal pada modal edit
            closeEditMapelModalBtn.addEventListener('click', closeEditMapelModal);
            cancelEditMapelBtn.addEventListener('click', closeEditMapelModal);


            // Fungsi handleEditMapel yang baru: Buka modal dan isi data
            function handleEditMapel(mapel) {
                // Isi form dengan data dari mapel yang dipilih
                document.getElementById('mapelRowEdit').value = mapel.row;
                document.getElementById('kodeEdit').value = mapel.kode;
                document.getElementById('namaMapelEdit').value = mapel.nama;
                document.getElementById('kelompokEdit').value = mapel.kelompok;

                // Set radio button yang sesuai untuk jenis ujian
                const radioBtn = document.querySelector(`input[name="jenisUjian"][value="${mapel.jenisUjian}"]`);
                if (radioBtn) {
                    radioBtn.checked = true;
                } else {
                    // Jika jenisUjian kosong, set default ke Ujian Madrasah
                    document.getElementById('jenisUjianMadrasahEdit').checked = true;
                }

                // Tampilkan modal
                editMapelModal.classList.remove('hidden');
                setTimeout(() => {
                    editMapelModal.querySelector('.modal-content').style.transform = 'scale(1)';
                }, 10);
            }

            // Event listener untuk form edit saat di-submit
            editMapelForm.addEventListener('submit', e => {
                e.preventDefault();
                const saveBtn = document.getElementById('saveEditMapelBtn');
                const originalBtnText = saveBtn.textContent;

                saveBtn.disabled = true;
                saveBtn.textContent = 'Menyimpan...';
                
                // Ambil data dari form. Kita gunakan FormData untuk cara yang mudah.
                const mapelData = Object.fromEntries(new FormData(e.target).entries());
                
                // Panggil fungsi backend 'updateMapel' yang sudah ada
                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        if (response.status === 'success') {
                            closeEditMapelModal();
                            loadMapelData(); // Muat ulang tabel mapel
                        }
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalBtnText;
                    })
                    .withFailureHandler(error => {
                        showGlobalStatus(error.message, false);
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalBtnText;
                    })
                    .updateMapel(userSpreadsheetId, mapelData);
            });

            function handleDeleteMapel(mapel, targetButton) {
                if (targetButton.dataset.confirming) {
                    google.script.run
                        .withSuccessHandler(response => {
                            showGlobalStatus(response.message, response.status === 'success');
                            if (response.status === 'success') loadMapelData();
                        })
                        .withFailureHandler(err => showGlobalStatus(err.message, false))
                        .deleteMapel(userSpreadsheetId, mapel.row);
                } else {
                    targetButton.textContent = 'Yakin?';
                    targetButton.dataset.confirming = true;
                    targetButton.classList.add('text-yellow-500', 'hover:text-yellow-700');
                    targetButton.classList.remove('text-red-600', 'hover:text-red-900');
                    setTimeout(() => {
                        if (targetButton.dataset.confirming) {
                            targetButton.textContent = 'Hapus';
                            delete targetButton.dataset.confirming;
                            targetButton.classList.remove('text-yellow-500', 'hover:text-yellow-700');
                            targetButton.classList.add('text-red-600', 'hover:text-red-900');
                        }
                    }, 3000);
                }
            }

            // --- INPUT NILAI FUNCTIONS ---
            document.getElementById('btn-show-ujian-madrasah').addEventListener('click', () => buildScoreTable('madrasah', 'Tabel Input Nilai Ujian Madrasah'));
            document.getElementById('btn-show-ujian-praktek').addEventListener('click', () => buildScoreTable('praktek', 'Tabel Input Nilai Ujian Praktek'));
            document.getElementById('btn-cek-rata-ujian').addEventListener('click', calculateUjianAverage);

            // GANTI SELURUH FUNGSI LAMA ANDA DENGAN VERSI BARU INI

            function buildScoreTable(jenis, title) {
                const container = document.getElementById('input-ujian-container');
                // [MODIFIKASI] Langsung tampilkan loader di kontainer utama
                container.innerHTML = `
                    <div class="text-center p-8">
                        <p class="font-bold loading-animation">Memuat data untuk tabel nilai</p>
                        <p>Silakan tunggu sebentar...</p>
                    </div>`;

                const sheetName = jenis === 'madrasah' ? 'Nilai Ujian Madrasah' : 'Nilai Ujian Praktek';

                Promise.all([
                    new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getStudents(userSpreadsheetId)),
                    new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getMapelByJenis(userSpreadsheetId, jenis)),
                    new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, sheetName))
                ]).then(([students, mapelList, existingScores]) => {
                    
                    // Hapus pesan loading
                    container.innerHTML = ''; 

                    if (!students || students.length === 0) {
                        container.innerHTML = `<p class="text-center text-red-500 p-4">Data siswa tidak ditemukan. Harap isi data siswa terlebih dahulu.</p>`;
                        return;
                    }
                    if (!mapelList || mapelList.length === 0) {
                        container.innerHTML = `<p class="text-center text-red-500 p-4">Tidak ada mata pelajaran yang ditandai untuk Ujian ${jenis}. Silahkan edit dan ubah Jenis Ujian pada Mata Pelajaran.</p>`;
                        return;
                    }

                    // [MODIFIKASI UTAMA] Buat satu pembungkus utama dengan style yang diinginkan
                    const mainWrapper = document.createElement('div');
                    mainWrapper.className = 'bg-white p-6 rounded-lg shadow-md'; // <-- Style kotak putih seperti di halaman rapor

                    const tableHtml = `
                        <h2 class="text-2xl font-bold text-gray-800">${title}</h2>
                        <p class="mt-1 mb-4 text-gray-600">Silahkan masukkan nilai Ujian Madrasah/Praktek atau gunakan copy paste jika nilai sudah ada.</p>
                        <form id="form-nilai-${jenis}">
                            <div class="overflow-x-auto">
                                <table id="score-table-${jenis}" class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                      <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                                        ${mapelList.map(m => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-Rata</th>
                                      </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                      ${students.map((s, index) => {
                                          const studentScores = existingScores[s.nisn] || {};
                                          let rowHtml = `<tr data-nisn="${s.nisn}" data-nama="${s.nama.toUpperCase()}"><td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${index + 1}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${s.nisn}</td><td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 nama-siswa-cell">${s.nama.toUpperCase()}</td>`;
                                          mapelList.forEach(m => {
                                              rowHtml += `<td class="px-2 py-1"><input type="number" min="0" max="100" class="score-input p-1 border rounded-md" data-mapel-kode="${m.kode}" value="${studentScores[m.kode] ?? ''}"></td>`;
                                          });
                                          rowHtml += `<td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell jumlah-nilai">0</td><td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell rata-rata-nilai">0.00</td></tr>`;
                                          return rowHtml;
                                      }).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-6 pt-4 border-t flex justify-end space-x-3">
                                <button type="button" class="clear-scores-btn bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Bersihkan</button>
                                <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Simpan Nilai ${jenis}</button>
                            </div>
                        </form>
                    `;
                    
                    mainWrapper.innerHTML = tableHtml;
                    container.appendChild(mainWrapper);

                    // Pasang semua event listener setelah konten ditambahkan ke DOM
                    const scoreTable = document.getElementById(`score-table-${jenis}`);
                    scoreTable.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
                    scoreTable.addEventListener('input', handleScoreInput);
                    scoreTable.addEventListener('paste', handleSmartPaste);
                    document.getElementById(`form-nilai-${jenis}`).addEventListener('submit', (e) => handleSaveNilai(e, jenis));
                    mainWrapper.querySelector('.clear-scores-btn').addEventListener('click', (e) => {
                        const form = e.target.closest('form');
                        form.querySelectorAll('.score-input').forEach(input => input.value = '');
                        form.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
                    });

                }).catch(err => {
                    container.innerHTML = `<p class="text-center text-red-500 p-4">Terjadi kesalahan saat memuat data: ${err.message}</p>`;
                });
            }

            function handleSaveNilai(event, jenisUjian) {
                event.preventDefault();
                const form = event.target;
                const saveBtn = form.querySelector('button[type="submit"]');
                saveBtn.disabled = true;
                saveBtn.textContent = 'Menyimpan...';
                const allRows = form.querySelectorAll('tbody tr');
                const nilaiData = [];
                allRows.forEach(row => {
                    const studentScores = {
                        nisn: row.dataset.nisn,
                        nama: row.dataset.nama,
                        scores: {}
                    };
                    const inputs = row.querySelectorAll('.score-input');
                    inputs.forEach(input => {
                        studentScores.scores[input.dataset.mapelKode] = input.value;
                    });
                    nilaiData.push(studentScores);
                });
                google.script.run
                    .withSuccessHandler(response => {
                        showGlobalStatus(response.message, response.status === 'success');
                        saveBtn.disabled = false;
                        saveBtn.textContent = `Simpan Nilai ${jenisUjian}`;
                    })
                    .withFailureHandler(err => {
                        showGlobalStatus(`Gagal menyimpan: ${err.message}`, false);
                        saveBtn.disabled = false;
                        saveBtn.textContent = `Simpan Nilai ${jenisUjian}`;
                    })
                    .saveNilai(userSpreadsheetId, {
                        jenis: jenisUjian,
                        nilai: nilaiData
                    });
            }

            function initRaporPage() {
                const container = document.getElementById('rapor-container');
                container.innerHTML = '<p>Memeriksa data sekolah...</p>';
                google.script.run
                    .withSuccessHandler(schoolData => {
                        if (!schoolData || !schoolData.jenjang) {
                            container.innerHTML = `<div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">Harap atur <b>Jenjang Sekolah</b> di halaman <a href="#" onclick="document.querySelector('[data-page=data-sekolah]').click()" class="font-bold underline">Data Sekolah</a> terlebih dahulu.</div>`;
                            return;
                        }
                        const jenjang = schoolData.jenjang;
                        const semesterList = semesters[jenjang];
                        let html = '';
                        for (const key in semesterList) {
                            // [PERBAIKAN UTAMA ADA DI SINI]
                            // Memastikan semua tombol dibungkus oleh div dengan class yang benar untuk layout
                            html += `
                                <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
                                    <h3 class="text-xl font-bold text-gray-700">${semesterList[key]}</h3>
                                    <div class="flex flex-wrap gap-4 mt-3">
                                        <button onclick="buildRaporScoreTable('${key}', 'Pengetahuan')" class="bg-sky-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-600 text-sm">Input Nilai Pengetahuan</button>
                                        <button onclick="buildRaporScoreTable('${key}', 'Keterampilan')" class="bg-teal-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-600 text-sm">Input Nilai Keterampilan</button>
                                        <button onclick="calculateRaporAverage('${key}')" class="bg-amber-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-amber-600 text-sm">Cek Rata-Rata Nilai</button>
                                        <button class="delete-rapor-semester-btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 text-sm" data-semester-key="${key}" data-semester-name="${semesterList[key]}">Hapus Data Semester Ini</button>
                                    </div>
                                    <div id="table-container-${key}" class="mt-4"></div>
                                </div>
                            `;
                        }
                        container.innerHTML = html;
                    })
                    .getSchoolData(userSpreadsheetId);
            }

            // GANTI FUNGSI LAMA ANDA DENGAN VERSI BARU INI

            function calculateUjianAverage() {
                const container = document.getElementById('input-ujian-container');
                container.innerHTML = `<div class="text-center p-8"><p class="font-bold loading-animation">Menghitung rata-rata</p><p>Silakan tunggu...</p></div>`;

                Promise.all([
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getStudents(userSpreadsheetId)),
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getMapel(userSpreadsheetId)),
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, 'Nilai Ujian Madrasah')),
                    new Promise(resolve => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, 'Nilai Ujian Praktek'))
                ]).then(([students, allMapel, nilaiMadrasah, nilaiPraktek]) => {
                    
                    container.innerHTML = ''; 

                    if (!students || students.length === 0) {
                        container.innerHTML = `<p class="text-red-500 text-center p-4">Data siswa tidak ditemukan.</p>`;
                        return;
                    }
                    if (!allMapel || allMapel.length === 0) {
                        container.innerHTML = `<p class="text-red-500 text-center p-4">Data mata pelajaran tidak ditemukan.</p>`;
                        return;
                    }

                    const mainWrapper = document.createElement('div');
                    mainWrapper.className = 'bg-white p-6 rounded-lg shadow-md mt-4';

                    // [MODIFIKASI] Menambahkan kelas CSS border dan kolom baru "Pembulatan"
                    let tableHtml = `
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Tabel Rata-Rata Nilai Ujian</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="border border-gray-300 px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">No</th>
                                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">NISN</th>
                                        <th class="border border-gray-300 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                                        ${allMapel.map(m => `<th class="border border-gray-300 px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}
                                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-Rata</th>
                                        <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Pembulatan</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                    
                    students.forEach((student, index) => {
                        // [MODIFIKASI] Menambahkan kelas border pada setiap <td>
                        tableHtml += `<tr>
                                        <td class="border border-gray-300 px-3 py-2 text-sm text-center">${index + 1}</td>
                                        <td class="border border-gray-300 px-4 py-2 text-sm text-center">${student.nisn}</td>
                                        <td class="border border-gray-300 px-4 py-2 text-sm font-medium nama-siswa-cell">${student.nama.toUpperCase()}</td>`;
                        
                        const studentScores = [];
                        allMapel.forEach(mapel => {
                            const nilaiM = parseFloat((nilaiMadrasah[student.nisn] || {})[mapel.kode]);
                            const nilaiP = parseFloat((nilaiPraktek[student.nisn] || {})[mapel.kode]);
                            
                            let avgScore = null;
                            const hasM = !isNaN(nilaiM);
                            const hasP = !isNaN(nilaiP);

                            if (hasM && hasP) avgScore = (nilaiM + nilaiP) / 2;
                            else if (hasM) avgScore = nilaiM;
                            else if (hasP) avgScore = nilaiP;

                            studentScores.push(avgScore);
                            tableHtml += `<td class="border border-gray-300 px-2 py-1 text-center average-score-cell">${avgScore !== null ? Math.round(avgScore) : '-'}</td>`;
                        });

                        const validScores = studentScores.filter(s => s !== null);
                        const total = validScores.reduce((sum, score) => sum + score, 0);
                        const count = validScores.length;
                        const average = count > 0 ? (total / count) : 0;
                        
                        // [MODIFIKASI] Menambahkan kolom pembulatan
                        const roundedAverage = Math.round(average);

                        tableHtml += `<td class="border border-gray-300 px-4 py-2 text-center font-bold">${Math.round(total)}</td>
                                      <td class="border border-gray-300 px-4 py-2 text-center font-bold">${average.toFixed(2)}</td>
                                      <td class="border border-gray-300 px-4 py-2 text-center font-bold text-blue-600">${roundedAverage}</td>
                                    </tr>`;
                    });

                    tableHtml += `</tbody></table></div>`;
                    
                    mainWrapper.innerHTML = tableHtml;
                    container.appendChild(mainWrapper);

                }).catch(err => {
                    container.innerHTML = `<p class="text-red-500 text-center p-4">Gagal memuat data rata-rata: ${err.message}</p>`;
                });
            }

            // --- REKAPITULASI FUNCTIONS ---
            function initRekapitulasiPage() {
                const loader = document.getElementById('rekap-loader');
                const content = document.getElementById('rekap-content');
                const setupDiv = document.getElementById('rekap-setup');
                const displayArea = document.getElementById('rekap-display-area');

                loader.classList.remove('hidden');
                content.classList.add('hidden');
                setupDiv.classList.add('hidden');
                displayArea.innerHTML = '';

                google.script.run
                    .withSuccessHandler(sheetsExist => {
                        if (sheetsExist) {
                            // Panggil fungsi baru yang sudah dioptimasi
                            google.script.run
                                .withSuccessHandler(response => {
                                    if (response.status === 'success') {
                                        rekapitulasiData = response.data; // Ambil data dari properti 'data'
                                        loader.classList.add('hidden');
                                        content.classList.remove('hidden');
                                        const activeBtn = document.querySelector('.rekap-btn.active') || document.querySelector('[data-rekap="ijazah"]');
                                        activeBtn.click();
                                    } else {
                                        loader.classList.add('hidden');
                                        showGlobalStatus('Error: ' + response.message, false);
                                    }
                                })
                                .getRekapitulasiData_Optimized(userSpreadsheetId); // Panggil fungsi baru
                        } else {
                            loader.classList.add('hidden');
                            setupDiv.classList.remove('hidden');
                        }
                    })
                    .checkRekapSheetsExist(userSpreadsheetId);
            }

            document.querySelectorAll('.rekap-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.rekap-btn').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    const type = e.currentTarget.dataset.rekap;
                    if (rekapitulasiData) displayRekap(type, rekapitulasiData);
                });
            });

            document.getElementById('updateRekapBtn')?.addEventListener('click', function() {
                const btn = this;
                const btnText = document.getElementById('updateRekapBtnText');
                const spinner = document.getElementById('updateRekapSpinner');

                btn.disabled = true;
                btnText.classList.add('hidden');
                spinner.classList.remove('hidden');

                google.script.run
                    .withSuccessHandler(response => {
                        if (response.status === 'success') {
                            showGlobalStatus(response.message, true);
                            initRekapitulasiPage();
                        } else {
                            showGlobalStatus(response.message, false);
                        }
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    })
                    .withFailureHandler(err => {
                        showGlobalStatus('Gagal memperbarui: ' + err.message, false);
                        btn.disabled = false;
                        btnText.classList.remove('hidden');
                        spinner.classList.add('hidden');
                    })
                    .updateRekapitulasi(userSpreadsheetId);
            });

            function displayRekap(type, rekapData) {
                const { students, mapel, bobot, rekapUjian, rekapRapor, rekapIjazah } = rekapData;
                const displayArea = document.getElementById('rekap-display-area');
                
                let dataToShow;
                let title;
                let subtitleHtml = '';
                
                const mapelCount = (mapel || []).length;

                switch (type) {
                    case 'ujian':
                        dataToShow = rekapUjian;
                        title = 'Rekapitulasi Nilai Ujian';
                        subtitleHtml = `<p class="text-sm font-normal text-gray-600 mt-1">Jumlah Mata Pelajaran: <strong>${mapelCount}</strong></p>`;
                        break;
                    case 'rapor':
                        dataToShow = rekapRapor;
                        title = 'Rekapitulasi Nilai Rapor';
                        subtitleHtml = `<p class="text-sm font-normal text-gray-600 mt-1">Jumlah Mata Pelajaran: <strong>${mapelCount}</strong></p>`;
                        break;
                    case 'ijazah':
                    default:
                        dataToShow = rekapIjazah;
                        title = 'Rekapitulasi Nilai Ijazah';
                        if (bobot) {
                            subtitleHtml = `<p class="text-sm font-normal text-gray-600 mt-1">
                                Bobot Ujian: <strong>${bobot.bobotUjian}%</strong> | 
                                Bobot Rapor: <strong>${bobot.bobotRapor}%</strong> | 
                                Jumlah Mata Pelajaran: <strong>${mapelCount}</strong>
                            </p>`;
                        }
                        break;
                }

                let tableHtml = `<div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-start flex-wrap gap-2">
                        <div>
                            <h3 class="text-xl font-bold">${title}</h3>
                            ${subtitleHtml}
                        </div>
                        <div class="flex space-x-2">
                            <button id="showExportModalButton" data-rekap-type="${type}" class="bg-blue-600 text-white font-medium py-2 px-3 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center space-x-1.5 text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 btn-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                <span class="btn-text">Pengaturan & Ekspor</span>
                                <span class="btn-spinner hidden loading-animation">Memuat...</span>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto mt-4">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-300 px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">No</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">NISN</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                                    ${mapel.map(m => `<th class="border border-gray-300 px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}
                                    <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-rata</th>
                                    ${type === 'ujian' ? '<th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Pembulatan</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>`;

                if (students && students.length > 0) {
                    students.forEach((student, index) => {
                        const scores = dataToShow[student.nisn] || {};
                        let total = 0;
                        
                        let rowHtml = `<tr>
                                        <td class="border border-gray-300 px-3 py-2 text-center">${index + 1}</td>
                                        <td class="border border-gray-300 px-4 py-2 text-center">${student.nisn}</td>
                                        <td class="border border-gray-300 px-4 py-2 nama-siswa-cell">${student.nama.toUpperCase()}</td>`;

                        mapel.forEach(m => {
                            const rawScore = parseFloat(scores[m.kode] || 0);
                            const roundedScore = Math.round(rawScore);
                            total += roundedScore;
                            rowHtml += `<td class="border border-gray-300 text-center">${roundedScore}</td>`;
                        });

                        const average = mapel.length > 0 ? (total / mapel.length) : 0;
                        
                        rowHtml += `<td class="border border-gray-300 text-center font-bold">${total}</td>
                                    <td class="border border-gray-300 text-center font-bold">${average.toFixed(2).replace('.', ',')}</td>`;
                        
                        if (type === 'ujian') {
                            const roundedAverage = Math.round(average);
                            rowHtml += `<td class="border border-gray-300 text-center font-bold text-blue-600">${roundedAverage}</td>`;
                        }
                        
                        rowHtml += `</tr>`;
                        tableHtml += rowHtml;
                    });
                }

                tableHtml += `</tbody></table></div></div>`;
                displayArea.innerHTML = tableHtml;

                document.getElementById('showExportModalButton')?.addEventListener('click', function() {
                    const btn = this;
                    const btnIcon = btn.querySelector('.btn-icon');
                    const btnText = btn.querySelector('.btn-text');
                    const spinner = btn.querySelector('.btn-spinner');
                    btn.disabled = true;
                    btnIcon.classList.add('hidden');
                    btnText.textContent = '';
                    spinner.classList.remove('hidden');
                    const rekapType = this.dataset.rekapType;
                    document.getElementById('exportForm').dataset.rekapType = rekapType;
                    const savedOptions = JSON.parse(localStorage.getItem('exportOptions'));
                    google.script.run
                        .withSuccessHandler(schoolData => {
                            btn.disabled = false;
                            btnIcon.classList.remove('hidden');
                            btnText.textContent = 'Pengaturan & Ekspor';
                            spinner.classList.add('hidden');
                            document.getElementById('exportNamaSekolah').value = schoolData.namaSekolah || '';
                            document.getElementById('exportNamaKamad').value = schoolData.namaKepsek || '';
                            document.getElementById('exportNip').value = schoolData.nipKepsek || '';
                            const tahunAjaranSelect = document.getElementById('exportTahunAjaran');
                            tahunAjaranSelect.innerHTML = '';
                            const currentYear = new Date().getFullYear();
                            const years = [`${currentYear - 2}/${currentYear - 1}`, `${currentYear - 1}/${currentYear}`, `${currentYear}/${currentYear + 1}`, `${currentYear + 1}/${currentYear + 2}`, `${currentYear + 2}/${currentYear + 3}`];
                            years.forEach(year => {
                                const option = document.createElement('option');
                                option.value = year;
                                option.textContent = year;
                                tahunAjaranSelect.appendChild(option);
                            });
                            if (savedOptions) {
                                tahunAjaranSelect.value = savedOptions.tahunAjaran || years[2];
                                document.getElementById('exportTempatTTD').value = savedOptions.tempatTTD || '';
                                document.getElementById('exportTanggalTTD').value = savedOptions.tanggalTTD || new Date().toISOString().split('T')[0];
                                document.getElementById('exportTipeKamad').value = savedOptions.tipeKamad || 'Kepala Madrasah';
                            } else {
                                tahunAjaranSelect.value = years[2];
                                document.getElementById('exportTanggalTTD').valueAsDate = new Date();
                            }
                            document.getElementById('export-modal').classList.remove('hidden');
                        })
                        .withFailureHandler(error => {
                            btn.disabled = false;
                            btnIcon.classList.remove('hidden');
                            btnText.textContent = 'Pengaturan & Ekspor';
                            spinner.classList.add('hidden');
                            showGlobalStatus('Gagal memuat pengaturan: ' + error.message, false);
                        })
                        .getSchoolData(userSpreadsheetId);
                });
            }

            // GANTI LAGI SELURUH BLOK EVENT LISTENER INI DI DALAM FUNGSI initializeApp()

            const changePasswordForm = document.getElementById('changePasswordForm');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    const currentPassword = document.getElementById('current-password').value;
                    const newPassword = document.getElementById('new-password-change').value;
                    const confirmPassword = document.getElementById('confirm-password-change').value;
                    const statusDiv = document.getElementById('changePasswordStatusMessage');
                    
                    const showStatus = (message, isSuccess, isHtml = false) => {
                        if (isHtml) {
                            statusDiv.innerHTML = message;
                        } else {
                            statusDiv.textContent = message;
                        }
                        statusDiv.className = `mt-6 p-4 rounded-md text-center transition-opacity duration-300 ${isSuccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                        statusDiv.style.opacity = '1';
                    };

                    // Mengosongkan pesan error sebelumnya
                    statusDiv.innerHTML = '';
                    statusDiv.style.opacity = '0';

                    if (!currentPassword || !newPassword || !confirmPassword) {
                        showStatus('Semua kolom wajib diisi.', false);
                        return;
                    }

                    if (newPassword !== confirmPassword) {
                        showStatus('Password baru dan konfirmasi tidak cocok.', false);
                        return;
                    }

                    const passwordErrors = validatePassword(newPassword);
                    if (passwordErrors.length > 0) {
                        let errorHtml = '<strong class="block text-center">Password baru belum memenuhi syarat:</strong><ul class="list-disc list-inside text-left mt-1 text-sm">';
                        passwordErrors.forEach(error => {
                            errorHtml += `<li>${error}</li>`;
                        });
                        errorHtml += '</ul>';
                        showStatus(errorHtml, false, true);
                        return;
                    }

                    const btn = document.getElementById('changePasswordBtn');
                    const btnText = document.getElementById('changePasswordBtnText');
                    const spinner = document.getElementById('changePasswordSpinner');
                    btn.disabled = true;
                    btnText.classList.add('hidden');
                    spinner.classList.remove('hidden');

                    const email = sessionStorage.getItem('userEmail');
                    if (!email) {
                        showStatus('Sesi tidak valid, silakan login ulang.', false);
                        logoutUser();
                        return;
                    }

                    google.script.run
                        .withSuccessHandler(response => {
                            showStatus(response.message, response.status === 'success');
                            if (response.status === 'success') {
                                changePasswordForm.reset();
                                // Sembunyikan pesan sukses setelah beberapa detik
                                setTimeout(() => { statusDiv.style.opacity = '0'; }, 5000);
                            }
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .withFailureHandler(error => {
                            showStatus('Error: ' + error.message, false);
                            btn.disabled = false;
                            btnText.classList.remove('hidden');
                            spinner.classList.add('hidden');
                        })
                        .changeUserPassword(email, currentPassword, newPassword);
                });
            }

            // Letakkan ini di dalam fungsi initializeApp()

            const deleteAllUjianScoresBtn = document.getElementById('deleteAllUjianScoresBtn');
            if (deleteAllUjianScoresBtn) {
                deleteAllUjianScoresBtn.addEventListener('click', function() {
                    const btn = this;
                    if (btn.dataset.confirming) {
                        btn.disabled = true;
                        btn.textContent = 'Menghapus...';

                        google.script.run
                            .withSuccessHandler(response => {
                                showGlobalStatus(response.message, response.status !== 'error');
                                btn.disabled = false;
                                btn.textContent = 'Hapus Semua Nilai Ujian';
                                delete btn.dataset.confirming;
                            })
                            .withFailureHandler(err => {
                                showGlobalStatus('Gagal: ' + err.message, false);
                                btn.disabled = false;
                                btn.textContent = 'Hapus Semua Nilai Ujian';
                                delete btn.dataset.confirming;
                            })
                            .deleteAllUjianScores(userSpreadsheetId);

                    } else {
                        btn.dataset.confirming = 'true';
                        btn.textContent = 'YAKIN? KLIK LAGI UNTUK HAPUS';
                        const originalColor = 'bg-red-600';
                        const hoverColor = 'hover:bg-red-700';
                        btn.classList.remove(originalColor, hoverColor);
                        btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');

                        setTimeout(() => {
                            if (btn.dataset.confirming) {
                                delete btn.dataset.confirming;
                                btn.textContent = 'Hapus Semua Nilai Ujian';
                                btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                                btn.classList.add(originalColor, hoverColor);
                            }
                        }, 4000); // Reset setelah 4 detik
                    }
                });
            }

            // Letakkan ini juga di dalam fungsi initializeApp()

            const raporContainer = document.getElementById('rapor-container');
            if (raporContainer) {
                raporContainer.addEventListener('click', function(event) {
                    // Cek apakah yang diklik adalah tombol hapus kita
                    if (event.target.classList.contains('delete-rapor-semester-btn')) {
                        const btn = event.target;
                        const semesterKey = btn.dataset.semesterKey;
                        const semesterName = btn.dataset.semesterName;

                        if (btn.dataset.confirming) {
                            btn.disabled = true;
                            btn.textContent = 'Menghapus...';

                            google.script.run
                                .withSuccessHandler(response => {
                                    showGlobalStatus(response.message, response.status !== 'error');
                                    btn.disabled = false;
                                    btn.textContent = 'Hapus Data Semester Ini';
                                    delete btn.dataset.confirming;
                                })
                                .withFailureHandler(err => {
                                    showGlobalStatus('Gagal: ' + err.message, false);
                                    btn.disabled = false;
                                    btn.textContent = 'Hapus Data Semester Ini';
                                    delete btn.dataset.confirming;
                                })
                                .deleteAllRaporScoresBySemester(userSpreadsheetId, semesterKey);

                        } else {
                            btn.dataset.confirming = 'true';
                            btn.textContent = `YAKIN HAPUS DATA ${semesterName.toUpperCase()}?`;
                            const originalColor = 'bg-red-600';
                            const hoverColor = 'hover:bg-red-700';
                            btn.classList.remove(originalColor, hoverColor);
                            btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');

                            setTimeout(() => {
                                if (btn.dataset.confirming) {
                                    delete btn.dataset.confirming;
                                    btn.textContent = 'Hapus Data Semester Ini';
                                    btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                                    btn.classList.add(originalColor, hoverColor);
                                }
                            }, 4000);
                        }
                    }
                });
            }
        }

        /**
         * Mengubah string menjadi format Proper Case (Setiap Kata Diawali Huruf Besar).
         * @param {string} str - Teks yang akan diubah.
         * @returns {string} Teks dalam format Proper Case.
         */
        function toProperCase(str) {
          if (!str || typeof str !== 'string') return '';
          return str.replace(/\w\S*/g, function(txt) {
            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
          });
        }

        function formatIndonesianDate(dateInput) {
            // Jika input kosong, null, atau undefined, langsung kembalikan string kosong
            if (!dateInput) {
                return "";
            }

            // Coba buat objek Date dari input. Ini bisa menangani string "YYYY-MM-DD" atau objek Date
            const date = new Date(dateInput);

            // Periksa apakah tanggal yang dihasilkan valid.
            // `getTime()` akan menghasilkan NaN untuk tanggal yang tidak valid.
            if (isNaN(date.getTime())) {
                return ""; // Kembalikan string kosong jika tanggal tidak valid
            }

            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            
            // Gunakan getUTCDate, dll. untuk menghindari masalah pergeseran tanggal karena timezone
            const day = date.getUTCDate();
            const monthIndex = date.getUTCMonth();
            const year = date.getUTCFullYear();

            // Hindari menampilkan tanggal epoch "1 Januari 1970"
            if (year === 1970 && monthIndex === 0 && day === 1) {
                return "";
            }

            return `${day} ${months[monthIndex]} ${year}`;
        }
        
        function handleSaveRapor(event, semesterKey, jenisNilai) {
            event.preventDefault();
            const form = event.target;
            const saveBtn = form.querySelector('button[type="submit"]');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Menyimpan...';
            const allRows = form.querySelectorAll('tbody tr');
            const nilaiData = [];
            allRows.forEach(row => {
                const studentScores = { nisn: row.dataset.nisn, nama: row.dataset.nama, scores: {} };
                row.querySelectorAll('.score-input').forEach(input => {
                    studentScores.scores[input.dataset.mapelKode] = input.value;
                });
                nilaiData.push(studentScores);
            });
            google.script.run
                .withSuccessHandler(response => {
                    showGlobalStatus(response.message, response.status === 'success');
                    saveBtn.disabled = false;
                    saveBtn.textContent = `Simpan Nilai ${jenisNilai}`;
                })
                .withFailureHandler(err => {
                    showGlobalStatus(`Gagal menyimpan: ${err.message}`, false);
                    saveBtn.disabled = false;
                    saveBtn.textContent = `Simpan Nilai ${jenisNilai}`;
                })
                .saveNilaiRapor(userSpreadsheetId, { semesterKey, jenisNilai, nilai: nilaiData });
        }

        function buildRaporScoreTable(semesterKey, jenisNilai) {
            const container = document.getElementById(`table-container-${semesterKey}`);
            container.innerHTML = `<div class="text-center p-8"><p class="font-bold loading-animation">Memuat data</p></div>`;
            const sheetName = `Rapor_${jenisNilai}_${semesterKey}`;
            Promise.all([
                new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getStudents(userSpreadsheetId)),
                new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getMapel(userSpreadsheetId)),
                new Promise((resolve) => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, sheetName))
            ]).then(([students, mapelList, existingScores]) => {
                if (!students || students.length === 0) {
                    container.innerHTML = `<p class="text-center text-red-500 p-4">Data siswa tidak ditemukan.</p>`; return;
                }
                if (!mapelList || mapelList.length === 0) {
                    container.innerHTML = `<p class="text-center text-red-500 p-4">Data mata pelajaran tidak ditemukan.</p>`; return;
                }
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'p-4 border rounded-lg';
                tableWrapper.innerHTML = `<h4 class="text-lg font-semibold mb-3">Tabel Nilai ${jenisNilai}</h4><p class="text-sm mt-1 mb-3 text-gray-600">Silahkan masukkan nilai rapor atau gunakan copy paste semua nilai rapor dari hasil ledger excel yang didapat pada Aplikasi Rapor Digital Madrasah (RDM).</p><form id="form-${sheetName}"><div class="overflow-x-auto"><table id="score-table-${sheetName}" class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">No</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>${mapelList.map(m => `<th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th><th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-Rata</th></tr></thead><tbody class="bg-white divide-y divide-gray-200"></tbody></table></div><div class="mt-6 pt-4 border-t flex justify-end space-x-3"><button type="button" class="clear-scores-btn bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400">Bersihkan</button><button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Simpan Nilai ${jenisNilai}</button></div></form>`;
                const tbody = tableWrapper.querySelector('tbody');
                students.forEach((s, index) => {
                    const studentScores = existingScores[s.nisn] || {};
                    let rowHtml = `<tr data-nisn="${s.nisn}" data-nama="${s.nama.toUpperCase()}"><td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500">${index + 1}</td><td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">${s.nisn}</td><td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900 nama-siswa-cell">${s.nama.toUpperCase()}</td>`;
                    mapelList.forEach(m => {
                        rowHtml += `<td class="px-2 py-1"><input type="number" min="0" max="100" class="score-input p-1 border rounded-md" data-mapel-kode="${m.kode}" value="${studentScores[m.kode] ?? ''}"></td>`;
                    });
                    rowHtml += `<td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell jumlah-nilai">0</td><td class="px-4 py-2 whitespace-nowrap text-sm text-center text-gray-800 total-cell rata-rata-nilai">0.00</td></tr>`;
                    tbody.innerHTML += rowHtml;
                });
                container.innerHTML = '';
                container.appendChild(tableWrapper);
                const scoreTable = document.getElementById(`score-table-${sheetName}`);
                scoreTable.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
                scoreTable.addEventListener('input', handleScoreInput);
                scoreTable.addEventListener('paste', handleSmartPaste);
                document.getElementById(`form-${sheetName}`).addEventListener('submit', (e) => handleSaveRapor(e, semesterKey, jenisNilai));
                tableWrapper.querySelector('.clear-scores-btn').addEventListener('click', (e) => {
                    const form = e.target.closest('form');
                    form.querySelectorAll('.score-input').forEach(input => input.value = '');
                    form.querySelectorAll('tbody tr').forEach(row => updateRowTotals(row));
                });
            });
        }

        // GANTI SELURUH FUNGSI LAMA ANDA DENGAN VERSI FINAL INI

        function calculateRaporAverage(semesterKey) {
            const container = document.getElementById(`table-container-${semesterKey}`);
            container.innerHTML = `<div class="text-center p-8"><p class="font-bold loading-animation">Menghitung rata-rata</p><p>Silakan tunggu...</p></div>`;
            
            const sheetNameP = `Rapor_Pengetahuan_${semesterKey}`;
            const sheetNameK = `Rapor_Keterampilan_${semesterKey}`;

            Promise.all([
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getStudents(userSpreadsheetId)),
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getMapel(userSpreadsheetId)),
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, sheetNameP)),
                new Promise(resolve => google.script.run.withSuccessHandler(resolve).getExistingNilai(userSpreadsheetId, sheetNameK))
            ]).then(([students, mapelList, nilaiPengetahuan, nilaiKeterampilan]) => {
                if (!students || students.length === 0) { container.innerHTML = `<p class="text-red-500 text-center p-4">Data siswa tidak ditemukan.</p>`; return; }
                if (!mapelList || mapelList.length === 0) { container.innerHTML = `<p class="text-red-500 text-center p-4">Data mata pelajaran tidak ditemukan.</p>`; return; }
                
                const tableWrapper = document.createElement('div');
                tableWrapper.className = 'bg-white p-6 rounded-lg shadow-md'; 

                let tableHtml = `
                    <h4 class="text-2xl font-bold text-gray-800 mb-4">Tabel Rata-Rata Nilai</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="border border-gray-300 px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">No</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">NISN</th>
                                    <th class="border border-gray-300 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Siswa</th>
                                    ${mapelList.map(m => `<th class="border border-gray-300 px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase" title="${m.nama}">${m.kode}</th>`).join('')}
                                    <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Jumlah</th>
                                    <th class="border border-gray-300 px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Rata-Rata</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                // [PERBAIKAN] Logika kalkulasi dipindahkan ke dalam loop ini
                students.forEach((student, index) => {
                    let rowInitialHtml = `<tr>
                                            <td class="border border-gray-300 px-3 py-2 text-sm text-center">${index + 1}</td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm text-center">${student.nisn}</td>
                                            <td class="border border-gray-300 px-4 py-2 text-sm font-medium nama-siswa-cell">${student.nama.toUpperCase()}</td>`;
                    
                    let scoresForThisRow = [];      // 1. Buat array kosong untuk menampung nilai per baris
                    let scoreCellsHtml = '';        // String untuk menampung HTML sel nilai per baris
                    
                    mapelList.forEach(mapel => {
                        const nilaiP = parseFloat((nilaiPengetahuan[student.nisn] || {})[mapel.kode]);
                        const nilaiK = parseFloat((nilaiKeterampilan[student.nisn] || {})[mapel.kode]);
                        
                        let avgScore = null;
                        const hasP = !isNaN(nilaiP);
                        const hasK = !isNaN(nilaiK);

                        if (hasP && hasK) avgScore = (nilaiP + nilaiK) / 2;
                        else if (hasP) avgScore = nilaiP;
                        else if (hasK) avgScore = nilaiK;
                        
                        scoresForThisRow.push(avgScore); // 2. Simpan nilai numerik ke array per baris
                        
                        // 3. Simpan HTML sel ke string sementara
                        scoreCellsHtml += `<td class="border border-gray-300 px-2 py-1 text-center average-score-cell">${avgScore !== null ? Math.round(avgScore) : '-'}</td>`;
                    });

                    // 4. Hitung total & rata-rata dari array yang benar (hanya untuk baris ini)
                    const validScores = scoresForThisRow.filter(s => s !== null);
                    const total = validScores.reduce((sum, score) => sum + score, 0);
                    const average = validScores.length > 0 ? (total / validScores.length) : 0;

                    // 5. Gabungkan semua bagian HTML menjadi satu baris utuh
                    const rowTotalsHtml = `<td class="border border-gray-300 px-4 py-2 text-center font-bold">${Math.round(total)}</td>
                                          <td class="border border-gray-300 px-4 py-2 text-center font-bold">${average.toFixed(2)}</td>`;

                    tableHtml += rowInitialHtml + scoreCellsHtml + rowTotalsHtml + `</tr>`;
                });

                tableHtml += `</tbody></table></div>`;
                
                container.innerHTML = '';
                tableWrapper.innerHTML = tableHtml;
                container.appendChild(tableWrapper);

            }).catch(err => {
                container.innerHTML = `<p class="text-red-500 text-center p-4">Gagal memuat data rata-rata: ${err.message}</p>`;
            });
        }

        const semesters = {
            MI: { k4_ganjil: 'Kelas 4 Ganjil', k4_genap: 'Kelas 4 Genap', k5_ganjil: 'Kelas 5 Ganjil', k5_genap: 'Kelas 5 Genap', k6_ganjil: 'Kelas 6 Ganjil' },
            MTS: { k7_ganjil: 'Kelas 7 Ganjil', k7_genap: 'Kelas 7 Genap', k8_ganjil: 'Kelas 8 Ganjil', k8_genap: 'Kelas 8 Genap', k9_ganjil: 'Kelas 9 Ganjil' },
            MA: { k10_ganjil: 'Kelas 10 Ganjil', k10_genap: 'Kelas 10 Genap', k11_ganjil: 'Kelas 11 Ganjil', k11_genap: 'Kelas 11 Genap', k12_ganjil: 'Kelas 12 Ganjil' }
        };

        function showGlobalStatus(message, isSuccess) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `toast-notification ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            statusDiv.innerHTML = message; // innerHTML agar bisa menampilkan format tebal
            document.getElementById('globalStatusMessage').appendChild(statusDiv);

            setTimeout(() => {
                statusDiv.remove();
            }, 4000); // Disesuaikan dengan durasi animasi CSS
        }

        function updateRowTotals(rowElement) {
            const inputs = rowElement.querySelectorAll('.score-input, .average-score-cell');
            let total = 0;
            let count = 0;
            inputs.forEach(input => {
                const value = parseFloat(input.value || input.textContent);
                if (!isNaN(value)) { total += value; count++; }
            });
            const average = count > 0 ? (total / count).toFixed(2) : '0.00';
            const totalCell = rowElement.querySelector('.jumlah-nilai');
            const avgCell = rowElement.querySelector('.rata-rata-nilai');
            if (totalCell) totalCell.textContent = Math.round(total);
            if (avgCell) avgCell.textContent = average;
        }

        function handleScoreInput(event) {
            if (event.target.classList.contains('score-input')) {
                updateRowTotals(event.target.closest('tr'));
            }
        }

        function handleSmartPaste(event) {
            if (!event.target.classList.contains('score-input')) return;
            event.preventDefault();
            const pastedText = (event.clipboardData || window.clipboardData).getData('text');
            const pastedRows = pastedText.split(/\r?\n/).filter(r => r).map(row => row.split('\t'));
            const tableBody = event.target.closest('tbody');
            if (!tableBody) return;
            const allTableRows = Array.from(tableBody.querySelectorAll('tr'));
            const startRowElement = event.target.closest('tr');
            const startRowIndex = allTableRows.indexOf(startRowElement);
            const allRowInputs = Array.from(startRowElement.querySelectorAll('.score-input'));
            const startColIndex = allRowInputs.indexOf(event.target);
            pastedRows.forEach((rowData, r_offset) => {
                const targetRow = allTableRows[startRowIndex + r_offset];
                if (targetRow) {
                    const targetRowInputs = Array.from(targetRow.querySelectorAll('.score-input'));
                    rowData.forEach((cellData, c_offset) => {
                        const targetInput = targetRowInputs[startColIndex + c_offset];
                        if (targetInput) targetInput.value = cellData.trim();
                    });
                    updateRowTotals(targetRow);
                }
            });
        }

        // File: Index.html (di dalam <script>)

        // Fungsi untuk memasang event listener pada link NISN
        function setupConflictDetailListeners() {
            document.querySelectorAll('.conflict-detail-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const index = e.target.dataset.index;
                    showConflictDetail(index);
                });
            });
        }

        // Fungsi untuk menampilkan modal dengan data perbandingan
        function showConflictDetail(index) {
            const conflict = currentImportConflicts[index];
            if (!conflict) return;

            const oldDataContainer = document.getElementById('conflict-old-data');
            const newDataContainer = document.getElementById('conflict-new-data');

            // Helper untuk membandingkan dan memberi highlight
            const createFieldHtml = (label, oldValue, newValue) => {
                const isDifferent = oldValue !== newValue;
                const highlightClass = isDifferent ? 'bg-yellow-100 p-2 rounded-md' : 'p-2';
                return `
                    <div class="field-pair">
                        <p><strong>${label}:</strong></p>
                        <div class="${highlightClass}">${oldValue || '<em>(kosong)</em>'}</div>
                        <div class="${highlightClass}">${newValue || '<em>(kosong)</em>'}</div>
                    </div>
                `;
            };
            
            // Format data untuk ditampilkan
            const formatData = (data) => ({
                'Nama Lengkap': data.nama,
                'NISN': data.nisn,
                'NIS': data.nis,
                'Jenis Kelamin': data.jenisKelamin,
                'Tempat Lahir': toProperCase(data.tempatLahir),
                'Tanggal Lahir': formatIndonesianDate(data.tanggalLahir),
                'Alamat Lengkap': data.alamat,
                'Nomor Telepon': data.telepon,
                'Email Siswa': data.emailSiswa,
                'Tahun Masuk': data.tahunMasuk,
                'Tahun Lulus': data.tahunLulus
            });
            
            const oldF = formatData(conflict.oldData);
            const newF = formatData(conflict.newData);

            let oldHtml = '';
            let newHtml = '';

            // Loop melalui setiap field untuk dibandingkan
            for (const key in oldF) {
                const isDifferent = (oldF[key] || '') !== (newF[key] || '');
                const highlightClass = isDifferent ? 'bg-yellow-200 font-bold p-2 rounded' : 'p-2';
                
                oldHtml += `<div class="${highlightClass} mb-2"><strong>${key}:</strong><br>${oldF[key] || '<em>(kosong)</em>'}</div>`;
                newHtml += `<div class="${highlightClass} mb-2"><strong>${key}:</strong><br>${newF[key] || '<em>(kosong)</em>'}</div>`;
            }

            oldDataContainer.innerHTML = oldHtml;
            newDataContainer.innerHTML = newHtml;

            // Tampilkan modal
            const modal = document.getElementById('conflict-detail-modal');
            modal.classList.remove('hidden');

            // Pasang event listener untuk tombol tutup
            document.getElementById('closeConflictDetailModalBtn').onclick = () => modal.classList.add('hidden');
            document.getElementById('closeConflictDetailModalBtn2').onclick = () => modal.classList.add('hidden');
        }

        /**
         * [BARU] Menampilkan validasi password secara real-time di bawah input.
         * @param {HTMLInputElement} passwordInput - Elemen input password pertama.
         * @param {HTMLElement} requirementsContainer - Elemen div untuk menampilkan daftar kriteria.
         */
        function setupRealtimePasswordValidation(passwordInput, requirementsContainer) {
            const requirements = [
                { regex: /.{8,}/, text: "Minimal 8 karakter" },
                { regex: /[A-Z]/, text: "Minimal satu huruf besar (A-Z)" },
                { regex: /[a-z]/, text: "Minimal satu huruf kecil (a-z)" },
                { regex: /[0-9]/, text: "Minimal satu angka (0-9)" },
                { regex: /[^A-Za-z0-9]/, text: "Minimal satu karakter spesial (!@#$)" }
            ];

            const icon_check = `<svg class="w-4 h-4 inline-block mr-1 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            const icon_cross = `<svg class="w-4 h-4 inline-block mr-1 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;

            passwordInput.addEventListener('input', () => {
                const password = passwordInput.value;
                requirementsContainer.innerHTML = ''; // Kosongkan daftar setiap kali ada input
                
                if (!password) return; // Jika input kosong, jangan tampilkan apa-apa

                requirements.forEach(req => {
                    const isValid = req.regex.test(password);
                    const textClass = isValid ? 'text-gray-600' : 'text-gray-500';
                    const icon = isValid ? icon_check : icon_cross;
                    requirementsContainer.innerHTML += `<div class="${textClass}">${icon}<span>${req.text}</span></div>`;
                });
            });
        }

        /**
         * [BARU] Memeriksa kecocokan password konfirmasi secara real-time.
         * @param {HTMLInputElement} passwordInput - Elemen input password pertama.
         * @param {HTMLInputElement} confirmInput - Elemen input password konfirmasi.
         * @param {HTMLElement} messageContainer - Elemen div untuk menampilkan pesan error.
         */
        function setupPasswordConfirmation(passwordInput, confirmInput, messageContainer) {
            const checkPasswords = () => {
                const pass1 = passwordInput.value;
                const pass2 = confirmInput.value;
                
                if (pass2 && pass1 !== pass2) {
                    messageContainer.textContent = 'Password tidak cocok.';
                } else {
                    messageContainer.textContent = '';
                }
            };

            passwordInput.addEventListener('input', checkPasswords);
            confirmInput.addEventListener('input', checkPasswords);
        }

        function loadAndRenderCompletenessTable() {
            const container = document.getElementById('completeness-table-container');
            container.innerHTML = `<p class="text-center text-gray-500 py-8 loading-animation">Menganalisis data siswa</p>`;

            google.script.run
                .withSuccessHandler(students => {
                    if (!students || students.length === 0) {
                        container.innerHTML = `<p class="text-center text-gray-500 py-8">Tidak ada data siswa untuk dianalisis.</p>`;
                        return;
                    }

                    const fieldsToCheck = [
                        { key: 'nama', label: 'Nama Lengkap' }, { key: 'nisn', label: 'NISN' }, { key: 'nis', label: 'NIS' },
                        { key: 'jenisKelamin', label: 'J. Kelamin' }, { key: 'tempatLahir', label: 'Tmpt Lahir' }, { key: 'tanggalLahir', label: 'Tgl Lahir' },
                        { key: 'alamat', label: 'Alamat' }, { key: 'telepon', label: 'Telepon' }, { key: 'emailSiswa', label: 'Email' },
                        { key: 'tahunMasuk', label: 'Thn Masuk' }, { key: 'tahunLulus', label: 'Thn Lulus' }
                    ];

                    let tableHTML = `<div class="border rounded-lg overflow-hidden"><table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left font-medium text-gray-600 sticky left-0 bg-gray-100 z-10 w-1/4 whitespace-nowrap">Nama Siswa</th>
                                ${fieldsToCheck.slice(1).map(field => `<th class="px-4 py-3 text-center font-medium text-gray-600 whitespace-nowrap">${field.label}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="completeness-tbody" class="bg-white divide-y divide-gray-200">`; // <-- Beri ID pada tbody

                    students.forEach(student => {
                        tableHTML += `<tr>
                            <td class="px-4 py-2 font-medium text-gray-800 whitespace-nowrap sticky left-0 bg-white">${student.nama.toUpperCase()}</td>`;
                        
                        fieldsToCheck.slice(1).forEach(field => {
                            const value = student[field.key] || '';
                            const hasData = value && value.toString().trim() !== '';
                            const icon = hasData ? '✅' : '❌';
                            
                            // [PERBAIKAN] Hapus title, ganti dengan data-value dan cursor-pointer
                            tableHTML += `<td class="text-center p-2 cursor-pointer" data-value="${String(value).replace(/"/g, '&quot;')}">${icon}</td>`;
                        });

                        tableHTML += `</tr>`;
                    });

                    tableHTML += `</tbody></table></div>`;
                    container.innerHTML = tableHTML;

                    // [BARU] Tambahkan satu event listener pada tbody untuk menangani semua klik (event delegation)
                    const tableBody = document.getElementById('completeness-tbody');
                    if (tableBody) {
                        tableBody.addEventListener('click', function(event) {
                            // Cek apakah yang diklik adalah sel data (bukan header atau bagian lain)
                            if (event.target && event.target.tagName === 'TD' && event.target.dataset.value) {
                                showDataTooltip(event.target);
                            }
                        });
                    }
                })
                .withFailureHandler(err => {
                    container.innerHTML = `<p class="text-center text-red-500 py-8">Gagal memuat data: ${err.message}</p>`;
                })
                .getStudents(userSpreadsheetId);
        }

        // ==========================================================
        // ===== [BARU] FUNGSI-FUNGSI UNTUK TOOLTIP DATA =====
        // ==========================================================

        /**
         * Menampilkan tooltip dengan data dari sel yang diklik.
         * @param {HTMLElement} targetCell - Elemen <td> yang diklik.
         */
        function showDataTooltip(targetCell) {
            const tooltip = document.getElementById('data-viewer-tooltip');
            const value = targetCell.dataset.value;

            // Jika tooltip sudah tampil di sel yang sama, sembunyikan saja.
            if (!tooltip.classList.contains('hidden') && tooltip.dataset.currentTarget === targetCell) {
                hideDataTooltip();
                return;
            }

            // Isi tooltip dengan data dan tampilkan
            tooltip.textContent = value || '(Data Kosong)';
            tooltip.classList.remove('hidden');
            tooltip.dataset.currentTarget = targetCell; // Tandai sel target

            // Posisikan tooltip di dekat sel yang diklik
            const cellRect = targetCell.getBoundingClientRect();
            tooltip.style.left = `${cellRect.left + window.scrollX}px`;
            tooltip.style.top = `${cellRect.bottom + window.scrollY + 5}px`; // 5px di bawah sel
        }

        /**
         * Menyembunyikan tooltip.
         */
        function hideDataTooltip() {
            const tooltip = document.getElementById('data-viewer-tooltip');
            tooltip.classList.add('hidden');
            delete tooltip.dataset.currentTarget; // Hapus penanda sel target
        }

        /**
         * Listener global untuk menyembunyikan tooltip saat mengklik di luar area target.
         */
        document.addEventListener('click', function(event) {
            const tooltip = document.getElementById('data-viewer-tooltip');
            // Sembunyikan jika yang diklik BUKAN sel data dan BUKAN tooltip itu sendiri
            if (!event.target.closest('td[data-value]') && !event.target.closest('#data-viewer-tooltip')) {
                hideDataTooltip();
            }
        }, true); // Gunakan 'true' untuk event capturing agar berjalan lebih dulu


        function loadAndRenderCompletenessTable() {
            const container = document.getElementById('completeness-table-container');
            const summaryDiv = document.getElementById('completeness-summary');
            container.innerHTML = `<p class="text-center text-gray-500 py-8 loading-animation">Menganalisis data siswa</p>`;
            summaryDiv.innerHTML = '';

            google.script.run
                .withSuccessHandler(students => {
                    if (!students || students.length === 0) {
                        container.innerHTML = `<p class="text-center text-gray-500 py-8">Tidak ada data siswa untuk dianalisis.</p>`;
                        return;
                    }

                    // Langkah 1: Proses data sekali saja untuk menghitung data kosong
                    const fieldsToCheck = [
                        'nama', 'nisn', 'nis', 'jenisKelamin', 'tempatLahir', 'tanggalLahir',
                        'alamat', 'telepon', 'emailSiswa', 'tahunMasuk', 'tahunLulus'
                    ];
                    
                    processedStudents = students.map(student => {
                        let missingCount = 0;
                        fieldsToCheck.forEach(field => {
                            const value = student[field] || '';
                            if (!value.toString().trim()) {
                                missingCount++;
                            }
                        });
                        return { ...student, missingDataCount: missingCount };
                    });

                    // Langkah 2: Render tampilan awal
                    renderCompletenessView();
                })
                .withFailureHandler(err => {
                    container.innerHTML = `<p class="text-center text-red-500 py-8">Gagal memuat data: ${err.message}</p>`;
                })
                .getStudents(userSpreadsheetId);
        }

        // FUNGSI BARU untuk me-render tampilan berdasarkan filter dan sort
        function renderCompletenessView() {
            const container = document.getElementById('completeness-table-container');
            const summaryDiv = document.getElementById('completeness-summary');
            const filterCheckbox = document.getElementById('completeness-filter-checkbox');
            const sortSelect = document.getElementById('completeness-sort-select');

            let studentsToRender = [...processedStudents];

            // Update Ringkasan Statistik
            const incompleteCount = studentsToRender.filter(s => s.missingDataCount > 0).length;
            summaryDiv.innerHTML = `Diperiksa: <strong>${studentsToRender.length} siswa</strong>. Ditemukan: <strong class="text-red-600">${incompleteCount} siswa</strong> dengan data tidak lengkap.`;

            // Terapkan Filter
            if (filterCheckbox.checked) {
                studentsToRender = studentsToRender.filter(s => s.missingDataCount > 0);
            }

            // Terapkan Sortir
            const sortValue = sortSelect.value;
            if (sortValue === 'name_asc') {
                studentsToRender.sort((a, b) => a.nama.localeCompare(b.nama));
            } else if (sortValue === 'missing_desc') {
                studentsToRender.sort((a, b) => b.missingDataCount - a.missingDataCount);
            }
            
            // --- Render Tabel ---
            const fields = [
                { key: 'nama', label: 'Nama Siswa' }, { key: 'nisn', label: 'NISN' }, { key: 'nis', label: 'NIS' },
                { key: 'jenisKelamin', label: 'J.K' }, { key: 'tempatLahir', label: 'Tmpt Lahir' }, { key: 'tanggalLahir', label: 'Tgl Lahir' },
                { key: 'alamat', label: 'Alamat' }, { key: 'telepon', label: 'Telepon' }, { key: 'emailSiswa', label: 'Email' },
                { key: 'tahunMasuk', label: 'Masuk' }, { key: 'tahunLulus', label: 'Lulus' }
            ];
            
            let tableHTML = `<div class="border rounded-lg overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 text-sm">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-3 py-3 text-left font-medium text-gray-600 sticky left-0 bg-gray-100 z-10 whitespace-nowrap w-48">Nama Siswa</th>
                        ${fields.slice(1).map(field => `<th class="px-2 py-3 text-center font-medium text-gray-600 whitespace-nowrap" title="${field.label}">${field.label}</th>`).join('')}
                    </tr>
                </thead>
                <tbody id="completeness-tbody" class="bg-white divide-y divide-gray-200">`;

            if (studentsToRender.length === 0) {
                tableHTML += `<tr><td colspan="${fields.length}" class="text-center p-8 text-gray-500">Tidak ada data yang cocok dengan filter.</td></tr>`;
            } else {
                studentsToRender.forEach(student => {
                    const rowClass = student.missingDataCount > 0 ? 'bg-red-50' : ''; // Highlight baris
                    tableHTML += `<tr class="${rowClass}">
                        <td class="px-3 py-2 font-medium text-gray-800 whitespace-nowrap sticky left-0 ${rowClass ? rowClass : 'bg-white'}">${student.nama.toUpperCase()}</td>`;
                    
                    fields.slice(1).forEach(field => {
                        const value = student[field.key] || '';
                        const hasData = value && value.toString().trim() !== '';
                        const icon = hasData ? '✅' : '❌';
                        tableHTML += `<td class="text-center p-2 cursor-pointer" data-value="${String(value).replace(/"/g, '&quot;')}">${icon}</td>`;
                    });
                    tableHTML += `</tr>`;
                });
            }

            tableHTML += `</tbody></table></div>`;
            container.innerHTML = tableHTML;

            // ===================================================================
            // ===== [TAMBAHAN] PASANG EVENT LISTENER UNTUK TOOLTIP =====
            // ===================================================================
            const tableBody = document.getElementById('completeness-tbody');
            if (tableBody) {
                tableBody.addEventListener('click', function(event) {
                    // Cek apakah elemen yang diklik atau parent-nya adalah <td> dengan data-value
                    const targetCell = event.target.closest('td[data-value]');
                    
                    if (targetCell) {
                        // Jika ya, panggil fungsi untuk menampilkan tooltip
                        showDataTooltip(targetCell);
                    }
                });
            }
        }

        // FUNGSI LAMA `setupCompletenessCheck` PERLU DIMODIFIKASI untuk menambahkan event listener baru
        function setupCompletenessCheck() {
            const modal = document.getElementById('completeness-modal');
            const openBtn = document.getElementById('checkCompletenessBtn');
            const closeBtn1 = document.getElementById('closeCompletenessModalBtn');
            const closeBtn2 = document.getElementById('closeCompletenessModalBtn2');

            // [BARU] Ambil elemen filter dan sort
            const filterCheckbox = document.getElementById('completeness-filter-checkbox');
            const sortSelect = document.getElementById('completeness-sort-select');

            const openModal = () => {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.querySelector('.modal-content').style.transform = 'scale(1)';
                }, 10);
                loadAndRenderCompletenessTable(); // Panggil fungsi utama saat modal dibuka
            };

            const closeModal = () => {
                modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
                setTimeout(() => modal.classList.add('hidden'), 300);
            };

            openBtn.addEventListener('click', openModal);
            closeBtn1.addEventListener('click', closeModal);
            closeBtn2.addEventListener('click', closeModal);
            
            // [BARU] Tambahkan event listener untuk kontrol dinamis
            filterCheckbox.addEventListener('change', renderCompletenessView);
            sortSelect.addEventListener('change', renderCompletenessView);
        }

        // Letakkan fungsi ini di dalam tag <script> Anda

        /**
         * [BARU] Menginisialisasi dan memulai tur aplikasi untuk pengguna baru.
         */
        function initializeAndStartTour() {
            const tour = new Shepherd.Tour({
                useModalOverlay: true,
                defaultStepOptions: {
                    classes: 'shadow-lg shepherd-custom-theme',
                    cancelIcon: {
                        enabled: true
                    },
                    scrollTo: { behavior: 'smooth', block: 'center' }
                }
            });

            // Teks untuk checkbox
            const dontShowAgainCheckbox = `
                <div class="shepherd-dont-show-again">
                    <input type="checkbox" id="dont-show-tour-again">
                    <label for="dont-show-tour-again">Jangan tampilkan lagi</label>
                </div>
            `;

            // Mendefinisikan langkah-langkah tur
            tour.addStep({
                id: 'step-1-dashboard',
                title: 'Selamat Datang!',
                text: 'Ini adalah halaman Dashboard, tempat Anda melihat ringkasan data sekolah.' + dontShowAgainCheckbox,
                attachTo: { element: '.nav-link[data-page="dashboard"]', on: 'right' },
                buttons: [
                    {
                        text: 'Selesai',
                        action: tour.cancel,
                        classes: 'shepherd-button-secondary'
                    },
                    {
                        text: 'Selanjutnya &rarr;',
                        action: tour.next
                    }
                ]
            });

            tour.addStep({
                id: 'step-2-data-sekolah',
                title: 'Data Sekolah',
                text: 'Kelola informasi detail sekolah Anda seperti NPSN, alamat, dan nama kepala sekolah di sini.',
                attachTo: { element: '.nav-link[data-page="data-sekolah"]', on: 'right' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });

            tour.addStep({
                id: 'step-3-data-siswa',
                title: 'Data Siswa',
                text: 'Menu ini adalah pusat manajemen data siswa. Anda bisa menambah, mengedit, menghapus, dan mengimpor data siswa dari file Excel.',
                attachTo: { element: '.nav-link[data-page="data-siswa"]', on: 'right' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });
            
            tour.addStep({
                id: 'step-4-mapel',
                title: 'Mapel & Bobot',
                text: 'Atur semua mata pelajaran yang ada dan tentukan bobot persentase antara nilai ujian dan rapor di halaman ini.',
                attachTo: { element: '.nav-link[data-page="mapel"]', on: 'right' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });
            
            tour.addStep({
                id: 'step-5-input-nilai-ujian',
                title: 'Input Nilai Ujian',
                text: 'Setelah siswa dan mapel siap, gunakan menu ini untuk menginput semua nilai ujian madrasah dan ujian praktek.',
                attachTo: { element: '.nav-link[data-page="input-ujian"]', on: 'right' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });

            tour.addStep({
                id: 'step-6-input-nilai-rapor',
                title: 'Input Nilai Rapor',
                text: 'Setelah siswa dan mapel siap, gunakan menu ini untuk menginput semua nilai rapor per semester.',
                attachTo: { element: '.nav-link[data-page="input-rapor"]', on: 'right' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });
            
            tour.addStep({
                id: 'step-7-rekapitulasi',
                title: 'Rekapitulasi (Paling Penting)',
                text: 'Di sinilah semua keajaiban terjadi! Aplikasi akan mengkalkulasi semua nilai dan menampilkannya di sini. Anda juga bisa mencetak laporan dari halaman ini.',
                attachTo: { element: '.nav-link[data-page="rekapitulasi"]', on: 'right' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });

            tour.addStep({
                id: 'step-8-ubah-password',
                title: 'Keamanan Akun',
                text: 'Anda dapat mengubah password akun Anda secara berkala melalui menu ini untuk menjaga keamanan.',
                attachTo: { element: '.nav-link[data-page="ubah-password"]', on: 'top' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selanjutnya &rarr;', action: tour.next }
                ]
            });

            tour.addStep({
                id: 'step-9-logout',
                title: 'Selesai!',
                text: 'Terakhir, gunakan tombol ini untuk keluar dari aplikasi dengan aman. Selamat bekerja!',
                attachTo: { element: '#logoutButton', on: 'top' },
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selesai', action: tour.next }
                ]
            });

            tour.addStep({
                id: 'step-10-footer',
                title: 'Dukungan & Bantuan',
                text: 'Menemukan kendala atau punya saran untuk aplikasi ini? Jangan ragu untuk menghubungi kami dengan mengklik tautan ini. Masukan Anda sangat berharga!',
                attachTo: { element: '#app-container footer a', on: 'top' }, // Selector menunjuk ke link di footer
                buttons: [
                    { text: '&larr; Kembali', action: tour.back, classes: 'shepherd-button-secondary' },
                    { text: 'Selesai!', action: tour.next } // Tombol Selesai di langkah terakhir
                ]
            });

            // Logika untuk menyimpan pilihan "Jangan tampilkan lagi"
            const handleTourEnd = () => {
                const checkbox = document.getElementById('dont-show-tour-again');
                if (checkbox && checkbox.checked) {
                    localStorage.setItem('hasCompletedAppTour', 'true');
                }
            };

            tour.on('complete', handleTourEnd);
            tour.on('cancel', handleTourEnd);

            tour.start();
        }
    </script>
</body>
</html>
