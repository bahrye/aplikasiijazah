<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Guru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f0f4f8;
        }
        .gradient-bg {
            background-color: #f3f4f6; /* bg-gray-100 */
            background-image: 
                radial-gradient(at 0% 0%, rgb(229, 231, 235) 0px, transparent 50%),
                radial-gradient(at 95% 95%, rgb(219, 234, 254) 0px, transparent 50%);
        }
        .content-view { 
            animation: fadeIn 0.6s ease-in-out; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(15px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #ffffff;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .nav-link-guru.active, .mapel-link.active {
            background-color: #4f46e5; /* indigo-700 */
            color: white;
            font-weight: 600;
        }
        .nav-link-guru:not(.active):hover, .mapel-link:not(.active):hover {
            background-color: #4338ca; /* indigo-800 */
            color: white;
        }
        .tab-btn.active {
            border-bottom-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .semester-btn.active {
            background-color: #eef2ff; /* indigo-50 */
            color: #4338ca; /* indigo-800 */
            font-weight: 600;
        }
        .score-input:read-only {
            background-color: #eef2ff;
            cursor: not-allowed;
            border-color: #e0e7ff;
        }
        .status-disetujui { background-color: #dcfce7 !important; border-color: #4ade80 !important; color: #166534 !important; }
        .status-ditolak { background-color: #fee2e2 !important; border-color: #f87171 !important; color: #991b1b !important; }
        .status-menunggu { background-color: #fef9c3 !important; border-color: #facc15 !important; color: #854d0e !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #3730a3; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #6366f1; border-radius: 10px; }

        #notification-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.75rem;
        }
        .toast {
            max-width: 350px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideInRight 0.5s ease-out forwards, fadeOut 0.5s ease-in 4.5s forwards;
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }

        #hamburger-btn-guru {
            display: none;
        }
        @media (max-width: 768px) {
            #main-app-container > .flex {
                display: block;
            }
            #main-app-container aside {
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                width: 280px;
                z-index: 40;
                transform: translateX(-100%); 
                transition: transform 0.3s ease-in-out;
            }
            #main-app-container main {
                width: 100%;
                padding-top: 5rem;
            }
            #main-app-container aside.is-open {
                transform: translateX(0);
            }
            #hamburger-btn-guru {
                display: block;
            }
        }

        /* GANTI KESELURUHAN BLOK CSS SUBMENU DENGAN KODE INI */

        /* === Gaya untuk Header Submenu (Tidak Berubah) === */
        .nav-link-header { cursor: pointer; }
        .nav-link-header .chevron { transition: transform 0.3s ease-in-out; }
        .nav-link-header.open .chevron { transform: rotate(90deg); }

        /* === Gaya untuk Kontainer Submenu (Hanya untuk Animasi) === */
        .submenu-mapel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.35s ease-in-out;
            /* Kontainer ini sekarang transparan dan tidak punya padding */
        }

        /* === [BARU] Wrapper untuk Tampilan di Dalam Submenu === */
        .submenu-content-wrapper {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 0.5rem; /* Memberi jarak 8px di sekeliling */
            margin-top: 0.25rem; /* Memberi jarak 4px dari header di atasnya */
            border-radius: 0.375rem; /* Sudut melengkung */
        }

        /* === Gaya untuk Item Kelas di Dalam Submenu === */
        .mapel-link {
            padding: 0.625rem 1rem;
            display: block;
            border-radius: 0.375rem; 
            font-size: 0.875rem; 
            color: #e0e7ff; 
            transition: background-color 0.2s, color 0.2s;
        }

        .mapel-link::before { content: "â€” "; font-weight: 600; color: #a5b4fc; }
        .mapel-link:not(.active):hover { background-color: #4f46e5; color: #ffffff; }
        .mapel-link.active { background-color: #eef2ff; color: #3730a3; font-weight: 600; }
        .mapel-link.active::before { color: #4f46e5; }

        /* Tambahkan ini di dalam <style> pada Guru.html */
        .sticky-col-left {
            position: -webkit-sticky; /* Untuk Safari */
            position: sticky;
            left: 0;
            z-index: 10;
            background-color: white; /* Warna latar agar tidak transparan */
            /* [PERUBAHAN] Menambahkan garis tipis di sisi kanan kolom sticky */
            border-right: 1px solid #e5e7eb; /* Warna sama dengan border tabel (gray-200) */
        }
        .sticky-col-left.header {
            background-color: #f9fafb; /* Warna latar header (bg-gray-50) */
        }

        /* ===== AWAL KODE BARU UNTUK FEEDBACK LOGIN GAGAL ===== */

        /* Kelas untuk mengubah border input menjadi merah */
        .input-error {
          border-color: #ef4444 !important; /* Warna merah (Tailwind's red-500) */
          box-shadow: 0 0 0 2px #fecaca;   /* Tambahkan glow merah tipis (Tailwind's red-200) */
        }

        /* Kelas untuk menerapkan animasi getar */
        .form-shake {
          animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Definisi animasi getar (keyframes) */
        @keyframes shake {
          10%, 90% {
            transform: translate3d(-1px, 0, 0);
          }
          20%, 80% {
            transform: translate3d(2px, 0, 0);
          }
          30%, 50%, 70% {
            transform: translate3d(-4px, 0, 0);
          }
          40%, 60% {
            transform: translate3d(4px, 0, 0);
          }
        }
        /* ===== AKHIR KODE BARU ===== */
    </style>

    <!-- [PERBAIKAN] Tambahkan dua baris ini di dalam <head> pada Guru.html -->
    <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />

</head>
<body class="text-gray-800">

    <div id="app" class="min-h-screen">

        <div id="notification-container"></div>

        <div id="confirmation-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[999]">
            <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md transform scale-95 p-6 text-center">
                <div id="confirm-icon-container" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                    <svg class="h-6 w-6 text-yellow-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h2 id="confirm-title" class="text-2xl font-bold text-gray-800">Konfirmasi Aksi</h2>
                <p id="confirm-message" class="mt-2 text-gray-600">Apakah Anda yakin ingin melanjutkan?</p>
                <div class="mt-6 flex justify-center space-x-4">
                    <button id="confirm-cancel-btn" class="bg-gray-300 text-gray-800 py-2 px-6 rounded-md hover:bg-gray-400 font-medium">
                        Batal
                    </button>
                    <button id="confirm-action-btn" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700 font-medium">
                        Ya, Lanjutkan
                    </button>
                </div>
            </div>
        </div>

        <div id="login-container" class="content-view min-h-screen flex items-center justify-center gradient-bg p-4">
            <div class="w-full max-w-md">
                <div class="bg-white rounded-2xl shadow-2xl p-8 text-center">
                    <h1 class="text-3xl font-bold text-gray-800">Portal Guru</h1>
                    <p class="text-gray-500 mt-2 mb-8">Silakan masuk dengan akun Anda.</p>
                    <form id="loginFormGuru">
                        <div class="space-y-6">
                            <input type="text" id="kode_sekolah_guru" placeholder="Kode Sekolah" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm text-center tracking-widest uppercase focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            <input type="text" id="username_guru" placeholder="Username" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                            <div class="relative">
                                <input type="password" id="password_guru" placeholder="Password" class="w-full px-4 py-3 pr-10 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <button type="button" data-toggle-password="password_guru" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                    <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                    <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                </button>
                            </div>
                        </div>
                    </form>
                    <div class="mt-4 text-left">
                        <div class="p-3 bg-blue-50 border-l-4 border-blue-400">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700">
                                        Jika lupa password, silakan hubungi <b>Admin Sekolah</b> untuk membuatkan username & password baru.
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div id="login-error-message" class="mt-2 text-center text-red-600 text-sm h-4"></div>
                    </div>

                    <div class="mt-2 space-y-3">
                        <button type="submit" form="loginFormGuru" id="loginButtonGuru" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105 shadow-lg">
                            <span id="loginBtnText">Masuk</span>
                            <div id="loginSpinner" class="hidden mx-auto loading-spinner" style="width:24px; height:24px; border-width:3px;"></div>
                        </button>
                        <button type="button" id="backToMainLoginBtnGuru" class="w-full bg-gray-200 text-gray-700 font-bold py-3 px-4 rounded-lg hover:bg-gray-300 transition shadow-md">
                            <span>Login Utama</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="main-app-container" class="hidden">
            <button id="hamburger-btn-guru" class="hidden fixed top-4 left-4 z-50 bg-indigo-600 text-white p-2 rounded-md shadow-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
                </svg>
            </button>
            <div id="sidebar-overlay-guru" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden"></div>

            <div class="flex h-screen bg-gray-100">
                <aside class="w-64 bg-indigo-800 text-white flex flex-col shadow-lg">
                    <div class="h-20 flex items-center justify-center text-2xl font-extrabold border-b border-indigo-900">
                        <span>PORTAL GURU</span>
                    </div>

                    <nav id="mapel-navigation" class="flex-1 px-4 py-4 space-y-1 overflow-y-auto custom-scrollbar">
                        <h3 class="px-2 text-xs font-semibold text-indigo-300 uppercase tracking-wider mb-2">Informasi</h3>
                        <div id="pilih-mapel-container"></div>
                    </nav>
                    <div class="p-4 border-t border-indigo-900">
                        <button id="logoutButtonGuru" class="w-full flex items-center justify-center space-x-3 p-3 rounded-lg bg-indigo-700 hover:bg-red-600 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
                            <span>Logout</span>
                        </button>
                    </div>
                </aside>

                <main class="flex-1 p-6 md:p-8 overflow-y-auto">
                    <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center text-gray-500">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-indigo-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v11.494m-9-5.747h18" /></svg>
                        <h2 class="text-2xl font-bold mt-4">Selamat Datang, <span id="nama-guru-display"></span>!</h2>
                        <p class="mt-2 max-w-md">Silakan pilih mata pelajaran dari panel di sebelah kiri untuk mulai mengelola nilai.</p>
                    </div>

                    <div id="form-container" class="hidden content-view">
                        <div id="submission-status-bar" class="mb-4 p-4 rounded-lg text-sm font-medium hidden items-center gap-3"></div>
                        <div class="border-b border-gray-200 bg-white px-6 rounded-t-lg">
                            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                <button class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="ujian">Nilai Ujian</button>
                                <button class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="rapor">Nilai Rapor</button>
                            </nav>
                        </div>
                        <div id="tab-content" class="bg-white p-6 rounded-b-lg shadow-sm">
                            <div id="tab-ujian"></div>
                            <div id="tab-rapor" class="hidden"></div>
                        </div>
                    </div>

                    <div id="page-profil-guru" class="hidden content-view">
                        <h1 class="text-3xl font-bold text-gray-800">Profil Saya</h1>
                        <p class="mt-2 text-gray-600 mb-8">Anda dapat mengubah data pribadi dan informasi login Anda di sini.</p>

                        <div class="bg-white p-8 rounded-lg shadow-md max-w-2xl">
                            <div class="space-y-6">
                                <h3 class="text-xl font-semibold text-gray-900 border-b pb-3">Data Pribadi</h3>
                                <div>
                                    <label for="profile_nama_guru" class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                                    <input type="text" id="profile_nama_guru" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="profile_nip_guru" class="block text-sm font-medium text-gray-700">NIP (Opsional)</label>
                                    <input type="text" id="profile_nip_guru" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div class="pt-2">
                                    <button id="saveProfileDataBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Simpan Data Pribadi</button>
                                </div>
                            </div>

                            <div class="border-t pt-6 mt-8 space-y-6">
                                <h3 class="text-xl font-semibold text-gray-900 border-b pb-3">Akun Login</h3>
                                <p class="text-sm p-3 bg-yellow-50 text-yellow-800 border-l-4 border-yellow-400 rounded-r-lg">
                                    <strong>PENTING:</strong> Jika Anda mengubah Username atau Password, Anda akan otomatis logout dan perlu masuk kembali dengan kredensial baru. Operator sekolah tidak akan memiliki izin untuk melihat password yang sudah Anda ubah. Jadi Anda tidak perlu khawatir akan mengungkap password baru Anda.
                                </p>
                                <div>
                                    <label for="profile_username_guru" class="block text-sm font-medium text-gray-700">Username</label>
                                    <input type="text" id="profile_username_guru" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="profile_password_guru" class="block text-sm font-medium text-gray-700">Password Baru</label>
                                    <div class="relative mt-1">
                                        <input type="password" id="profile_password_guru" class="w-full p-2 pr-10 border border-gray-300 rounded-md shadow-sm">
                                        <button type="button" data-toggle-password="profile_password_guru" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600">
                                            <svg class="eye-icon h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                            <svg class="eye-slash-icon h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="pt-2">
                                    <button id="saveProfileCredentialsBtn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-700 transition-colors">Simpan Akun Login</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="page-siswa-tanpa-kelas" class="hidden content-view">
                        <h1 class="text-3xl font-bold text-gray-800">Siswa Tanpa Kelas</h1>
                        <p class="mt-2 text-gray-600 mb-8">Berikut adalah daftar siswa yang belum terdaftar di kelas manapun. Silakan hubungi admin sekolah untuk melengkapi data mereka.</p>
                        <div id="siswa-tanpa-kelas-container" class="bg-white p-4 rounded-lg shadow-md">
                            </div>
                    </div>

                    <div id="page-daftar-siswa" class="hidden content-view">
                        <h1 class="text-3xl font-bold text-gray-800">Daftar Siswa</h1>
                        <p class="mt-2 text-gray-600 mb-8">Lihat dan filter daftar siswa berdasarkan kelas yang Anda ajar.</p>

                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="mb-6">
                                <label for="filter-kelas-siswa" class="block text-sm font-medium text-gray-700">Filter berdasarkan Kelas:</label>
                                <select id="filter-kelas-siswa" class="mt-1 block w-full md:w-1/2 lg:w-1/3 p-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    </select>
                            </div>
                            
                            <div id="daftar-siswa-container" class="overflow-x-auto">
                                </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <!-- [PERUBAHAN] Tambahkan modal ini ke Guru.html -->
        <div id="guru-nilai-import-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-[999]">
            <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-3xl transform scale-95 flex flex-col max-h-[90vh]">
                <div class="flex-shrink-0 flex justify-between items-center border-b p-4">
                    <h2 id="guru-import-modal-title" class="text-xl font-bold text-gray-800">Import Nilai</h2>
                    <button id="closeGuruImportModalBtn" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                </div>
                <div class="flex-grow overflow-y-auto p-6 space-y-6">
                    <p class="text-sm text-gray-600">Unduh template, isi nilai, lalu unggah kembali file tersebut. Nilai yang diimpor akan disimpan sebagai draf.</p>
                    <form action="#" class="dropzone" id="guru-nilai-dropzone-form">
                        <div class="dz-message" data-dz-message>
                            <span>Letakkan File Excel di sini atau Klik untuk memilih</span>
                        </div>
                    </form>
                </div>
                <div class="flex-shrink-0 mt-auto p-4 border-t flex justify-end">
                    <button id="closeGuruImportModalBtn2" type="button" class="bg-gray-500 text-white py-2 px-6 rounded-md hover:bg-gray-600">Tutup</button>
                </div>
            </div>
        </div>

        <!-- [PERUBAHAN] Tambahkan blok div ini di dalam <body>, sebelum tag penutup </body> -->
        <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center text-center z-[9999] p-4">
            <h2 id="overlay-title" class="text-2xl font-bold text-gray-800">Memproses Permintaan Anda</h2>
            <p id="overlay-subtitle" class="mt-2 text-gray-600">Mohon tunggu dan jangan menutup jendela ini...</p>
            <div id="overlay-button-container" class="mt-6"></div>
        </div>
    </div>

<script>
    const WEB_APP_URL = "<?= webAppUrl ?>";
    let allStudentsForGuruPage = [];
    let guruPollingTimers = {};

    function showNotification(message, type = 'success') {
        const container = document.getElementById('notification-container');
        const toast = document.createElement('div');
        let bgColor = 'bg-green-500';
        let icon = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        if (type === 'error') { bgColor = 'bg-red-500'; icon = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; } 
        else if (type === 'info') { bgColor = 'bg-blue-500'; icon = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; }
        toast.className = `toast ${bgColor}`;
        toast.innerHTML = `${icon}<span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 5000);
    }

    function showConfirmationModal(options) {
        const modal = document.getElementById('confirmation-modal');
        const titleEl = document.getElementById('confirm-title');
        const messageEl = document.getElementById('confirm-message');
        const actionBtn = document.getElementById('confirm-action-btn');
        const cancelBtn = document.getElementById('confirm-cancel-btn');
        titleEl.textContent = options.title || 'Konfirmasi Aksi';
        messageEl.innerHTML = options.message || 'Apakah Anda yakin?';
        const newActionBtn = actionBtn.cloneNode(true);
        actionBtn.parentNode.replaceChild(newActionBtn, actionBtn);
        newActionBtn.textContent = options.confirmText || 'Ya';
        newActionBtn.className = `py-2 px-6 rounded-md font-medium text-white ${options.confirmColor || 'bg-red-600 hover:bg-red-700'}`;
        const closeModal = () => {
            modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
            setTimeout(() => modal.classList.add('hidden'), 300);
        };
        cancelBtn.onclick = closeModal;
        newActionBtn.onclick = () => { closeModal(); if (options.onConfirm) { options.onConfirm(); } };
        modal.classList.remove('hidden');
        setTimeout(() => { modal.querySelector('.modal-content').style.transform = 'scale(1)'; }, 10);
    }

    function showView(viewId) { 
        // Fungsi ini sekarang HANYA mengatur halaman di dalam portal utama
        document.querySelectorAll('main > .content-view, main > #form-container, main > #welcome-screen').forEach(el => el.classList.add('hidden'));
        const targetView = document.getElementById(viewId);
        if(targetView) {
            targetView.classList.remove('hidden');
        } else if (viewId === 'welcome-screen') {
            document.getElementById('welcome-screen').classList.remove('hidden');
        }
    }
    
    // Ganti fungsi handleGuruLogin di Guru.html dengan ini:
    function handleGuruLogin(e) {
        e.preventDefault();
        const schoolCodeInput = document.getElementById('kode_sekolah_guru');
        const usernameInput = document.getElementById('username_guru');
        const passwordInput = document.getElementById('password_guru');
        const btn = document.getElementById('loginButtonGuru'), 
              btnText = document.getElementById('loginBtnText'), 
              spinner = document.getElementById('loginSpinner'), 
              errorDiv = document.getElementById('login-error-message');

        // [PERUBAHAN 1] Dapatkan elemen form untuk animasi getar
        const formContainer = document.querySelector('#login-container > div > div'); // div pembungkus form di portal guru

        btn.disabled = true; 
        btnText.classList.add('hidden'); 
        spinner.classList.remove('hidden'); 
        errorDiv.textContent = '';
        
        // [PERUBAHAN 2] Hapus kelas error sebelumnya
        schoolCodeInput.classList.remove('input-error');
        usernameInput.classList.remove('input-error');
        passwordInput.classList.remove('input-error');
        formContainer.classList.remove('form-shake');

        // [PERUBAHAN 3] Tambahkan listener untuk menghapus error saat mengetik
        schoolCodeInput.addEventListener('input', () => schoolCodeInput.classList.remove('input-error'));
        usernameInput.addEventListener('input', () => usernameInput.classList.remove('input-error'));
        passwordInput.addEventListener('input', () => passwordInput.classList.remove('input-error'));
        
        google.script.run.withSuccessHandler(r => {
            btn.disabled = false; 
            btnText.classList.remove('hidden'); 
            spinner.classList.add('hidden');

            if (r.status === 'success') { 
                sessionStorage.setItem('guruData', JSON.stringify(r.data));
                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('main-app-container').classList.remove('hidden');
                initializeAppGuru(r.data); 
            } else { 
                errorDiv.textContent = r.message; 
                // [PERUBAHAN 4] Terapkan efek visual saat gagal
                schoolCodeInput.classList.add('input-error');
                usernameInput.classList.add('input-error');
                passwordInput.classList.add('input-error');
                formContainer.classList.add('form-shake');
                setTimeout(() => {
                    formContainer.classList.remove('form-shake');
                }, 500); // Durasi animasi
            }
        }).withFailureHandler(err => {
            btn.disabled = false; 
            btnText.classList.remove('hidden'); 
            spinner.classList.add('hidden'); 
            errorDiv.textContent = 'Terjadi kesalahan: ' + err.message;
            // [PERUBAHAN 5] Terapkan juga efek visual saat ada kegagalan koneksi
            schoolCodeInput.classList.add('input-error');
            usernameInput.classList.add('input-error');
            passwordInput.classList.add('input-error');
            formContainer.classList.add('form-shake');
            setTimeout(() => {
                formContainer.classList.remove('form-shake');
            }, 500);
        }).loginGuru(schoolCodeInput.value.trim(), usernameInput.value.trim(), passwordInput.value);
    }

    // File: Guru.html (di dalam tag <script>)
    // Ganti fungsi lama setupGuruHamburgerMenu() dengan versi ini.

    function setupGuruHamburgerMenu() {
        const hamburgerBtn = document.getElementById('hamburger-btn-guru');
        const sidebar = document.querySelector('#main-app-container aside');
        const overlay = document.getElementById('sidebar-overlay-guru');

        const openSidebar = () => {
            sidebar.classList.add('is-open');
            overlay.classList.remove('hidden');
        };

        const closeSidebar = () => {
            sidebar.classList.remove('is-open');
            overlay.classList.add('hidden');
        };

        hamburgerBtn.addEventListener('click', openSidebar);
        overlay.addEventListener('click', closeSidebar);
        
        // --- [AWAL PERUBAHAN UTAMA] ---
        // Logika event listener yang disempurnakan
        sidebar.addEventListener('click', (e) => {
            // Cari tag <a> terdekat yang diklik oleh pengguna
            const link = e.target.closest('a');

            // Jika tidak ada link yang diklik, abaikan
            if (!link) {
                return;
            }

            // Cek apakah link yang diklik adalah header dropdown
            if (link.classList.contains('nav-link-header')) {
                // Jika YA, JANGAN tutup sidebar. Biarkan event listener lain
                // yang menangani buka/tutup submenu bekerja.
                return; 
            }
            
            // Jika BUKAN header dropdown (misalnya link "Profil Saya" atau link kelas),
            // maka tutup sidebar.
            closeSidebar();
        });
        // --- [AKHIR PERUBAHAN UTAMA] ---
    }

    // File: Guru.html (di dalam tag <script>)
    // Ganti keseluruhan fungsi initializeAppGuru() Anda dengan kode ini.

    function initializeAppGuru(guruData) {
        sessionStorage.setItem('isSubmissionEnabled', guruData.isSubmissionEnabled);
        document.getElementById('nama-guru-display').textContent = guruData.nama;
        
        const mapelContainer = document.getElementById('pilih-mapel-container');
        mapelContainer.innerHTML = ''; // Selalu kosongkan kontainer sebelum membangun menu baru

        // Tambahkan menu "Profil Saya" secara dinamis
        mapelContainer.insertAdjacentHTML('beforeend', `
            <a href="#" class="nav-link-guru flex items-center space-x-3 p-3 rounded-lg text-sm font-medium" data-page="profil-guru">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zM12 12a5 5 0 00-5 5h10a5 5 0 00-5-5z" clip-rule="evenodd" />
                </svg>
                <span>Profil Saya</span>
            </a>
        `);
        
        // --- [AWAL PERUBAHAN] ---
        // Tambahkan menu "Daftar Siswa" yang baru di sini
        mapelContainer.insertAdjacentHTML('beforeend', `
            <a href="#" class="nav-link-guru flex items-center space-x-3 p-3 rounded-lg text-sm font-medium" data-page="daftar-siswa">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
                </svg>
                <span>Daftar Siswa</span>
            </a>
        `);
        // --- [AKHIR PERUBAHAN] ---

        // Tambahkan menu "Siswa Tanpa Kelas"
        mapelContainer.insertAdjacentHTML('beforeend', `
            <a href="#" id="nav-siswa-tanpa-kelas" class="nav-link-guru flex items-center space-x-3 p-3 rounded-lg text-sm font-medium" data-page="siswa-tanpa-kelas">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Siswa Tanpa Kelas</span>
            </a>
            <div class="border-t border-indigo-700 my-2"></div>
            <h3 class="px-2 text-xs font-semibold text-indigo-300 uppercase tracking-wider mb-2">Mata Pelajaran</h3>
        `);

        // Loop melalui setiap mata pelajaran
        guruData.mapel.forEach(m => {
            // [PERBAIKAN] Logika di dalam if ini diubah untuk menyertakan div wrapper baru
            if (m.kelas && m.kelas.length >= 1) {
                let submenuHtml = '';
                m.kelas.forEach(k => {
                    submenuHtml += `
                        <a href="#" class="mapel-link block" data-kode="${m.kode}" data-kelas="${k}" data-jenis-ujian="${m.jenisUjian}">
                            <span>Kelas ${k}</span>
                        </a>
                    `;
                });

                // Menambahkan div baru ".submenu-content-wrapper" untuk membungkus link
                mapelContainer.insertAdjacentHTML('beforeend', `
                    <div class="mapel-group">
                        <a href="#" class="nav-link-header nav-link-guru flex items-center justify-between p-3 rounded-lg text-sm font-medium">
                            <span class="flex items-center space-x-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a1 1 0 011-1h14a1 1 0 110 2H3a1 1 0 01-1-1z" /></svg>
                                <span>${m.nama}</span>
                            </span>
                            <svg class="chevron h-4 w-4 transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </a>
                        <div class="submenu-mapel">
                            <div class="submenu-content-wrapper">
                                ${submenuHtml}
                            </div>
                        </div>
                    </div>
                `);
            }
        });

        // Event listener tidak perlu diubah, karena sudah dirancang untuk menangani dropdown
        const newMapelContainer = mapelContainer.cloneNode(true);
        mapelContainer.parentNode.replaceChild(newMapelContainer, mapelContainer);

        newMapelContainer.addEventListener('click', function(e) {
            stopAllGuruPolling();

            const target = e.target;
            
            // --- Logika untuk membuka/menutup submenu (DIPERBARUI) ---
            const header = target.closest('.nav-link-header');
            if (header) {
                e.preventDefault();
                const submenu = header.nextElementSibling;
                const isOpen = header.classList.contains('open');

                // Tutup semua submenu lain terlebih dahulu
                document.querySelectorAll('.nav-link-header.open').forEach(otherHeader => {
                    if (otherHeader !== header) {
                        otherHeader.classList.remove('open');
                        // Atur max-height kembali ke null agar kembali ke nilai CSS (yaitu 0)
                        otherHeader.nextElementSibling.style.maxHeight = null; 
                    }
                });

                // Toggle submenu yang diklik
                if (isOpen) {
                    header.classList.remove('open');
                    submenu.style.maxHeight = null; // Menutup submenu
                } else {
                    header.classList.add('open');
                    // [KUNCI PERBAIKAN] Mengatur max-height sesuai tinggi konten aslinya.
                    // Ini akan memastikan kontainer cukup tinggi untuk semua item di dalamnya.
                    submenu.style.maxHeight = submenu.scrollHeight + "px"; 
                }
                return; // Hentikan eksekusi setelah menangani header
            }

            // --- Logika untuk memilih link kelas (Tidak berubah) ---
            const mapelLink = target.closest('.mapel-link');
            if (mapelLink) {
                e.preventDefault();
                handleMapelSelection(mapelLink.dataset.kode, mapelLink.dataset.jenisUjian, mapelLink.dataset.kelas);
            }
            
            // --- Logika untuk menu statis seperti "Profil Saya" (Tidak berubah) ---
            const navLink = target.closest('.nav-link-guru');
            if (navLink && !navLink.classList.contains('mapel-link') && !navLink.classList.contains('nav-link-header')) {
                e.preventDefault();
                const page = navLink.dataset.page;
                showGuruPage(page);
            }
        });

        // ===== AWAL BLOK KODE BARU =====

        // Setelah UI navigasi siap, cek status pengajuan yang mungkin masih aktif
        startGuruStatusPolling(); 
        // ===== AKHIR BLOK KODE BARU =====

        document.getElementById('logoutButtonGuru').addEventListener('click', handleGuruLogout);
        setupScoreInputValidation();
        setupTabs();
        setupActionListeners();
        setupGuruHamburgerMenu();
        setupPasswordToggles();
        showView('welcome-screen');
    }

    // File: Guru.html (di dalam tag <script>)
    // Ganti fungsi showGuruPage() dengan versi ini

    function showGuruPage(pageId) {
        document.querySelectorAll('main > .content-view, main > #form-container, main > #welcome-screen').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.nav-link-guru, .mapel-link').forEach(l => l.classList.remove('active'));
        
        if (pageId === 'profil-guru') {
            document.getElementById('page-profil-guru').classList.remove('hidden');
            document.querySelector('.nav-link-guru[data-page="profil-guru"]').classList.add('active');
            loadProfilePage();
        } else if (pageId === 'daftar-siswa') { // --- [PERUBAHAN] ---
            document.getElementById('page-daftar-siswa').classList.remove('hidden');
            document.querySelector('.nav-link-guru[data-page="daftar-siswa"]').classList.add('active');
            loadDaftarSiswaPage(); // Panggil fungsi baru untuk memuat halaman ini
        } else if (pageId === 'siswa-tanpa-kelas') {
            document.getElementById('page-siswa-tanpa-kelas').classList.remove('hidden');
            document.getElementById('nav-siswa-tanpa-kelas').classList.add('active');
            loadSiswaTanpaKelas();
        } else {
            // Ini untuk halaman input nilai, biarkan seperti ini
            document.getElementById('form-container').classList.remove('hidden');
        }
    }

    function loadProfilePage() {
        // Ambil data guru dari session
        const guruData = JSON.parse(sessionStorage.getItem('guruData'));
        
        // Deklarasikan semua elemen HANYA SATU KALI di awal fungsi
        const namaInput = document.getElementById('profile_nama_guru');
        const nipInput = document.getElementById('profile_nip_guru');
        const usernameInput = document.getElementById('profile_username_guru');
        const passwordInput = document.getElementById('profile_password_guru');

        // Tampilkan notifikasi loading
        showNotification('Memuat data profil...', 'info');

        // Panggil data terbaru dari server
        google.script.run
            .withSuccessHandler(response => {
                if (response.status === 'success') {
                    const profile = response.profile;
                    
                    // Isi nilai ke input yang sudah dideklarasikan
                    namaInput.value = profile.nama;
                    nipInput.value = profile.nip || '';
                    usernameInput.value = profile.username;
                    
                    // Atur kolom password agar kosong dan memberikan instruksi
                    passwordInput.value = '';
                    passwordInput.placeholder = "Isi HANYA jika ingin mengubah password";
                    
                } else {
                    showNotification(response.message, 'error');
                }
            })
            .withFailureHandler(err => {
                showNotification(`Gagal memuat profil: ${err.message}`, 'error');
            })
            .getGuruProfile(guruData.spreadsheetId, guruData.username);
    }

    // File: Guru.html (di dalam tag <script>)

    function handleMapelSelection(mapelKode, jenisUjian, kelas) {
        // 1. Secara manual tampilkan container form dan sembunyikan halaman lain
        document.getElementById('welcome-screen').classList.add('hidden');
        document.getElementById('page-profil-guru').classList.add('hidden');
        document.getElementById('page-siswa-tanpa-kelas').classList.add('hidden');
        document.getElementById('page-daftar-siswa').classList.add('hidden');
        document.getElementById('form-container').classList.remove('hidden');

        // 2. Hapus status aktif dari semua link navigasi
        document.querySelectorAll('.nav-link-guru.active, .mapel-link.active').forEach(l => l.classList.remove('active'));

        // 3. Buat selector yang spesifik untuk kode mapel DAN kelas
        const selector = `.mapel-link[data-kode="${mapelKode}"][data-kelas="${kelas}"]`;
        const activeLink = document.querySelector(selector);
        
        // 4. Terapkan kelas .active pada link yang benar
        if (activeLink) {
            activeLink.classList.add('active');
            // Jika link ada di dalam dropdown, aktifkan juga headernya
            const parentGroup = activeLink.closest('.mapel-group');
            if (parentGroup) {
                parentGroup.querySelector('.nav-link-header').classList.add('active');
            }
        }

        // 5. Reset tab ke "Nilai Ujian" (logika ini tidak berubah)
        document.querySelector('.tab-btn.active')?.classList.remove('active');
        document.querySelector('[data-tab="ujian"]').classList.add('active');
        document.getElementById('tab-ujian').classList.remove('hidden');
        document.getElementById('tab-rapor').classList.add('hidden');
        
        // 6. Muat data form dengan parameter yang sudah benar (logika ini tidak berubah)
        buildUjianForm(mapelKode, jenisUjian, kelas);
        buildRaporForm(mapelKode, kelas);
    }

    function getSavedAndSubmittedValues(mapelKode) {
        const guruData = JSON.parse(sessionStorage.getItem('guruData'));
        return new Promise((resolve, reject) => {
            google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getGuruNilai(guruData.spreadsheetId, guruData.username, mapelKode);
        });
    }

    // GANTI FUNGSI INI DI Guru.html
    async function buildUjianForm(mapelKode, jenisUjian, kelas) {
        const container = document.getElementById('tab-ujian');
        container.innerHTML = `<p class="loading-animation p-4">Memuat data nilai ujian...</p>`;

        try {
            const guruData = JSON.parse(sessionStorage.getItem('guruData'));
            const type = 'ujian';

            const response = await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .getNilaiPageData_Guru(guruData.spreadsheetId, guruData.username, mapelKode, type, kelas);
            });

            if (response.status !== 'success') throw new Error(response.message);

            const { students, savedValues, submittedValues, approvalStatus, submissionId, batchStatus, kkm, isLockedForGuru } = response;
            if (!students || students.length === 0) {
                container.innerHTML = `<p class="p-4 text-center text-gray-500">Tidak ada data siswa untuk kelas ${kelas}.</p>`; return;
            }

            const mapelInfo = guruData.mapel.find(m => m.kode === mapelKode);
            const namaMapel = mapelInfo ? mapelInfo.nama : mapelKode;

            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = 'bg-gray-50 p-4 rounded-lg';

            // Perubahan di sini untuk memastikan layout yang benar
            const headerDiv = document.createElement('div');
            headerDiv.className = 'space-y-4'; // Biarkan item di dalamnya tersusun vertikal

            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = `<h3 class="text-xl font-bold text-gray-800">${namaMapel} - Kelas ${kelas}</h3>`;

            const buttonContainer = document.createElement('div');

            headerDiv.appendChild(titleDiv);
            headerDiv.appendChild(buttonContainer);

            const scoreTableHtml = buildScoreTable(type, 'Nilai Ujian', mapelKode, students, savedValues, submittedValues, approvalStatus, kkm, isLockedForGuru, { jenisUjian });

            wrapperDiv.appendChild(headerDiv);
            const tableContentDiv = document.createElement('div');
            tableContentDiv.className = 'mt-4';
            tableContentDiv.innerHTML = scoreTableHtml;
            wrapperDiv.appendChild(tableContentDiv);

            container.innerHTML = '';
            container.appendChild(wrapperDiv);

            const buttonsHtml = buildActionButtons(type, mapelKode, submittedValues, approvalStatus, null, submissionId, batchStatus, kelas, isLockedForGuru);
            buttonContainer.innerHTML = buttonsHtml;

            // ===== [BARU] MULAI POLLING JIKA PERLU =====
            const isSubmitted = submittedValues && submittedValues[type] && Object.keys(submittedValues[type]).length > 0;
            if (isSubmitted && submissionId && !batchStatus.allApproved) {
                startGuruPolling(submissionId, type);
            }
            // ==========================================

        } catch (error) {
            container.innerHTML = `<p class="text-red-500 p-4">Gagal memuat data: ${error.message}</p>`;
        }
    }

    async function buildRaporForm(mapelKode, kelas) { // Tambahkan 'kelas'
        const container = document.getElementById('tab-rapor');
        container.innerHTML = `<p class="loading-animation p-4">Memuat data...</p>`;
        try {
            const guruData = JSON.parse(sessionStorage.getItem('guruData'));
            const { jenjang } = await new Promise((res, rej) => google.script.run.withSuccessHandler(res).withFailureHandler(rej).getStudentsAndJenjangForGuru(guruData.spreadsheetId));
            const semesterMap = {
                MI: { k4_ganjil: 'Kls 4 Ganjil', k4_genap: 'Kls 4 Genap', k5_ganjil: 'Kls 5 Ganjil', k5_genap: 'Kls 5 Genap', k6_ganjil: 'Kls 6 Ganjil' },
                MTS: { k7_ganjil: 'Kls 7 Ganjil', k7_genap: 'Kls 7 Genap', k8_ganjil: 'Kls 8 Ganjil', k8_genap: 'Kls 8 Genap', k9_ganjil: 'Kls 9 Ganjil' },
                MA: { k10_ganjil: 'Kls 10 Ganjil', k10_genap: 'Kls 10 Genap', k11_ganjil: 'Kls 11 Ganjil', k11_genap: 'Kls 11 Genap', k12_ganjil: 'Kls 12 Ganjil' }
            };
            const semesters = semesterMap[jenjang] || {};
            if (Object.keys(semesters).length === 0) { container.innerHTML = `<p class="p-4 text-center text-gray-500">Jenjang sekolah tidak valid.</p>`; return; }
            
            let semesterNavHtml = '<div class="flex flex-wrap gap-2 border-b mb-4 pb-2">';
            Object.entries(semesters).forEach(([key, name], index) => {
                const activeClass = index === 0 ? 'active' : '';
                semesterNavHtml += `<button class="semester-btn text-sm px-4 py-2 rounded-md transition-colors ${activeClass}" data-semester-key="${key}">${name}</button>`;
            });
            semesterNavHtml += '</div>';
            const formHtml = `${semesterNavHtml}<div id="rapor-table-container"></div>`;
            container.innerHTML = formHtml;
            
            container.querySelectorAll('.semester-btn').forEach(btn => {
                btn.onclick = () => {
                    stopAllGuruPolling();
                    container.querySelectorAll('.semester-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    // ===== PERUBAHAN DI SINI: Teruskan 'kelas' saat memanggil =====
                    renderRaporSemesterTable(btn.dataset.semesterKey, mapelKode, kelas);
                };
            });
            const firstSemesterKey = Object.keys(semesters)[0];
            if(firstSemesterKey) {
                // ===== PERUBAHAN DI SINI: Teruskan 'kelas' saat memanggil pertama kali =====
                renderRaporSemesterTable(firstSemesterKey, mapelKode, kelas);
            }
        } catch (error) {
            container.innerHTML = `<p class="text-red-500 p-4">Gagal memuat data rapor: ${error.message}</p>`;
        }
    }

    // GANTI FUNGSI INI DI Guru.html
    async function renderRaporSemesterTable(semesterKey, mapelKode, kelas) {
        const tableContainer = document.getElementById('rapor-table-container');
        tableContainer.innerHTML = `<p class="loading-animation p-4">Memuat data semester...</p>`;
        const type = `rapor_${semesterKey}`;

        try {
            const guruData = JSON.parse(sessionStorage.getItem('guruData'));

            const response = await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .getNilaiPageData_Guru(guruData.spreadsheetId, guruData.username, mapelKode, type, kelas);
            });

            if (response.status !== 'success') throw new Error(response.message);

            const { students, savedValues, submittedValues, approvalStatus, submissionId, batchStatus, kkm, isLockedForGuru } = response;
            if (!students || students.length === 0) {
                tableContainer.innerHTML = `<p class="p-4 text-center text-gray-500">Tidak ada data siswa untuk kelas ${kelas}.</p>`; return;
            }

            const mapelInfo = guruData.mapel.find(m => m.kode === mapelKode);
            const namaMapel = mapelInfo ? mapelInfo.nama : mapelKode;

            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = 'bg-gray-50 p-4 rounded-lg';

            // Perubahan di sini untuk memastikan layout yang benar
            const headerDiv = document.createElement('div');
            headerDiv.className = 'space-y-4'; // Biarkan item di dalamnya tersusun vertikal

            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = `<h3 class="text-xl font-bold text-gray-800">${namaMapel} - Kelas ${kelas}</h3>`;

            const buttonContainer = document.createElement('div');

            headerDiv.appendChild(titleDiv);
            headerDiv.appendChild(buttonContainer);

            const tableHtml = buildScoreTable(type, '', mapelKode, students, savedValues, submittedValues, approvalStatus, kkm, isLockedForGuru, { semesterKey });

            wrapperDiv.appendChild(headerDiv);
            const tableContentDiv = document.createElement('div');
            tableContentDiv.className = 'mt-4';
            tableContentDiv.innerHTML = tableHtml;
            wrapperDiv.appendChild(tableContentDiv);

            tableContainer.innerHTML = '';
            tableContainer.appendChild(wrapperDiv);

            const buttonsHtml = buildActionButtons(type, mapelKode, submittedValues, approvalStatus, null, submissionId, batchStatus, kelas, isLockedForGuru);
            buttonContainer.innerHTML = buttonsHtml;

            // ===== [BARU] MULAI POLLING JIKA PERLU =====
            const isSubmitted = submittedValues && submittedValues[type] && Object.keys(submittedValues[type]).length > 0;
            if (isSubmitted && submissionId && !batchStatus.allApproved) {
                startGuruPolling(submissionId, type);
            }
            // ==========================================

        } catch (error) {
            tableContainer.innerHTML = `<p class="text-red-500 p-4">Gagal memuat tabel: ${error.message}</p>`;
        }
    }
    
    // GANTI FUNGSI INI DI Guru.html
    /**
     * [PERBAIKAN FINAL v7] Membangun tombol aksi dengan perataan kiri dan logika cetak yang disempurnakan.
     */
    function buildActionButtons(type, mapelKode, submittedValues, approvalStatus, isSubmissionEnabled, submissionId, batchStatus, kelas, isLockedForGuru) {
        const isSubmitted = submittedValues && submittedValues[type] && Object.keys(submittedValues[type]).length > 0;
        let buttonsHtml = '';

        // --- Kasus 1: Form DIKUNCI oleh admin ---
        if (isLockedForGuru) {
            // Logika baru untuk tombol Cetak pada form terkunci
            const isFullyApproved = isSubmitted && batchStatus && batchStatus.allApproved;
            const btnClass = isFullyApproved ? 'bg-cyan-600 hover:bg-cyan-700' : 'bg-gray-400 cursor-not-allowed';
            const btnDisabled = isFullyApproved ? '' : 'disabled';
            const btnTitle = isFullyApproved ? 'Cetak Nilai' : 'Tombol Cetak akan aktif setelah semua nilai dikirim dan disetujui oleh admin.';

            // Tombol Cetak selalu ditampilkan, namun statusnya (aktif/nonaktif) bergantung pada kondisi di atas
            const printButtonHtml = `<button data-action="print" data-type="${type}" data-mapel-kode="${mapelKode}" data-submission-id="${submissionId}" data-kelas="${kelas}" class="text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2 ${btnClass}" ${btnDisabled} title="${btnTitle}">Cetak Nilai</button>`;

            return `
                <div class="flex flex-wrap items-center justify-start gap-4 w-full">
                    <div class="p-3 bg-yellow-100 text-yellow-800 rounded-lg text-sm font-medium text-center">
                        Pengeditan nilai untuk kelas ini sedang dikunci oleh admin.
                    </div>
                    ${printButtonHtml}
                </div>
            `;
        }

        // --- Kasus 2: Form TIDAK DIKUNCI ---
        if (isSubmitted) {
            const form = document.getElementById(`form-${type}`);
            const hasRejectedInputs = form ? !!form.querySelector('.score-input.status-ditolak') : false;

            if (hasRejectedInputs) {
                buttonsHtml += `<button data-action="resubmit" data-type="${type}" data-mapel-kode="${mapelKode}" data-submission-id="${submissionId}" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 text-sm flex items-center gap-2">Kirim Kembali Revisi</button>`;
            }

            const isFullyApproved = batchStatus && batchStatus.allApproved;
            if (isFullyApproved) {
                buttonsHtml += `<button data-action="print" data-type="${type}" data-mapel-kode="${mapelKode}" data-submission-id="${submissionId}" data-kelas="${kelas}" class="text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2 bg-cyan-600 hover:bg-cyan-700">Cetak Nilai</button>`;
            }

            buttonsHtml += `<button data-action="cancel" data-type="${type}" data-mapel-kode="${mapelKode}" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-yellow-600 text-sm flex items-center gap-2">Batal Kirim</button>`;
        } else {
            buttonsHtml = `
                <button data-action="export" data-type="${type}" data-mapel-kode="${mapelKode}" data-kelas="${kelas}" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 text-sm flex items-center whitespace-nowrap"><div class="btn-content flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V3"></path></svg><span>Download Template</span></div><div class="btn-spinner hidden loading-spinner" style="width:20px; height:20px; border-width:3px;"></div></button>
                <button data-action="import" data-type="${type}" data-mapel-kode="${mapelKode}" data-kelas="${kelas}" class="bg-sky-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-sky-700 text-sm flex items-center whitespace-nowrap"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span>Import Nilai</span></button>
                <div class="h-6 border-l border-gray-300 hidden md:block"></div>
                <button data-action="save" data-type="${type}" data-mapel-kode="${mapelKode}" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm flex items-center gap-2">Simpan Draf</button>
                <button data-action="submit" data-type="${type}" data-mapel-kode="${mapelKode}" class="text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2 bg-green-600 hover:bg-green-700">Kirim Nilai</button>
            `;
        }

        // Mengembalikan semua tombol dalam satu div dengan perataan kiri (justify-start)
        return `<div class="flex items-center justify-start flex-wrap gap-2">${buttonsHtml}</div>`;
    }

    // GANTI FUNGSI INI DI Guru.html
    /**
     * [MODIFIKASI] Membangun tabel nilai dengan mempertimbangkan status kunci (isLockedForGuru).
     */
    function buildScoreTable(type, title, mapelKode, students, savedValues, submittedValues, approvalStatus, kkm, isLockedForGuru, options = {}) {
        const isSubmitted = submittedValues && submittedValues[type];
        const dataToDisplay = isSubmitted ? (submittedValues[type] || {}) : (savedValues ? (savedValues[type] || {}) : {});

        let headers = `<th class="px-4 py-2 text-left border border-gray-200 sticky-col-left header w-28">NISN</th>
                      <th class="px-4 py-2 text-left border border-gray-200 sticky-col-left header w-48">Nama Siswa</th>`;

        let legendHtml = `<div class="text-xs text-gray-500 mb-3 p-2 bg-gray-100 rounded-md"><b>Keterangan:</b> `;
        const legends = [`<b>KKM</b> = ${kkm || 'N/A'}`];
        let inputsHtml;

        if (type === 'ujian') {
            const { jenisUjian } = options;
            const hasUM = jenisUjian === 'Ujian Madrasah' || jenisUjian === 'Keduanya';
            const hasUPr = jenisUjian === 'Ujian Praktek' || jenisUjian === 'Keduanya';
            if (hasUM) { headers += `<th class="px-2 py-2 text-center w-24 border border-gray-200">UM</th>`; legends.push('<b>UM</b> = Ujian Madrasah'); }
            if (hasUPr) { headers += `<th class="px-2 py-2 text-center w-24 border border-gray-200">UPr</th>`; legends.push('<b>UPr</b> = Ujian Praktek'); }

            inputsHtml = (s) => {
                let html = '';
                const nisn = s.nisn;
                const lockedClass = isLockedForGuru ? 'bg-gray-200 cursor-not-allowed' : '';

                if (hasUM) {
                    const value = dataToDisplay[`${nisn}_um`] || '';
                    const status = approvalStatus[`ujian_um_${nisn}`];
                    let isReadOnlyDynamic = isLockedForGuru || (isSubmitted && value !== '' && status !== 'Ditolak');
                    let statusClass = (isSubmitted && value !== '') ? (status === 'Disetujui' ? 'status-disetujui' : status === 'Ditolak' ? 'status-ditolak' : 'status-menunggu') : '';
                    const kkmClass = (!isNaN(parseFloat(value)) && parseFloat(value) < kkm) ? 'text-red-600 font-bold' : '';
                    html += `<td class="px-2 py-1 border border-gray-200"><input type="number" name="${nisn}_um" min="0" max="100" class="w-20 p-1 border rounded-md score-input text-center ${statusClass} ${kkmClass} ${lockedClass}" value="${value}" ${isReadOnlyDynamic ? 'readonly' : ''}></td>`;
                }
                if (hasUPr) {
                    const value = dataToDisplay[`${nisn}_upr`] || '';
                    const status = approvalStatus[`ujian_upr_${nisn}`];
                    let isReadOnlyDynamic = isLockedForGuru || (isSubmitted && value !== '' && status !== 'Ditolak');
                    let statusClass = (isSubmitted && value !== '') ? (status === 'Disetujui' ? 'status-disetujui' : status === 'Ditolak' ? 'status-ditolak' : 'status-menunggu') : '';
                    const kkmClass = (!isNaN(parseFloat(value)) && parseFloat(value) < kkm) ? 'text-red-600 font-bold' : '';
                    html += `<td class="px-2 py-1 border border-gray-200"><input type="number" name="${nisn}_upr" min="0" max="100" class="w-20 p-1 border rounded-md score-input text-center ${statusClass} ${kkmClass} ${lockedClass}" value="${value}" ${isReadOnlyDynamic ? 'readonly' : ''}></td>`;
                }
                return html;
            };
        } else { // Rapor
            headers += `<th class="px-2 py-2 text-center w-24 border border-gray-200">Peng</th><th class="px-2 py-2 text-center w-24 border border-gray-200">Ket</th>`;
            legends.push('<b>Peng</b> = Pengetahuan', '<b>Ket</b> = Keterampilan');

            inputsHtml = (s) => {
                const nisn = s.nisn;
                const lockedClass = isLockedForGuru ? 'bg-gray-200 cursor-not-allowed':''

                const valuePeng = dataToDisplay[`${nisn}_peng`] || '';
                const statusPeng = approvalStatus[`${type}_peng_${nisn}`];
                let isReadOnlyPeng = isLockedForGuru || (isSubmitted && valuePeng !== '' && statusPeng !== 'Ditolak');
                let statusClassPeng = (isSubmitted && valuePeng !== '') ? (statusPeng === 'Disetujui' ? 'status-disetujui' : statusPeng === 'Ditolak' ? 'status-ditolak' : 'status-menunggu') : '';
                const kkmClassPeng = (!isNaN(parseFloat(valuePeng)) && parseFloat(valuePeng) < kkm) ? 'text-red-600 font-bold' : '';

                const valueKet = dataToDisplay[`${nisn}_ket`] || '';
                const statusKet = approvalStatus[`${type}_ket_${nisn}`];
                let isReadOnlyKet = isLockedForGuru || (isSubmitted && valueKet !== '' && statusKet !== 'Ditolak');
                let statusClassKet = (isSubmitted && valueKet !== '') ? (statusKet === 'Disetujui' ? 'status-disetujui' : statusKet === 'Ditolak' ? 'status-ditolak' : 'status-menunggu') : '';
                const kkmClassKet = (!isNaN(parseFloat(valueKet)) && parseFloat(valueKet) < kkm) ? 'text-red-600 font-bold' : '';

                return `<td class="px-2 py-1 border border-gray-200"><input type="number" name="${nisn}_peng" min="0" max="100" class="w-20 p-1 border rounded-md score-input text-center ${statusClassPeng} ${kkmClassPeng} ${lockedClass}" value="${valuePeng}" ${isReadOnlyPeng ? 'readonly' : ''}></td>
                        <td class="px-2 py-1 border border-gray-200"><input type="number" name="${nisn}_ket" min="0" max="100" class="w-20 p-1 border rounded-md score-input text-center ${statusClassKet} ${kkmClassKet} ${lockedClass}" value="${valueKet}" ${isReadOnlyKet ? 'readonly' : ''}></td>`;
            };
        }

        headers += `<th class="px-2 py-2 text-center w-24 border border-gray-200">Jumlah</th>
                    <th class="px-2 py-2 text-center w-24 border border-gray-200">Rata-rata</th>`;
        legendHtml += legends.join(' | ') + '</div>';
        let studentRows = '';
        students.forEach(s => {
            studentRows += `<tr class="hover:bg-gray-50"><td class="px-4 py-2 text-gray-500 border border-gray-200 sticky-col-left">${s.nisn}</td><td class="px-4 py-2 font-medium border border-gray-200 sticky-col-left">${s.nama.toUpperCase()}</td>${inputsHtml(s)}<td class="px-2 py-1 border border-gray-200 text-center font-bold jumlah-nilai">0</td><td class="px-2 py-1 border border-gray-200 text-center font-bold rata-rata-nilai">0</td></tr>`;
        });
        let tableHtml = `${legendHtml}<form id="form-${type}" data-mapel-kode="${mapelKode}" data-type="${type}"><div class="overflow-x-auto"><table class="min-w-full border-collapse text-sm" data-kkm="${kkm}"><thead class="bg-gray-100"><tr>${headers}</tr></thead><tbody>${studentRows}</tbody></table></div></form>`;
        setTimeout(() => { const tableContainer = document.getElementById(`form-${type}`); if(tableContainer) { tableContainer.querySelectorAll('tbody tr').forEach(row => updateRowStats(row)); tableContainer.addEventListener('input', e => { if (e.target.classList.contains('score-input')) { updateRowStats(e.target.closest('tr')); } }); } }, 0);
        return tableHtml;
    }

    /**
     * [FUNGSI BARU] Menghitung dan memperbarui kolom Jumlah & Rata-rata untuk satu baris.
     */
    function updateRowStats(tableRow) {
        if (!tableRow) return;

        const scoreInputs = tableRow.querySelectorAll('.score-input');
        const jumlahCell = tableRow.querySelector('.jumlah-nilai');
        const rataRataCell = tableRow.querySelector('.rata-rata-nilai');
        
        // [PERUBAHAN] Ambil KKM dari atribut data di tabel
        const kkm = parseFloat(tableRow.closest('table')?.dataset.kkm) || 75;

        if (!jumlahCell || !rataRataCell) return;

        let total = 0;
        let count = 0;

        scoreInputs.forEach(input => {
            const value = parseFloat(input.value);
            if (!isNaN(value)) {
                total += value;
                count++;
            }
            // [PERUBAHAN] Logika pewarnaan real-time saat mengetik
            input.classList.remove('text-red-600', 'font-bold');
            if (!isNaN(value) && value < kkm) {
                input.classList.add('text-red-600', 'font-bold');
            }
        });

        const average = count > 0 ? (total / count) : 0;
        const roundedAverage = Math.round(average);

        jumlahCell.textContent = total;
        rataRataCell.textContent = roundedAverage;

        // [PERUBAHAN] Logika pewarnaan untuk rata-rata
        rataRataCell.classList.remove('text-red-600');
        if (roundedAverage < kkm && count > 0) {
            rataRataCell.classList.add('text-red-600');
        }
    }

    /**
     * [FUNGSI BARU] Memasang validasi real-time pada semua input nilai.
     * Mencegah input di luar rentang 0-100.
     */
    function setupScoreInputValidation() {
        const tabContent = document.getElementById('tab-content');
        if (!tabContent) return;

        // Listener ini memberikan feedback instan jika nilai > 100
        tabContent.addEventListener('input', function(e) {
            if (e.target.classList.contains('score-input') && e.target.type === 'number') {
                const input = e.target;
                let value = parseInt(input.value, 10);
                if (value > 100) {
                    input.value = 100;
                }
            }
        });

        // Listener ini membersihkan nilai saat guru selesai mengisi (menghilangkan '0' di depan)
        tabContent.addEventListener('blur', function(e) {
            if (e.target.classList.contains('score-input') && e.target.type === 'number') {
                const input = e.target;
                const rawValue = input.value;

                // Jika input kosong, biarkan kosong
                if (rawValue.trim() === '') {
                    updateRowStats(input.closest('tr'));
                    return;
                }

                // Konversi ke integer untuk validasi dan menghilangkan leading zero
                const value = parseInt(rawValue, 10);

                if (isNaN(value) || value < 0) {
                    input.value = ''; // Hapus jika tidak valid atau negatif
                } else {
                    // Set nilai kembali ke input. Ini akan otomatis menghapus leading zero.
                    // Contoh: parseInt('09') adalah 9, jadi input.value akan menjadi '9'.
                    // parseInt('010') adalah 10, jadi input.value akan menjadi '10'.
                    input.value = value;
                }
                
                // Panggil updateRowStats lagi untuk memastikan pewarnaan KKM dan perhitungan diperbarui
                updateRowStats(input.closest('tr'));
            }
        }, true); // 'true' untuk event capturing
    }

    // GANTI FUNGSI INI KEMBALI KE VERSI ASLI
    function getFormData(type, mapelKode) {
        const form = document.getElementById(`form-${type}`);
        const inputs = form.querySelectorAll('input[type="number"]');
        const nilai = {};
        inputs.forEach(input => { nilai[input.name] = input.value; }); // <-- PERUBAHAN DI SINI
        const guruData = JSON.parse(sessionStorage.getItem('guruData'));
        return { spreadsheetId: guruData.spreadsheetId, username: guruData.username, mapelKode, type: type, nilai: nilai };
    }
    
    // [PERUBAHAN] Ganti fungsi setupActionListeners
    function setupActionListeners() {
        const tabContent = document.getElementById('tab-content');
        tabContent.addEventListener('click', function(e) {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            e.preventDefault();
            const action = button.dataset.action;
            const type = button.dataset.type;
            const mapelKode = button.dataset.mapelKode;
            const kelas = button.dataset.kelas;

            if (action === 'save') { handleSaveDraft(button, type, mapelKode); } 
            else if (action === 'submit') { handleKirimNilai(button, type, mapelKode); } 
            else if (action === 'cancel') { handleBatalKirim(button, type, mapelKode); }
            else if (action === 'print') { handleCetakNilai(button, type, mapelKode, kelas); } 
            else if (action === 'resubmit') { handleResendNilai(button, type, mapelKode); }
            else if (action === 'export') { handleExportNilaiTemplate(button, type, mapelKode, kelas); }
            else if (action === 'import') { openGuruImportModal(button, type, mapelKode, kelas); }
        });
    }

    // [PERUBAHAN] Tambahkan 3 fungsi baru ini
    let guruNilaiDropzone;
    Dropzone.autoDiscover = false;

    // File: Guru.html

    function handleExportNilaiTemplate(btn, type, mapelKode, kelas) {
        const guruData = JSON.parse(sessionStorage.getItem('guruData'));
        
        // ===============================================================
        // === AWAL PERUBAHAN: Targetkan elemen yang benar ===============
        // ===============================================================
        const btnContent = btn.querySelector('.btn-content'); // Menggantikan btnText
        const spinner = btn.querySelector('.btn-spinner');
        
        btn.disabled = true;
        if(btnContent) btnContent.classList.add('hidden'); // Sembunyikan div yang berisi ikon dan teks
        if(spinner) spinner.classList.remove('hidden');
        // ===============================================================
        // === AKHIR PERUBAHAN ===========================================
        // ===============================================================

        google.script.run
            .withSuccessHandler(result => {
                if (result.base64Data) {
                    const link = document.createElement('a');
                    link.href = `data:${result.mimeType};base64,${result.base64Data}`;
                    link.download = result.fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification('Template berhasil diekspor.', 'success');
                } else {
                    showNotification('Gagal ekspor: ' + (result.error || 'Unknown error'), 'error');
                }
                // Kembalikan tombol ke normal setelah sukses
                btn.disabled = false;
                if(btnContent) btnContent.classList.remove('hidden'); // Tampilkan kembali
                if(spinner) spinner.classList.add('hidden');
            })
            .withFailureHandler(err => {
                showNotification('Error: ' + err.message, 'error');
                // Kembalikan tombol ke normal jika gagal
                btn.disabled = false;
                if(btnContent) btnContent.classList.remove('hidden'); // Tampilkan kembali
                if(spinner) spinner.classList.add('hidden');
            })
            .generateNilaiTemplateForGuru(guruData.spreadsheetId, kelas, mapelKode, type, guruData);
    }

    function openGuruImportModal(btn, type, mapelKode, kelas) {
        const modal = document.getElementById('guru-nilai-import-modal');
        const title = document.getElementById('guru-import-modal-title');
        title.textContent = `Import Nilai untuk ${mapelKode} - Kelas ${kelas}`;
        
        modal.classList.remove('hidden');
        setTimeout(() => modal.querySelector('.modal-content').style.transform = 'scale(1)', 10);

        if (guruNilaiDropzone) {
            guruNilaiDropzone.destroy();
        }

        guruNilaiDropzone = new Dropzone("#guru-nilai-dropzone-form", {
            url: "#", autoProcessQueue: false, maxFiles: 1, acceptedFiles: '.xlsx, .xls', addRemoveLinks: true,
            init: function() {
                this.on("addedfile", function(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const fileData = { fileName: file.name, mimeType: file.type, content: e.target.result.split(',')[1] };
                        const guruData = JSON.parse(sessionStorage.getItem('guruData'));
                        
                        const overlay = document.getElementById('loading-overlay');
                        const overlayTitle = document.getElementById('overlay-title');
                        
                        // [PERBAIKAN] Pastikan overlay dan overlayTitle ada sebelum digunakan
                        if (overlay && overlayTitle) {
                            overlayTitle.textContent = "Mengimpor Nilai Guru...";
                            overlay.classList.remove('hidden');
                        }

                        this.emit("processing", file);
                        google.script.run
                            .withSuccessHandler(res => {
                                if (overlay) overlay.classList.add('hidden');
                                this.emit("success", file);
                                showNotification(res.message, res.status === 'success' ? 'success' : 'error');
                                if (res.status === 'success') {
                                    closeGuruImportModal();
                                    if (type === 'ujian') {
                                        buildUjianForm(mapelKode, guruData.mapel.find(m => m.kode === mapelKode).jenisUjian, kelas);
                                    } else {
                                        renderRaporSemesterTable(type.split('_').slice(1).join('_'), mapelKode, kelas);
                                    }
                                }
                            })
                            .withFailureHandler(err => {
                                if (overlay) overlay.classList.add('hidden');
                                this.emit("error", file, err.message);
                                showNotification('Gagal impor: ' + err.message, 'error');
                            })
                            .importNilaiFromExcelForGuru(guruData.spreadsheetId, fileData, guruData.username, mapelKode, type);
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        document.getElementById('closeGuruImportModalBtn').onclick = closeGuruImportModal;
        document.getElementById('closeGuruImportModalBtn2').onclick = closeGuruImportModal;
    }

    function closeGuruImportModal() {
        const modal = document.getElementById('guru-nilai-import-modal');
        modal.classList.add('hidden');
        if (guruNilaiDropzone) {
            guruNilaiDropzone.removeAllFiles(true);
        }
    }

    function handleResendNilai(btn, type, mapelKode) {
        showConfirmationModal({
            title: "Kirim Ulang Nilai Revisi",
            message: "Hanya nilai yang ditolak (dan dapat diedit) yang akan dikirim ulang untuk persetujuan. Lanjutkan?",
            confirmText: "Ya, Kirim Ulang",
            confirmColor: "bg-blue-600 hover:bg-blue-700",
            onConfirm: () => {
                const form = document.getElementById(`form-${type}`);
                const inputs = form.querySelectorAll('input[type="number"]:not([readonly])');
                const nilaiRevisi = {};
                inputs.forEach(input => {
                    if (input.value !== '') {
                        nilaiRevisi[input.name] = input.value;
                    }
                });

                if (Object.keys(nilaiRevisi).length === 0) {
                    showNotification("Tidak ada nilai yang direvisi untuk dikirim ulang.", "error");
                    return;
                }
                
                const guruData = JSON.parse(sessionStorage.getItem('guruData'));
                const submissionId = btn.dataset.submissionId;

                const payload = {
                    spreadsheetId: guruData.spreadsheetId,
                    username: guruData.username,
                    nama: guruData.nama,
                    submissionId: submissionId,
                    tipeNilai: type,
                    nilaiRevisi: nilaiRevisi
                };

                const originalHtml = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<div class="loading-spinner mx-auto" style="width:16px; height:16px; border-width:2px;"></div>';

                google.script.run
                    .withSuccessHandler(res => {
                        showNotification(res.message, res.status === 'success' ? 'success' : 'error');
                        if (res.status === 'success') {
                            // ===== PERUBAHAN UTAMA DI SINI =====
                            // Mulai polling juga setelah mengirim revisi
                            const activeMapelLink = document.querySelector('.mapel-link.active');
                            startGuruStatusPolling();
                            // ===================================
                            
                            if (type === 'ujian') {
                                buildUjianForm(activeMapelLink.dataset.kode, activeMapelLink.dataset.jenisUjian, activeMapelLink.dataset.kelas);
                            } else if (type.startsWith('rapor_')) {
                                const semesterKey = type.split('_').slice(1).join('_');
                                renderRaporSemesterTable(semesterKey, mapelKode, activeMapelLink.dataset.kelas);
                            }
                        } else {
                            btn.disabled = false;
                            btn.innerHTML = originalHtml;
                        }
                    })
                    .withFailureHandler(err => {
                        showNotification('Gagal: ' + err.message, 'error');
                        btn.disabled = false;
                        btn.innerHTML = originalHtml;
                    })
                    .resubmitRevisedNilai(payload);
            }
        });
    }

    /**
     * [PERBAIKAN FINAL] Menangani klik tombol cetak dengan validasi ID Pengajuan
     * untuk mencegah error 'submissionId is not defined'.
     */
    function handleCetakNilai(btn, type, mapelKode, kelas) { 
        const guruData = JSON.parse(sessionStorage.getItem('guruData'));
        const submissionId = btn.dataset.submissionId;

        if (!submissionId || submissionId === 'null' || submissionId === 'undefined') {
            showNotification("Gagal mencetak: Tidak dapat menemukan ID pengajuan yang valid. Coba segarkan halaman.", "error");
            return; 
        }

        const payload = {
            spreadsheetId: guruData.spreadsheetId,
            tipe: type,
            mapelKode: mapelKode,
            guruData: guruData,
            submissionId: submissionId,
            kelas: kelas // <-- TAMBAHKAN PROPERTI KELAS DI SINI
        };

        const originalHtml = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<div class="loading-spinner mx-auto" style="width:16px; height:16px; border-width:2px;"></div>';

        google.script.run
            .withSuccessHandler(response => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                if (response.status === 'success') {
                    const link = document.createElement('a');
                    link.href = `data:application/pdf;base64,${response.pdfData}`;
                    link.download = response.fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showNotification('PDF berhasil dibuat.', 'success');
                } else {
                    // Tampilkan pesan error dari server jika ada
                    showNotification('Gagal membuat PDF: ' + response.message, 'error');
                }
            })
            .withFailureHandler(err => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                showNotification('Error saat menghubungi server: ' + err.message, 'error');
            })
            .generateNilaiPdfForGuru(payload);
    }

    function handleSaveDraft(btn, type, mapelKode) {
        const payload = getFormData(type, mapelKode);
        if (Object.keys(payload.nilai).length === 0) { 
            showNotification("Tidak ada nilai untuk disimpan.", "error"); 
            return; 
        }
        const originalHtml = btn.innerHTML;
        btn.disabled = true; 
        btn.innerHTML = '<div class="loading-spinner mx-auto" style="width:16px; height:16px; border-width:2px;"></div>';
        
        google.script.run
            .withSuccessHandler(res => { 
                showNotification(res.message, res.status === 'success' ? 'success' : 'error');
                btn.innerHTML = originalHtml; 
                btn.disabled = false;
                if (res.status === 'success') {
                    const activeMapelLink = document.querySelector('.mapel-link.active');
                    if (type === 'ujian') {
                        // [PERBAIKAN] Tambahkan 'activeMapelLink.dataset.kelas' sebagai argumen ketiga
                        buildUjianForm(activeMapelLink.dataset.kode, activeMapelLink.dataset.jenisUjian, activeMapelLink.dataset.kelas);
                    } else if (type.startsWith('rapor_')) {
                        const semesterKey = type.split('_').slice(1).join('_');
                        // [PERBAIKAN] Tambahkan 'activeMapelLink.dataset.kelas' sebagai argumen ketiga
                        renderRaporSemesterTable(semesterKey, mapelKode, activeMapelLink.dataset.kelas);
                    }
                }
            })
            .withFailureHandler(err => { 
                showNotification('Gagal: ' + err.message, 'error'); 
                btn.innerHTML = originalHtml; 
                btn.disabled = false;
            })
            .saveGuruDraftNilai(payload);
    }

    function handleKirimNilai(btn, type, mapelKode) {
        showConfirmationModal({
            title: "Konfirmasi Kirim Nilai",
            message: "Anda yakin ingin mengirim nilai ini? Setelah dikirim, nilai tidak dapat diubah kecuali dibatalkan oleh admin.",
            confirmText: "Ya, Kirim",
            confirmColor: "bg-green-600 hover:bg-green-700",
            onConfirm: () => {
                const payload = getFormData(type, mapelKode);
                if (Object.keys(payload.nilai).length === 0) { 
                    showNotification("Tidak ada nilai untuk dikirim.", "error"); 
                    return; 
                }
                const guruData = JSON.parse(sessionStorage.getItem('guruData'));
                payload.nama = guruData.nama; 
                const originalHtml = btn.innerHTML;
                btn.disabled = true; 
                btn.innerHTML = '<div class="loading-spinner mx-auto" style="width:16px; height:16px; border-width:2px;"></div>';
                
                google.script.run
                    .withSuccessHandler(res => { 
                        showNotification(res.message, res.status === 'success' ? 'success' : 'error');
                        if (res.status === 'success') {
                            // ===== PERUBAHAN UTAMA DI SINI =====
                            // Setelah sukses, panggil fungsi polling dengan submissionId dari server
                            const activeMapelLink = document.querySelector('.mapel-link.active');
                            startGuruStatusPolling();
                            // ===================================

                            if (type === 'ujian') {
                                buildUjianForm(activeMapelLink.dataset.kode, activeMapelLink.dataset.jenisUjian, activeMapelLink.dataset.kelas);
                            } else if (type.startsWith('rapor_')) {
                                const semesterKey = type.split('_').slice(1).join('_');
                                renderRaporSemesterTable(semesterKey, mapelKode, activeMapelLink.dataset.kelas);
                            }
                        } else { 
                            btn.innerHTML = originalHtml; 
                            btn.disabled = false; 
                        }
                    })
                    .withFailureHandler(err => { 
                        showNotification('Gagal: ' + err.message, 'error'); 
                        btn.innerHTML = originalHtml; 
                        btn.disabled = false;
                    })
                    .submitGuruNilai(payload);
            }
        });
    }

    function handleBatalKirim(btn, type, mapelKode) {
        showConfirmationModal({
            title: "Konfirmasi Batal Kirim",
            message: "Anda yakin ingin membatalkan pengiriman nilai ini? Anda dapat mengeditnya kembali setelah dibatalkan.",
            confirmText: "Ya, Batalkan",
            confirmColor: "bg-yellow-500 hover:bg-yellow-600",
            onConfirm: () => {
                const guruData = JSON.parse(sessionStorage.getItem('guruData'));
                const payload = { spreadsheetId: guruData.spreadsheetId, username: guruData.username, mapelKode, type: type };
                const originalHtml = btn.innerHTML;
                btn.disabled = true; 
                btn.innerHTML = '<div class="loading-spinner mx-auto" style="width:16px; height:16px; border-width:2px;"></div>';
                
                google.script.run
                    .withSuccessHandler(res => { 
                        showNotification(res.message, res.status === 'success' ? 'success' : 'error');
                        if (res.status === 'success') { 
                            const activeMapelLink = document.querySelector('.mapel-link.active');
                            if (type === 'ujian') {
                                // [PERBAIKAN] Tambahkan 'activeMapelLink.dataset.kelas' sebagai argumen ketiga
                                buildUjianForm(activeMapelLink.dataset.kode, activeMapelLink.dataset.jenisUjian, activeMapelLink.dataset.kelas);
                            } else if (type.startsWith('rapor_')) {
                                const semesterKey = type.split('_').slice(1).join('_');
                                // [PERBAIKAN] Tambahkan 'activeMapelLink.dataset.kelas' sebagai argumen ketiga
                                renderRaporSemesterTable(semesterKey, mapelKode, activeMapelLink.dataset.kelas);
                            }
                        } else { 
                            btn.innerHTML = originalHtml; 
                            btn.disabled = false; 
                        }
                    })
                    .withFailureHandler(err => { 
                        showNotification('Gagal: ' + err.message, 'error'); 
                        btn.innerHTML = originalHtml; 
                        btn.disabled = false;
                    })
                    .cancelGuruSubmission(payload);
            }
        });
    }
    
    function setupTabs() {
        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const targetTab = tab.dataset.tab;
                document.querySelectorAll('#tab-content > div').forEach(content => {
                    content.id === `tab-${targetTab}` ? content.classList.remove('hidden') : content.classList.add('hidden');
                });
            });
        });
    }

    function handleGuruLogout() {
        sessionStorage.removeItem('guruData');

        // ===== AWAL PERUBAHAN =====
        // Secara eksplisit sembunyikan portal utama dan tampilkan halaman login
        document.getElementById('main-app-container').classList.add('hidden');
        document.getElementById('login-container').classList.remove('hidden');
        // ===== AKHIR PERUBAHAN =====

        document.getElementById('loginFormGuru').reset();
        document.getElementById('pilih-mapel-container').innerHTML = '';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const storedGuruData = sessionStorage.getItem('guruData');
        if (storedGuruData) {
            // ===== AWAL PERUBAHAN =====
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('main-app-container').classList.remove('hidden');
            initializeAppGuru(JSON.parse(storedGuruData));
            // ===== AKHIR PERUBAHAN =====
        } else {
            // ===== AWAL PERUBAHAN =====
            document.getElementById('main-app-container').classList.add('hidden');
            document.getElementById('login-container').classList.remove('hidden');
            // ===== AKHIR PERUBAHAN =====
            setupPasswordToggles(); 
        }
        document.getElementById('loginFormGuru').addEventListener('submit', handleGuruLogin);
        document.getElementById('backToMainLoginBtnGuru').addEventListener('click', function() {
            if (typeof WEB_APP_URL !== 'undefined' && WEB_APP_URL) {
                window.top.location.href = WEB_APP_URL;
            } else {
                showNotification("Gagal kembali ke halaman utama.", "error");
            }
        });

        document.getElementById('saveProfileDataBtn')?.addEventListener('click', handleSaveProfileData);
        document.getElementById('saveProfileCredentialsBtn')?.addEventListener('click', handleSaveProfileCredentials);
    });

    // Tambahkan fungsi baru ini
    function setupPasswordToggles() {
        document.querySelectorAll('[data-toggle-password]').forEach(button => {
            // Hapus listener lama untuk mencegah penumpukan jika fungsi dipanggil berkali-kali
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);

            newButton.addEventListener('click', () => {
                const inputId = newButton.getAttribute('data-toggle-password');
                const passwordInput = document.getElementById(inputId);
                if (passwordInput) {
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    newButton.querySelector('.eye-icon').classList.toggle('hidden');
                    newButton.querySelector('.eye-slash-icon').classList.toggle('hidden');
                }
            });
        });
    }

    // Tambahkan fungsi baru ini di dalam <script> pada Guru.html
    function loadSiswaTanpaKelas() {
        const container = document.getElementById('siswa-tanpa-kelas-container');
        container.innerHTML = `<p class="text-center p-4 loading-animation">Memuat data siswa...</p>`;

        const guruData = JSON.parse(sessionStorage.getItem('guruData'));

        google.script.run
            .withSuccessHandler(response => {
                if (response.status === 'success') {
                    const students = response.data;
                    if (students.length === 0) {
                        container.innerHTML = `<p class="text-center p-4 text-green-700 font-semibold">Bagus! Semua siswa sudah memiliki kelas.</p>`;
                        return;
                    }
                    
                    let tableHtml = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Lengkap</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jenis Kelamin</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tempat, Tgl Lahir</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">`;
                    
                    students.forEach(s => {
                        const tglLahirFormatted = s.tanggalLahir ? new Date(s.tanggalLahir).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'}) : '-';
                        tableHtml += `
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.nisn}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.nama.toUpperCase()}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.jenisKelamin === 'L' ? 'Laki-laki' : 'Perempuan'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.tempatLahir}, ${tglLahirFormatted}</td>
                            </tr>
                        `;
                    });

                    tableHtml += `</tbody></table></div>`;
                    container.innerHTML = tableHtml;
                } else {
                    container.innerHTML = `<p class="text-center text-red-500 p-4">${response.message}</p>`;
                }
            })
            .withFailureHandler(err => {
                container.innerHTML = `<p class="text-center text-red-500 p-4">Error: ${err.message}</p>`;
            })
            .getSiswaTanpaKelas(guruData.spreadsheetId);
    }

    // File: Guru.html (di dalam tag <script>)

    function toProperCase(str) {
      if (!str || typeof str !== 'string') return '';
      return str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
      });
    }

    function formatIndonesianDate(dateInput) {
        if (!dateInput) return "-";
        const date = new Date(dateInput);
        if (isNaN(date.getTime())) return "-";
        return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    }

    /**
     * Memuat data awal untuk halaman Daftar Siswa.
     */
    function loadDaftarSiswaPage() {
        const container = document.getElementById('daftar-siswa-container');
        const filterSelect = document.getElementById('filter-kelas-siswa');
        container.innerHTML = `<p class="text-center p-4 loading-animation">Memuat data siswa...</p>`;

        const guruData = JSON.parse(sessionStorage.getItem('guruData'));
        if (!guruData) return;

        // 1. Ambil semua kelas unik yang diajar guru untuk mengisi filter
        const uniqueKelas = [...new Set(guruData.mapel.flatMap(m => m.kelas))].sort();
        
        // 2. Isi dropdown filter
        filterSelect.innerHTML = '<option value="semua">Tampilkan Semua Kelas</option>';
        uniqueKelas.forEach(k => {
            filterSelect.add(new Option(`Kelas ${k}`, k));
        });

        // 3. Pasang event listener untuk filter
        filterSelect.onchange = () => {
            const selectedKelas = filterSelect.value;
            const studentsToRender = selectedKelas === 'semua' 
                ? allStudentsForGuruPage 
                : allStudentsForGuruPage.filter(s => s.kelas === selectedKelas);
            renderDaftarSiswaTable(studentsToRender);
        };

        // 4. Panggil data siswa dari server
        google.script.run
            .withSuccessHandler(response => {
                if (response.status === 'success') {
                    allStudentsForGuruPage = response.data; // Simpan data di cache
                    renderDaftarSiswaTable(allStudentsForGuruPage); // Tampilkan semua siswa pada awalnya
                } else {
                    container.innerHTML = `<p class="text-center text-red-500 p-4">${response.message}</p>`;
                }
            })
            .withFailureHandler(err => {
                container.innerHTML = `<p class="text-center text-red-500 p-4">Error: ${err.message}</p>`;
            })
            .getStudentListForGuru(guruData.spreadsheetId);
    }

    /**
     * Merender tabel daftar siswa ke dalam kontainer.
     * @param {Array} studentsToDisplay - Array siswa yang akan ditampilkan.
     */
    function renderDaftarSiswaTable(studentsToDisplay) {
        const container = document.getElementById('daftar-siswa-container');
        
        if (studentsToDisplay.length === 0) {
            container.innerHTML = `<p class="text-center p-4 text-gray-500">Tidak ada data siswa untuk ditampilkan.</p>`;
            return;
        }

        let tableHtml = `<table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">NISN</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Lengkap</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jenis Kelamin</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tempat, Tanggal Lahir</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">`;

        studentsToDisplay.forEach(s => {
            const ttl = `${toProperCase(s.tempatLahir)}, ${formatIndonesianDate(s.tanggalLahir)}`;
            tableHtml += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.nisn}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.nama.toUpperCase()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.jenisKelamin === 'L' ? 'Laki-laki' : 'Perempuan'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${ttl}</td>
                </tr>
            `;
        });

        tableHtml += `</tbody></table>`;
        container.innerHTML = tableHtml;
    }

    /**
     * Menangani penyimpanan data pribadi guru (Nama & NIP).
     */
    function handleSaveProfileData() {
        const btn = document.getElementById('saveProfileDataBtn');
        btn.disabled = true;
        btn.textContent = 'Menyimpan...';

        const guruData = JSON.parse(sessionStorage.getItem('guruData'));
        const profileData = {
            nama: document.getElementById('profile_nama_guru').value,
            nip: document.getElementById('profile_nip_guru').value,
        };

        google.script.run
            .withSuccessHandler(response => {
                btn.disabled = false;
                btn.textContent = 'Simpan Data Pribadi';
                showNotification(response.message, response.status === 'success' ? 'success' : 'error');
                if (response.status === 'success') {
                    // Perbarui nama di sidebar dan session
                    document.getElementById('nama-guru-display').textContent = profileData.nama;
                    guruData.nama = profileData.nama;

                    // PERBAIKAN: Tambahkan baris ini untuk memperbarui NIP di sesi
                    guruData.nip = profileData.nip;

                    sessionStorage.setItem('guruData', JSON.stringify(guruData));
                }
            })
            .withFailureHandler(err => {
                btn.disabled = false;
                btn.textContent = 'Simpan Data Pribadi';
                showNotification(`Error: ${err.message}`, 'error');
            })
            .updateGuruData_Guru(guruData.spreadsheetId, guruData.username, profileData);
    }

    /**
     * Menangani penyimpanan kredensial login guru (Username & Password).
     */
    function handleSaveProfileCredentials() {
        showConfirmationModal({
            title: "Konfirmasi Ubah Akun",
            message: "Anda yakin ingin mengubah Username atau Password? Anda akan diminta untuk login kembali setelah ini.",
            confirmText: "Ya, Ubah & Logout",
            confirmColor: "bg-red-600 hover:bg-red-700",
            onConfirm: () => {
                const btn = document.getElementById('saveProfileCredentialsBtn');
                btn.disabled = true;
                btn.textContent = 'Menyimpan...';
                
                const guruData = JSON.parse(sessionStorage.getItem('guruData'));
                const credentialData = {
                    username: document.getElementById('profile_username_guru').value,
                    password: document.getElementById('profile_password_guru').value,
                };

                if (!credentialData.username || !credentialData.password) {
                    showNotification("Username dan Password tidak boleh kosong.", "error");
                    btn.disabled = false;
                    btn.textContent = 'Simpan Akun Login';
                    return;
                }

                google.script.run
                    .withSuccessHandler(response => {
                        btn.disabled = false;
                        btn.textContent = 'Simpan Akun Login';
                        showNotification(response.message, response.status === 'success' ? 'success' : 'error');
                        if (response.status === 'success') {
                            showNotification('Login Anda diperbarui. Anda akan logout dalam 3 detik...', 'info');
                            setTimeout(handleGuruLogout, 3000);
                        }
                    })
                    .withFailureHandler(err => {
                        btn.disabled = false;
                        btn.textContent = 'Simpan Akun Login';
                        showNotification(`Error: ${err.message}`, 'error');
                    })
                    .updateGuruCredentials_Guru(guruData.spreadsheetId, guruData.username, credentialData);
            }
        });
    }

    // ===== AWAL KODE BARU UNTUK REALTIME POLLING =====

    let pollingInterval; // Variabel global untuk menyimpan interval polling

    /**
     * [VERSI FINAL 2.0] Memulai polling untuk memeriksa status SEMUA pengajuan guru.
     */
    function startGuruStatusPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }
        const guruData = JSON.parse(sessionStorage.getItem('guruData'));
        if (!guruData) return;

        const poll = () => {
            google.script.run
                .withSuccessHandler(statusData => {
                    updateGuruPollingStatusBar(statusData);
                    if (!statusData.hasPending) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                    }
                })
                .withFailureHandler(err => {
                    console.error("Gagal melakukan polling status:", err);
                })
                // ===== PERUBAHAN UTAMA: Panggil fungsi backend yang baru =====
                .getPendingSubmissionStatus(guruData.spreadsheetId, guruData.username);
        };

        poll(); 
        pollingInterval = setInterval(poll, 15000); 
    }

    /**
     * [VERSI FINAL 2.0] Memperbarui tampilan banner status polling sesuai format yang diminta.
     */
    function updateGuruPollingStatusBar(statusData) {
        const statusBar = document.getElementById('submission-status-bar');
        if (!statusBar) return;

        if (!statusData || !statusData.hasPending) {
            statusBar.classList.add('hidden');
            return;
        }

        let contentHtml = '<div class="w-full">';
        contentHtml += '<div class="font-semibold text-gray-800 mb-2 flex items-center gap-2"><svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Status Pengajuan:</div>';
        
        contentHtml += '<div class="space-y-1 pl-2 text-gray-700">';

        let hasContent = false;
        
        // Tampilkan baris untuk Nilai Ujian jika ada yang menunggu
        if (statusData.ujian.pending > 0) {
            contentHtml += `
                <div>
                    Nilai Ujian (${statusData.ujian.pending} menunggu): 
                    <strong class="text-green-600">${statusData.ujian.approved}</strong> disetujui, 
                    <strong class="text-red-600">${statusData.ujian.rejected}</strong> ditolak
                </div>`;
            hasContent = true;
        }

        // Tampilkan baris untuk Nilai Rapor jika ada yang menunggu
        if (statusData.rapor.pending > 0) {
            contentHtml += `
                <div>
                    Nilai Rapor (${statusData.rapor.pending} menunggu): 
                    <strong class="text-green-600">${statusData.rapor.approved}</strong> disetujui, 
                    <strong class="text-red-600">${statusData.rapor.rejected}</strong> ditolak
                </div>`;
            hasContent = true;
        }
        
        contentHtml += '</div></div>';

        if (hasContent) {
            statusBar.innerHTML = contentHtml;
            statusBar.className = 'mb-4 p-4 rounded-lg text-sm flex items-start gap-3 bg-yellow-50 border-l-4 border-yellow-400';
            statusBar.classList.remove('hidden');
        } else {
            statusBar.classList.add('hidden');
        }
    }

    // ===== [BARU] FUNGSI UNTUK REAL-TIME UPDATE DI PORTAL GURU =====

    /**
     * Menghentikan semua proses polling yang sedang berjalan.
     */
    function stopAllGuruPolling() {
        for (const id in guruPollingTimers) {
            clearInterval(guruPollingTimers[id]);
        }
        guruPollingTimers = {};
    }

    /**
     * Memulai proses polling untuk sebuah ID pengajuan tertentu.
     */
    function startGuruPolling(submissionId, formType) {
        stopAllGuruPolling(); // Selalu hentikan polling lama sebelum memulai yang baru

        // Mulai polling baru setiap 5 detik
        guruPollingTimers[submissionId] = setInterval(() => {
            const guruData = JSON.parse(sessionStorage.getItem('guruData'));
            google.script.run
                .withSuccessHandler(response => {
                    if (response.status === 'success') {
                        updateUIWithLiveData(response, submissionId, formType);
                        if (response.allApproved) {
                            stopAllGuruPolling(); // Hentikan jika semua sudah disetujui
                        }
                    } else {
                        stopAllGuruPolling();
                    }
                })
                .withFailureHandler(err => {
                    console.error("Polling gagal:", err);
                    stopAllGuruPolling();
                })
                .getLiveApprovalStatus_Guru(guruData.spreadsheetId, submissionId);
        }, 5000); // Interval 5 detik
    }

    /**
     * Memperbarui tampilan (kotak input dan tombol cetak) berdasarkan data live.
     */
    function updateUIWithLiveData(data, submissionId, formType) {
        const { approvalStatus, allApproved } = data;
        const form = document.getElementById(`form-${formType}`);
        if (!form) return;

        // Perbarui status setiap kotak input nilai
        for (const key in approvalStatus) {
            const parts = key.split('_');
            const nisn = parts.pop();
            const scoreTypeParts = parts;

            let inputName = '';
            if (scoreTypeParts[0] === 'ujian') {
                inputName = `${nisn}_${scoreTypeParts[1]}`;
            } else if (scoreTypeParts[0] === 'rapor') {
                inputName = `${nisn}_${scoreTypeParts[3]}`;
            }

            if(inputName) {
                const input = form.querySelector(`input[name="${inputName}"]`);
                if (input) {
                    const newStatus = approvalStatus[key];
                    input.classList.remove('status-menunggu', 'status-ditolak', 'status-disetujui');
                    if (newStatus === 'Disetujui') input.classList.add('status-disetujui');
                    else if (newStatus === 'Ditolak') input.classList.add('status-ditolak');
                    else input.classList.add('status-menunggu');
                }
            }
        }

        // Perbarui tombol Cetak Nilai
        if (allApproved) {
            const printButton = document.querySelector(`button[data-action="print"][data-submission-id="${submissionId}"]`);
            if (printButton) {
                printButton.disabled = false;
                printButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                printButton.classList.add('bg-cyan-600', 'hover:bg-cyan-700');
                printButton.title = 'Cetak Nilai';
            }
        }
    }
</script>
</body>
</html>
