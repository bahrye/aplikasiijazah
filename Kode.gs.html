// =================================================================
// KONFIGURASI GLOBAL
// =================================================================

// PENTING: Ganti dengan ID Spreadsheet Template yang sudah Anda buat.
// Anda bisa mendapatkan ID ini dari URL spreadsheet template Anda.
// Contoh URL: https://docs.google.com/spreadsheets/d/INI_ADALAH_ID_NYA/edit
const TEMPLATE_SPREADSHEET_ID = "14u86jJydOZu-nsTRTH_dOGIBhvLLIObLkbXsHrJ0xhM"; 

// Nama-nama Sheet yang digunakan di dalam spreadsheet data setiap sekolah.
const SHEET_PENGGUNA = "Data Pengguna"; // Ini ada di spreadsheet induk
const SHEET_DATA_SEKOLAH = "Data Sekolah";
const SHEET_DATA_SISWA = "Data Siswa";
const SHEET_MAPEL = "Data Mata Pelajaran";
const SHEET_BOBOT = "Data Bobot Nilai";
const SHEET_NILAI_UJIAN_MADRASAH = "Nilai Ujian Madrasah";
const SHEET_NILAI_UJIAN_PRAKTEK = "Nilai Ujian Praktek";
const SHEET_REKAP_UJIAN = "Rekap Nilai Ujian";
const SHEET_REKAP_RAPOR = "Rekap Nilai Rapor";
const SHEET_REKAP_IJAZAH = "Rekap Nilai Ijazah";
const SHEET_MAPEL_DEFAULT = "Mapel Default"; // Sheet di Spreadsheet Induk untuk mapel standar


/**
 * Fungsi utama yang dipanggil saat web app diakses.
 * @returns {HtmlService.HtmlOutput} Output HTML untuk ditampilkan.
 */
function doGet(e) {
  return HtmlService.createHtmlOutputFromFile('Index')
    .setTitle('Aplikasi Akademik Sekolah')
    .setFaviconUrl("https://uploadimage.io/images/2025/06/10/Icon-Legalisir-Ijazah.png")
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// =================================================================
// FUNGSI AUTENTIKASI DAN MANAJEMEN AKUN
// =================================================================

/**
 * Mendaftarkan pengguna baru, membuat spreadsheet data khusus untuknya.
 * @param {{email: string, password: string, namaSekolah: string, jenjang: string}} userData Objek berisi data pengguna baru.
 * @returns {{status: string, message: string}} Objek status hasil pendaftaran.
 */
function registerUser(userData) {
  try {
    if (TEMPLATE_SPREADSHEET_ID === "GANTI_DENGAN_ID_TEMPLATE_ANDA") {
      throw new Error("ID Spreadsheet Template belum diatur di dalam Kode.gs. Harap periksa instruksi.");
    }

    const { email, password, namaSekolah, jenjang } = userData;
    const lock = LockService.getScriptLock();
    lock.waitLock(30000); // Tunggu hingga 30 detik

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let userSheet = ss.getSheetByName(SHEET_PENGGUNA);

    if (!userSheet) {
      throw new Error(`Sheet '${SHEET_PENGGUNA}' tidak ditemukan di spreadsheet induk.`);
    }

    if (userSheet.getLastRow() > 1) {
        const dataRange = userSheet.getRange(2, 2, userSheet.getLastRow() - 1, 1);
        const existingEmails = dataRange.getValues().flat();
        const emailExists = existingEmails.some(existingEmail => existingEmail.toLowerCase() === email.toLowerCase());

        if (emailExists) {
          lock.releaseLock();
          return { status: "error", message: "Email sudah terdaftar." };
        }
    }

    const templateFile = DriveApp.getFileById(TEMPLATE_SPREADSHEET_ID);
    const newSpreadsheetName = `Data Akademik - ${namaSekolah}`;
    const newFile = templateFile.makeCopy(newSpreadsheetName);
    const newSpreadsheetId = newFile.getId();

    const newSs = SpreadsheetApp.openById(newSpreadsheetId);
    const dataSekolahSheet = newSs.getSheetByName(SHEET_DATA_SEKOLAH);
    if (dataSekolahSheet) {
      dataSekolahSheet.getRange(2, 1).setValue(jenjang);
      dataSekolahSheet.getRange(2, 2).setValue(namaSekolah);
    }

    const userId = Utilities.getUuid();
    userSheet.appendRow([userId, email, password, namaSekolah, jenjang, newSpreadsheetId]);
    
    lock.releaseLock();
    return { status: "success", message: "Pendaftaran berhasil! Akun dan database sekolah Anda telah dibuat." };

  } catch (error) {
    Logger.log(error);
    return { status: "error", message: "Gagal mendaftar: " + error.message };
  }
}

/**
 * Memeriksa kredensial login dan mengembalikan spreadsheetId jika berhasil.
 * @param {string} email Email pengguna.
 * @param {string} password Password pengguna.
 * @returns {{status: string, message: string, spreadsheetId?: string}} Objek status login.
 */
function checkLogin(email, password) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const userSheet = ss.getSheetByName(SHEET_PENGGUNA);

    if (!userSheet) {
      return { status: "error", message: `Kesalahan Konfigurasi: Sheet '${SHEET_PENGGUNA}' tidak ditemukan.` };
    }

    if (userSheet.getLastRow() < 2) {
      return { status: "error", message: "Belum ada pengguna terdaftar." };
    }

    const users = userSheet.getRange(2, 1, userSheet.getLastRow() - 1, 6).getValues();
    const userFound = users.find(userRow => userRow[1].toLowerCase() === email.toLowerCase());

    if (!userFound) {
      return { status: "error", message: "Email tidak terdaftar." };
    }

    const storedPassword = userFound[2];
    if (storedPassword.toString() !== password.toString()) {
      return { status: "error", message: "Password salah." };
    }
    
    const spreadsheetId = userFound[5];
    return { status: "success", message: "Login berhasil.", spreadsheetId: spreadsheetId };

  } catch (error) {
    Logger.log(error);
    return { status: "error", message: "Kesalahan Server: " + error.message };
  }
}

// =================================================================
// FUNGSI UTILITAS UMUM
// =================================================================

/**
 * Helper function untuk membuka spreadsheet berdasarkan ID.
 * @param {string} spreadsheetId ID dari Google Sheet yang akan dibuka.
 * @returns {SpreadsheetApp.Spreadsheet} Objek Spreadsheet.
 */
function getSpreadsheet(spreadsheetId) {
  if (!spreadsheetId) {
    throw new Error("Spreadsheet ID tidak valid atau tidak diberikan.");
  }
  return SpreadsheetApp.openById(spreadsheetId);
}


// =================================================================
// FUNGSI MANAJEMEN DATA SEKOLAH, SISWA, MAPEL, DLL.
// =================================================================

/**
 * Menyimpan data sekolah ke dalam sheet 'Data Sekolah'.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {object} dataObj Objek berisi data sekolah.
 * @returns {{status: string, message: string}} Status penyimpanan.
 */
function saveSchoolData(spreadsheetId, dataObj) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    let sheet = ss.getSheetByName(SHEET_DATA_SEKOLAH);
    const schoolDataRow = [
        dataObj.jenjang||"", dataObj.namaSekolah||"", dataObj.npsn||"", dataObj.alamat||"", 
        dataObj.kelurahan||"", dataObj.kecamatan||"", dataObj.kabupaten||"", dataObj.provinsi||"", 
        dataObj.kodePos||"", dataObj.telepon||"", dataObj.email||"", dataObj.website||"", 
        dataObj.namaKepsek||"", dataObj.nipKepsek||""
    ];
    sheet.getRange(2, 1, 1, schoolDataRow.length).setValues([schoolDataRow]);
    return { status: "success", message: "Data sekolah berhasil diperbarui." };
  } catch (error) {
    Logger.log(error);
    return { status: "error", message: "Gagal menyimpan data sekolah: " + error.message };
  }
}

/**
 * Mengambil data sekolah dari sheet 'Data Sekolah'.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @returns {object|null} Objek data sekolah atau null jika gagal.
 */
function getSchoolData(spreadsheetId) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    const sheet = ss.getSheetByName(SHEET_DATA_SEKOLAH);
    if (!sheet || sheet.getLastRow() < 2) return null;
    const values = sheet.getRange("A2:N2").getValues()[0];
    return {jenjang:values[0], namaSekolah:values[1], npsn:values[2], alamat:values[3], kelurahan:values[4], kecamatan:values[5], kabupaten:values[6], provinsi:values[7], kodePos:values[8], telepon:values[9], email:values[10], website:values[11], namaKepsek:values[12], nipKepsek:values[13]};
  } catch (error) {
    Logger.log(error);
    return null;
  }
}

/**
 * Mengambil daftar siswa dari sheet 'Data Siswa'.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @returns {Array<object>} Array objek data siswa.
 */
function getStudents(spreadsheetId) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    const sheet = ss.getSheetByName(SHEET_DATA_SISWA);
    if (!sheet || sheet.getLastRow() < 2) return [];
    sheet.getRange("A:B").setNumberFormat('@');
    const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, 5);
    const values = dataRange.getValues();
    return values.map((row, index) => {
        let tanggalLahirStr = '';
        // Memastikan data tanggal valid sebelum diproses
        if (row[4] && row[4] instanceof Date) {
             // Memformat tanggal ke YYYY-MM-DD sesuai zona waktu spreadsheet
             tanggalLahirStr = Utilities.formatDate(row[4], Session.getScriptTimeZone(), "yyyy-MM-dd");
        }
        return {
            row: index + 2, 
            nisn: row[0], 
            nis: row[1], 
            nama: row[2], 
            tempatLahir: row[3], 
            tanggalLahir: tanggalLahirStr
        };
    });
  } catch (e) { 
    Logger.log(`getStudents Error: ${e}`);
    return []; 
  }
}

/**
 * Menambahkan siswa baru ke sheet 'Data Siswa'.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {object} studentData Objek data siswa baru.
 * @returns {{status: string, message: string}} Status penambahan.
 */
function addStudent(spreadsheetId, studentData) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    let sheet = ss.getSheetByName(SHEET_DATA_SISWA);
    sheet.getRange("A:B").setNumberFormat('@');
    // FIX: Mengonversi string tanggal YYYY-MM-DD menjadi objek Date di zona waktu lokal skrip
    const tanggalLahirObject = studentData.tanggalLahir ? new Date(studentData.tanggalLahir.replace(/-/g, '/')) : '';
    const newRow = [studentData.nisn, studentData.nis, studentData.nama, studentData.tempatLahir, tanggalLahirObject];
    sheet.appendRow(newRow);
    return { status: "success", message: `Siswa "${studentData.nama}" berhasil ditambahkan.` };
  } catch (e) { Logger.log(e); return { status: "error", message: "Gagal menambah siswa: " + e.message }; }
}

/**
 * Memperbarui data siswa di sheet 'Data Siswa'.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {object} studentData Objek data siswa yang akan diupdate.
 * @returns {{status: string, message: string}} Status pembaruan.
 */
function updateStudent(spreadsheetId, studentData) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    const sheet = ss.getSheetByName(SHEET_DATA_SISWA);
    sheet.getRange("A:B").setNumberFormat('@');
    // FIX: Mengonversi string tanggal YYYY-MM-DD menjadi objek Date di zona waktu lokal skrip
    const tanggalLahirObject = studentData.tanggalLahir ? new Date(studentData.tanggalLahir.replace(/-/g, '/')) : '';
    const rowToUpdate = [studentData.nisn, studentData.nis, studentData.nama, studentData.tempatLahir, tanggalLahirObject];
    sheet.getRange(studentData.studentRow, 1, 1, rowToUpdate.length).setValues([rowToUpdate]);
    return { status: "success", message: `Data siswa "${studentData.nama}" berhasil diperbarui.` };
  } catch (e) { Logger.log(e); return { status: "error", message: "Gagal memperbarui data: " + e.message }; }
}

/**
 * Menghapus data siswa dari sheet 'Data Siswa'.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {number} rowNumber Nomor baris yang akan dihapus.
 * @returns {{status: string, message: string}} Status penghapusan.
 */
function deleteStudent(spreadsheetId, rowNumber) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    const sheet = ss.getSheetByName(SHEET_DATA_SISWA);
    sheet.deleteRow(rowNumber);
    return { status: "success", message: "Data siswa berhasil dihapus." };
  } catch (e) { Logger.log(e); return { status: "error", message: "Gagal menghapus data: " + e.message }; }
}

/**
 * Menghapus semua data siswa dari sheet 'Data Siswa'.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @returns {{status: string, message: string}} Status penghapusan.
 */
function deleteAllStudents(spreadsheetId) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    const sheet = ss.getSheetByName(SHEET_DATA_SISWA);
    if (sheet && sheet.getLastRow() > 1) {
      sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).clearContent();
    }
    return { status: "success", message: "Semua data siswa telah berhasil dihapus." };
  } catch (e) {
    Logger.log(e);
    return { status: "error", message: "Gagal menghapus data siswa: " + e.message };
  }
}

/**
 * Menghasilkan template Excel untuk impor data siswa.
 * @returns {object} Objek berisi data file template.
 */
function generateSiswaTemplate() {
  let tempFile;
  try {
    const templateName = `Template_Import_Siswa_${new Date().getTime()}`;
    const ss = SpreadsheetApp.create(templateName);
    tempFile = DriveApp.getFileById(ss.getId());
    
    const sheet = ss.getSheets()[0];
    const headers = ["NISN", "NIS", "Nama Lengkap", "Tempat Lahir", "Tanggal Lahir (Format:YYYY-MM-DD)"];
    sheet.appendRow(headers);
    sheet.getRange("A1:E1").setFontWeight("bold").setBackground("#d9ead3");
    sheet.getRange("A:B").setNumberFormat("@");
    sheet.setColumnWidths(1, 5, 150);
    sheet.getRange("E:E").setNumberFormat("yyyy-mm-dd");

    SpreadsheetApp.flush();

    const url = `https://www.googleapis.com/drive/v3/files/${ss.getId()}/export?mimeType=application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`;
    const response = UrlFetchApp.fetch(url, {
      headers: { Authorization: `Bearer ${ScriptApp.getOAuthToken()}` },
      muteHttpExceptions: true
    });

    const blob = response.getBlob();
    return {
      fileName: 'Template_Import_Siswa.xlsx',
      mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      base64Data: Utilities.base64Encode(blob.getBytes())
    };
  } catch (e) {
    Logger.log(e);
    return { error: e.toString() };
  } finally {
    if (tempFile) {
      tempFile.setTrashed(true);
    }
  }
}

/**
 * Mengimpor data dari file Excel ke sheet yang ditentukan.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {object} fileData Data file yang diunggah.
 * @param {string} sheetName Nama sheet tujuan.
 * @returns {object} Hasil proses impor.
 */
function importFromExcel(spreadsheetId, fileData, sheetName) {
  let tempFile;
  try {
    const decoded = Utilities.base64Decode(fileData.content, Utilities.Charset.UTF_8);
    const blob = Utilities.newBlob(decoded, fileData.mimeType, fileData.fileName);
    
    const tempSpreadsheetFile = Drive.Files.insert({title: `temp_import_${new Date().getTime()}`}, blob, {convert: true});
    tempFile = DriveApp.getFileById(tempSpreadsheetFile.id);
    const importSheet = SpreadsheetApp.openById(tempFile.getId()).getSheets()[0];
    const data = importSheet.getDataRange().getValues();
    
    if (data.length <= 1) throw new Error("File kosong atau hanya berisi header.");
    data.shift(); // Hapus header

    const targetSpreadsheet = getSpreadsheet(spreadsheetId);
    let targetSheet = targetSpreadsheet.getSheetByName(sheetName);
    
    if (sheetName === SHEET_DATA_SISWA) {
        const existingStudents = getStudents(spreadsheetId);
        const existingNisnMap = new Map();
        existingStudents.forEach(s => {
            if(s.nisn) existingNisnMap.set(s.nisn.toString().trim(), s);
        });

        const newStudents = [];
        const skippedDuplicates = [];
        const conflicts = [];
        const processedNisns = new Set(); 

        data.forEach((row) => {
            const nisn = (row[0] || '').toString().trim();
            const nama = (row[2] || '').toString().trim();
            if (!nisn || !nama) return; 
            if (processedNisns.has(nisn)) {
                skippedDuplicates.push({nisn, nama, reason: 'Duplikat di dalam file import.'});
                return;
            }
            processedNisns.add(nisn);
            if (existingNisnMap.has(nisn)) {
                const existingStudent = existingNisnMap.get(nisn);
                if (existingStudent.nama.trim().toLowerCase() === nama.toLowerCase()) {
                    skippedDuplicates.push({nisn, nama, reason: 'Data sudah ada.'});
                } else {
                    conflicts.push({nisn, nama, reason: `NISN sudah terdaftar dengan nama: ${existingStudent.nama}`});
                }
            } else {
                newStudents.push(row);
            }
        });
        
        if (newStudents.length > 0) {
          targetSheet.getRange("A:B").setNumberFormat("@");
          targetSheet.getRange(targetSheet.getLastRow() + 1, 1, newStudents.length, newStudents[0].length).setValues(newStudents);
        }

        return {
          status: "partial",
          message: "Proses impor siswa selesai.",
          newCount: newStudents.length,
          skippedCount: skippedDuplicates.length,
          conflictCount: conflicts.length,
          conflicts: conflicts
        };
    } else if (sheetName === SHEET_MAPEL) {
        const existingMapel = getMapel(spreadsheetId);
        const existingMapelCodes = new Set(existingMapel.map(m => m.kode.toString().trim()));

        const newMapel = [];
        let skippedCount = 0;
        
        data.forEach(row => {
            const kode = (row[0] || '').toString().trim();
            if (!kode) return; // Lewati baris tanpa kode mapel

            if (existingMapelCodes.has(kode)) {
                skippedCount++;
            } else {
                newMapel.push(row);
                existingMapelCodes.add(kode); // Tambahkan ke set untuk menangani duplikat di dalam file itu sendiri
            }
        });

        if (newMapel.length > 0) {
            targetSheet.getRange(targetSheet.getLastRow() + 1, 1, newMapel.length, newMapel[0].length).setValues(newMapel);
        }

        let message = `${newMapel.length} mapel baru berhasil diimpor.`;
        if (skippedCount > 0) {
          message += ` ${skippedCount} mapel dilewati karena kode sudah ada.`
        }

        return {
            status: "success",
            message: message,
            newCount: newMapel.length,
            skippedCount: skippedCount
        };

    } else { 
        // Logika umum untuk sheet lain yang tidak memerlukan pemeriksaan duplikat
        const rowsToAppend = data.filter(row => row.some(cell => cell.toString().trim() !== ""));
        if (rowsToAppend.length > 0) {
          targetSheet.getRange(targetSheet.getLastRow() + 1, 1, rowsToAppend.length, rowsToAppend[0].length).setValues(rowsToAppend);
        }
        return { status: "success", message: `${rowsToAppend.length} data berhasil diimpor ke sheet ${sheetName}.` };
    }

  } catch (e) {
    Logger.log(e);
    return { status: "error", message: `Gagal mengimpor data: ${e.toString()}` };
  } finally {
      if (tempFile) {
          tempFile.setTrashed(true);
      }
  }
}

/**
 * Mengambil daftar mata pelajaran dari sheet 'Data Mata Pelajaran'.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @returns {Array<object>} Array objek data mata pelajaran.
 */
function getMapel(spreadsheetId) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    const sheet = ss.getSheetByName(SHEET_MAPEL);
    if (!sheet || sheet.getLastRow() < 2) return [];
    const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, 4);
    const values = dataRange.getValues();
    return values.map((row, index) => ({ row: index + 2, kode: row[0], nama: row[1], kelompok: row[2], jenisUjian: row[3] || '' }));
  } catch (e) { Logger.log(e); return []; }
}

/**
 * Menambahkan mata pelajaran baru.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {object} mapelData Data mata pelajaran baru.
 * @returns {{status: string, message: string}} Status penambahan.
 */
function addMapel(spreadsheetId, mapelData) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    let sheet = ss.getSheetByName(SHEET_MAPEL);
    const newRow = [mapelData.kode, mapelData.nama, mapelData.kelompok, mapelData.jenisUjian];
    sheet.appendRow(newRow);
    return { status: "success", message: `Mata Pelajaran "${mapelData.nama}" berhasil ditambahkan.` };
  } catch (e) { Logger.log(e); return { status: "error", message: "Gagal menambah mapel: " + e.message }; }
}

/**
 * Memperbarui data mata pelajaran.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {object} mapelData Data mata pelajaran yang akan diupdate.
 * @returns {{status: string, message: string}} Status pembaruan.
 */
function updateMapel(spreadsheetId, mapelData) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    const sheet = ss.getSheetByName(SHEET_MAPEL);
    const rowToUpdate = [mapelData.kode, mapelData.nama, mapelData.kelompok, mapelData.jenisUjian];
    sheet.getRange(mapelData.mapelRow, 1, 1, rowToUpdate.length).setValues([rowToUpdate]);
    return { status: "success", message: `Mata Pelajaran "${mapelData.nama}" berhasil diperbarui.` };
  } catch (e) { Logger.log(e); return { status: "error", message: "Gagal memperbarui data mapel: " + e.message }; }
}

/**
 * Menghapus mata pelajaran.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {number} rowNumber Nomor baris yang akan dihapus.
 * @returns {{status: string, message: string}} Status penghapusan.
 */
function deleteMapel(spreadsheetId, rowNumber) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    const sheet = ss.getSheetByName(SHEET_MAPEL);
    sheet.deleteRow(rowNumber);
    return { status: "success", message: "Mata pelajaran berhasil dihapus." };
  } catch (e) { Logger.log(e); return { status: "error", message: "Gagal menghapus mapel: " + e.message }; }
}

/**
 * Menghapus semua mata pelajaran.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @returns {{status: string, message: string}} Status penghapusan.
 */
function deleteAllMapel(spreadsheetId) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    const sheet = ss.getSheetByName(SHEET_MAPEL);
    if (sheet && sheet.getLastRow() > 1) {
      sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).clearContent();
    }
    return { status: "success", message: "Semua data mata pelajaran telah berhasil dihapus." };
  } catch (e) {
    Logger.log(e);
    return { status: "error", message: "Gagal menghapus data mata pelajaran: " + e.message };
  }
}

/**
 * Menghasilkan template Excel untuk impor data mata pelajaran.
 * @returns {object} Objek berisi data file template.
 */
function generateMapelTemplate() {
    let tempFile;
    try {
        const templateName = `Template_Import_Mapel_${new Date().getTime()}`;
        const ss = SpreadsheetApp.create(templateName);
        tempFile = DriveApp.getFileById(ss.getId());
        
        const sheet = ss.getSheets()[0];
        const headers = ["Kode Mapel", "Nama Mata Pelajaran", "Kelompok (Umum/Peminatan/Muatan Lokal)", "Jenis Ujian (Ujian Madrasah/Ujian Praktek/Keduanya)"];
        sheet.appendRow(headers);
        sheet.getRange("A1:D1").setFontWeight("bold").setBackground("#d9ead3");
        sheet.setColumnWidths(1, 4, 200);

        SpreadsheetApp.flush();

        const url = `https://www.googleapis.com/drive/v3/files/${ss.getId()}/export?mimeType=application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`;
        const response = UrlFetchApp.fetch(url, {
        headers: { Authorization: `Bearer ${ScriptApp.getOAuthToken()}` },
        muteHttpExceptions: true
        });

        const blob = response.getBlob();
        return {
        fileName: 'Template_Import_Mapel.xlsx',
        mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        base64Data: Utilities.base64Encode(blob.getBytes())
        };
    } catch (e) {
        Logger.log(e);
        return { error: e.toString() };
    } finally {
        if (tempFile) {
        tempFile.setTrashed(true);
        }
    }
}

/**
 * Mengimpor daftar mata pelajaran standar berdasarkan jenjang sekolah.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @returns {object} Hasil proses impor.
 */
function importMapelBySystem(spreadsheetId) {
  try {
    const userSs = getSpreadsheet(spreadsheetId);
    const jenjang = (getSchoolData(spreadsheetId) || {}).jenjang;

    if (!jenjang) {
      return { status: 'error', message: 'Jenjang sekolah belum diatur. Harap atur di menu Data Sekolah terlebih dahulu.' };
    }

    const masterSs = SpreadsheetApp.getActiveSpreadsheet();
    const mapelDefaultSheet = masterSs.getSheetByName(SHEET_MAPEL_DEFAULT);
    if (!mapelDefaultSheet) {
      return { status: 'error', message: `Sheet '${SHEET_MAPEL_DEFAULT}' tidak ditemukan di spreadsheet master.` };
    }

    const defaultMapelData = mapelDefaultSheet.getDataRange().getValues();
    defaultMapelData.shift(); // Hapus header

    const mapelForJenjang = defaultMapelData
      .filter(row => row[0] === jenjang) // Filter berdasarkan jenjang
      .map(row => [row[1], row[2], row[3], row[4]]); // Ambil kolom B-E (Kode, Nama, Kelompok, Jenis Ujian)

    if (mapelForJenjang.length === 0) {
      return { status: 'info', message: `Tidak ada mata pelajaran default yang ditemukan untuk jenjang ${jenjang}.`};
    }
    
    const existingMapel = getMapel(spreadsheetId);
    const existingMapelCodes = new Set(existingMapel.map(m => m.kode.toString().trim()));

    const newMapel = mapelForJenjang.filter(row => !existingMapelCodes.has(row[0].toString().trim()));
    const skippedCount = mapelForJenjang.length - newMapel.length;

    if (newMapel.length > 0) {
      const targetSheet = userSs.getSheetByName(SHEET_MAPEL);
      targetSheet.getRange(targetSheet.getLastRow() + 1, 1, newMapel.length, newMapel[0].length).setValues(newMapel);
    }

    let message = `${newMapel.length} mata pelajaran berhasil diimpor.`;
    if (skippedCount > 0) {
      message += ` ${skippedCount} mata pelajaran dilewati karena kode sudah ada.`;
    }

    return { status: "success", message: message, newCount: newMapel.length, skippedCount: skippedCount };

  } catch (e) {
    Logger.log(e);
    return { status: "error", message: "Gagal mengimpor dari sistem: " + e.message };
  }
}

/**
 * Menyimpan data bobot nilai.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {object} bobotData Objek berisi bobot nilai.
 * @returns {{status: string, message: string}} Status penyimpanan.
 */
function saveBobot(spreadsheetId, bobotData) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    let sheet = ss.getSheetByName(SHEET_BOBOT);
    const bobotRow = [bobotData.bobotUjian, bobotData.bobotRapor];
    if (sheet.getLastRow() >= 2) sheet.getRange("A2:B2").clearContent();
    sheet.getRange(2, 1, 1, bobotRow.length).setValues([bobotRow]);
    return { status: "success", message: "Bobot nilai berhasil disimpan." };
  } catch (e) { Logger.log(e); return { status: "error", message: "Gagal menyimpan bobot nilai: " + e.message }; }
}

/**
 * Mengambil data bobot nilai, atau mengaturnya ke default jika belum ada.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @returns {object} Objek berisi bobot nilai.
 */
function getBobot(spreadsheetId) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    const sheet = ss.getSheetByName(SHEET_BOBOT);
    if (!sheet) {
      return { bobotUjian: 40, bobotRapor: 60 };
    }

    if (sheet.getLastRow() >= 2) {
        const values = sheet.getRange("A2:B2").getValues()[0];
        if (values[0] !== '' && values[1] !== '' && !isNaN(values[0]) && !isNaN(values[1])) {
            return { bobotUjian: values[0], bobotRapor: values[1] };
        }
    }
    
    const defaultBobot = { bobotUjian: 40, bobotRapor: 60 };
    sheet.getRange(2, 1, 1, 2).setValues([[defaultBobot.bobotUjian, defaultBobot.bobotRapor]]);
    
    return defaultBobot;
  } catch (e) { 
    Logger.log('Error di getBobot: ' + e.message); 
    return { bobotUjian: 40, bobotRapor: 60 }; 
  }
}

/**
 * Mengambil daftar mapel berdasarkan jenis ujian.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {string} jenis Jenis ujian ('madrasah' atau 'praktek').
 * @returns {Array<object>} Array objek data mata pelajaran.
 */
function getMapelByJenis(spreadsheetId, jenis) {
  const allMapel = getMapel(spreadsheetId);
  if (jenis === 'madrasah') return allMapel.filter(m => m.jenisUjian === 'Ujian Madrasah' || m.jenisUjian === 'Keduanya');
  if (jenis === 'praktek') return allMapel.filter(m => m.jenisUjian === 'Ujian Praktek' || m.jenisUjian === 'Keduanya');
  return [];
}

/**
 * Menyimpan data nilai ujian.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {object} data Objek berisi jenis dan data nilai.
 * @returns {object} Status penyimpanan.
 */
function saveNilai(spreadsheetId, data) {
  const { jenis, nilai } = data;
  const sheetName = jenis === 'madrasah' ? SHEET_NILAI_UJIAN_MADRASAH : SHEET_NILAI_UJIAN_PRAKTEK;
  const mapelList = getMapelByJenis(spreadsheetId, jenis);
  return processAndSaveScores(spreadsheetId, sheetName, mapelList, nilai);
}

/**
 * Menyimpan data nilai rapor.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {object} data Objek berisi semester, jenis, dan data nilai.
 * @returns {object} Status penyimpanan.
 */
function saveNilaiRapor(spreadsheetId, data) {
  const { semesterKey, jenisNilai, nilai } = data;
  const sheetName = `Rapor_${jenisNilai}_${semesterKey}`;
  const mapelList = getMapel(spreadsheetId);
  return processAndSaveScores(spreadsheetId, sheetName, mapelList, nilai);
}

/**
 * Mengambil data nilai yang sudah ada dari sebuah sheet.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {string} sheetName Nama sheet nilai.
 * @returns {object} Objek berisi nilai yang sudah ada, dengan NISN sebagai key.
 */
function getExistingNilai(spreadsheetId, sheetName) {
  try {
    const ss = getSpreadsheet(spreadsheetId);
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet || sheet.getLastRow() < 2) return {};
    sheet.getRange("A:A").setNumberFormat('@');
    const data = sheet.getDataRange().getValues();
    const headers = data.shift();
    const nisnIndex = headers.indexOf("NISN");
    const existingScores = {};
    data.forEach(row => {
      const nisn = row[nisnIndex];
      if (nisn) {
          existingScores[nisn] = {};
          headers.forEach((header, index) => {
              if (index > 1) existingScores[nisn][header] = row[index];
          });
      }
    });
    return existingScores;
  } catch(e) { Logger.log(e); return {}; }
}

/**
 * Memproses dan menyimpan data nilai ke sheet yang ditentukan.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {string} sheetName Nama sheet tujuan.
 * @param {Array<object>} mapelList Daftar mata pelajaran.
 * @param {Array<object>} nilai Daftar nilai.
 * @returns {{status: string, message: string}} Status penyimpanan.
 */
function processAndSaveScores(spreadsheetId, sheetName, mapelList, nilai) {
  const ss = getSpreadsheet(spreadsheetId);
  let sheet = ss.getSheetByName(sheetName);
  const headers = ["NISN", "Nama Lengkap", ...mapelList.map(m => m.kode)];
  try {
    if (!sheet) sheet = ss.insertSheet(sheetName);
    sheet.clear(); 
    sheet.appendRow(headers);
    sheet.getRange("A:A").setNumberFormat('@');
    sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold");
    const rows = nilai.map(n => {
      const rowData = [n.nisn, n.nama];
      mapelList.forEach(mapel => {
        rowData.push(n.scores[mapel.kode] || '');
      });
      return rowData;
    });
    if (rows.length > 0) sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
    return { status: 'success', message: `Data nilai untuk sheet '${sheetName}' berhasil disimpan.` };
  } catch (e) { Logger.log(e); return { status: 'error', message: `Gagal menyimpan data: ${e.message}` }; }
}

// =================================================================
// FUNGSI REKAPITULASI NILAI
// =================================================================

/**
 * Mengambil data dari sebuah sheet dan mengubahnya menjadi objek dengan NISN sebagai key.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {string} sheetName Nama sheet.
 * @returns {object} Data sheet dalam bentuk objek.
 */
function getSheetDataAsObject(spreadsheetId, sheetName) {
    try {
        const ss = getSpreadsheet(spreadsheetId);
        const sheet = ss.getSheetByName(sheetName);
        if (!sheet || sheet.getLastRow() < 2) return {};
        sheet.getRange("A:A").setNumberFormat('@');
        const data = sheet.getDataRange().getValues();
        const headers = data.shift();
        const nisnIndex = headers.indexOf("NISN");
        if (nisnIndex === -1) return {};

        const dataObj = {};
        data.forEach(row => {
            const nisn = row[nisnIndex].toString().trim();
            if (nisn) {
                dataObj[nisn] = {};
                headers.forEach((header, index) => {
                    // Mulai dari kolom ke-3 (setelah NISN dan Nama)
                    if (index > 1) dataObj[nisn][header] = row[index];
                });
            }
        });
        return dataObj;
    } catch (e) {
        Logger.log(`Error getting data from ${sheetName}: ${e}`);
        return {};
    }
}

/**
 * Memperbarui semua data di sheet rekapitulasi.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @returns {{status: string, message: string}} Status pembaruan.
 */
function updateRekapitulasi(spreadsheetId) {
  try {
    const students = getStudents(spreadsheetId);
    if (!students || students.length === 0) {
      return {status: 'error', message: 'Tidak ada data siswa untuk direkap.'};
    }
    const mapel = getMapel(spreadsheetId);
    if (!mapel || mapel.length === 0) {
      return {status: 'error', message: 'Tidak ada data mata pelajaran untuk direkap.'};
    }
    const bobot = getBobot(spreadsheetId) || { bobotUjian: 0, bobotRapor: 0 };
    const jenjang = (getSchoolData(spreadsheetId) || {}).jenjang;

    if (!jenjang) {
      return {status: 'error', message: 'Jenjang sekolah belum diatur di menu Data Sekolah.'};
    }

    const semesterKeys = {
      MI: ['k4_ganjil', 'k4_genap', 'k5_ganjil', 'k5_genap', 'k6_ganjil'],
      MTS: ['k7_ganjil', 'k7_genap', 'k8_ganjil', 'k8_genap', 'k9_ganjil'],
      MA: ['k10_ganjil', 'k10_genap', 'k11_ganjil', 'k11_genap', 'k12_ganjil']
    };
    const semestersForJenjang = semesterKeys[jenjang] || [];

    const sheetsToRead = [SHEET_NILAI_UJIAN_MADRASAH, SHEET_NILAI_UJIAN_PRAKTEK];
    semestersForJenjang.forEach(smKey => {
        sheetsToRead.push(`Rapor_Pengetahuan_${smKey}`);
        sheetsToRead.push(`Rapor_Keterampilan_${smKey}`);
    });
    
    const allData = {};
    sheetsToRead.forEach(sheetName => {
        allData[sheetName] = getSheetDataAsObject(spreadsheetId, sheetName);
    });

    const nilaiUjianMadrasah = allData[SHEET_NILAI_UJIAN_MADRASAH] || {};
    const nilaiUjianPraktek = allData[SHEET_NILAI_UJIAN_PRAKTEK] || {};
    
    const rekapUjian = {};
    const rekapRapor = {};
    const rekapIjazah = {};

    students.forEach(student => {
        const nisn = student.nisn.toString().trim();
        rekapUjian[nisn] = {};
        rekapRapor[nisn] = {};
        rekapIjazah[nisn] = {};

        mapel.forEach(m => {
            const kode = m.kode;
            const nilaiUM = parseFloat( (nilaiUjianMadrasah[nisn] || {})[kode] );
            const nilaiUP = parseFloat( (nilaiUjianPraktek[nisn] || {})[kode] );

            let rataUjian = 0;
            if (!isNaN(nilaiUM) && !isNaN(nilaiUP)) rataUjian = (nilaiUM + nilaiUP) / 2;
            else if (!isNaN(nilaiUM)) rataUjian = nilaiUM;
            else if (!isNaN(nilaiUP)) rataUjian = nilaiUP;
            rekapUjian[nisn][kode] = rataUjian;

            let totalNilaiRapor = 0;
            let semesterCount = 0;
            
            semestersForJenjang.forEach(smKey => {
                const sheetNameP = `Rapor_Pengetahuan_${smKey}`;
                const sheetNameK = `Rapor_Keterampilan_${smKey}`;
                
                const nilaiP = parseFloat( ((allData[sheetNameP] || {})[nisn] || {})[kode] );
                const nilaiK = parseFloat( ((allData[sheetNameK] || {})[nisn] || {})[kode] );

                if (!isNaN(nilaiP) && !isNaN(nilaiK)) {
                    totalNilaiRapor += (nilaiP + nilaiK) / 2;
                    semesterCount++;
                } else if (!isNaN(nilaiP)) {
                    totalNilaiRapor += nilaiP;
                    semesterCount++;
                } else if (!isNaN(nilaiK)) {
                    totalNilaiRapor += nilaiK;
                    semesterCount++;
                }
            });

            const rataRapor = semesterCount > 0 ? totalNilaiRapor / semesterCount : 0;
            rekapRapor[nisn][kode] = rataRapor;

            const bobotUjianVal = parseFloat(bobot.bobotUjian) || 0;
            const bobotRaporVal = parseFloat(bobot.bobotRapor) || 0;
            const nilaiAkhir = (rataUjian * (bobotUjianVal / 100)) + (rataRapor * (bobotRaporVal / 100));
            rekapIjazah[nisn][kode] = nilaiAkhir;
        });
    });

    saveRekapSheet(spreadsheetId, SHEET_REKAP_UJIAN, students, mapel, rekapUjian);
    saveRekapSheet(spreadsheetId, SHEET_REKAP_RAPOR, students, mapel, rekapRapor);
    saveRekapSheet(spreadsheetId, SHEET_REKAP_IJAZAH, students, mapel, rekapIjazah);
    
    return {status: "success", message: "Data rekapitulasi berhasil diperbarui."};
  } catch(e) {
    Logger.log(e);
    return {status: "error", message: "Gagal memperbarui rekapitulasi: " + e.message};
  }
}

/**
 * Menyimpan data rekapitulasi ke sheet yang ditentukan.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {string} sheetName Nama sheet rekap.
 * @param {Array<object>} students Daftar siswa.
 * @param {Array<object>} mapel Daftar mata pelajaran.
 * @param {object} data Data rekapitulasi.
 */
function saveRekapSheet(spreadsheetId, sheetName, students, mapel, data) {
    const ss = getSpreadsheet(spreadsheetId);
    let sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
        sheet = ss.insertSheet(sheetName);
    }
    sheet.clear();
    const headers = ["NISN", "Nama Lengkap", ...mapel.map(m => m.kode)];
    sheet.appendRow(headers);
    sheet.getRange("A1:Z1").setFontWeight("bold");
    sheet.getRange("A:A").setNumberFormat("@");

    const rows = students.map(student => {
        const nisn = student.nisn.toString().trim();
        const rowData = [nisn, student.nama];
        mapel.forEach(m => {
            rowData.push((data[nisn] || {})[m.kode] || 0);
        });
        return rowData;
    });

    if (rows.length > 0) {
        sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
    }
}

/**
 * Mengambil semua data rekapitulasi untuk ditampilkan.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @returns {object} Objek berisi semua data rekapitulasi.
 */
function getRekapitulasiData(spreadsheetId) {
  const students = getStudents(spreadsheetId);
  const mapel = getMapel(spreadsheetId);
  const bobot = getBobot(spreadsheetId); // Tambahkan baris ini
  return {
    students,
    mapel,
    bobot, // Tambahkan properti ini
    rekapUjian: getSheetDataAsObject(spreadsheetId, SHEET_REKAP_UJIAN),
    rekapRapor: getSheetDataAsObject(spreadsheetId, SHEET_REKAP_RAPOR),
    rekapIjazah: getSheetDataAsObject(spreadsheetId, SHEET_REKAP_IJAZAH),
  };
}

/**
 * Memeriksa apakah sheet rekapitulasi sudah ada.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @returns {boolean} True jika semua sheet ada.
 */
function checkRekapSheetsExist(spreadsheetId) {
  const ss = getSpreadsheet(spreadsheetId);
  const sheetUjian = ss.getSheetByName(SHEET_REKAP_UJIAN);
  const sheetRapor = ss.getSheetByName(SHEET_REKAP_RAPOR);
  const sheetIjazah = ss.getSheetByName(SHEET_REKAP_IJAZAH);
  return !!(sheetUjian && sheetRapor && sheetIjazah);
}

/**
 * Mengekspor data rekapitulasi ke format PDF atau Excel dengan layout kustom presisi. (Versi Final 2.6 - Penyesuaian Akhir)
 * @param {string} spreadsheetId ID spreadsheet target.
 * @param {string} type Jenis rekap ('ujian', 'rapor', 'ijazah').
 * @param {string} format Format ekspor ('pdf' atau 'excel').
 * @param {object} exportOptions Objek berisi data dari form modal.
 * @returns {object} Objek berisi data file yang telah di-encode base64.
 */
function exportRekapData(spreadsheetId, type, format, exportOptions) {
  let tempSpreadsheetFileId = null;
  try {
    // 1. Tentukan Judul Laporan
    let reportTitle;
    switch (type) {
      case 'ijazah': reportTitle = "REKAPITULASI NILAI IJAZAH"; break;
      case 'rapor': reportTitle = "REKAPITULASI NILAI RAPOR"; break;
      case 'ujian': reportTitle = "REKAPITULASI NILAI UJIAN"; break;
      default: throw new Error("Jenis rekap tidak valid.");
    }

    // 2. Ambil data yang diperlukan
    const { students, mapel } = getRekapitulasiData(spreadsheetId);
    if (!students || students.length === 0) throw new Error("Tidak ada data siswa untuk diekspor.");
    
    const sheetName = `Rekap Nilai ${type.charAt(0).toUpperCase() + type.slice(1)}`;
    const dataToProcess = getSheetDataAsObject(spreadsheetId, sheetName);

    // 3. Bangun data tabel
    const tableBodyData = [];
    students.forEach((student, index) => {
        const nisn = student.nisn;
        const studentScores = dataToProcess[nisn] || {};
        let total = 0;
        
        const rowData = [index + 1, `'${nisn}`, student.nama.toUpperCase()];
        
        mapel.forEach(m => {
            const score = parseFloat(studentScores[m.kode] || 0);
            rowData.push(Math.round(score));
            total += score;
        });
        const average = mapel.length > 0 ? (total / mapel.length) : 0;
        
        rowData.push(Math.round(total));
        rowData.push(average.toFixed(2).replace('.', ','));
        tableBodyData.push(rowData);
    });
    
    // 4. Buat spreadsheet sementara
    const tempSpreadsheetName = `Cetak_${reportTitle.replace(/ /g, "_")}_${new Date().getTime()}`;
    const tempSpreadsheet = SpreadsheetApp.create(tempSpreadsheetName);
    tempSpreadsheetFileId = tempSpreadsheet.getId();
    const tempSheet = tempSpreadsheet.getSheets()[0];
    tempSheet.setName("Rekapitulasi");

    // --- PEMFORMATAN KUSTOM ---
    const schoolData = getSchoolData(spreadsheetId);
    let currentRow = 1;
    const numMapel = mapel.length;
    const numColumns = numMapel + 5;

    // Header Laporan
    tempSheet.getRange(currentRow, 1, 1, numColumns).merge().setValue(reportTitle).setFontSize(16);
    currentRow++;
    tempSheet.getRange(currentRow, 1, 1, numColumns).merge().setValue((schoolData.namaSekolah || "NAMA SEKOLAH").toUpperCase()).setFontSize(16);
    currentRow++;
    tempSheet.getRange(currentRow, 1, 1, numColumns).merge().setValue(`Tahun Ajaran ${exportOptions.tahunAjaran || ""}`).setFontSize(14);
    currentRow += 2;

    // --- HEADER TABEL (STRUKTUR 2 BARIS) ---
    const tableStartRow = currentRow;
    // Baris 1: "MATA PELAJARAN"
    tempSheet.getRange(tableStartRow, 4, 1, numMapel).merge().setValue("MATA PELAJARAN");
    
    // Baris 2: Kode Mapel
    const mapelHeaders = mapel.map(m => m.kode);
    tempSheet.getRange(tableStartRow + 1, 4, 1, numMapel).setValues([mapelHeaders]);
    
    // Header Tetap
    tempSheet.getRange(tableStartRow, 1).setValue("No.");
    tempSheet.getRange(tableStartRow, 2).setValue("NISN");
    tempSheet.getRange(tableStartRow, 3).setValue("Nama Siswa");
    tempSheet.getRange(tableStartRow, 4 + numMapel).setValue("Jumlah");
    tempSheet.getRange(tableStartRow, 5 + numMapel).setValue("Rata-Rata");

    // Merge Vertikal
    tempSheet.getRange(tableStartRow, 1, 2, 1).merge();
    tempSheet.getRange(tableStartRow, 2, 2, 1).merge();
    tempSheet.getRange(tableStartRow, 3, 2, 1).merge();
    tempSheet.getRange(tableStartRow, 4 + numMapel, 2, 1).merge();
    tempSheet.getRange(tableStartRow, 5 + numMapel, 2, 1).merge();
    
    // Tulis Body Tabel
    tempSheet.getRange(tableStartRow + 2, 1, tableBodyData.length, numColumns).setValues(tableBodyData);

    // --- APLIKASI FORMAT ---
    // Seluruh Area
    const fullRange = tempSheet.getRange(1, 1, tempSheet.getLastRow() + 5, numColumns);
    fullRange.setFontFamily("Arial").setVerticalAlignment("middle");

    // Header Laporan
    tempSheet.getRange(1, 1, 3, 1).setFontWeight("bold").setHorizontalAlignment("center");

    // Header Tabel
    const tableHeaderRange = tempSheet.getRange(tableStartRow, 1, 2, numColumns);
    tableHeaderRange.setFontWeight("bold").setFontSize(12).setHorizontalAlignment("center").setBackground("#ffff00");
    
    // Body Tabel
    tempSheet.getRange(tableStartRow + 2, 1, tableBodyData.length, numColumns).setFontSize(12);
    tempSheet.getRange(tableStartRow + 2, 1, tableBodyData.length, 1).setHorizontalAlignment("center");
    tempSheet.getRange(tableStartRow + 2, 2, tableBodyData.length, 1).setNumberFormat("@").setHorizontalAlignment("center");
    tempSheet.getRange(tableStartRow + 2, 3, tableBodyData.length, 1).setHorizontalAlignment("left");
    tempSheet.getRange(tableStartRow + 2, 4, tableBodyData.length, numMapel + 2).setHorizontalAlignment("center");

    // Border
    tempSheet.getRange(tableStartRow, 1, tableBodyData.length + 2, numColumns).setBorder(true, true, true, true, true, true);
    
    // --- LOGIKA LEBAR KOLOM YANG DISEMPURNAKAN ---
    // Atur Lebar Kolom Tetap
    tempSheet.setColumnWidth(1, 40);
    tempSheet.setColumnWidth(2, 100);
    tempSheet.setColumnWidth(3, 220);
    tempSheet.setColumnWidth(4 + numMapel, 80);
    tempSheet.setColumnWidth(5 + numMapel, 80);
    
    // Tentukan lebar kolom mapel agar seragam dan pas
    const pixelPerChar = 7.5; 
    let maxMapelWidth = 0;
    mapel.forEach(m => {
        let width = m.kode.length * pixelPerChar + 10;
        if (width > maxMapelWidth) {
            maxMapelWidth = width;
        }
    });
    // Terapkan lebar maksimum ke semua kolom mapel
    if (maxMapelWidth > 0) {
        for (let i = 4; i <= 3 + numMapel; i++) {
            tempSheet.setColumnWidth(i, Math.round(maxMapelWidth));
        }
    }
    // --- AKHIR LOGIKA LEBAR KOLOM ---

    // Blok Tanda Tangan
    const signatureBlockStartRow = tableStartRow + tableBodyData.length + 3;
    const signatureColumnStart = numColumns - 3;
    const formatDateToIndonesian = (dateString) => {
      if (!dateString) return "";
      const date = new Date(dateString);
      return new Intl.DateTimeFormat('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }).format(date);
    };
    
    let ttdRow = signatureBlockStartRow;
    const ttdDate = formatDateToIndonesian(exportOptions.tanggalTTD);
    
    tempSheet.getRange(ttdRow, signatureColumnStart, 1, 4).merge().setValue(`${exportOptions.tempatTTD || "Tempat"}, ${ttdDate}`);
    ttdRow++;
    tempSheet.getRange(ttdRow, signatureColumnStart, 1, 4).merge().setValue(exportOptions.tipeKamad || "Kepala Madrasah");
    ttdRow += 3;
    tempSheet.getRange(ttdRow, signatureColumnStart, 1, 4).merge().setValue(schoolData.namaKepsek || "Nama Kepala").setFontWeight("bold").setFontLine('underline');
    ttdRow++;
    const nipRange = tempSheet.getRange(ttdRow, signatureColumnStart, 1, 4).merge();
    nipRange.setNumberFormat("@");
    nipRange.setValue(schoolData.nipKepsek ? `NIP. ${schoolData.nipKepsek}` : "NIP. -");
    
    // Samakan ukuran font seluruh blok ttd
    tempSheet.getRange(signatureBlockStartRow, signatureColumnStart, 5, 4).setFontSize(12).setHorizontalAlignment("left");
    
    SpreadsheetApp.flush(); 

    // 5. Ekspor file
    const exportUrl = `https://docs.google.com/spreadsheets/d/${tempSpreadsheetFileId}/export`;
    const token = ScriptApp.getOAuthToken();
    const fetchOptions = { headers: { Authorization: `Bearer ${token}` }, muteHttpExceptions: true };
    let blob, fileName, mimeType;

    if (format === 'excel') {
      fileName = `${reportTitle.replace(/ /g, "_")}.xlsx`;
      mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
      const url = `${exportUrl}?format=xlsx`;
      blob = UrlFetchApp.fetch(url, fetchOptions).getBlob().setName(fileName);
    } else { // PDF
      fileName = `${reportTitle.replace(/ /g, "_")}.pdf`;
      mimeType = 'application/pdf';
      const pdfOptions = `?exportFormat=pdf&format=pdf&size=A4&portrait=false&fitw=true&sheetnames=false&printtitle=false&gridlines=false&gid=${tempSheet.getSheetId()}`;
      const url = `${exportUrl}${pdfOptions}`;
      blob = UrlFetchApp.fetch(url, fetchOptions).getBlob().setName(fileName);
    }
    
    if (!blob || blob.getBytes().length === 0) throw new Error("Gagal membuat file ekspor. Blob kosong.");
    
    // 6. Kembalikan data file
    return {
      fileName: fileName,
      mimeType: mimeType,
      base64Data: Utilities.base64Encode(blob.getBytes())
    };

  } catch (e) {
    Logger.log(`Export Error: ${e.toString()}\nStack: ${e.stack}`);
    return { error: e.toString() };
  } finally {
    // 7. Hapus file sementara
    if (tempSpreadsheetFileId) {
      try {
        DriveApp.getFileById(tempSpreadsheetFileId).setTrashed(true);
      } catch (err) {
        Logger.log(`Gagal menghapus file sementara ${tempSpreadsheetFileId}: ${err.toString()}`);
      }
    }
  }
}

/**
 * Mengambil data agregat untuk halaman dashboard.
 * @param {string} spreadsheetId ID spreadsheet target.
 * @returns {object} Objek berisi data untuk dashboard.
 */
function getDashboardData(spreadsheetId) {
  try {
    // Memanggil fungsi yang sudah ada untuk mendapatkan data
    const students = getStudents(spreadsheetId);
    const mapel = getMapel(spreadsheetId);
    const schoolData = getSchoolData(spreadsheetId);

    // Mengembalikan objek yang berisi semua data yang diperlukan
    return {
      status: "success",
      studentCount: students.length,
      mapelCount: mapel.length,
      schoolData: schoolData,
      mapelList: mapel // Mengirim daftar mapel untuk diproses menjadi grafik
    };
  } catch (e) {
    Logger.log(e);
    return { status: "error", message: "Gagal mengambil data dashboard: " + e.message };
  }
}
